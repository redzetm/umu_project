# ush-0.0.3-基本設計書.md
UmuOS User Shell (ush) — 基本設計書（0.0.3 / 拡張）  
Target OS: UmuOS-0.1.6-dev  

本書は [ush-0.0.3/docs/ush-0.0.3-仕様書.md](ush-0.0.3/docs/ush-0.0.3-仕様書.md) を、実装に落とし込むための基本設計（構成・責務・入出力・例外）として整理する。

---

# 1. 目的と非目的

## 1.1 目的
- UmuOS におけるユーザー向け対話シェルとして、軽量で観測可能な操作環境を提供する。
- 直列処理・成功/失敗分岐（`&&` / `||`）中心の「小物スクリプト」を ush で書けるようにする。
- 未対応は「検出してエラー」に倒し、誤動作より観測可能性を優先する。

## 1.2 非目的（0.0.3ではやらない）
- POSIX sh / bash 互換の追求。
- 制御構文（`if/for/while/case` 等）による本格スクリプト。
- 位置パラメータ（`$1` 等）を含む引数処理。
- 多段パイプ（`a|b|c`）や高度なリダイレクト。

本格スクリプトが必要な場合は `/bin/sh`（BusyBox ash）で実行する。

---

# 2. 実行環境と運用

## 2.1 位置づけ
- `/bin/sh`（BusyBox ash）は互換性重視のスクリプト実行用途として継続利用する。
- `ush` はユーザー向け対話操作・軽量スクリプトとして `/umu_bin/ush` を想定する。

## 2.2 起動・配置
- バイナリの配置先は `/umu_bin/ush` とする。
- スクリプト実行（shebang）は `#!/umu_bin/ush` を想定する。

## 2.3 プロンプト設定（環境変数）
- ush はプロンプト表示のたびに `USH_PS1` → `PS1` → デフォルトの順に参照する。
- 運用上は `/etc/profile` に `export USH_PS1=...` を設定しておくのが単純。

---

# 3. 全体構成

## 3.1 対話モード処理フロー（概略）
1. SIGINT 方針を設定（親は落ちない）
2. プロンプトを生成・表示
3. 行編集付きで 1 行入力を取得
4. 空行/コメント行なら何もせず戻る
5. トークナイズ（クォート処理、演算子トークン化、コメント除去、未対応検出）
6. 構文解析（`|` / `&&` / `||` / リダイレクト制約を検査し、内部表現へ）
7. 実行（builtins または外部実行、`last_status` 更新）
8. ループ継続（EOF なら `exit(last_status)`）

## 3.2 スクリプトモード処理フロー（概略）
1. `ush <script>` でファイルを開く
2. 先頭行が `#!` なら 1 行目を無視
3. 以降、1 行ずつ読み込み
4. 空行/コメント行はスキップ
5. 各行を対話と同じ評価器で実行
6. エラーでも次の行へ進む（fail-fast なし）
7. `exit` builtin で終了

## 3.3 モジュール分割（責務）
- main
  - 対話/スクリプトモードの分岐、ループ、状態（`last_status`）管理、SIGINT 方針
- prompt
  - `USH_PS1`/`PS1`/デフォルト選択、最小展開（`\u` `\w` `\$` `\\`）
- lineedit
  - raw mode 入力、カーソル移動、削除、履歴、Tab 補完
- tokenize
  - 文字列→トークン列（クォート処理、演算子の独立トークン化、コメント除去、未対応検出）
- parse
  - トークン列→AST（`CMD`/`PIPE`/`AND`/`OR`）
  - 構文制約（1段パイプ、リダイレクト位置、`<`/`>` 適用範囲）チェック
- expand
  - 変数展開（`$VAR`/`$?`）
  - チルダ展開（`~`/`~/...`）
- builtins
  - `cd` `pwd` `export` `exit` `help`（親プロセスで実行）
- exec
  - AST 評価（短絡、パイプ、リダイレクト、PATH 探索、fork/exec/wait）
  - `ENOEXEC` のみ `/bin/sh` フォールバック

---

# 4. データ設計

## 4.1 状態（`last_status`）
- ush は `last_status`（初期値 0）を保持する。
- 更新規約は仕様書 6.1/9.5 に準拠する。

## 4.2 内部表現（概念）
- token
  - 文字列トークン（WORD）
  - 演算子トークン（`|` `&&` `||` `<` `>` `>>`）
  - WORD はクォート種別（未クォート/シングル/ダブル）を持つ
- command
  - `argv[]`（最大 `USH_MAX_ARGS`）
  - `in_path`/`out_path`/`out_append`
- AST
  - `CMD`（単一コマンド）
  - `PIPE`（最大 2 コマンド）
  - `AND`/`OR`（左結合）

---

# 5. 入力設計（line editor）

## 5.1 前提
- 対話入力は端末を raw mode（canonical off, echo off）にして 1 文字ずつ処理する。

## 5.2 対応キー（仕様準拠）
- Enter: 行確定（`\n`/`\r`）
- Ctrl-D: バッファ空なら EOF（終了）、非空なら無視
- BS(0x08)/DEL(0x7f): カーソル左を削除
- Delete（`ESC [ 3 ~`）: カーソル位置を削除
- 矢印（`ESC [ A/B/C/D`）: 履歴/移動
- Tab: コマンド名補完（先頭トークンのみ）
  - 候補 1 つ: 確定補完（再描画）
  - 候補複数: 共通プレフィックス分だけ伸長（再描画）
  - 伸長不可: 候補一覧表示→プロンプト＋入力行を再描画

---

# 6. 字句設計（tokenize）

## 6.1 区切り
- 空白（スペース/タブ）で区切る。
- 連続空白は 1 つの区切りとして扱う（先頭/末尾は無視）。

## 6.2 コメント（`#`）
- 未クォートで「トークン先頭の `#`」をコメント開始として扱い、以降を無視する。

## 6.3 クォート
- `'...'`（展開なし）
- `"..."`（変数展開のみ）
- 未閉鎖クォートは `syntax error`（`last_status=2`）

## 6.4 演算子
- 空白の有無に関わらず独立トークンとして認識する。
  - `|` `&&` `||` `<` `>` `>>`

## 6.5 未対応（検出してエラー）
- `;`, `&`（単体）, `(`, `)`, `{`, `}`
- グロブ（`* ? [ ]`）
- ヒアドキュメント
- 環境代入（先頭 `NAME=...` 形式）
- 変数展開の未対応形（`${...}`, `$1`, `$(...)`, バッククォート）

---

# 7. 構文設計（parse）

## 7.1 優先順位
- `|` が高い
- `&&`/`||` が低い

## 7.2 構文制約（仕様準拠）
- パイプは 1 段まで（最大 2 コマンド）
- リダイレクトは「words の後ろ」にまとめて書く
- `<` は 0 または 1 個、`>`/`>>` は 0 または 1 個（同時不可）
- パイプラインの場合
  - `<` は左コマンドのみ
  - `>`/`>>` は右コマンドのみ

---

# 8. 実行設計（exec）

## 8.1 builtins
- builtins は親プロセスで実行する。
- builtins は「パイプなし」かつ「リダイレクトなし」の場合のみ対応。
- `&&`/`||` の左右要素として builtins を置くことは許可する。

## 8.2 外部実行
- `argv[0]` に `/` があるなら PATH 探索しない。
- `/` が無い場合は `$PATH` を `:` 区切りで探索。
- `$PATH` 未設定時のデフォルトは `/umu_bin:/sbin:/bin`。

## 8.3 パイプ（1段）
- `cmd1 | cmd2` のみ。
- `last_status` は右側（cmd2）の終了コード。

## 8.4 リダイレクト失敗の扱い（重要）
- リダイレクト対象ファイルは **fork 前に親で `open()` して成功確認**する。
- 1 つでも失敗したら、その行は **1 つも fork/exec しない**（部分実行しない）。

## 8.5 ENOEXEC フォールバック
- `execve()` が `ENOEXEC` の場合のみ `/bin/sh` にフォールバックする。

---

# 9. エラー設計

## 9.1 出力
- エラーは stderr。
- 接頭辞 `ush:` を付ける。

## 9.2 メッセージ種別
- 未対応検出: `ush: unsupported syntax`（`last_status=2`）
- 構文エラー: `ush: syntax error`（`last_status=2`）
- リダイレクト等の実行準備エラー: `ush: open: <strerror>` 等（`last_status=1`）

---

# 10. 受け入れ（基本設計観点）
- 仕様書の全項目が、この基本設計に矛盾なく写像されていること。
- 特に以下が成立していること:
  - `&&`/`||` が短絡評価で動作し、`last_status` が規約通り更新される
  - 1段パイプが動作し、`last_status` は右側終了コードになる
  - リダイレクト `open()` 失敗時に部分実行が起きない
  - Tab 補完が仕様通りの3段階動作をする
