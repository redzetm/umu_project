# ush-0.0.3-仕様書.md
UmuOS User Shell (ush) — 仕様書（0.0.3 / 拡張）  
Target OS: UmuOS-0.1.6-dev  

この文書は、ush 0.0.2（MVP）の仕様を土台にして、ush 0.0.3 で「**対話は ush を基本**」「**小物スクリプトは ush**」「**複雑なスクリプトは ash(/bin/sh) に委譲**」という運用を成立させるための仕様を定義する。

---

# 1. 目的と非目的

## 1.1 目的
- UmuOS におけるユーザー向け対話シェルとして、軽量で観測可能な操作環境を提供する
- 直列処理・成功/失敗分岐（`&&` / `||`）中心の「小物スクリプト」を ush で書けるようにする

## 1.2 非目的（0.0.3ではやらない）
- POSIX sh / bash 互換の追求
- 制御構文（`if/for/while/case` 等）による本格スクリプト
- 位置パラメータ（`$1` 等）を含む引数処理
- 多段パイプ（`a|b|c`）や高度なリダイレクト

本格スクリプトが必要な場合は `/bin/sh`（BusyBox ash）で実行する。

---

# 2. 位置づけ（ash と ush）

## 2.1 役割分担
- `/umu_bin/ush` : ユーザー向け対話操作・軽量スクリプト（本仕様）
- `/bin/sh` : 互換性重視のスクリプト実行（BusyBox ash）

## 2.2 運用方針（推奨）
- 対話操作は ush を基本にする
- スクリプトは以下で使い分ける
  - ush: 直列処理・簡易な失敗分岐（`&&`/`||`）・パイプ1段で足りるもの
  - sh: 分岐/ループ/引数処理/多段パイプなどが必要なもの

---

# 3. 設計思想
- 最小限・高速・シンプル
- 教育的で読みやすいコード
- 未対応は「検出してエラー」
  - 失敗しても挙動が読める（観測可能）ことを優先する

---

# 4. ビルド方針
- musl-gcc による静的リンクを基本とする
- 開発ホストでビルドし、UmuOS へ持ち込む

例：

```sh
musl-gcc -static -O2 -s -o ush main.o ...
```

---

# 5. 機能一覧（0.0.3）

## 5.1 対話シェル
- プロンプト表示
- 1 行入力（EOF/Ctrl-D で終了）
- 行編集（最低限）
  - Backspace/Delete/左右矢印/上下（履歴）
  - Tab 補完（先頭トークンのコマンド名。挙動は 0.0.2 と同様）
    - 候補が 1 つなら、その候補で確定補完（バッファ書き換え＋再描画）
    - 候補が複数なら、共通プレフィックスが伸びる分だけ補完
    - それ以上決められない場合は、改行して候補一覧を表示→プロンプト＋入力行を再描画
- PATH 検索（未設定時は `/umu_bin:/sbin:/bin`）
- 外部コマンド実行（fork/exec）
- builtins: `cd`, `pwd`, `export`, `exit`, `help`
- SIGINT の扱い（親は落ちない、子はデフォルト）

## 5.2 シェル言語（小物スクリプト向け）
対応するもの：

- クォート
  - シングルクォート `'...'`（展開なし）
  - ダブルクォート `"..."`（変数展開のみ）
- 展開
  - `$VAR`（環境変数）
  - `$?`（直前の終了コード）
  - `~` / `~/...`（チルダ展開）
- 演算子
  - `|`（1段パイプのみ）
  - `&&` / `||`（短絡評価）
  - `<` `>` `>>`（リダイレクト）
- コメント
  - `#`（行中コメント対応、ただしトークン先頭のみ）

---

# 6. 実行モデル

## 6.1 `last_status`
- ush は `last_status`（初期値 0）を保持する
- 外部コマンド実行後
  - 通常終了: `WEXITSTATUS(status)`
  - シグナル終了: `128 + WTERMSIG(status)`
- builtin 実行後
  - 成功: 0
  - 実行エラー: 1
  - 構文/引数不正: 2
- 対話モードの EOF（Ctrl-D）は `exit(last_status)`

外部コマンド探索の慣習：

- 未発見: 127
- 実行不可（権限等）: 126

## 6.2 エラーメッセージ
- stderr に出力し、先頭に `ush:` を付与する
- 代表例
  - `ush: unsupported syntax`
  - `ush: syntax error`
  - `ush: open: <strerror>`

---

# 7. トークナイズ（0.0.3）

## 7.1 区切り
- 空白（スペース/タブ）で区切る
- 連続空白は 1 つの区切りとして扱う（先頭/末尾は無視）

## 7.2 コメント（`#`）
未クォートで、かつ「トークン先頭の `#`」をコメント開始として扱う。

- `# ...` / `   # ...` はその行を無視
- `echo hi # comment` の `#` 以降を無視
- `echo foo#bar` の `#` はトークン途中なのでコメント扱いしない

## 7.3 演算子（独立トークン）
空白の有無に関わらず、以下を独立トークンとして認識する。

- `|` `&&` `||` `<` `>` `>>`

ただし、クォート内では演算子は文字として扱う。

## 7.4 クォート

### 7.4.1 シングルクォート（`'...'`）
- 囲まれた範囲は 1 トークン
- 展開なし
- 閉じクォートがない場合はエラー

### 7.4.2 ダブルクォート（`"..."`）
- 囲まれた範囲は 1 トークン
- ダブルクォート内は空白や演算子も文字
- ダブルクォート内で行う展開は **変数展開のみ**（`$VAR`, `$?`）
- 閉じクォートがない場合はエラー

制限：

- バックスラッシュ（`\`）はエスケープとして解釈しない（通常文字）
  - 例: `echo \"a\"` のような書き方で `"` を「引用符」として扱うことはできない

## 7.5 変数展開
対応：

- `$NAME`（`NAME` は `[A-Za-z_][A-Za-z0-9_]*`）
- `$?`（`last_status` を 10 進で展開）

規約：

- 未定義の環境変数は空文字
- シングルクォート内は展開しない
- ダブルクォート内と未クォートで展開する

未対応（検出してエラー）：

- `${NAME}`
- `$1` などの位置パラメータ
- `$(...)` / `` `...` ``

## 7.6 チルダ展開
未クォートのトークン先頭で、以下のみ対応する。

- `~` → `$HOME`
- `~/path` → `$HOME/path`

規約：

- `$HOME` が未設定の場合は `~` を `/` とみなす
- クォート内では展開しない
- `~user` は未対応

## 7.7 未対応（検出してエラー）
0.0.3 では以下を未対応とし、検出したらその行は実行しない。

- `;`, `&`, `(`, `)`, `{`, `}`
- 行継続（バックスラッシュ改行）
- グロブ（`* ? [ ]`）
- ヒアドキュメント
- 環境代入（先頭に `NAME=...` を置く形式。例: `FOO=bar echo hi`）
  - ただし `export NAME=VALUE` は builtin として許可する

未対応検出時：

- stderr に `ush: unsupported syntax`
- `last_status = 2`

---

# 8. 構文（パーサ）

## 8.1 優先順位
- `|` が高い
- `&&` / `||` が低い

## 8.2 文法（簡易）
コメントはトークナイザ段階で除去されている前提とする。

```
line        := list
list        := pipeline ( ("&&" | "||") pipeline )*
pipeline    := command ("|" command)?
command     := words redirects?
words       := WORD+
redirects   := ("<" WORD)? ((">"|">>") WORD)?
```

### 8.2.1 リダイレクトの書ける位置（0.0.3）
0.0.3 では、リダイレクトは **コマンド引数（words）の後ろにまとめて書く**。

- OK: `cat a.txt > out.txt`
- NG: `cat > out.txt a.txt`（文法違反として扱い、`syntax error`）

また、同一コマンド内で許可するリダイレクトは以下に限定する。

- 入力リダイレクト `<` は 0 個または 1 個
- 出力リダイレクト `>` / `>>` は 0 個または 1 個（両方同時は不可）
- リダイレクト演算子の直後には必ず `WORD` が必要（欠けている場合は `syntax error`）
- コマンド（`words`）は最低 1 個の `WORD` が必要（例: `> out.txt` は `syntax error`）

制限：

- パイプは 1 段まで（最大 2 コマンド）
- `<` はパイプライン先頭コマンドのみ
- `>` / `>>` はパイプライン末尾コマンドのみ

## 8.3 AST（概念）
実装は自由だが、最低限次のノードを想定する。

- `CMD(argv, in_redir?, out_redir?)`
- `PIPE(left_cmd, right_cmd)`
- `AND(left, right)`
- `OR(left, right)`

---

# 9. 実行（exec）

## 9.1 条件実行（`&&`, `||`）
- `A && B` : `A` が 0 のときだけ `B`
- `A || B` : `A` が 0 以外のときだけ `B`

`last_status` は最後に実行した要素の終了コード。

## 9.2 パイプ（1段）
- `cmd1 | cmd2` のみ
- `pipe()` を 1 本作り、2 回 `fork()`
- 左の stdout を pipe write に、右の stdin を pipe read に `dup2()`
- `last_status` は右側（cmd2）の終了コード

補足：

- 同一行にリダイレクトがある場合は 9.3 のとおり **fork 前に事前 `open()` で成功確認**する
  - 事前 `open()` に失敗した場合、この行は **1 つも fork せず**実行しない（部分実行を防ぐ）

## 9.3 リダイレクト

- `< file` : `open(file, O_RDONLY)`
- `> file` : `open(file, O_WRONLY | O_CREAT | O_TRUNC, 0644)`
- `>> file` : `open(file, O_WRONLY | O_CREAT | O_APPEND, 0644)`

失敗時：

- stderr に `ush: open: <strerror>` など
- 行の実行を中止し `last_status = 1`
  - **この行では 1 つも fork/exec しない**（部分実行を防ぐ）

補足：

- リダイレクト対象（`<`/`>`/`>>`）のファイルは **fork 前に親で `open()` して成功確認**する
  - 成功した FD を子へ引き渡し、子プロセス側で `dup2()` してから `execve()` する
- パイプラインの場合、左コマンドに `<`、右コマンドに `>`/`>>` を適用する（8.2 の制限どおり）
- どれか 1 つでもリダイレクト設定に失敗した場合、その行は実行しない

## 9.4 コマンド探索
- コマンドに `/` を含む場合は PATH 検索しない
- `/` を含まない場合は `$PATH` を `:` 区切りで走査
- 実行不可（EACCES）候補が 1 つでもあれば、最終失敗は 126
- それ以外は 127

`execve()` が `ENOEXEC` の場合のみ `/bin/sh` へフォールバックする。

## 9.5 `last_status` の決定規則（優先順位）
同一行の評価で複数の「失敗要因」があり得るため、0.0.3 では次の順序で `last_status` を決める。

1) 字句/構文段階の失敗
  - 未対応構文検出（7.7）: `last_status = 2`（その行は実行しない）
  - 構文エラー（例: リダイレクトの引数欠け、閉じクォート欠け等）: `last_status = 2`（その行は実行しない）
2) リダイレクトの失敗
  - `open()` 等に失敗: `last_status = 1`（その行は実行しない）
3) 実行（fork/exec）段階の失敗
  - コマンド探索に失敗: 126/127（6.1 の慣習どおり）
4) 実行結果
  - 外部コマンド: 通常終了は 0..255、シグナル終了は `128 + signal`
  - builtins: 0/1/2（6.1, 10.2）

構文要素ごとの扱い：

- `A && B` / `A || B` は左→右に評価し、短絡した場合 `B` は実行しない（`last_status` は `A` の結果のまま）
- `cmd1 | cmd2` は 2 つとも起動し、`last_status` は常に右（cmd2）の終了コード

---

# 10. builtins
対象： `cd`, `pwd`, `export`, `exit`, `help`

## 10.1 builtins の実行条件
- builtins は親プロセス（ush 本体）で実行する
- `&&` / `||` の左右要素として builtins を置くことは許可する
  - 例: `cd /tmp && pwd`

制限：

- builtins は「パイプなし」かつ「リダイレクトなし」の場合のみ対応
- builtins をパイプに含めることは未対応

## 10.2 各 builtin の仕様（最小）
- `cd [DIR]`
  - `DIR` 省略時は `$HOME`（未設定なら `/`）
- `pwd`
  - 現在ディレクトリを 1 行で出力
- `export NAME=VALUE` / `export NAME`
  - `NAME=VALUE` は環境変数を設定
  - `NAME` のみは、未定義なら空文字で作成（定義済みなら維持）
  - `NAME` は `[A-Za-z_][A-Za-z0-9_]*`
- `exit [N]`
  - `N` 省略時は `last_status`
- `help`
  - 主要な使い方（builtins 一覧）を表示

---

# 11. スクリプトモード

## 11.1 起動
- `ush <script>` でスクリプトモード
- `#!/umu_bin/ush` で起動できることを想定する

## 11.2 実行規約
- 1 行ずつ読み、各行を対話と同じ評価器で実行する
- 空行/コメント行はスキップ
- 先頭行が `#!` で始まる場合は 1 行目を無視する
- `exit` が実行されたら、その時点で終了する

エラー時：

- `unsupported syntax` / `syntax error` が起きても次の行へ進む（fail-fast は未対応）
- 実行エラー（コマンド未発見、実行不可、リダイレクト失敗など）でも次の行へ進む

---

# 12. シグナル
- 親（ush 本体）は SIGINT で落ちない
- 子は SIGINT をデフォルト動作に戻してから exec する

---

# 13. 制限値
- 1 行の最大長: 8192
- 最大引数数: 128
- 1 トークン最大長: 1024

---

# 14. プロンプト
プロンプト仕様は 0.0.2 と同様。

- 優先順位: `USH_PS1` → `PS1` → デフォルト
- デフォルト: `\u@UmuOS:ush:\w\$ `
- 展開（最小）: `\u`, `\w`, `\$`, `\\`

---

# 15. ディレクトリ構造（参考）
実装上は以下のような分割を推奨する（必須ではない）。

```
ush/
  include/
  src/
    tokenizer.c
    parser.c
    exec.c
    builtins.c
    lineedit.c
```

---

# 16. UmuOS への組み込み
- ビルドした `ush` バイナリを `/umu_bin/ush` に配置
- `/bin/sh` は BusyBox のまま維持

---

# 17. 付録：一般的なB系シェルにあるが未実装の機能
ここでは「一般的なB系シェル（sh/ash/bash等）にはあるが、ush 0.0.3（本仕様）では未対応」の機能を列挙する。

## 17.1 構文・制御構文
- コマンド区切り `;`
- バックグラウンド実行 `&`
- グルーピング `(...)` / `{ ...; }`
- `if/then/elif/else/fi`
- `for/while/until/do/done`
- `case/esac`
- 関数定義

## 17.2 展開・評価
- バックスラッシュエスケープ（入力行の `\`）
- `${VAR}`
- 位置パラメータ（`$1`, `$@`, `$#` 等）
- コマンド置換 `$(...)` / `` `...` ``
- 算術展開 `$((...))`
- グロブ `* ? [ ]`

## 17.3 リダイレクト・パイプ（高度）
- 多段パイプ
- stderr リダイレクト（`2>` / `2>&1` 等）
- `<<`（ヒアドキュメント）、`<<<`（ヒアストリング）
- FD 操作（`n>file` など）

## 17.4 対話機能
- ジョブ制御
- 履歴展開（`!`）　



