# ver0.1.1 失敗の振り返り（全面改稿）

この文書は、UmuOS ver0.1.1（作業ディレクトリ: `UmuOSver011/`）の試行で起きた失敗を、
後続プロジェクト（ver0.1.1 のやり直し、ver0.2 以降）で“参考文献”として使える粒度まで落とし込むための記録である。

このプロジェクトの設計思想（トップの README.md）は「理解・観測・検証」を最優先とし、
失敗や判断も研究成果として扱う。そのため、本書は「できなかったこと」の列挙ではなく、
“どこで何が起き、なぜそう判断し、次はどう進めれば同じ穴に落ちないか”を仕様/運用に落とすことを目的とする。

> 注意：作業途中の成果物（run/配下のログ・一時ファイル等）は削除/整理され得る。
> 本書は、残っている設計/実装ノート（`docs/UmuOSver011詳細設計.md`, `docs/実装ノート.md`）および当時の状況説明に基づいて再構成している。

---

## 0. この文書の読み方（最短ルート）

- 「結論だけ先に」→ 1章（エグゼクティブサマリ）
- 「何が起きたかを追う」→ 4章（時系列）
- 「原因を体系的に理解したい」→ 5.3節（原因の構造化）
- 「次からの進め方（ルール）だけ欲しい」→ 6章（再発防止の仕様化）
- 「コマンド/注意点を参照したい」→ 付録

---

## 1. エグゼクティブサマリ（失敗の要点）

### 1.1 何が失敗だったか（短く）

ver0.1.1 は「ベース版としていつでも戻れる安定点」を作るはずだったが、結果として
**“変更点が多すぎて、原因が混ざり、戻れる基準点が作れない”** 状態に陥った。

この失敗は、技術的なミス（例：BusyBox applet の symlink、ext4 破損、shadow の未確定）だけでなく、
プロジェクト運用（観測点の固定、実験の粒度、成果物の確定方法）にも根がある。

### 1.2 一番大きい根本原因（1行）

**「ベース版」を作る手順が“先に”固定されないまま、複数の不確実要素（ネットワーク/telnet/認証/FS/起動オプション）を同時に動かした**。

### 1.3 失敗を構成したトップ要因（重要度順）

1) **1回の実験に含める変更量が大きすぎた**
	 - 例：起動（switch_root）と認証（passwd/shadow）とネットワーク（ブリッジ/NAT/telnet）を並行に触り、切り分けが破綻した。

2) **観測点と“固定点”が足りなかった**
	 - どこまで進んだかを示すログ/表示が不足すると「止まったように見える」→推測で次の変更を重ねる→混乱が増幅する。

3) **永続ディスク（ext4）側の作業手順に地雷があり、再現性が崩れた**
	 - BusyBox applet symlink がホスト絶対パスを指す事故
	 - ext4 の checksum エラー（fsck 必須状態）

4) **認証（/etc/shadow）を確定できず、ログインの成功/失敗が揺れた**
	 - プレースホルダのまま起動だけ通る／ログインだけ失敗する、といった“半成功”が続いた。

5) **開発環境のネットワーク（Proxmox vmbr0 / Ubuntu br0 / QEMU）で障害の影響範囲が広かった**
	 - ネストブリッジを常用した場合、失敗が Proxmox 側まで波及し得る。
	 - ここが一度でも不調になると、以降の検証が止まる（研究が進まない）。

### 1.4 成果として残せたこと（“失敗の価値”）

- 受入環境を「開発環境QEMU（`accel=tcg`）+ シリアル」に限定し、再現性の軸が明確になった
- 「ネット無しでブート経路（UEFI→switch_root）を先に固める」順序の重要性が確定した
- BusyBox applet の生成方法（chroot 前提）が仕様として明文化された
- Proxmox 側障害の扱い（復旧手順の集約、NAT推奨/ブリッジ任意）を“設計として”固定できた

---

## 2. 前提整理（この試行の狙いと境界）

### 2.1 UmuOS の設計思想（不変条件）

トップ README のとおり、UmuOS は「使うため」ではなく「理解するため」のOSである。
したがって、成功とは“動いた”ではなく、
**動作を説明できる観測点があり、再現できる手順として残っている**こと。

### 2.2 ver0.1.1 で狙ったこと（計画由来）

`UmuOSver011基本計画.md` では、概ね次を狙っていた：

- カーネル 6.18.1 + initramfs（自作 init C）+ ext4 永続 `/` への移行
- ver0.1 の「揮発と永続の混在」を解消し、`/` を丸ごと永続化
- root/tama のログイン（ID+パスワード）を成立させる
- ネットワーク（静的IP）と telnet での接続（開発用途）
- 起動ログの永続化（`/logs`）

### 2.3 受入環境（固定したかった条件）

`docs/実装ノート.md` と `docs/UmuOSver011詳細設計.md` で固定したかった条件：

- 開発環境: Ubuntu 24.04 LTS（ProxmoxVE 上の VM）
- 実行: QEMU `qemu-system-x86_64`（`accel=tcg` 前提）
- 観測: シリアル（ttyS0）でログを取る

### 2.4 成果物と“混ざりやすい場所”（ディレクトリ観点）

この試行では、成果物が複数の層に分散していたため、
「どれが正で、どれが一時物か」が曖昧になると、再現性が崩れやすい。

主な層：

- ISO層（ブート資産）
	- `UmuOSver011-boot.iso`
	- `iso_root/`（GRUB cfg、vmlinuz、initrd など）

- initramfs層（移行専用）
	- `initramfs/`（rootfs, init.c, initrd.img）
	- ここでやるべきことは「永続ディスクを見つけて switch_root」まで

- 永続ディスク層（最終的な /）
	- `disk/disk.img`
	- `/etc/inittab`, `/etc/init.d/rcS`, `/etc/passwd`, `/etc/shadow` 等はここが正

- 実行/ログ層（run/, logs/）
	- 一時ファイルが溜まりやすく、整理/削除で“事実の裏付け”が欠けやすい

混ざると破綻する代表例：

- initramfs でログインをやろうとする（本来は switch_root 後にやる）
- 永続ディスクのファイルを「作ったつもり」で確認が抜ける（存在/権限/中身）
- QEMUの起動オプションを頻繁に変え、観測経路（ttyS0）が揺れる

---

## 3. システム構成（何を作ろうとしていたか）

### 3.1 ブートの全体像

```text
UEFI(OVMF)
	↓
GRUB (ISO内)
	↓  kernel cmdline: root=UUID=... console=...
Linux kernel 6.18.1
	↓
initramfs (/init: C実装)
	- /dev/proc/sys を用意
	- root=UUID=... を解析
	- UUID一致するブロックデバイスを自前探索
	- /newroot に ext4 を mount
	- switch_root /newroot /sbin/init
	↓
ext4 ルート (disk.img)
	- BusyBox init/getty/login
	- /etc/inittab /etc/init.d/rcS
	- /etc/passwd /etc/shadow
	- /logs/boot.log 追記
```

### 3.2 失敗が起きやすい“境界”

この構成は境界が多い（それぞれが独立に失敗する）：

- GRUB → kernel: cmdline（root=UUID/console）
- kernel → initramfs: デバイス可視性（devtmpfs）
- initramfs → ext4: UUID解決、mount、switch_root
- ext4 → login: BusyBox applet、権限、shadow
- ネットワーク: ホスト/Proxmox/ゲストのL2/L3

“境界を跨ぐ変更”を複数同時にやると、どこで壊れたか分からなくなる。

---

## 4. 時系列（何が起きたか）

> 目的：後から同じ順序で追えること。
> ここでは「フェーズ」「観測された症状」「そのときの判断」を時系列で並べる。

### 4.1 フェーズA：設計と環境準備

- 必要パッケージを導入（qemu/ovmf/busybox/e2fsprogs 等）
- カーネル 6.18.1 を defconfig でビルドし ISO 側に配置
- initramfs の rootfs 骨格を作成し、BusyBox（static）を配置

観測/学び：
- `lsinitramfs | head` だけだと `/init` が見えないことがあり、誤解を招いた（実装ノート 2.2.1）。

### 4.2 フェーズB：ネット無しでブート経路を固める（本来の正しい順序）

狙い：
- ネットワークを切り離し、`UEFI→GRUB→kernel→initramfs→ext4→switch_root` の主経路を成立させる。

実際に起きた問題：
- ext4 ルート側の `/bin/sh` 等が壊れて `rcS` で止まったように見える

原因：
- ext4 側で BusyBox applet を生成した際、symlink がホスト絶対パス（例：`/mnt/umuos011/bin/busybox`）を指し、
	ゲスト起動時に解決できず実行不能になった（実装ノート 2.2.3.1）。

対処：
- chroot してゲスト基準のパスで applet を生成する方針に変更。

### 4.3 フェーズC：ext4 の整合性崩れ（fsck が必要になる）

症状：
- ext4 の checksum エラーなどが発生し、以後の変更が“正しく書けているか”自信が持てなくなる。

影響：
- 何かを直しても、ディスク側の破損で別要因の不具合が出る可能性が混ざり、検証が不可能になる。

対処（運用に落とすべきこと）：
- 「VM停止 → e2fsck → 続行」をルール化しないと、検証が“流砂”になる。

### 4.4 フェーズD：ネットワーク検証と Proxmox 側障害疑い

症状：
- br0/vmbr0 を絡めた検証中に、Proxmox の `vmbr0` がハングした疑い（ネットワーク障害）。

判断：
- 受入の本質はネットワークではなくブート/永続/ログイン。
- ネットワーク検証が基盤（Proxmox）を巻き込むなら、手順順序を見直し、影響範囲を閉じるべき。

結果：
- NAT（QEMU user networking + port forward）を推奨経路にし、ブリッジは必要時のみへ（実装ノート 2.2.4、詳細設計 10章の方針）。

### 4.5 フェーズE：telnet接続が不安定（接続即切断）と認証未確定

症状：
- hostfwd でポートが LISTEN していても、telnet 接続が即切断される。

疑われる要因（混在していた可能性が高い）：
- `telnetd -l /bin/login` の起動はしているが、`/bin/login`（BusyBox login）側で認証が通らない
- `/etc/shadow` がプレースホルダのまま（実装ノート 2.2.5）
- `securetty` や `inittab/getty` 側の設定不足

ここでの本質：
- telnet は「ネット」「デーモン」「login」「shadow」が全て絡むため、
	ベース（ローカルシリアルでログイン成功）が固まっていない状態で進めると切り分け不能。

### 4.6 フェーズF：/etc/shadow の編集・検証が不安定でループ

症状：
- `/etc/shadow` の値がプレースホルダ（`<ROOT_HASH>` 等）だとログインできない。
- 一方で、環境/手順により「外部からの編集・検証がやりにくい（マスクされる/確定しない）」状態があり、
	認証の成功条件を固定できなかった。

影響：
- “起動はするがログインできない”が継続し、以後の検証が止まる。

### 4.7 フェーズG：QEMU起動オプションの揺れ（観測経路が壊れる）

症状：
- `-daemonize` を使いたい、かつ `-nographic` でシリアルを見たい、といった要求が同時に出る
- 起動はしているはずだが、画面/シリアルが見えず「起動していない」に見える

背景：
- QEMUはオプションの組み合わせによって、標準入出力や表示が期待とズレる。
	“観測（ttyS0）”がプロジェクトの生命線なのに、ここが揺れると全てが推測になる。

対策（仕様として固定すべきこと）：
- **観測経路を固定**し、起動方式をむやみに変えない
- 例：GUI不要なら `-display none` + `-serial ...` を基本形として固定する（どこに出るかを固定する）

### 4.8 フェーズH：「理解が追いつかない」問題（運用上の失敗）

症状：
- 修正が積み重なるほど、どの変更で何が変わったか追えなくなる
- AIに相談しながら進めるも、なんでこの処理が必要なのか、自身のい理解が追い付かない。

本質：
- UmuOSの価値は「説明できる理解」にあるため、
	**変更量＞理解量** になった時点で、成功していても研究としては失敗になり得る

再発防止：
- 変更は「合意した1点」だけ
- 変更の前後で「観測点」がどう変わったかを文章で残す
- “次に何をやるか”を 1〜3 行で固定し、それ以外はやらない

---

## 5. 失敗事象のカタログ（症状→原因→対処→再発防止）

この章は「同じ症状が出たときに、最短で原因に辿り着く」ための索引。

### 5.1 事象一覧（概要）

| ID | 症状（見え方） | 影響 | 主因 | 恒久対策 |
|---:|---|---|---|---|
| F-01 | initrd に `/init` が無い気がする | 調査の迷走 | `head` による見落とし | “必要ファイルだけgrep” を手順化 |
| F-02 | `mount: マウント済みです` | 作業停止/誤判断 | 既にloop mount済み | findmnt/mountpoint を固定確認 |
| F-03 | `rcS` で止まる/シェルが起動しない | ブート失敗 | BusyBox applet symlink がホスト絶対パス | chroot + 相対symlink確認 |
| F-04 | ext4 checksum エラー | 何を直しても不安 | FS破損 | VM停止後に e2fsck を運用化 |
| F-05 | Proxmox `vmbr0` 不調/ハング疑い | 環境全体が止まる | ネストブリッジ等のL2影響 | NAT優先・ブリッジ任意へ |
| F-06 | telnet 接続が即切断 | 開発経路が死ぬ | login/shadow/ネットの混在 | シリアルでログイン確定→最後に導入 |
| F-07 | root/tama ログイン不可 | 受入失敗 | `/etc/shadow` 未確定 | ハッシュ生成/権限/検証手順の固定 |
| F-08 | 作ったはずの設定ファイルが無い/権限が違う | 混乱 | 途中中断・確認不足 | “存在→権限→中身”の順を固定 |
| F-09 | QEMUを起動したのに観測できない | 切り分け不能 | 起動オプションで入出力が揺れる | 観測経路を固定（display/serial） |
| F-10 | 認証情報が“確定しないように見える” | ループ | shadowの確定/検証手順が曖昧 | shadowは手順固定・成功条件固定 |

### 5.2 各事象の詳細

#### F-01 initrd に `/init` が無いように見える

- 症状：`lsinitramfs ... | head` に `init` が見えない
- 原因：一覧が長いだけで先頭に出ていない（実装ノート 2.2.1）
- 対処：必要な2点だけ確認する
	- `lsinitramfs initrd.img | grep -E '^(init|bin/switch_root)$'`
- 再発防止：検証コマンドは“最小確認”を標準にする

#### F-03 ext4 側 BusyBox applet が壊れる（`rcS` で止まる）

- 症状：`rcS` 実行段階で止まる、getty/login が出ない
- 原因：host で mount したパスが symlink に埋め込まれる（実装ノート 2.2.3.1）
- 対処：chroot して applet 生成、生成後に symlink を確認
	- 例：`sudo chroot /mnt/umuos011 /bin/busybox --install -s /bin`
	- 例：`ls -l /mnt/umuos011/bin/sh` が `-> /bin/busybox` になっていること
- 再発防止：applet生成は“必ずchroot”を仕様にする

#### F-04 ext4 破損（checksum）

- 症状：fsck がエラーを出す、以後の変更が信用できない
- 原因：強制停止/不整合/操作ミスなど複合（本書では原因断定より運用対策を重視）
- 対処：VM停止後に `e2fsck` を実行し、クリーンにしてから再開
- 再発防止：実験の終了条件に `sync` と正常停止を入れ、破損時は必ず fsck を挟む

#### F-07 `/etc/shadow` 未確定でログインできない

- 症状：`login:` は出るが root/tama が通らない
- 原因：`<ROOT_HASH>` 等のプレースホルダのまま（実装ノート 2.2.5）
- 対処：ホストで SHA-512 ハッシュを生成し、shadow に確定値を入れる（権限600必須）
- 再発防止：shadow の作成・権限・検証（ログイン成功）を“ネット導入前”に必ず通す
- ver0.1では、手動で設定し、問題はなかった事象は事実。

#### F-05 Proxmox `vmbr0` 不調/ハング疑い（ネットワーク障害）

- 症状：LAN疎通や管理アクセスが不安定/停止したように見える
- 背景：ネストブリッジ（Proxmox vmbr0 の上に Ubuntu br0、その上に QEMU）を常用すると、
	L2ループ/ストーム等で影響がホスト側に波及し得る（実装ノート 2.2.4、詳細設計 3.3.1）
- 対処：復旧手順は詳細設計 3.3.1 に集約（この文書では重複させない）
- 再発防止：
	- 受入の主経路は「ネット無し」で固める
	- ネットが必要ならまず NAT で代替し、影響範囲をUbuntu VM内に閉じる
	- ブリッジは必要時のみ（研究の本質から切り離す）

#### F-06 telnet 接続が即切断

- 症状：hostfwdでLISTENしていても、telnetが即切断
- 典型的な混線：
	- ネットワーク（到達性）
	- telnetd（デーモン）
	- login（/bin/login が実行できるか）
	- 認証（/etc/shadow）
	これらが同時に未確定だと、切断理由が特定できない
- 推奨切り分け順：
	1) **シリアルで root/tama ログイン成功**（これが先）
	2) ext4側で `telnetd` を起動し、同一ゲスト内で動作を確認（可能なら）
	3) hostfwd/NATをつなぐ
- 再発防止：telnetは“最後”の機能として扱い、ベース版の受入には入れない（または別受入に分離）

#### F-08 作ったはずの設定ファイルが無い/権限が違う

- 症状：`/etc/shadow` や `/etc/init.d/rcS` が存在しない、権限が期待と違う
- 原因：コマンド列の途中中断（^C）、sudo/権限、確認漏れ（実装ノート 2.2.4 7.3〜7.5）
- 対処：必ず次の順で確認する
	1) 存在（`ls`）
	2) 権限（`stat` の Access）
	3) 中身（`cat`/`head`）
- 再発防止：複数ファイルを“一気に作る”より、1ファイルずつ確定→確認する

#### F-09 QEMUを起動したのに観測できない

- 症状：起動しているはずなのに、シリアル/画面が見えない
- 原因：起動オプションの組み合わせで、出力先が期待と変わる（`-nographic`/`-daemonize`/display設定等）
- 対処：観測経路（ttyS0の出し先）を固定する
- 再発防止：QEMU起動オプションは“ベース形”を1つ決め、変更するのは1点だけにする

#### F-10 認証情報が“確定しないように見える”（shadowの揺れ）

- 症状：shadowを直したつもりでもログインが通らない／値の検証が難しい
- 原因候補：
	- shadowがプレースホルダのまま
	- 権限600でなくBusyBox loginが読めない/挙動が変わる
	- そもそも ext4 に書けていない（fsck対象、マウント状態の混乱）
- 対処：
	- shadowは「作成→権限→ログイン成功」で成功条件を固定する
	- 失敗時は、まず ext4 の健全性（fsck）とファイル存在/権限から戻る
- 再発防止：認証は“単独の受入”として固め、ネット/telnetと混ぜない

---

### 5.3 原因の構造化（なぜ混ざったか）

この失敗は「単発バグ」ではなく、複数の要因が絡んで“混線”した。
後続PJで同じ混線を避けるため、原因を層で分けておく。

#### 5.3.1 技術要因（現象を直接引き起こしたもの）

- BusyBox applet symlink のホスト絶対パス化
- ext4 破損（checksum）と fsck 不在
- `/etc/shadow` 未確定（プレースホルダ）
- QEMU起動オプションの揺れ（観測不能）

#### 5.3.2 設計/切り分け要因（混ざりを増幅したもの）

- 受入の主経路（ネット無し）を固める前に、ネット/telnetへ進んだ
- “成功定義”が単一の巨大テスト（ブート+永続+ログイン+ネット+telnet）に寄っていた
- switch_root と login を同じフェーズで扱った

#### 5.3.3 運用要因（研究としての失敗を生むもの）

- 途中中断（^C）や長いコマンド列で「どこまで実行したか」を失いやすい
- 変更量が理解量を超えると、成功しても“納得”が残らない

#### 5.3.4 5 Whys（例：telnet即切断）

1. なぜ切断される？ → loginに到達していない/認証できない可能性
2. なぜloginできない？ → `/etc/shadow` が未確定/権限不正/ファイル未作成
3. なぜshadowが未確定？ → 置換・検証手順が固定されていない
4. なぜ手順が固定されていない？ → ベース版（シリアルログイン成功）前にtelnetへ進んだ
5. なぜ先に進んだ？ → 成功定義が大きく、1回の実験で多くを達成しようとした

---

## 6. 再発防止を「仕様」に落とす（次のプロジェクトの運用規約）

### 6.1 ルール：1回の実験は1変数

悪い例：
- 「initを変えつつ、rcSを変えつつ、ネットも入れて、telnetも入れる」

良い例（順序固定）：
1. ネット無しでブート経路（UEFI→switch_root）
2. ネット無しでログイン（root/tama）
3. 永続ログ（/logs/boot.log）
4. （必要なら）NAT での telnet
5. （必要時のみ）ブリッジ

### 6.2 固定すべき観測点（最低限）

各境界で、必ず同じ文字列が出るようにする（ログの“杭”）。

- initramfs
	- `[init] cmdline parsed: root=UUID=...`
	- `[init] devtmpfs mounted`
	- `[init] root device found: /dev/...`
	- `[init] mounted /newroot`
	- `[init] switching root`
- ext4 側 rcS
	- `[rcS] start`
	- `[rcS] mounted proc/sys/devpts`
	- `[rcS] started getty`

“止まった”ではなく“どこで止まったか”に変える。

### 6.3 ベース版運用の最小要件（“戻れる”とは何か）

ベース版と呼ぶには、以下が揃っている必要がある：

- 受入テストが文章で固定されている
- 受入テストを実行すると毎回同じ結果になる
- 失敗した場合に戻る方法（スナップショット/復旧手順）が文章で固定されている

スクリプト化は必須ではない（理解を優先するなら手順の文章化が先）。

---

## 7. 後続プロジェクトのための“やらない宣言”（スコープ管理）

ver0.1.1 を安定ベースにするには、次の順序で切り離すと理解が進む：

- ネットワーク/telnet は「最後に導入する機能」に落とす
	- 理由：telnet は障害の掛け算（ネット×デーモン×login×shadow）になり、基礎の切り分けを破壊しやすい。

- 認証（shadow）と起動（switch_root）を別フェーズにする
	- 理由：起動が失敗しているのか、認証が失敗しているのかを混ぜない。

---

## 付録A：参照マップ（どの文書に何があるか）

- `docs/UmuOSver011詳細設計.md`
	- 失敗からの教訓を仕様として織り込んだ手順（root=UUID、観測性、NAT/ブリッジ方針、vmbr0障害時手順）
- `docs/実装ノート.md`
	- 実装中に実際に起きた“ハマり”と対処（BusyBox symlink、shadow、権限確認、vmbr0障害の学び）
- `UmuOSver011基本計画.md`
	- ver0.1.1 の狙いと成功条件の定義

## 付録B：最低限のコマンド索引（抜粋）

### B.1 ext4 健全性チェック（VM停止後）

```bash
sudo e2fsck -f disk/disk.img
```

### B.2 disk.img の UUID 取得（GRUB cmdline 用）

```bash
sudo blkid -p -o value -s UUID disk/disk.img
```

### B.3 BusyBox applet の安全な生成（ext4 側）

```bash
sudo mount -o loop disk/disk.img /mnt/umuos
sudo chroot /mnt/umuos /bin/busybox --install -s /bin
ls -l /mnt/umuos/bin/sh
sudo umount /mnt/umuos
```

