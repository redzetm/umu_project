# 実装ノート

- ここでは、UmuOS ver0.1.1 の実装過程で発生した注意点・判断理由・ハマりポイントを記載する
- 詳細設計書には書かれていない「実装時の思考」「なぜその実装を選んだのか」を残すことを目的とする
- 将来 ver0.2 以降で実装を置き換える際の判断材料としても利用する
- コードそのものの説明ではなく、「設計と実装のズレ」「実装して初めて分かったこと」を重視する
- 不明点や調査は、WEBやCopilot、Github Copilotと相談して進める方式
- **<重要> ただ起動して成功ではない。メカニズムを理解することを最重要とする**


## 開発環境と実行環境

- 開発環境  
  - MiniPC MEM32GB  
  - CPU: 12th Gen Intel(R) Core(TM) i9-12900HK (2.50 GHz)
  - OS: Windows 11 Pro 25H2  
  - エディタ: Visual Studio Code 1.107.1

- 開発形態  
  - Windows 環境から、自宅サーバー上の Ubuntu 24.04 LTS に SSH 接続して開発
  - ビルド・ISO 作成・ディスク操作は Ubuntu 側で実施する

- 実行環境  
  - 自宅サーバー: Xeon / MEM32GB  
  - 仮想化基盤: QEMU-KVM  
  - GUI 管理ツール: 仮想マシンマネージャ（virt-manager）

- UmuOS ver0.1 / ver0.1.1 は、いずれも仮想マシンマネージャから起動することを前提とした設計とする
  - ローカル QEMU 起動は補助的なテスト用途と位置付ける

---

## 1. 環境準備について

### 1.1 必要パッケージの選定理由

UmuOS ver0.1.1 では、以下の方針で必要パッケージを選定した。

- 設計書に記載した工程を **最後まで実行できる最小構成** とする
- 「将来使うかもしれない」ツールは、意図的に含めない
- Ubuntu 24.04 LTS の **標準環境に含まれているものは前提とする**

そのため、以下のような判断を行っている。

- `build-essential` や `libelf-dev` などは、カーネルビルドに必須なため明示的に指定
- `grub-efi-amd64-bin` / `xorriso` は、UEFI ISO 作成に必要なため含めた
- `busybox-static` は、initramfs と ext4 側の両方で利用するため必須と判断
- `e2fsprogs` は、ext4 イメージ作成および UUID 確認のために必要

一方で、以下のようなツールは **意図的に含めていない**。

- `parted` / `fdisk`  
  → ver0.1.1 では「ディスク全体を ext4 として使う」設計のため不要
- `dosfstools`  
  → ESP や FAT32 を直接操作しないため不要
- `strace` / `gdb`  
  → デバッグ用途として有用だが、必須ではないため現時点では含めていない

この段階では「足りないものを先に入れる」よりも、  
**「なぜ入れていないかを説明できる状態」を重視した。**


### 1.2 ディレクトリ構成の考え方

作業ディレクトリは、以下の考え方で分離している。

- `kernel/`  
  → Linux カーネルのビルド専用
- `initramfs/`  
  → 起動初期（switch_root 前）専用の領域
- `iso_root/`  
  → ISO に含めるファイルのみを配置する領域
- `disk/`  
  → 永続データを持つ ext4 イメージ専用
- `logs/`  
  → 実装上は不要だが、開発ディレクトリ構成としての慣例的な置き場（UmuOS 内の /logs とは別）

特に重要なのは、  
**「ISO に含めるもの」と「永続化されるもの」を物理的に分けている点**である。

この分離により、

- ISO を作り直しても永続データは影響を受けない
- 起動用資産と運用データの責務が明確になる
- ver0.2 以降で構成を変えても、影響範囲を限定できる

という効果を狙っている。

この段階ではまだ OS は起動しないが、  
後工程で迷わないための「地ならし」として重要な工程である。

### 補足説明：ISO と disk.img を分離する設計意図

本構成では、ISO イメージと ext4 の disk.img を明確に分離している。

- ISO は「起動するための資産（ブートローダ・カーネル・initramfs）」のみを含む
- disk.img は「OS の実体（/ 以下すべて）」を保持する永続ストレージとする

この分離により、ISO は再生成可能な成果物、disk.img は運用・検証の対象という
役割分担が明確になる。


### 前提条件（この設計が成立する条件）

この分離設計は、以下の前提条件のもとで成立している。

- `/` は ext4 の disk.img にマウントされる
- ISO 内には rootfs を持たず、initramfs は `/` へ移行するためだけに存在する
- 永続化が必要なデータ（/etc, /home, /logs 等）はすべて disk.img 側に配置する
- ISO は CD-ROM として接続し、書き換えを前提としない

これにより、ISO を差し替えても disk.img の内容には影響が出ない構成となる。


##### UUID を用いたマウント指定について

UUIDは、ファイルシステム作成時に割り当てられる一意な識別子であり、デバイス名とは独立して保持される。

仮想化環境（QEMU / virt-manager）では、ディスクの接続順やバス構成の違いにより、
同一の disk.img であっても `/dev/vda` や `/dev/sda` などのデバイス名が変化する可能性がある。
そのため、デバイス名を前提としたマウント指定は再現性が低く、起動失敗の原因となりやすい。

UUID を用いて `/` を指定することで、

- 起動環境（QEMU / virt-manager）の差異に依存しない
- ディスク接続順の変更に影響されない
- 同一 disk.img を継続して利用できる

という特性を得られる。

UmuOS ver0.1.1 では、再現性と安定性を最優先とするため、
root デバイスの特定は初期段階から UUID 指定を前提とした設計としている。


### 注意事項・制約

この設計により disk.img のみをバックアップ対象とできるが、
以下の点には注意が必要である。

- `/sbin/init` や `/etc` を破壊すると起動不能になる
- ext4 の互換性を壊すような操作（不整合な fsck 等）は避ける
- kernel や initramfs を変更した場合でも、`/` の構造が前提どおりである必要がある

また、ISO 側の変更（kernel 更新・initramfs 修正）は、
disk.img の内容を前提として行う必要がある。

ver0.1.1 では、この「起動資産と OS 実体の境界」を確定させることを最優先とし、
ver0.2 以降での構成変更や BusyBox 置換に備える仕様となる。

---

## 2. 永続ディスク（disk.img / ext4）の作業ログ

### 実施したコマンド

UmuOS ver0.1.1 では、永続ストレージとして「raw 形式のファイル（disk.img）を ext4 としてフォーマット」し、
VM には追加ディスクとして接続する。

作業（20GB の例）:

```bash
cd ~/umu/UmuOSver011/disk
truncate -s 20G disk.img
mkfs.ext4 -F disk.img
```

**mkfs.ext4 -F disk.imgを行うと以下の様な出力となる。**

tama@umu:~/umu/UmuOSver011/disk$ mkfs.ext4 -F disk.img
mke2fs 1.47.0 (5-Feb-2023)
Discarding device blocks: done
Creating filesystem with 5242880 4k blocks and 1310720 inodes
Filesystem UUID: de27448b-bcd4-4e7d-b99e-95b364b48dd0           →　→　UUIDが発行されるから注意です！
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,
        4096000

Allocating group tables: done
Writing inode tables: done
Creating journal (32768 blocks): done
Writing superblocks and filesystem accounting information: done


### UUID について（確認コマンドは必須か？）

`mkfs.ext4` の実行結果に `Filesystem UUID:` が表示されるため、
その値を控えておけばこの時点で追加の確認コマンドは必須ではない。

今回の実行では、以下の UUID が発行されている。

```text
de27448b-bcd4-4e7d-b99e-95b364b48dd0
```

後日 UUID を再確認したい場合（ログを残していない・作り直した等）のために、
取得手段として `blkid` / `dumpe2fs` を手順に残しておくのは有効。

```bash
sudo blkid -p -o value -s UUID disk.img
```

（`blkid` が読めない場合）

```bash
sudo dumpe2fs -h disk.img | grep -E '^Filesystem UUID:'
```

### 重要: UUID を反映する場所

この UUID は「起動時に initramfs 側が root（永続ディスク）を特定するためのキー」になる。
最低限、以下の反映が必要。

- GRUB の `linux` 行に `root=UUID=...` として渡す
- 自作 init は `/proc/cmdline` から `root=UUID=...` を読んで `/newroot` に ext4 を mount する

補足:
- `mkfs.ext4` をやり直すと UUID は変わるため、作り直したら必ず再取得して反映し直す

---

## 3. カーネルビルド（6.18.1）の作業ログ

### 実施したコマンド（設計書 3.1〜3.4）

UmuOS ver0.1.1 では Linux 6.18.1 を採用し、まずは **defconfig のまま**ビルドして起動検証を優先する。
（カーネル設定の最適化は ver0.2 以降の課題に回す）

```bash
cd ~/umu/UmuOSver011/kernel
wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.18.1.tar.xz
tar -xf linux-6.18.1.tar.xz
cd linux-6.18.1

make mrproper
make defconfig
cp .config ../config-6.18.1

make -j$(nproc)

cp arch/x86/boot/bzImage ~/umu/UmuOSver011/iso_root/boot/vmlinuz-6.18.1
cp .config ~/umu/UmuOSver011/iso_root/boot/config-6.18.1
```

### ポイント（なぜこうしているか）

- **`make mrproper`**
  - ビルドディレクトリを“確実にまっさらに”して再現性を上げる。
  - 過去の `.config` や生成物の混入による「なぜか起動しない」を避ける。

- **`defconfig` を採用**
  - 目的は「まず起動して switch_root まで到達する」ことであり、カーネルの最適化は後回し。
  - ver0.1.1 は安定化版なので、カスタム設定で可変要素を増やさない。

- **成果物は `bzImage`（= 起動用カーネル）**
  - x86_64 では `arch/x86/boot/bzImage` が GRUB から起動する “実体” になる。
  - ファイル名は運用上わかりやすいように `vmlinuz-6.18.1` にリネームして `iso_root/boot/` に配置する。

- **`config-6.18.1` を残す**
  - 「そのISOがどの設定で作られたか」を後追いできる。
  - 問題切り分け（起動失敗/ドライバ不足）で重要。

### 実装上の注意

- `make -j$(nproc)` はCPU/メモリを強く使う。ホストが重い場合は `-j2` などに落としてよい。
- 途中で失敗した場合でも、原因（不足パッケージ/容量/ツールチェーン）を潰してから再実行すればよい。
- カーネルを作り直したら、`iso_root/boot/vmlinuz-6.18.1` も更新されるため、ISO再生成の前提が揃う。

---

## 4. initramfs（移行用）の作業ログ

### 4.1 構造作成（rootfs + BusyBox）

0.1.1 の initramfs は「最小の初期化 → ext4 の /newroot へ移行（switch_root）」が目的。
そのため initramfs 内に置くツールは、基本的に BusyBox を中心に最小化する。

実施したコマンド（設計書 4.1）:

```bash
cd ~/umu/UmuOSver011/initramfs
mkdir -p rootfs/{bin,sbin,etc,proc,sys,dev,dev/pts,run,newroot}

# initramfs内では BusyBox が「静的」である必要がある。
# Ubuntuで busybox-static を入れている前提なら /bin/busybox を使う。
cp /bin/busybox rootfs/bin/
sudo chown root:root rootfs/bin/busybox

# BusyBoxコマンドのsymlink（相対リンクに統一）
cd ~/umu/UmuOSver011/initramfs/rootfs/bin
busybox --install -s .
for cmd in $(ls -1 | grep -v "^busybox$"); do
  rm "$cmd"
  ln -s busybox "$cmd"
done
```

### ポイント（なぜこうしているか）

- **ディレクトリを最初に固定化**
  - `/proc` `/sys` `/dev` `/dev/pts` `/run` を initramfs 側で用意しておくと、
    自作 init の処理が単純になり、起動トラブルの切り分けもしやすい。

- **BusyBox は initramfs では静的リンクが前提**
  - initramfs には通常 libc や動的リンカが無いため、動的BusyBoxだと実行できない。
  - Ubuntu では `busybox-static` を入れていれば `/bin/busybox` が静的版になっている想定。

- **所有者を root:root にする理由**
  - initramfs の中身は基本的に root 権限で動く前提。
  - パーミッション/所有者が不自然だと、起動時に想定外の拒否や挙動差の原因になり得る。

- **symlink を相対リンクに統一する理由**
  - initramfs は最終的に cpio に固められて別環境で展開されるため、
    絶対パスのリンクや作成時の作業ディレクトリ依存を避けて再現性を上げる。
  - `busybox --install -s .` は便利だが、環境によってリンク先が意図とズレることがあるので、
    ここでは「すべて `busybox` へ向ける」形に明示的に統一している。

### 補足（この段階でのゴール）

- この工程の完了条件は「initramfs に最低限のコマンドが揃い、次工程の /init（自作init）を配置できる」こと。
- まだ `initrd.img`（cpio化）や `switch_root` 実行までは行わない。

### 4.2 /init（自作init：C言語）

ここまでで「initramfs の土台（BusyBox + ディレクトリ）」が揃ったので、次は rootfs 直下に `/init` を配置する。
initramfs のエントリポイントは `/init` であり、ここが起動できないとカーネルはすぐ panic する。

実施したコマンド（設計書 4.2 のビルド例）:

```bash
cd ~/umu/UmuOSver011/initramfs
# src/init.c を作成したら

gcc -static -Os -s -o rootfs/init src/init.c
chmod 755 rootfs/init
sudo chown root:root rootfs/init
```

ポイント:

- `-static` は必須寄り（initramfs は共有ライブラリが無い/少ない前提のため）
- `-Os` はサイズを抑える意図（initramfs を肥大化させない）
- `rootfs/init` は **rootfs 直下**に置く（`rootfs/bin/init` ではない）

確認（任意だが推奨）:

```bash
file rootfs/init
ldd rootfs/init
# 期待: "statically linked" / "not a dynamic executable"
```

### 4.3 initramfs（cpio）作成

`rootfs/` の内容を `newc` 形式で固めて gzip し、起動用の initrd として ISO 側へ配置する。

実施したコマンド（設計書 4.3）:

```bash
cd ~/umu/UmuOSver011/initramfs/rootfs
find . -print0 | sudo cpio --null -o -H newc | gzip > ../initrd.img-6.18.1
cd ..
cp initrd.img-6.18.1 ~/umu/UmuOSver011/iso_root/boot/
```

確認（任意だが推奨）:

```bash
ls -lh ~/umu/UmuOSver011/initramfs/initrd.img-6.18.1       ~/umu/UmuOSver011/iso_root/boot/initrd.img-6.18.1

gzip -t ~/umu/UmuOSver011/initramfs/initrd.img-6.18.1

# /init が入っていることの確認
zcat ~/umu/UmuOSver011/initramfs/initrd.img-6.18.1 | cpio -t | grep -E '^\./init$'
```

ここまでの完了条件:

- `~/umu/UmuOSver011/initramfs/rootfs/init` が存在し、実行可能（755）である
- `~/umu/UmuOSver011/iso_root/boot/initrd.img-6.18.1` が作成されている
- initrd の中に `./init` が含まれている

---

## 5. ext4ルート（disk.img）へ rootfs を作成（作業ログ）

ここは「永続化される OS の実体」を作る工程。
initramfs は最終的に `switch_root` で disk.img 側の `/` に移行するので、disk.img の中身が “本番の /” になる。

### 5.1 disk.img 作成（未作成なら）

作業（20GB の例）:

```bash
cd ~/umu/UmuOSver011/disk
truncate -s 20G disk.img
mkfs.ext4 -F disk.img
```

ポイント:

- `mkfs.ext4` をやり直すと UUID が変わるので、やり直した場合は GRUB の `root=UUID=...` も必ず更新する。

### 5.2 disk.img をホストでマウントして rootfs を作る

実施したコマンド（設計書 5.2）:

```bash
sudo mkdir -p /mnt/umuos011
sudo mount -o loop ~/umu/UmuOSver011/disk/disk.img /mnt/umuos011
```

最低限のディレクトリ作成:

```bash
sudo mkdir -p /mnt/umuos011/{bin,sbin,etc,proc,sys,dev,dev/pts,run,root,home/tama,logs,etc/init.d,etc/umu}
```

#### ここで混乱しやすいポイント（初心者向け）

- `/mnt/umuos011` は **ホスト上の絶対パス**。
  - つまり、この作業は「どのディレクトリで実行してもOK」。`cd` の場所には依存しない。
  - `disk.img` の中身（ext4の中身）が **ホストの `/mnt/umuos011` に見える**状態になる。

- 「QEMU-KVM（virt-manager）で起動できるか？」は、`/mnt/umuos011` を作ったかどうかではなく、
  **QEMU が参照するホスト上に `disk.img` が存在するか**で決まる。
  - もし virt-manager が自宅サーバーへリモート接続しているなら、`disk.img` は自宅サーバー側に置く必要がある。
  - ローカルPC側で `/mnt/umuos011` にマウントして編集しても、サーバー側のQEMUはそのファイルを参照できない（同じホストでないため）。

#### BusyBox 配置（ext4側の /bin）

ext4 側は「起動後の /」なので、`/sbin/init` を含めて最低限のコマンドが必要。
0.1.1 は安定化優先のため BusyBox を使う。

```bash
sudo cp /bin/busybox /mnt/umuos011/bin/
sudo chown root:root /mnt/umuos011/bin/busybox

sudo ln -sf /bin/busybox /mnt/umuos011/sbin/init

cd /mnt/umuos011/bin
sudo ./busybox --install -s .
```

確認（任意だが推奨）:

```bash
mount | grep -F /mnt/umuos011
findmnt /mnt/umuos011
ls -l /mnt/umuos011/sbin/init
```

この段階での完了条件:

- `disk.img` が `/mnt/umuos011` にマウントされている
- `/mnt/umuos011/bin/busybox` が存在し、`root:root` になっている
- `/mnt/umuos011/sbin/init` が `/bin/busybox` を指すリンクになっている

次工程（この後にやること）:

- `/mnt/umuos011/etc/passwd` `/mnt/umuos011/etc/shadow` の作成
- `/mnt/umuos011/etc/inittab` と `/mnt/umuos011/etc/init.d/rcS` の作成（起動処理・ログ・ネット設定）

### 5.3 ユーザー/認証ファイル（ext4側）

目的:

- switch_root 後は ext4 側の BusyBox（`/bin/busybox`）が `/sbin/init` として動く。
- `getty` → `login` の認証では、基本的に ext4 側の `/etc/passwd` と `/etc/shadow` を参照する。
  - ここが無い/壊れているとログインできず、起動後の操作が詰む。

#### 1) /etc/passwd を作る（644）

`/etc/passwd` は「ユーザー一覧」と「ホーム/シェル」を書くファイル。
今回は最小構成として `root` と `tama` を作る。

作成例:

```bash
sudo tee /mnt/umuos011/etc/passwd >/dev/null <<'EOF'
root:x:0:0:root:/root:/bin/sh
tama:x:1000:1000:tama:/home/tama:/bin/sh
EOF
```

補足:

- `root:x:...` の `x` は「パスワードは /etc/shadow に置く」意味（passwd に平文パスワードは書かない）。
- 最後の `/bin/sh` は「ログイン後に起動するシェル」。
  - 0.1.1 では BusyBox の applet として `/bin/sh` が用意されている前提（5.2の `busybox --install -s .`）。

#### 2) /etc/shadow を作る（600）

`/etc/shadow` はパスワードハッシュを置くファイル。
権限を間違えると（誰でも読める等）セキュリティ的に危険なので、必ず 600 にする。

ハッシュ作成（例: SHA-512）:

```bash
openssl passwd -6
```

出力された文字列（例: `$6$...` で始まる）を控えて、`<ROOT_HASH_HERE>` と `<TAMA_HASH_HERE>` に埋める。

作成例:

```bash
sudo tee /mnt/umuos011/etc/shadow >/dev/null <<'EOF'
root:<ROOT_HASH_HERE>:19000:0:99999:7:::
tama:<TAMA_HASH_HERE>:19000:0:99999:7:::
EOF
```

補足:

- `19000` は「最終パスワード更新日（1970-01-01 からの日数）」を意味する。
  - 厳密に合わせなくても当面の検証は進むが、運用に入れるなら適切な値にする/管理方針を決める。
  - よく分からなければ、まずは設計書の例どおりでOK（起動検証優先）。

#### 3) 所有者と権限を整える

```bash
sudo chown root:root /mnt/umuos011/etc/passwd /mnt/umuos011/etc/shadow
sudo chmod 644 /mnt/umuos011/etc/passwd
sudo chmod 600 /mnt/umuos011/etc/shadow
```

確認（任意だが推奨）:

```bash
ls -l /mnt/umuos011/etc/passwd /mnt/umuos011/etc/shadow
grep -n '^root:' /mnt/umuos011/etc/passwd
grep -n '^tama:' /mnt/umuos011/etc/passwd
```

この段階での完了条件:

- `/mnt/umuos011/etc/passwd` が存在し、`-rw-r--r--`（644）になっている
- `/mnt/umuos011/etc/shadow` が存在し、`-rw-------`（600）になっている
- `root` と `tama` の行が正しく入っている

