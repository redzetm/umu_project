# 実装ノート

- ここでは、UmuOS ver0.1.1 の実装過程で発生した注意点・判断理由・ハマりポイントを記載する
- 詳細設計書には書かれていない「実装時の思考」「なぜその実装を選んだのか」を残すことを目的とする
- 将来 ver0.2 以降で実装を置き換える際の判断材料としても利用する
- コードそのものの説明ではなく、「設計と実装のズレ」「実装して初めて分かったこと」を重視する
- 不明点や調査は、Web や GitHub Copilot と相談して進める方式
- **<重要> ただ起動して成功ではない。メカニズムを理解することを最重要とする**


## 開発環境と実行環境

- 開発環境  
  - MiniPC MEM32GB  
  - CPU: 12th Gen Intel(R) Core(TM) i9-12900HK (2.50 GHz)
  - OS: Windows 11 Pro 25H2  
  - エディタ: Visual Studio Code 1.107.1

- 開発形態  
  - Windows 環境から、自宅サーバー（ProxmoxVE9.1.1）上の Ubuntu 24.04 LTS に SSH 接続して開発
  - ビルド・ISO 作成・ディスク操作は Ubuntu 側で実施する

- 実行環境  
  - 自宅サーバー: Xeon / MEM32GB  OS　ProxmoxVE9.1.1
  - 仮想化基盤: QEMU-KVM  
  - GUI 管理ツール: ProxmoxVE9.1.1（WEBによるGUI）、基本CLIを利用

- UmuOS ver0.1 では、CentOS Stream9 の仮想マシンマネージャから起動することを前提とした設計とした
  - ver0.1.1 からは、開発環境（Ubuntu 24.04 LTS）上の QEMU で、シリアル（ttyS0）での起動を前提とする

### 受入範囲（ver0.1.1）

- 受入は「開発環境の QEMU」で再現できることに限定する（virt-manager 等での起動可否は受入に含めない）
- QEMU は `accel=tcg` 前提とし、KVM（ネスト KVM や `/dev/kvm` の有無）は考慮対象外とする
- 実行基盤として ProxmoxVE 上で作業することはあるが、受入確認は上記条件（QEMU + シリアル）で行う

---

## 環境準備メモ（実施ログ）

### 必要パッケージ

詳細設計の「必要パッケージ」コマンドを実行し、必要な追加パッケージも含めて導入された。

実行コマンド：

`sudo apt update`

`sudo apt install -y build-essential bc bison flex libssl-dev libelf-dev libncurses-dev dwarves git wget grub-efi-amd64-bin grub-common xorriso mtools qemu-system-x86 ovmf cpio gzip xz-utils busybox-static e2fsprogs musl-tools`

メモ：

- `sudo` が必要（パスワード入力が求められる）
- 既に導入済みの環境では「すでに最新」と表示されるのは正常
- `apt` が「自動でインストールされたが不要なパッケージ」を提案することがあるが、ここでは受入条件に直接関係しないため、削除判断は別途行う

### ディレクトリ作成

詳細設計の「ディレクトリ作成」コマンドを実行し、作業用フォルダを揃えた。

実行コマンド：

`mkdir -p ~/umu/umu_project/UmuOSver011/{kernel,initramfs,iso_root/boot/grub,logs,disk,run}`

メモ：

- これはシェルのブレース展開（`{...}`）に依存するため、シェルを介さないツール等では文字列がそのまま扱われることがある

### ブリッジ（br0）準備（静的IP/telnet検証用）

詳細設計 3.3 は、開発マシン側（Ubuntu）のネットワーク構成を変更する作業であり、SSH で作業していると切断されるリスクがある。

方針（手順の順序）：

- まずはネット無し（詳細設計 10.2）で「UEFI→GRUB→kernel→initramfs→ext4→switch_root」まで成立させる
- 静的IP/telnet の検証に進む段階（詳細設計 10.3 の直前）で br0 を作る

理由：

- br0 の不備はブート経路の失敗と混ざるため、先にブート経路を固めた方が切り分けが速い
- netplan 適用は SSH 切断し得るため、Proxmox コンソール等の復旧経路を確保してから実施する

補足：Proxmox 側の `vmbr0` が不調（ハング疑い）になった場合の復旧“手順”は、手順の二重管理を避けるため **詳細設計 3.3.1** に集約した。ここ（実装ノート）には「実際に起きた状況・判断・学び」を残す（後述 2.2.4）。

### kernel（6.18.1）取得・ビルド

詳細設計 5 の手順で kernel 6.18.1 を取得し、defconfig でビルドした。

実行コマンド（概要）：

`cd ~/umu/umu_project/UmuOSver011/kernel`

`wget -nc https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.18.1.tar.xz`

`tar -xf linux-6.18.1.tar.xz`

`cd linux-6.18.1`

`make mrproper`

`make defconfig`

`make -j"$(nproc)"`

ビルド後の配置：

- `arch/x86/boot/bzImage` → `~/umu/umu_project/UmuOSver011/iso_root/boot/vmlinuz-6.18.1`
- `.config` → `~/umu/umu_project/UmuOSver011/iso_root/boot/config-6.18.1`

メモ：

- defconfig 時点で、initramfs から ext4 を mount するのに必要な `CONFIG_EXT4_FS=y` / `CONFIG_VIRTIO_BLK=y` / `CONFIG_DEVTMPFS=y` / `CONFIG_BLK_DEV_INITRD=y` / `CONFIG_RD_GZIP=y` は `=y` になっていた
- `file vmlinuz-6.18.1` で bzImage として認識されることを確認した

### initramfs（rootfs骨格 + BusyBox 配置）

詳細設計 6.1 の手順で、initramfs の rootfs 骨格を作り、BusyBox（static）を配置した。

実行コマンド（概要）：

`cd ~/umu/umu_project/UmuOSver011/initramfs`

`mkdir -p rootfs/{bin,sbin,etc,proc,sys,dev,dev/pts,run,newroot}`

`cp /bin/busybox rootfs/bin/`

`sudo chown root:root rootfs/bin/busybox`

`sudo chmod 755 rootfs/bin/busybox`

applet 生成：

`cd ~/umu/umu_project/UmuOSver011/initramfs/rootfs/bin`

`./busybox --install -s .`

メモ：

- `/bin/busybox` は statically linked であることを `file /bin/busybox` で確認した（initramfs 内で動的リンクだと起動に失敗しやすいため）

---

## 1. UmuOSver011詳細設計を実装した場合の成果物一覧
### プロジェクト内（~/umu/umu_project/UmuOSver011 配下）

- ドキュメント
  - `UmuOSver011基本計画.md`
  - `docs/UmuOSver011詳細設計.md`
  - `docs/実装ノート.md`

- kernel（ソースと成果物）
  - `kernel/linux-6.18.1/`（取得したカーネルソース）
  - `iso_root/boot/vmlinuz-6.18.1`
  - `iso_root/boot/config-6.18.1`

- initramfs（移行専用）
  - `initramfs/src/init.c`（自作 init）
  - `initramfs/rootfs/`（cpio生成元）
  - `initramfs/initrd.img-6.18.1`（生成物）
  - `iso_root/boot/initrd.img-6.18.1`（ISOに格納するコピー）

- GRUB/ISO（ブート資産）
  - `iso_root/boot/grub/grub.cfg`
  - `UmuOSver011-boot.iso`

- 永続ディスク（最終的な /）
  - `disk/disk.img`（パーティション無しの ext4）

- QEMU実行用ファイル
  - `run/OVMF_VARS_umuos011.fd`

### disk.img 内（ext4 ルートの主要ファイル）

- init
  - `/sbin/init`（`/bin/busybox` への symlink を想定）
  - `/etc/inittab`
  - `/etc/init.d/rcS`

- ユーザー/認証
  - `/etc/passwd`
  - `/etc/shadow`
  - `/etc/securetty`（rootログインが拒否される場合のみ）
  - `/home/tama/`（所有者 `1000:1000` を想定）

- ネットワーク（静的）
  - `/etc/umu/network.conf`
  - `/etc/resolv.conf`（rcS が DNS を設定した結果）

- ログ（永続）
  - `/logs/boot.log`

### 開発マシン側（システム設定：必要時のみ）

- ブリッジ設定
  - `/etc/netplan/01-br0.yaml`

- QEMU bridge helper 設定
  - `/etc/qemu/bridge.conf`

---

## 2. 追記テンプレ（実装しながら埋める）

### 2.1 変数（環境差分が出やすいもの）

- 作業ルート：
- Kernel：
- ISO：
- 永続ディスク：
- disk.img UUID：（環境で変わる。詳細設計 4.2 で取得）
- initramfs：
- GRUB設定：

### 2.2 ハマりポイント（失敗→原因→対処）

#### 2.2.1 initrd の中身確認：`head` だけだと `/init` が見えない

- 症状（ログ/現象）：
  - `lsinitramfs ... | head -n 30` の出力に `init` が見えず、「initrd に /init が入っていない？」と不安になる
- 原因（何が起きていたか）：
  - 一覧が長いだけで、先頭30行に `init` が含まれていなかった（`head` の性質）
- 対処（手順・コマンド）：
  - “必要な2点”だけピンポイントで確認する
  - `lsinitramfs ~/umu/umu_project/UmuOSver011/initramfs/initrd.img-6.18.1 | grep -E '^(init|bin/switch_root)$'`
  - `lsinitramfs` が無い場合は `zcat initrd.img-6.18.1 | cpio -t` で代替できる
- 再発防止（設計への反映/注意書き）：
  - 詳細設計 6.3 の「検証」に、任意（推奨）の中身確認コマンド（`lsinitramfs` と代替）を追記した

#### 2.2.2 disk.img の mount：`マウント済みです` は失敗ではない

- 症状（ログ/現象）：
  - `sudo mount -o loop ... disk.img /mnt/umuos011` を実行すると、`... はマウント済みです.` と出て `mount_exit=1` になる
- 原因（何が起きていたか）：
  - すでに `/mnt/umuos011` に loop マウントされていた状態で、再度 mount しようとして失敗した（＝現在のマウント状態が壊れているわけではない）
- 対処（手順・コマンド）：
  - “いまマウントされているか”を明示的に確認してから次に進む
  - `mountpoint -q /mnt/umuos011; echo $?`（0ならマウントポイント）
  - `findmnt /mnt/umuos011`（例：`/dev/loopXX` が ext4 として見えればOK）
  - 迷ったら一度 `sudo umount /mnt/umuos011` してから、改めて設計の 7.1 をやり直す

#### 2.2.3 disk.img 側への BusyBox 配置：コピー確認と `/sbin/init` の確認方法

#### 2.2.3.1 追加：ext4 側の BusyBox applet が壊れる（`rcS` で止まる）

- 症状（ログ/現象）：
  - 起動時に `rcS` 実行の段階で止まったように見える（gettyが出ない/ログが進まない）
  - ext4 内の `/bin/sh` や `/bin/getty` が実在せず（または symlink が解決できず）実行不能

- 原因（何が起きていたか）：
  - `disk.img` をホストで `/mnt/umuos011` にマウントした状態で `./busybox --install -s .` を実行すると、
    symlink が `/mnt/umuos011/bin/busybox` のような「ホスト側の絶対パス」を指すことがある。
  - UmuOS 起動時にはそのパスが存在しないため、`/bin/sh` が壊れて `rcS` が実行できない。

- 対処（手順・コマンド）：
  - 詳細設計 7.2 の手順に合わせ、**chroot して** UmuOS 側のパス基準で applet を生成する。
  - 例：`sudo chroot /mnt/umuos011 /bin/busybox --install -s /bin`（必要に応じて `/sbin` も）

- 再発防止：
  - applet生成後に `ls -l /mnt/umuos011/bin/sh` が `/bin/busybox` を指すことを毎回確認する

#### 2.2.4 Proxmox `vmbr0` ハング疑い（ネットワーク障害）：切り分けと運用の学び

- 症状（ログ/現象）：
  - （要追記）ブリッジ検証（QEMU の `-nic bridge,br=br0`）の途中で、LAN 側疎通や Proxmox 管理系アクセスが不安定/停止したように見えた
  - （要追記）Ubuntu 開発VMのネットワーク変更（netplan 適用）と同時期に発生した可能性

- 仮説（何が起きていそうか）：
  - L2 ループ/ブロードキャストストーム（ネストブリッジ構成で起きやすい）
  - Proxmox firewall / bridge helper / セキュリティ制約が意図せず遮断
  - 物理NIC/ドライバ側の一時不調（dmesg に兆候が出る）

- まず採るべきデータ（再現性と原因追跡のため）：
  - Proxmox ホスト：`ip -s link show vmbr0`（drop/error の増加有無）、`bridge link`、`dmesg -T | tail -n 200`
  - 影響範囲：どのVMが起動中だったか（特に br0 作成済みの Ubuntu 開発VM／テスト中のゲスト）
  - “直前に変更したこと”の列挙（netplan変更、QEMU起動オプション変更など）

- 対処（手順・コマンド）：
  - 復旧の手順は詳細設計 3.3.1 に集約（このノートにはコマンドを重複させない）

- 学び（次回どう進めるか）：
  - 受入の主経路（UEFI→switch_root まで）は「ネット無し」で確実に固め、ネットワーク検証（ブリッジ）は最後に回す
  - ブリッジが不安定なら、QEMU の user-mode NAT + ポートフォワードで代替し、`vmbr0` を触る範囲を最小化する

  - 運用方針（安定稼働を最優先）：
    - **デフォルトは NAT（詳細設計 10.3）** とし、ブリッジ（詳細設計 10.4）は「同一LANから `192.168.0.204` に直で到達する必要がある」場合に限定する
    - UmuOS に入りたい時は「外部PC → UbuntuへSSH → Ubuntu上で `telnet 127.0.0.1 2223`」を基本動線にする（telnet をLANに露出させない）

  - この判断の理由：
    - ネストブリッジ（Proxmox `vmbr0` の上に Ubuntu 内 `br0`、さらに QEMU）を常用すると、L2 ループ/ストーム等で **影響が Proxmox 側まで波及**しやすい
    - NAT + port forward は L2 を外に出さず、失敗しても影響範囲が Ubuntu VM 内に閉じるため、復旧しやすい
    - 受入の本質は「UEFI→switch_root→永続化→ログ→ログイン」であり、LAN直結の静的IPは“必要時の追加検証”として切り離しても受入の再現性が上がる

- 症状（ログ/現象）：
  - `cp` の成否が出力だけだと分かりづらく、直後の `chown/chmod` で「`/mnt/umuos011/bin/busybox` が無い」エラーになることがある
  - `/sbin/init` を作ったつもりでも、確認が曖昧で「本当にできた？」となる
- 原因（何が起きていたか）：
  - `cp` が失敗/未実行だったり、コマンド列が途中で途切れて結果確認が抜けると、その後の操作が連鎖的に失敗する
- 対処（手順・コマンド）：
  - BusyBox の存在をまず確認してから権限設定に進む
  - `ls -l /mnt/umuos011/bin/busybox`
  - `sudo cp -v /bin/busybox /mnt/umuos011/bin/`（コピーし直し）
  - `/sbin/init` は symlink なので、ディレクトリ一覧か `stat` で確認する
  - `ls -la /mnt/umuos011/sbin`
  - `stat /mnt/umuos011/sbin/init`
- 再発防止（設計への反映/注意書き）：
  - 7.2 は「作成→コピー→確認」を小さく区切って進める（失敗しても原因が局所化できる）


#### 2.2.4 7.3〜7.5（shadow/inittab/rcS/network.conf）：未作成のまま進む・権限が揺れて見える

- 症状（ログ/現象）：
  - `/etc/passwd` だけできていて、`/etc/shadow` / `/etc/inittab` / `/etc/init.d/rcS` / `/etc/umu/network.conf` が存在しない
  - `chmod` したはずなのに `ls -l` の結果が期待と違って見える（例：`rcS` が `-rw-r--r--` に見える、`network.conf` が 600 になっていないように見える）
  - コマンド列投入後に確認前の段階でセッションが途切れる、`^C` で途中停止して「どこまで実行されたか」が分からなくなる

- 原因（何が起きていたか）：
  - `/etc` 配下の作業は `sudo` 必須で、エディタ起動（vim等）では権限不足になりやすい
  - 複数ファイルをまとめて作るコマンド列は、途中で止まると「一部だけ作成/権限が古い」状態になりやすい
  - 出力が途中で切れたり混ざると、`chmod` の結果確認が曖昧になる（“実際の権限”ではなく“表示の取り違い”が起きる）

- 対処（手順・コマンド）：
  - まず“存在確認”→中身/権限確認の順で固定する
  - 存在確認：
    - `sudo ls -l /mnt/umuos011/etc/shadow /mnt/umuos011/etc/inittab /mnt/umuos011/etc/init.d/rcS /mnt/umuos011/etc/umu/network.conf`
  - 権限確認は `ls -l` だけに頼らず、`stat` の `Access: (0xxx/...)` を見ると確実：
    - `sudo stat /mnt/umuos011/etc/shadow | head`
    - `sudo stat /mnt/umuos011/etc/umu/network.conf | head`
  - 作成は `sudo tee <<'EOF'` で確実に root で書く（詳細設計 7.3〜7.5 と同じ形に揃える）
  - 期待する権限（設計どおり）：
    - `/etc/passwd`：644
    - `/etc/shadow`：600
    - `/etc/inittab`：644
    - `/etc/init.d/rcS`：755
    - `/etc/umu/network.conf`：600
  - 権限がズレていたら“単体で”叩き直してから `stat` で確認する：
    - `sudo chmod 600 /mnt/umuos011/etc/shadow`
    - `sudo chmod 755 /mnt/umuos011/etc/init.d/rcS`
    - `sudo chmod 600 /mnt/umuos011/etc/umu/network.conf`

- 再発防止（設計への反映/注意書き）：
  - 7.3〜7.5 は「作成 → `ls` で存在確認 → `stat` で権限確認」の3点セットで進める
  - `^C` を入れた場合は、次の作業に進む前に必ず“存在確認”に戻る（途中実行の前提で進まない）

#### 2.2.5 `/etc/shadow` の `<ROOT_HASH>` / `<TAMA_HASH>`：プレースホルダのままだとログインできない

- 症状（ログ/現象）：
  - 起動はするが、`login` で `root`/`tama` のログインが通らない

- 原因（何が起きていたか）：
  - 詳細設計どおり、`/etc/shadow` のハッシュは環境依存で、設計書に直書きしない方針。
  - そのため、プレースホルダ（`<ROOT_HASH>` / `<TAMA_HASH>`）のままだと認証が成立しない。

- 対処（手順・コマンド）：
  - 開発マシン側で SHA-512 ハッシュを生成して置換する：
    - `openssl passwd -6`
  - 置換後、必ず `chmod 600` を確認する：
    - `sudo stat /mnt/umuos011/etc/shadow | head`
