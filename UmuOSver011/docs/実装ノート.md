# 実装ノート

- ここでは、UmuOS ver0.1.1 の実装過程で発生した注意点・判断理由・ハマりポイントを記載する
- 詳細設計書には書かれていない「実装時の思考」「なぜその実装を選んだのか」を残すことを目的とする
- 将来 ver0.2 以降で実装を置き換える際の判断材料としても利用する
- コードそのものの説明ではなく、「設計と実装のズレ」「実装して初めて分かったこと」を重視する
- 不明点や調査は、WEBやCopilot、Github Copilotと相談して進める方式
- **<重要> ただ起動して成功ではない。メカニズムを理解することを最重要とする**


## 開発環境と実行環境

- 開発環境  
  - MiniPC MEM32GB  
  - CPU: 12th Gen Intel(R) Core(TM) i9-12900HK (2.50 GHz)
  - OS: Windows 11 Pro 25H2  
  - エディタ: Visual Studio Code 1.107.1

- 開発形態  
  - Windows 環境から、自宅サーバー上の Ubuntu 24.04 LTS に SSH 接続して開発
  - ビルド・ISO 作成・ディスク操作は Ubuntu 側で実施する

- 実行環境  
  - 自宅サーバー: Xeon / MEM32GB  
  - 仮想化基盤: QEMU-KVM  
  - GUI 管理ツール: 仮想マシンマネージャ（virt-manager）

- UmuOS ver0.1 / ver0.1.1 は、いずれも仮想マシンマネージャから起動することを前提とした設計とする
  - ローカル QEMU 起動は補助的なテスト用途と位置付ける

---

## 1. 環境準備について

### 1.1 必要パッケージの選定理由

UmuOS ver0.1.1 では、以下の方針で必要パッケージを選定した。

- 設計書に記載した工程を **最後まで実行できる最小構成** とする
- 「将来使うかもしれない」ツールは、意図的に含めない
- Ubuntu 24.04 LTS の **標準環境に含まれているものは前提とする**

そのため、以下のような判断を行っている。

- `build-essential` や `libelf-dev` などは、カーネルビルドに必須なため明示的に指定
- `grub-efi-amd64-bin` / `xorriso` は、UEFI ISO 作成に必要なため含めた
- `busybox-static` は、initramfs と ext4 側の両方で利用するため必須と判断
- `e2fsprogs` は、ext4 イメージ作成および UUID 確認のために必要

一方で、以下のようなツールは **意図的に含めていない**。

- `parted` / `fdisk`  
  → ver0.1.1 では「ディスク全体を ext4 として使う」設計のため不要
- `dosfstools`  
  → ESP や FAT32 を直接操作しないため不要
- `strace` / `gdb`  
  → デバッグ用途として有用だが、必須ではないため現時点では含めていない

この段階では「足りないものを先に入れる」よりも、  
**「なぜ入れていないかを説明できる状態」を重視した。**


### 1.2 ディレクトリ構成の考え方

作業ディレクトリは、以下の考え方で分離している。

- `kernel/`  
  → Linux カーネルのビルド専用
- `initramfs/`  
  → 起動初期（switch_root 前）専用の領域
- `iso_root/`  
  → ISO に含めるファイルのみを配置する領域
- `disk/`  
  → 永続データを持つ ext4 イメージ専用
- `logs/`  
  → 実装上は不要だが、開発ディレクトリ構成としての慣例的な置き場（UmuOS 内の /logs とは別）

特に重要なのは、  
**「ISO に含めるもの」と「永続化されるもの」を物理的に分けている点**である。

この分離により、

- ISO を作り直しても永続データは影響を受けない
- 起動用資産と運用データの責務が明確になる
- ver0.2 以降で構成を変えても、影響範囲を限定できる

という効果を狙っている。

この段階ではまだ OS は起動しないが、  
後工程で迷わないための「地ならし」として重要な工程である。

### 補足説明：ISO と disk.img を分離する設計意図

本構成では、ISO イメージと ext4 の disk.img を明確に分離している。

- ISO は「起動するための資産（ブートローダ・カーネル・initramfs）」のみを含む
- disk.img は「OS の実体（/ 以下すべて）」を保持する永続ストレージとする

この分離により、ISO は再生成可能な成果物、disk.img は運用・検証の対象という
役割分担が明確になる。


### 前提条件（この設計が成立する条件）

この分離設計は、以下の前提条件のもとで成立している。

- `/` は ext4 の disk.img にマウントされる
- ISO 内には rootfs を持たず、initramfs は `/` へ移行するためだけに存在する
- 永続化が必要なデータ（/etc, /home, /logs 等）はすべて disk.img 側に配置する
- ISO は CD-ROM として接続し、書き換えを前提としない

これにより、ISO を差し替えても disk.img の内容には影響が出ない構成となる。


##### UUID を用いたマウント指定について

UUIDは、ファイルシステム作成時に割り当てられる一意な識別子であり、デバイス名とは独立して保持される。

仮想化環境（QEMU / virt-manager）では、ディスクの接続順やバス構成の違いにより、
同一の disk.img であっても `/dev/vda` や `/dev/sda` などのデバイス名が変化する可能性がある。
そのため、デバイス名を前提としたマウント指定は再現性が低く、起動失敗の原因となりやすい。

UUID を用いて `/` を指定することで、

- 起動環境（QEMU / virt-manager）の差異に依存しない
- ディスク接続順の変更に影響されない
- 同一 disk.img を継続して利用できる

という特性を得られる。

UmuOS ver0.1.1 では、再現性と安定性を最優先とするため、
root デバイスの特定は初期段階から UUID 指定を前提とした設計としている。


### 注意事項・制約

この設計により disk.img のみをバックアップ対象とできるが、
以下の点には注意が必要である。

- `/sbin/init` や `/etc` を破壊すると起動不能になる
- ext4 の互換性を壊すような操作（不整合な fsck 等）は避ける
- kernel や initramfs を変更した場合でも、`/` の構造が前提どおりである必要がある

また、ISO 側の変更（kernel 更新・initramfs 修正）は、
disk.img の内容を前提として行う必要がある。

ver0.1.1 では、この「起動資産と OS 実体の境界」を確定させることを最優先とし、
ver0.2 以降での構成変更や BusyBox 置換に備える仕様となる。





