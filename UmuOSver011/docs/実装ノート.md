# 実装ノート

- ここでは、UmuOS ver0.1.1 の実装過程で発生した注意点・判断理由・ハマりポイントを記載する
- 詳細設計書には書かれていない「実装時の思考」「なぜその実装を選んだのか」を残すことを目的とする
- 将来 ver0.2 以降で実装を置き換える際の判断材料としても利用する
- コードそのものの説明ではなく、「設計と実装のズレ」「実装して初めて分かったこと」を重視する
- 不明点や調査は、WEBやCopilot、Github Copilotと相談して進める方式
- **<重要> ただ起動して成功ではない。メカニズムを理解することを最重要とする**


## 開発環境と実行環境

- 開発環境  
  - MiniPC MEM32GB  
  - CPU: 12th Gen Intel(R) Core(TM) i9-12900HK (2.50 GHz)
  - OS: Windows 11 Pro 25H2  
  - エディタ: Visual Studio Code 1.107.1

- 開発形態  
  - Windows 環境から、自宅サーバー上の Ubuntu 24.04 LTS に SSH 接続して開発
  - ビルド・ISO 作成・ディスク操作は Ubuntu 側で実施する

- 実行環境  
  - 自宅サーバー: Xeon / MEM32GB  
  - 仮想化基盤: QEMU-KVM  
  - GUI 管理ツール: 仮想マシンマネージャ（virt-manager）

- UmuOS ver0.1 / ver0.1.1 は、いずれも仮想マシンマネージャから起動することを前提とした設計とする
  - ローカル QEMU 起動は補助的なテスト用途と位置付ける

---

## 1. 環境準備について

### 1.1 必要パッケージの選定理由

UmuOS ver0.1.1 では、以下の方針で必要パッケージを選定した。

- 設計書に記載した工程を **最後まで実行できる最小構成** とする
- 「将来使うかもしれない」ツールは、意図的に含めない
- Ubuntu 24.04 LTS の **標準環境に含まれているものは前提とする**

そのため、以下のような判断を行っている。

- `build-essential` や `libelf-dev` などは、カーネルビルドに必須なため明示的に指定
- `grub-efi-amd64-bin` / `xorriso` は、UEFI ISO 作成に必要なため含めた
- `busybox-static` は、initramfs と ext4 側の両方で利用するため必須と判断
- `e2fsprogs` は、ext4 イメージ作成および UUID 確認のために必要

一方で、以下のようなツールは **意図的に含めていない**。

- `parted` / `fdisk`  
  → ver0.1.1 では「ディスク全体を ext4 として使う」設計のため不要
- `dosfstools`  
  → ESP や FAT32 を直接操作しないため不要
- `strace` / `gdb`  
  → デバッグ用途として有用だが、必須ではないため現時点では含めていない

この段階では「足りないものを先に入れる」よりも、  
**「なぜ入れていないかを説明できる状態」を重視した。**


### 1.2 ディレクトリ構成の考え方

作業ディレクトリは、以下の考え方で分離している。

- `kernel/`  
  → Linux カーネルのビルド専用
- `initramfs/`  
  → 起動初期（switch_root 前）専用の領域
- `iso_root/`  
  → ISO に含めるファイルのみを配置する領域
- `disk/`  
  → 永続データを持つ ext4 イメージ専用
- `logs/`  
  → 実装上は不要だが、開発ディレクトリ構成としての慣例的な置き場（UmuOS 内の /logs とは別）

特に重要なのは、  
**「ISO に含めるもの」と「永続化されるもの」を物理的に分けている点**である。

この分離により、

- ISO を作り直しても永続データは影響を受けない
- 起動用資産と運用データの責務が明確になる
- ver0.2 以降で構成を変えても、影響範囲を限定できる

という効果を狙っている。

この段階ではまだ OS は起動しないが、  
後工程で迷わないための「地ならし」として重要な工程である。

### 補足説明：ISO と disk.img を分離する設計意図

本構成では、ISO イメージと ext4 の disk.img を明確に分離している。

- ISO は「起動するための資産（ブートローダ・カーネル・initramfs）」のみを含む
- disk.img は「OS の実体（/ 以下すべて）」を保持する永続ストレージとする

この分離により、ISO は再生成可能な成果物、disk.img は運用・検証の対象という
役割分担が明確になる。


### 前提条件（この設計が成立する条件）

この分離設計は、以下の前提条件のもとで成立している。

- `/` は ext4 の disk.img にマウントされる
- ISO 内には rootfs を持たず、initramfs は `/` へ移行するためだけに存在する
- 永続化が必要なデータ（/etc, /home, /logs 等）はすべて disk.img 側に配置する
- ISO は CD-ROM として接続し、書き換えを前提としない

これにより、ISO を差し替えても disk.img の内容には影響が出ない構成となる。


##### UUID を用いたマウント指定について

UUIDは、ファイルシステム作成時に割り当てられる一意な識別子であり、デバイス名とは独立して保持される。

仮想化環境（QEMU / virt-manager）では、ディスクの接続順やバス構成の違いにより、
同一の disk.img であっても `/dev/vda` や `/dev/sda` などのデバイス名が変化する可能性がある。
そのため、デバイス名を前提としたマウント指定は再現性が低く、起動失敗の原因となりやすい。

UUID を用いて `/` を指定することで、

- 起動環境（QEMU / virt-manager）の差異に依存しない
- ディスク接続順の変更に影響されない
- 同一 disk.img を継続して利用できる

という特性を得られる。

UmuOS ver0.1.1 では、再現性と安定性を最優先とするため、
root デバイスの特定は初期段階から UUID 指定を前提とした設計としている。


### 注意事項・制約

この設計により disk.img のみをバックアップ対象とできるが、
以下の点には注意が必要である。

- `/sbin/init` や `/etc` を破壊すると起動不能になる
- ext4 の互換性を壊すような操作（不整合な fsck 等）は避ける
- kernel や initramfs を変更した場合でも、`/` の構造が前提どおりである必要がある

また、ISO 側の変更（kernel 更新・initramfs 修正）は、
disk.img の内容を前提として行う必要がある。

ver0.1.1 では、この「起動資産と OS 実体の境界」を確定させることを最優先とし、
ver0.2 以降での構成変更や BusyBox 置換に備える仕様となる。

---

## 2. 永続ディスク（disk.img / ext4）の作業ログ

### 実施したコマンド

UmuOS ver0.1.1 では、永続ストレージとして「raw 形式のファイル（disk.img）を ext4 としてフォーマット」し、
VM には追加ディスクとして接続する。

作業（20GB の例）:

```bash
cd ~/umu/umu_project/UmuOSver011/disk
truncate -s 20G disk.img
mkfs.ext4 -F disk.img
```

**mkfs.ext4 -F disk.imgを行うと以下の様な出力となる。**

tama@umu:~/umu/umu_project/UmuOSver011/disk$ mkfs.ext4 -F disk.img
mke2fs 1.47.0 (5-Feb-2023)
Discarding device blocks: done
Creating filesystem with 5242880 4k blocks and 1310720 inodes
Filesystem UUID: de27448b-bcd4-4e7d-b99e-95b364b48dd0           →　→　UUIDが発行されるから注意です！
Superblock backups stored on blocks:
        32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208,
        4096000

Allocating group tables: done
Writing inode tables: done
Creating journal (32768 blocks): done
Writing superblocks and filesystem accounting information: done


### UUID について（確認コマンドは必須か？）

`mkfs.ext4` の実行結果に `Filesystem UUID:` が表示されるため、
その値を控えておけばこの時点で追加の確認コマンドは必須ではない。

今回の実行では、以下の UUID が発行されている。

```text
de27448b-bcd4-4e7d-b99e-95b364b48dd0
```

後日 UUID を再確認したい場合（ログを残していない・作り直した等）のために、
取得手段として `blkid` / `dumpe2fs` を手順に残しておくのは有効。

```bash
sudo blkid -p -o value -s UUID disk.img
```

（`blkid` が読めない場合）

```bash
sudo dumpe2fs -h disk.img | grep -E '^Filesystem UUID:'
```

### 重要: UUID を反映する場所

この UUID は「起動時に initramfs 側が root（永続ディスク）を特定するためのキー」になる。
最低限、以下の反映が必要。

- GRUB の `linux` 行に `root=UUID=...` として渡す
- 自作 init は `/proc/cmdline` から `root=UUID=...` を読んで `/newroot` に ext4 を mount する

補足:
- `mkfs.ext4` をやり直すと UUID は変わるため、作り直したら必ず再取得して反映し直す

---

## 3. カーネルビルド（6.18.1）の作業ログ

### 実施したコマンド（設計書 3.1〜3.4）

UmuOS ver0.1.1 では Linux 6.18.1 を採用し、まずは **defconfig のまま**ビルドして起動検証を優先する。
（カーネル設定の最適化は ver0.2 以降の課題に回す）

```bash
cd ~/umu/umu_project/UmuOSver011/kernel
wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.18.1.tar.xz
tar -xf linux-6.18.1.tar.xz
cd linux-6.18.1

make mrproper
make defconfig
cp .config ../config-6.18.1

make -j$(nproc)

cp arch/x86/boot/bzImage ~/umu/umu_project/UmuOSver011/iso_root/boot/vmlinuz-6.18.1
cp .config ~/umu/umu_project/UmuOSver011/iso_root/boot/config-6.18.1
```

### ポイント（なぜこうしているか）

- **`make mrproper`**
  - ビルドディレクトリを“確実にまっさらに”して再現性を上げる。
  - 過去の `.config` や生成物の混入による「なぜか起動しない」を避ける。

- **`defconfig` を採用**
  - 目的は「まず起動して switch_root まで到達する」ことであり、カーネルの最適化は後回し。
  - ver0.1.1 は安定化版なので、カスタム設定で可変要素を増やさない。

- **成果物は `bzImage`（= 起動用カーネル）**
  - x86_64 では `arch/x86/boot/bzImage` が GRUB から起動する “実体” になる。
  - ファイル名は運用上わかりやすいように `vmlinuz-6.18.1` にリネームして `iso_root/boot/` に配置する。

- **`config-6.18.1` を残す**
  - 「そのISOがどの設定で作られたか」を後追いできる。
  - 問題切り分け（起動失敗/ドライバ不足）で重要。

### 実装上の注意

- `make -j$(nproc)` はCPU/メモリを強く使う。ホストが重い場合は `-j2` などに落としてよい。
- 途中で失敗した場合でも、原因（不足パッケージ/容量/ツールチェーン）を潰してから再実行すればよい。
- カーネルを作り直したら、`iso_root/boot/vmlinuz-6.18.1` も更新されるため、ISO再生成の前提が揃う。

---

## 4. initramfs（移行用）の作業ログ

### 4.1 構造作成（rootfs + BusyBox）

0.1.1 の initramfs は「最小の初期化 → ext4 の /newroot へ移行（switch_root）」が目的。
そのため initramfs 内に置くツールは、基本的に BusyBox を中心に最小化する。

実施したコマンド（設計書 4.1）:

```bash
cd ~/umu/umu_project/UmuOSver011/initramfs
mkdir -p rootfs/{bin,sbin,etc,proc,sys,dev,dev/pts,run,newroot}

# initramfs内では BusyBox が「静的」である必要がある。
# Ubuntuで busybox-static を入れている前提なら /bin/busybox を使う。
cp /bin/busybox rootfs/bin/
sudo chown root:root rootfs/bin/busybox

# BusyBoxコマンドのsymlink（相対リンクに統一）
cd ~/umu/umu_project/UmuOSver011/initramfs/rootfs/bin
busybox --install -s .
for cmd in $(ls -1 | grep -v "^busybox$"); do
  rm "$cmd"
  ln -s busybox "$cmd"
done
```

### ポイント（なぜこうしているか）

- **ディレクトリを最初に固定化**
  - `/proc` `/sys` `/dev` `/dev/pts` `/run` を initramfs 側で用意しておくと、
    自作 init の処理が単純になり、起動トラブルの切り分けもしやすい。

- **BusyBox は initramfs では静的リンクが前提**
  - initramfs には通常 libc や動的リンカが無いため、動的BusyBoxだと実行できない。
  - Ubuntu では `busybox-static` を入れていれば `/bin/busybox` が静的版になっている想定。

- **所有者を root:root にする理由**
  - initramfs の中身は基本的に root 権限で動く前提。
  - パーミッション/所有者が不自然だと、起動時に想定外の拒否や挙動差の原因になり得る。

- **symlink を相対リンクに統一する理由**
  - initramfs は最終的に cpio に固められて別環境で展開されるため、
    絶対パスのリンクや作成時の作業ディレクトリ依存を避けて再現性を上げる。
  - `busybox --install -s .` は便利だが、環境によってリンク先が意図とズレることがあるので、
    ここでは「すべて `busybox` へ向ける」形に明示的に統一している。

### 補足（この段階でのゴール）

- この工程の完了条件は「initramfs に最低限のコマンドが揃い、次工程の /init（自作init）を配置できる」こと。
- まだ `initrd.img`（cpio化）や `switch_root` 実行までは行わない。

### 4.2 /init（自作init：C言語）

ここまでで「initramfs の土台（BusyBox + ディレクトリ）」が揃ったので、次は rootfs 直下に `/init` を配置する。
initramfs のエントリポイントは `/init` であり、ここが起動できないとカーネルはすぐ panic する。

実施したコマンド（設計書 4.2 のビルド例）:

```bash
cd ~/umu/umu_project/UmuOSver011/initramfs
# src/init.c を作成したら

gcc -static -Os -s -o rootfs/init src/init.c
chmod 755 rootfs/init
sudo chown root:root rootfs/init
```

ポイント:

- `-static` は必須寄り（initramfs は共有ライブラリが無い/少ない前提のため）
- `-Os` はサイズを抑える意図（initramfs を肥大化させない）
- `rootfs/init` は **rootfs 直下**に置く（`rootfs/bin/init` ではない）

確認（任意だが推奨）:

```bash
file rootfs/init
ldd rootfs/init
# 期待: "statically linked" / "not a dynamic executable"
```

### 4.3 initramfs（cpio）作成

`rootfs/` の内容を `newc` 形式で固めて gzip し、起動用の initrd として ISO 側へ配置する。

実施したコマンド（設計書 4.3）:

```bash
cd ~/umu/umu_project/UmuOSver011/initramfs/rootfs
find . -print0 | sudo cpio --null -o -H newc | gzip > ../initrd.img-6.18.1
cd ..
cp initrd.img-6.18.1 ~/umu/umu_project/UmuOSver011/iso_root/boot/
```

確認（任意だが推奨）:

```bash
ls -lh ~/umu/umu_project/UmuOSver011/initramfs/initrd.img-6.18.1       ~/umu/umu_project/UmuOSver011/iso_root/boot/initrd.img-6.18.1

gzip -t ~/umu/umu_project/UmuOSver011/initramfs/initrd.img-6.18.1

# /init が入っていることの確認
zcat ~/umu/umu_project/UmuOSver011/initramfs/initrd.img-6.18.1 | cpio -t | grep -E '^\./init$'
```

ここまでの完了条件:

- `~/umu/umu_project/UmuOSver011/initramfs/rootfs/init` が存在し、実行可能（755）である
- `~/umu/umu_project/UmuOSver011/iso_root/boot/initrd.img-6.18.1` が作成されている
- initrd の中に `./init` が含まれている

---

## 5. ext4ルート（disk.img）へ rootfs を作成（作業ログ）

ここは「永続化される OS の実体」を作る工程。
initramfs は最終的に `switch_root` で disk.img 側の `/` に移行するので、disk.img の中身が “本番の /” になる。

### 5.1 disk.img 作成（未作成なら）

作業（20GB の例）:

```bash
cd ~/umu/umu_project/UmuOSver011/disk
truncate -s 20G disk.img
mkfs.ext4 -F disk.img
```

ポイント:

- `mkfs.ext4` をやり直すと UUID が変わるので、やり直した場合は GRUB の `root=UUID=...` も必ず更新する。

### 5.2 disk.img をホストでマウントして rootfs を作る

実施したコマンド（設計書 5.2）:

```bash
sudo mkdir -p /mnt/umuos011
sudo mount -o loop ~/umu/umu_project/UmuOSver011/disk/disk.img /mnt/umuos011
```

最低限のディレクトリ作成:

```bash
sudo mkdir -p /mnt/umuos011/{bin,sbin,etc,proc,sys,dev,dev/pts,run,root,home/tama,logs,etc/init.d,etc/umu}
```

#### ここで混乱しやすいポイント（初心者向け）

- `/mnt/umuos011` は **ホスト上の絶対パス**。
  - つまり、この作業は「どのディレクトリで実行してもOK」。`cd` の場所には依存しない。
  - `disk.img` の中身（ext4の中身）が **ホストの `/mnt/umuos011` に見える**状態になる。

- 「QEMU-KVM（virt-manager）で起動できるか？」は、`/mnt/umuos011` を作ったかどうかではなく、
  **QEMU が参照するホスト上に `disk.img` が存在するか**で決まる。
  - もし virt-manager が自宅サーバーへリモート接続しているなら、`disk.img` は自宅サーバー側に置く必要がある。
  - ローカルPC側で `/mnt/umuos011` にマウントして編集しても、サーバー側のQEMUはそのファイルを参照できない（同じホストでないため）。

#### BusyBox 配置（ext4側の /bin）

ext4 側は「起動後の /」なので、`/sbin/init` を含めて最低限のコマンドが必要。
0.1.1 は安定化優先のため BusyBox を使う。

```bash
sudo cp /bin/busybox /mnt/umuos011/bin/
sudo chown root:root /mnt/umuos011/bin/busybox

sudo ln -sf /bin/busybox /mnt/umuos011/sbin/init

cd /mnt/umuos011/bin
sudo ./busybox --install -s .
```

確認（任意だが推奨）:

```bash
mount | grep -F /mnt/umuos011
findmnt /mnt/umuos011
ls -l /mnt/umuos011/sbin/init
```

この段階での完了条件:

- `disk.img` が `/mnt/umuos011` にマウントされている
- `/mnt/umuos011/bin/busybox` が存在し、`root:root` になっている
- `/mnt/umuos011/sbin/init` が `/bin/busybox` を指すリンクになっている

次工程（この後にやること）:

- `/mnt/umuos011/etc/passwd` `/mnt/umuos011/etc/shadow` の作成
- `/mnt/umuos011/etc/inittab` と `/mnt/umuos011/etc/init.d/rcS` の作成（起動処理・ログ・ネット設定）

### 5.3 ユーザー/認証ファイル（ext4側）

目的:

- switch_root 後は ext4 側の BusyBox（`/bin/busybox`）が `/sbin/init` として動く。
- `getty` → `login` の認証では、基本的に ext4 側の `/etc/passwd` と `/etc/shadow` を参照する。
  - ここが無い/壊れているとログインできず、起動後の操作が詰む。

#### 1) /etc/passwd を作る（644）

`/etc/passwd` は「ユーザー一覧」と「ホーム/シェル」を書くファイル。
今回は最小構成として `root` と `tama` を作る。

作成例:

```bash
sudo tee /mnt/umuos011/etc/passwd >/dev/null <<'EOF'
root:x:0:0:root:/root:/bin/sh
tama:x:1000:1000:tama:/home/tama:/bin/sh
EOF
```

補足:

- `root:x:...` の `x` は「パスワードは /etc/shadow に置く」意味（passwd に平文パスワードは書かない）。
- 最後の `/bin/sh` は「ログイン後に起動するシェル」。
  - 0.1.1 では BusyBox の applet として `/bin/sh` が用意されている前提（5.2の `busybox --install -s .`）。

#### 2) /etc/shadow を作る（600）

`/etc/shadow` はパスワードハッシュを置くファイル。
権限を間違えると（誰でも読める等）セキュリティ的に危険なので、必ず 600 にする。

ハッシュ作成（例: SHA-512）:

```bash
openssl passwd -6
```

出力された文字列（例: `$6$...` で始まる）を控えて、`<ROOT_HASH_HERE>` と `<TAMA_HASH_HERE>` に埋める。

作成例:

```bash
sudo tee /mnt/umuos011/etc/shadow >/dev/null <<'EOF'
root:<ROOT_HASH_HERE>:19000:0:99999:7:::
tama:<TAMA_HASH_HERE>:19000:0:99999:7:::
EOF
```

補足:

- `19000` は「最終パスワード更新日（1970-01-01 からの日数）」を意味する。
  - 厳密に合わせなくても当面の検証は進むが、運用に入れるなら適切な値にする/管理方針を決める。
  - よく分からなければ、まずは設計書の例どおりでOK（起動検証優先）。

#### 3) 所有者と権限を整える

```bash
sudo chown root:root /mnt/umuos011/etc/passwd /mnt/umuos011/etc/shadow
sudo chmod 644 /mnt/umuos011/etc/passwd
sudo chmod 600 /mnt/umuos011/etc/shadow
```

確認（任意だが推奨）:

```bash
ls -l /mnt/umuos011/etc/passwd /mnt/umuos011/etc/shadow
grep -n '^root:' /mnt/umuos011/etc/passwd
grep -n '^tama:' /mnt/umuos011/etc/passwd
```

この段階での完了条件:

- `/mnt/umuos011/etc/passwd` が存在し、`-rw-r--r--`（644）になっている
- `/mnt/umuos011/etc/shadow` が存在し、`-rw-------`（600）になっている
- `root` と `tama` の行が正しく入っている


### 5.4 BusyBox init 設定（ext4側）を入れる理由と注意点

#### なぜ「ext4側で BusyBox init + rcS」なのか

ver0.1.1 の狙いは「initramfs は `/` へ移行するためだけに最小化し、起動後の OS の実体（設定・認証・ログ・ネット）は ext4 側で完結させる」こと。

- initramfs の `/init` は `switch_root` までに責務を絞る
- `switch_root` 後は ext4 側の `/sbin/init`（= BusyBox init）が “本番の init” になる
- BusyBox init は ext4 側の `/etc/inittab` を読み、`::sysinit:` で rcS を起動する

この分割により、

- ネット設定（静的IP）や telnet の on/off が ext4 のファイル編集で完結する
- `/logs/boot.log` のようなログを「永続領域」に自然に残せる
- ISO を作り直しても、運用状態（/etcや/homeや/logs）が壊れにくい

という“永続化前提の OS”としての一貫性が出る。


#### /etc/inittab（最小）についてのメモ

設計書の最小例:

```text
::sysinit:/etc/init.d/rcS

ttyS0::respawn:/sbin/getty -L 115200 ttyS0 vt100
tty1::respawn:/sbin/getty 0 tty1 linux

::ctrlaltdel:/sbin/reboot
::shutdown:/bin/umount -a -r
```

ポイント:

- `::sysinit:` は「getty を起動する前に一度だけ必ず実行したい処理」を置く。
  - ver0.1.1 では “永続ログ作成” と “静的IP適用” と “telnet任意起動” をここに集約する。
- `ttyS0` を入れるのは virt-manager / QEMU のシリアルコンソールでログインできるようにするため。
  - `console=ttyS0,115200n8` を kernel cmdline に入れている前提と整合する。
- `tty1` はローカルコンソール（画面）用。
- `respawn` は getty が落ちても再起動されるため、ログイン口が維持される。


#### /etc/init.d/rcS（起動スクリプト）で意識したこと

設計書の rcS は、0.1.1 の受入条件（永続ログ / 静的IP / telnet任意）を満たすための最小構成。

1) 疑似FSのマウント（/proc /sys /dev /dev/pts）

- `ip` や `getty`、`telnetd` は /dev や /proc が無いと動作が不安定になりやすい。
- rcS 内で「未マウントなら mount」する形にして、冪等で再実行可能にする。
- `grep ... /proc/mounts` を使うため、/proc が無い状態では判定できない。
  - そのため `/proc` の mount 行だけは“最初に必ず試す”形になっている。

2) 永続ログ

- `/logs/boot.log` は ext4 の `/` 上に置くことで「再起動後も残る」ログになる。
- `>>` 追記にして「毎回上書きして履歴を消さない」ようにした。
- 早期ブートでは時計が 1970 年等になることがある（NTP未設定のため）。
  - それでも「rcS が実行された」「ネット処理が走った」証跡としては十分。

3) ネットワーク（静的IP）

- `/etc/umu/network.conf` を `.`（source）して設定を読み込むのは簡単だが、
  **任意コード実行と同じ**なのでファイル権限・書き込み権限は厳密にする必要がある。
  - 少なくとも `root:root` で一般ユーザーが編集できない運用にする。
- `ip addr add` は同じ IP を重複追加すると汚れるため、`ip addr show` でチェックしてから追加する。
- default route は `ip route replace` にして、既存があっても一意に収束するようにした。

注意:

- BusyBox の `ip` はフルの iproute2 と比べて機能が限定される可能性がある。
  - もし `ip` が存在しない/オプションが足りない場合は、(a) BusyBox のビルド設定確認、または (b) ext4 側に iproute2 を入れる、のどちらかが必要になる。

4) telnet（必要時のみ）

- telnet は平文で危険なので、デフォルト無効（`TELNET_ENABLE=0`）にし、
  LAN内の検証用途で必要なときだけ有効化する。
- telnetd は **switch_root 後（ext4側の / が有効になった後）に起動**する。
  - これにより `/etc/passwd` `/etc/shadow` による認証が必ず永続側の実体を参照する。

補足（ハマりポイント）:

- `/bin/login` が存在しないと `telnetd -l /bin/login` はログインできない。
  - 0.1.1 では BusyBox applet の symlink（`busybox --install -s .`）で `/bin/login` が用意される前提。


#### rcS に必要な“最低限のコマンド群”

rcS がやっていることから逆算すると、最低限以下が動く必要がある。

- `sh`（rcS 実行）
- `mkdir` `grep` `mount`（疑似FSマウント）
- `date`（ログ用）
- `ip`（静的IP設定）
- `telnetd` `login`（telnet有効時）

BusyBox を `/bin/busybox` 1本で置き、symlink を張っているのは「コマンド不足」を減らすため。


#### 権限（実装メモ）

- `/etc/init.d/rcS` は実行されるので `755` 必須。
- `root:root` にして意図しない改変を防ぐ。

```bash
sudo chmod 755 /mnt/umuos011/etc/init.d/rcS
sudo chown root:root /mnt/umuos011/etc/init.d/rcS
```


#### 切り分け（rcS が動いていない疑いがある場合）

- `/logs/boot.log` が作られない/追記されない
  - `/etc/inittab` の `::sysinit:` が正しいか
  - `/etc/init.d/rcS` の shebang（`#!/bin/sh`）が正しいか
  - `rcS` の実行権限（`+x`）が付いているか
- ネットが入らない
  - `/etc/umu/network.conf` のパスと内容（`IP=` `GW=`）
  - `IFNAME` が環境の NIC 名と一致しているか（QEMU/virtio で `eth0` とは限らないケースがある）
- telnet が入らない
  - `TELNET_ENABLE=1` になっているか
  - `telnetd` / `login` が存在するか


### 5.5 ネットワーク設定ファイル（ext4側 /etc/umu/network.conf）

#### これは何のためのファイル？（初心者向け）

UmuOS 0.1.1 では DHCP を使わず、起動時に **静的IP** を必ず入れる方針。
そのために「IP/GW/DNS を書いた設定ファイル」を ext4 側に置き、rcS が毎回それを読んで `ip` コマンドを実行する。

重要:

- “起動中に手で `ip addr add ...` を打つ” だけだと再起動で消える
- “ext4 側の `/etc/umu/network.conf` を作る” と再起動後も同じ設定が自動適用される


#### ファイルの置き場所（間違えやすい点）

rcS の中で参照しているパスは **`/etc/umu/network.conf`**。
ホストで作業しているときは、これが

- ホスト側: `/mnt/umuos011/etc/umu/network.conf`
- ゲスト起動後: `/etc/umu/network.conf`

という対応になる。

つまり、ホストで編集する時は必ず `/mnt/umuos011/etc/umu/network.conf` に作る。


#### 作成例（ホスト側で ext4 を編集）

（例）:

```bash
sudo mkdir -p /mnt/umuos011/etc/umu
sudo tee /mnt/umuos011/etc/umu/network.conf >/dev/null <<'EOF'
IFNAME=eth0
IP=192.168.0.204/24
GW=192.168.0.1
DNS=8.8.8.8
TELNET_ENABLE=0
EOF
```


#### オーナー/パーミッションを厳しくする理由

rcS は `network.conf` を **`.`（source）で読み込む**。
これは「ただの設定を読む」ではなく、シェルとして“そのまま実行され得る”という意味。

そのため、`network.conf` が一般ユーザーに書き換え可能だと、
起動時に root 権限で任意コマンドを実行される危険がある。

推奨は以下。

- `network.conf`: `root:root` + `600`（root だけ読み書き）
- ディレクトリ `/etc/umu`: `root:root` + `755`（書き換え不可、読み取りは可）

```bash
sudo chown root:root /mnt/umuos011/etc/umu/network.conf
sudo chmod 600 /mnt/umuos011/etc/umu/network.conf

sudo chown root:root /mnt/umuos011/etc/umu
sudo chmod 755 /mnt/umuos011/etc/umu
```

補足:

- 内容が機微情報でなくても「改ざんされない」ことが大事なので、0.1.1 は 600 推奨。
- 読み取りを許可したい運用にするなら 644 でも動くが、改ざん耐性は落ちる。


#### 確認（ホスト側）

```bash
ls -ld /mnt/umuos011/etc/umu
ls -l  /mnt/umuos011/etc/umu/network.conf
cat    /mnt/umuos011/etc/umu/network.conf
```


#### 起動後にネットが入らない時の切り分け

1) 設定が読まれているか

- `/logs/boot.log` に `net:` のログが出るかを見る。
  - `skip (IP/GW not set)` が出る場合は、`IP=` または `GW=` が空扱いになっている。
    - 余計な空白や全角文字が混ざっていないか確認。

2) NIC 名（IFNAME）が合っているか

- QEMU/virtio の構成次第で `eth0` ではなく `ens3` などになることがある。
- 起動後に以下で確認して、`network.conf` の `IFNAME=` を合わせる。

```sh
ip link
```

3) `ip` コマンドが使えるか

- BusyBox の `ip` は機能が限定されることがある。
- `ip addr` / `ip route` が動く前提なので、もしコマンドが無い/足りない場合は BusyBox の applet を確認する。


## 6. GRUB 設定（ISO 側の grub.cfg）

### 6.1 grub.cfg を作る目的

`grub.cfg` は「ISO を起動したときに、どのカーネルをどういう引数で起動し、どの initrd（initramfs）を渡すか」を決めるファイル。

UmuOS 0.1.1 の構成では役割分担が重要。

- ISO（`iso_root/`）: 起動資産（GRUB + kernel + initramfs）
- disk.img（ext4）: OS の実体（/etc, /home, /logs など）

このため、`grub.cfg` は ext4 側ではなく **ISO 側**に置く。


### 作成先（ここを間違えると一生読まれない）

作成先は以下。

- `~/umu/umu_project/UmuOSver011/iso_root/boot/grub/grub.cfg`

`grub-mkrescue -o ... iso_root` は、`iso_root/` の中身だけを ISO に詰める。
つまり `iso_root/boot/grub/grub.cfg` に置かれていないと、ISO 起動時に GRUB が設定を読めない。


### grub.cfg のオーナー/パーミッション（ホスト側）

ここは ext4（`/mnt/umuos011`）と違い、**ホストのホームディレクトリ配下**にある “ISO の素材” なので、基本的に root 権限は不要。
（むしろ `sudo` で作って root 所有にしてしまうと、後で編集しづらくなる。）

推奨:

- `~/umu/umu_project/UmuOSver011/iso_root/boot/grub/`（ディレクトリ）
  - owner/group: `tama:tama`（作業ユーザー）
  - permission: `755`
- `~/umu/umu_project/UmuOSver011/iso_root/boot/grub/grub.cfg`（ファイル）
  - owner/group: `tama:tama`
  - permission: `644`

理由:

- `grub.cfg` は秘密情報ではなく、実行ファイルでもないため 644 で十分。
- `grub-mkrescue` が読み取れれば良いので、読み取り可能（world-readable）で問題ない。

例:

```bash
chmod 755 ~/umu/umu_project/UmuOSver011/iso_root/boot/grub
chmod 644 ~/umu/umu_project/UmuOSver011/iso_root/boot/grub/grub.cfg
chown -R $USER:$USER ~/umu/umu_project/UmuOSver011/iso_root/boot/grub
```

注意:

- `sudo` で作った結果 `root:root` になってしまった場合は、上の `chown` で作業ユーザーに戻せばOK。


### root=UUID=... は「disk.img の UUID」でOK

`root=UUID=...` の値は、永続ディスク（disk.img を ext4 で作ったときの UUID）を入れる。

理由:

- 0.1.1 では initramfs の自作 init が `/proc/cmdline` を読んで、そこにある `root=UUID=...` を使って `/newroot` に ext4 を mount する設計。
- デバイス名（`/dev/vda` 等）は環境で変わるので、UUID 指定の方が再現性が高い。

注意:

- `mkfs.ext4` をやり直すと UUID は変わる。
  - disk.img を作り直したら、`grub.cfg` の UUID も必ず更新する。


### console=... を付ける理由（画面が出ない問題の予防）

`console=tty0 console=ttyS0,115200n8` は「画面（tty0）とシリアル（ttyS0）の両方にカーネルログを出す」指定。

- virt-manager のコンソールだけ見てもログが出ない
- `-serial mon:stdio` の QEMU でしか見えない

といった“見えない”問題を避けるために両方指定する。


### よくあるミスと切り分け

1) ISO 起動したがメニューが出ない/古い設定のまま

- `iso_root/boot/grub/grub.cfg` の場所が違う
- ISO を作り直していない（`grub-mkrescue` を再実行していない）

2) initramfs までは動くが ext4 を mount できない

- `root=UUID=...` が disk.img の UUID と違う
- disk.img を VM に接続していない（virt-manager の追加ディスク設定ミス）

3) ログが何も見えない

- `console=...` が無い/typo
- virt-manager 側でシリアルデバイスが無い（シリアルを追加しているか）


### 事前確認コマンド（ホスト側）

```bash
# grub.cfg が指定場所にあるか
ls -l ~/umu/umu_project/UmuOSver011/iso_root/boot/grub/grub.cfg

# disk.img の UUID を再確認（必要なら）
sudo blkid -p -o value -s UUID ~/umu/umu_project/UmuOSver011/disk/disk.img
```


## 7. ISOイメージ作成（grub-mkrescue）

### 7.1 何をしている工程？（初心者向け）

この工程は `iso_root/` に置いた

- GRUB 設定（`boot/grub/grub.cfg`）
- kernel（`boot/vmlinuz-6.18.1`）
- initramfs（`boot/initrd.img-6.18.1`）

を 1つの ISO（CD-ROM）にまとめる作業。

重要:

- **disk.img（ext4の永続ディスク）は ISO に入れない**
  - ISO は “起動するためだけ”
  - OS の実体（/etc, /home, /logs 等）は disk.img 側

なので、ISO を作り直しても永続データは基本的に無傷、という設計思想が守られる。


### 7.2 実行したコマンド（成功）

```bash
cd ~/umu/umu_project/UmuOSver011
grub-mkrescue -o UmuOSver011-boot.iso iso_root
```


### 7.3 ISO のオーナー/パーミッション

`grub-mkrescue` は通常 root 権限不要。
`sudo` で実行すると ISO が `root:root` 所有になり、後で移動/削除/上書きが面倒になる。

推奨:

- `~/umu/umu_project/UmuOSver011/UmuOSver011-boot.iso`
  - owner/group: `tama:tama`（作業ユーザー）
  - permission: `644`

もし `sudo` 実行などで root 所有になってしまった場合:

```bash
sudo chown $USER:$USER ~/umu/umu_project/UmuOSver011/UmuOSver011-boot.iso
chmod 644 ~/umu/umu_project/UmuOSver011/UmuOSver011-boot.iso
```


### 7.4 できたことの確認（任意だが推奨）

```bash
ls -lh ~/umu/umu_project/UmuOSver011/UmuOSver011-boot.iso
file  ~/umu/umu_project/UmuOSver011/UmuOSver011-boot.iso
```

確認ポイント:

- ISO ファイルが作成されていること
- 以降の工程（QEMU/virt-manager 起動）でこの ISO を指定できること


### 7.5 よくある失敗パターン

- `grub-mkrescue: xorriso ... not found` のようなエラー
  - `xorriso` / `grub-efi-amd64-bin` などが未導入の可能性
- `grub.cfg` を修正したのにメニューが変わらない
  - ISO を作り直していない（この工程を再実行する必要がある）
- kernel/initrd を入れ替えたのに反映されない
  - `iso_root/boot/` にコピーしたファイルが古い/パス違い





