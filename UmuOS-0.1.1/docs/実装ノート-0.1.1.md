# 実装ノート-0.1.1

目的：詳細設計-0.1.1.md の手順を、再現可能なログとして残す。

---

## 2025-12-29

### 実施範囲
- 2.1 必要パッケージ
- 2.2 作業ディレクトリ作成
- 3. Kernel（6.18.1）取得・ビルド・配置（3.1〜3.4）

### 結果
- 特にトラブルなく完了。

### 実行内容（要点）
- 作業ルート：`~/umu/umu_project/UmuOS-0.1.1`
- 2.1 必要パッケージ（再現用）
  - 実行コマンド（詳細設計の通り）：
    - `sudo apt update`
    - `sudo apt install -y build-essential bc bison flex libssl-dev libelf-dev libncurses-dev dwarves git wget grub-efi-amd64-bin grub-common xorriso mtools qemu-system-x86 ovmf cpio gzip xz-utils busybox-static e2fsprogs musl-tools`
  - 確認（観測点）：
    - `command -v qemu-system-x86_64`（※未記録なら出力を追記）
    - `command -v grub-mkrescue`（※未記録なら出力を追記）
    - `command -v musl-gcc` → `/usr/bin/musl-gcc`
    - `file /bin/busybox | head -n 1` → `statically linked`
- ディレクトリ作成：
  - `mkdir -p kernel initramfs/{rootfs,src} iso_root/boot/grub disk run logs docs`
- Kernel：
  - `linux-6.18.1.tar.xz` を取得して展開
  - `make mrproper` → `make defconfig` → `make -j"$(nproc)"`
  - `bzImage` を `iso_root/boot/vmlinuz-6.18.1` に配置
  - `.config` を `iso_root/boot/config-6.18.1` に配置

### 観測点（3.3 必須カーネル設定）
以下がすべて built-in（`=y`）であることを確認：
- `CONFIG_BLK_DEV_INITRD=y`
- `CONFIG_RD_GZIP=y`
- `CONFIG_DEVTMPFS=y`
- `CONFIG_DEVTMPFS_MOUNT=y`
- `CONFIG_VIRTIO_BLK=y`
- `CONFIG_EXT4_FS=y`

### 観測点（3.4 vmlinuz の確認）
- `file iso_root/boot/vmlinuz-6.18.1` の出力に `Linux kernel x86 boot executable bzImage, version 6.18.1` を確認。
- 出力に `Normal VGA` 表記があるが、これは bzImage の情報であり、以降の観測（ttyS0）は GRUB の `console=` と QEMU の `-nographic/-serial` に依存する前提。

### 次にやること
- 4. 永続ディスク（disk.img）作成・UUID取得（UUID を控えて GRUB の `root=UUID=...` に使う）

---

## 2025-12-29（追記）

### 実施範囲
- 4. 永続ディスク（disk.img）作成・UUID取得（4.1）

### 結果
- 特にトラブルなく完了。

### 実行内容（要点）
- `cd ~/umu/umu_project/UmuOS-0.1.1/disk`
- `truncate -s 4G disk.img`
- `mkfs.ext4 -F disk.img`

### 観測点（UUID）
- `mkfs.ext4` の出力にて Filesystem UUID を確認：
  - `38d2ebb4-39fb-4f53-90eb-20dc2de045b3`

### 次にやること
- 4.2 `sudo blkid -p -o value -s UUID disk.img` で UUID を再取得し、上記と一致することを確認（以降 `DISK_UUID` として扱う）

### 追記（4.2 UUID 取得：観測点）
- 実行：`cd ~/umu/umu_project/UmuOS-0.1.1/disk` → `sudo blkid -p -o value -s UUID disk.img`
- 取得UUID（DISK_UUID）：`38d2ebb4-39fb-4f53-90eb-20dc2de045b3`
- 4.1（mkfs.ext4 出力の Filesystem UUID）と一致を確認。

---

## 2025-12-29（追記）

### 実施範囲
- 5. ext4 ルート（disk.img）中身を作る（5.1〜5.3 途中まで）

### 結果
- 特にトラブルなく進行中。

### 観測点（5.1 loopマウント）
- `sudo mount -o loop .../disk.img /mnt/umuos011` が成功。
- `findmnt /mnt/umuos011` の出力：
  - `SOURCE=/dev/loop14`（loop番号は実行ごとに変動しうる）
  - `FSTYPE=ext4`

### 実行内容（要点）
- 5.2 最小ディレクトリ作成：
  - `sudo mkdir -p /mnt/umuos011/{bin,sbin,etc,proc,sys,dev,dev/pts,run,home,root,tmp,logs,etc/init.d}`
- 5.3 BusyBox 配置：
  - `sudo cp /bin/busybox /mnt/umuos011/bin/busybox`
  - `sudo chown root:root /mnt/umuos011/bin/busybox`

### 次にやること
- 5.3 `sudo chmod 755 /mnt/umuos011/bin/busybox` を実行
- 5.3 `file /mnt/umuos011/bin/busybox | head` で `statically linked` を確認
- 5.4 必ず `chroot` して BusyBox applet を生成（混線防止の最重要ポイント）

### 追記（5.3 BusyBox：観測点）
- `sudo chmod 755 /mnt/umuos011/bin/busybox` を実行。
- `file /mnt/umuos011/bin/busybox | head` にて `statically linked` を確認。

### 観測点（5.4 BusyBox applet：chroot）
- 実行：
  - `sudo chroot /mnt/umuos011 /bin/busybox --install -s /bin`
  - `sudo chroot /mnt/umuos011 /bin/busybox --install -s /sbin`
- 確認：
  - `/mnt/umuos011/bin/sh -> /bin/busybox`
  - `/mnt/umuos011/sbin/init -> /bin/busybox`
  - どちらも chroot 環境基準のパスを指しているため、symlink 混線は回避できている。

### 追記（5.5 /sbin/init を BusyBox に向ける）
- 念のため明示：`sudo ln -sf /bin/busybox /mnt/umuos011/sbin/init`
- 確認：`/mnt/umuos011/sbin/init -> /bin/busybox`

### 追記（5.6 inittab：ttyS0 でログイン）
- 作成：`sudo vim /mnt/umuos011/etc/inittab`
- 権限：`sudo chown root:root /mnt/umuos011/etc/inittab`、`sudo chmod 644 /mnt/umuos011/etc/inittab`
- 内容確認：`sudo cat -n /mnt/umuos011/etc/inittab`
  - `::sysinit:/etc/init.d/rcS`
  - `ttyS0::respawn:/sbin/getty -L 115200 ttyS0 vt100`
  - `::ctrlaltdel:/sbin/reboot`
  - `::shutdown:/bin/umount -a`

### 追記（5.7 rcS：初期化 + 任意の永続ログ）
- 作成：`sudo vim /mnt/umuos011/etc/init.d/rcS`
- 権限：`sudo chown root:root /mnt/umuos011/etc/init.d/rcS`、`sudo chmod 755 /mnt/umuos011/etc/init.d/rcS`
- 確認：
  - `head -n 3` で `#!/bin/sh` と初期化方針コメントを確認
  - `ls -l` で `-rwxr-xr-x` を確認
  - `file` で `POSIX shell script` を確認（UTF-8）

### 追記（5.8 ユーザー：root / tama）
- `/etc/passwd` と `/etc/group` を作成（vimで編集）
- パスワードハッシュ作成：`openssl passwd -6` を2回実行して `$6$...` を取得
- `/etc/shadow` を作成し、権限を設定（重要）
  - `sudo chown root:root /mnt/umuos011/etc/shadow`
  - `sudo chmod 600 /mnt/umuos011/etc/shadow`
- 観測点：`ls -l /mnt/umuos011/etc/shadow` が `-rw------- root root`（600）
- `/etc/passwd` と `/etc/group` の所有者/権限を明示（切り分けしやすくするため）
  - `sudo chown root:root /mnt/umuos011/etc/passwd /mnt/umuos011/etc/group`
  - `sudo chmod 644 /mnt/umuos011/etc/passwd /mnt/umuos011/etc/group`

### 追記（5.8.3 ホーム作成と所有者）
- `sudo mkdir -p /mnt/umuos011/root`
- `sudo mkdir -p /mnt/umuos011/home/tama`
- `sudo chown 1000:1000 /mnt/umuos011/home/tama`

### 観測点（5.9 ext4 側の必須ファイル存在確認）
- `/mnt/umuos011/sbin/init -> /bin/busybox` を確認
- `/mnt/umuos011/etc/inittab` が存在することを確認
- `/mnt/umuos011/etc/init.d/rcS` が実行可能（`-rwxr-xr-x`）であることを確認
- `/mnt/umuos011/etc/passwd` が存在することを確認
- `/mnt/umuos011/etc/shadow` が 600（`-rw-------`）であることを確認

### 追記（5.10 アンマウント）
- `sync` を実行（書き込みフラッシュ）
- `sudo umount /mnt/umuos011` を実行し、ext4（disk.img）の編集を終了

### 追記（中間チェック：ext4 イメージ健全性）
- 実行：`sudo e2fsck -f ~/umu/umu_project/UmuOS-0.1.1/disk/disk.img`
- 結果：エラー修復なしで完了（Pass 1〜5 完走）

### 追記（6.1 前チェック：ツール/前提の確認）
- `command -v musl-gcc` → `/usr/bin/musl-gcc`
- `command -v lsinitramfs` → `/usr/bin/lsinitramfs`
- `file /bin/busybox | head -n 1` → `statically linked` を確認

### 追記（6.1 initramfs rootfs 骨格：正しいオペレーション）
- 方針：BusyBox applet（特に `switch_root`）は **chroot して生成**する
  - 理由：ホスト側で `busybox --install` を実行すると、symlink がホスト絶対パス化して壊れることがある
- 実行（要点）：
  - `cd ~/umu/umu_project/UmuOS-0.1.1/initramfs`
  - `rm -rf rootfs`
  - `mkdir -p rootfs/{bin,sbin,etc,proc,sys,dev,dev/pts,run,newroot}`
  - `cp /bin/busybox rootfs/bin/busybox`
  - `chmod 755 rootfs/bin/busybox`
  - `sudo chroot rootfs /bin/busybox --install -s /bin`
- 観測点：`ls -l initramfs/rootfs/bin/switch_root` が initramfs 内で解決できるリンクになっている（例：`/bin/busybox` または `busybox`）

---

## 2025-12-30

### 実施範囲
- 6. initramfs（/init）作成（6.2〜6.5）
- 7. GRUB 設定（UEFIブート）（7.1）

### 結果
- initramfs：`/init` のビルド、initrd 生成、内容検証、ISO への配置まで完了。
- GRUB：`grub.cfg` を作成し、`root=UUID=...` が DISK_UUID に置換済みであることを観測点で確認。

### 追記（6.2 自作 init（C）ビルド）
- 実行：
  - `cd ~/umu/umu_project/UmuOS-0.1.1`
  - `musl-gcc -static -O2 -Wall -Wextra -o initramfs/rootfs/init initramfs/src/init.c`
  - `chmod 755 initramfs/rootfs/init`
  - `file initramfs/rootfs/init`
- 観測点：`file` 出力に `statically linked` を確認（実行権限も `-rwxr-xr-x`）。

### 追記（6.3 initrd 生成：cpio + gzip）
- 実行：
  - `cd ~/umu/umu_project/UmuOS-0.1.1/initramfs/rootfs`
  - `find . -print0 | cpio --null -ov --format=newc | gzip -9 > ../initrd.img-6.18.1`
  - `ls -lh ../initrd.img-6.18.1`
- 結果：`initrd.img-6.18.1` が生成されることを確認。

### 追記（6.4 initrd 内容検証：観測点）
- 実行：
  - `lsinitramfs ~/umu/umu_project/UmuOS-0.1.1/initramfs/initrd.img-6.18.1 | grep -E '^(init|bin/switch_root)$'`
- 観測点：以下の2行が出力されることを確認。
  - `bin/switch_root`
  - `init`

### 追記（6.5 ISO へ initrd を配置）
- 実行：
  - `cd ~/umu/umu_project/UmuOS-0.1.1`
  - `cp initramfs/initrd.img-6.18.1 iso_root/boot/initrd.img-6.18.1`
  - `ls -l iso_root/boot/initrd.img-6.18.1`
- 結果：`iso_root/boot/initrd.img-6.18.1` の存在を確認。

### 追記（7.1 grub.cfg 作成：UUID 置換）
- `iso_root/boot/grub/grub.cfg` を作成（ttyS0 優先の serial/terminal 設定を有効化）。
- 実行（UUID 取得〜置換〜観測点）：
  - `DISK_UUID="$(sudo blkid -p -o value -s UUID ~/umu/umu_project/UmuOS-0.1.1/disk/disk.img)"`
  - `sed -i "s/DISK_UUID_REPLACE_ME/$DISK_UUID/" iso_root/boot/grub/grub.cfg`
  - `grep -n "root=UUID" iso_root/boot/grub/grub.cfg`
- 観測点（出力）：
  - `16:        root=UUID=38d2ebb4-39fb-4f53-90eb-20dc2de045b3 \\`

### 追記（8. ISO 生成）
- 実行：
  - `cd ~/umu/umu_project/UmuOS-0.1.1`
  - `rm -f UmuOS-0.1.1-boot.iso`
  - `grub-mkrescue -o UmuOS-0.1.1-boot.iso iso_root`
  - `ls -lh UmuOS-0.1.1-boot.iso`
- 観測点：ISO が生成され、サイズが 27M 程度であることを確認。

### 次にやること
- 9. QEMU 起動（OVMF + virtio-blk + `-nographic`）
- 10. 受入（initramfsログ→login→永続性確認）
