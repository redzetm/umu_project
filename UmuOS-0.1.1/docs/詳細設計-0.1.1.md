# 詳細設計-0.1.1（作業手順 + 仕様：再現性・観測性・混線防止）

本詳細設計は、UmuOS-0.1.1 を「いつでも戻れるベース版」として成立させるための **作業手順（オペレーション）** を、コマンドレベルで網羅する。

- 受入環境（固定）：**開発機（Ubuntu 24.04 LTS）上の QEMU（accel=tcg）**
- 観測（固定）：**シリアル ttyS0**
- ゴール（必須）：
  1. UEFI → GRUB → Linux kernel → initramfs（自作 `/init`）→ 永続 ext4（disk.img）へ `switch_root` が成立
  2. 最終的な `/` が ext4（disk.img）で、**再起動後も永続性が確認できる**
  3. ttyS0 で `root` / `tama` が **パスワードログイン**できる
- ゴール（推奨/任意）：
  - 永続ログ `/logs/boot.log` の追記（※initramfs からは書かない。ext4 側の rcS で追記する）
- スコープ外（0.1.1）：ネットワーク（NAT/ブリッジ/telnet）

> 重要：1回の実験で変えるのは1点だけ。次に進む前に「観測点」で到達を確定する。
> 実装手順通りに進めるが、都度、同階層ディレクトリにある 実装ノート-0.1.1.mdにポイントを追記する

---

## 0. 固定パラメータ（この文書で固定する値）

- Kernel version：`6.18.1`
- ISO 名：`UmuOS-0.1.1-boot.iso`
- initrd 名：`initrd.img-6.18.1`
- kernel 名：`vmlinuz-6.18.1`
- 永続ディスク：`disk/disk.img`
- 永続ディスクサイズ：**4GiB**
- QEMU ディスク：**virtio-blk（if=virtio）**
- initramfs `/init`：**musl 静的リンク**（`musl-gcc -static`）

---

## 1. ディレクトリ構成（プロジェクト内の配置）

作業ルート：`~/umu/umu_project/UmuOS-0.1.1`

- `kernel/`：カーネルソースとビルド
- `initramfs/`：initramfs の生成元と生成物
  - `initramfs/rootfs/`：cpio 生成元
  - `initramfs/src/`：`init.c`
- `iso_root/`：ISO に焼くファイル
  - `iso_root/boot/grub/grub.cfg`
  - `iso_root/boot/vmlinuz-6.18.1`
  - `iso_root/boot/initrd.img-6.18.1`
- `disk/`：永続ディスク
- `run/`：QEMU 実行用ファイル（OVMF_VARS のコピーなど）

---

## 2. 事前準備（開発機：Ubuntu 24.04 LTS）

### 2.1 必要パッケージ

```bash
sudo apt update
sudo apt install -y \
  build-essential bc bison flex libssl-dev libelf-dev libncurses-dev dwarves \
  git wget \
  grub-efi-amd64-bin grub-common xorriso mtools \
  qemu-system-x86 ovmf \
  cpio gzip xz-utils \
  busybox-static e2fsprogs \
  musl-tools
```

確認：

```bash
command -v qemu-system-x86_64
command -v grub-mkrescue
command -v musl-gcc
file /bin/busybox | head
```

### 2.2 作業ディレクトリ作成

```bash
cd ~/umu/umu_project/UmuOS-0.1.1
mkdir -p kernel initramfs/{rootfs,src} iso_root/boot/grub disk run logs docs
```

確認（意図したディレクトリが作られているか）：

```bash
ls -d kernel initramfs initramfs/rootfs initramfs/src iso_root/boot/grub disk run logs docs
```

---

## 3. Kernel（6.18.1）取得・ビルド・配置

### 3.1 取得と展開

```bash
cd ~/umu/umu_project/UmuOS-0.1.1/kernel
wget -nc https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.18.1.tar.xz
rm -rf linux-6.18.1
tar -xf linux-6.18.1.tar.xz
cd linux-6.18.1
```

### 3.2 ビルド（defconfig）

```bash
make mrproper
make defconfig
make -j"$(nproc)"
```

### 3.3 必須カーネル設定の確認（観測点）

initramfs から ext4 を mount するため、少なくとも以下が built-in（`=y`）であることを確認する。

```bash
grep -E '^(CONFIG_EXT4_FS=|CONFIG_DEVTMPFS=|CONFIG_DEVTMPFS_MOUNT=|CONFIG_BLK_DEV_INITRD=|CONFIG_VIRTIO_BLK=|CONFIG_RD_GZIP=)' .config
```

期待：
- `CONFIG_EXT4_FS=y`
- `CONFIG_DEVTMPFS=y`（可能なら `CONFIG_DEVTMPFS_MOUNT=y`）
- `CONFIG_BLK_DEV_INITRD=y`
- `CONFIG_VIRTIO_BLK=y`
- `CONFIG_RD_GZIP=y`

### 3.4 ISO配置

```bash
cd ~/umu/umu_project/UmuOS-0.1.1
cp kernel/linux-6.18.1/arch/x86/boot/bzImage iso_root/boot/vmlinuz-6.18.1
cp kernel/linux-6.18.1/.config iso_root/boot/config-6.18.1
file iso_root/boot/vmlinuz-6.18.1
```

---

## 4. 永続ディスク（disk.img）作成・UUID取得

### 4.1 作成（4GiB、パーティション無しの ext4）

```bash
cd ~/umu/umu_project/UmuOS-0.1.1/disk
rm -f disk.img
truncate -s 4G disk.img
mkfs.ext4 -F disk.img
```

### 4.2 UUID 取得（最重要：GRUB の root=UUID に使用）

```bash
cd ~/umu/umu_project/UmuOS-0.1.1/disk
sudo blkid -p -o value -s UUID disk.img
```

この UUID を控える（以降、`DISK_UUID` と呼ぶ）。

---

## 5. ext4 ルート（disk.img）中身を作る

### 5.1 一時マウント（loop）

```bash
sudo mkdir -p /mnt/umuos011
sudo mount -o loop ~/umu/umu_project/UmuOS-0.1.1/disk/disk.img /mnt/umuos011
findmnt /mnt/umuos011
```

**つまずきポイント（重要）**：
- `mount: ... はマウント済みです` は「壊れた」ではなく **既にマウント済み** の可能性がある。
- 迷ったら `findmnt /mnt/umuos011` で状態を見て、必要なら `sudo umount /mnt/umuos011`。

### 5.2 最小ディレクトリ

```bash
sudo mkdir -p /mnt/umuos011/{bin,sbin,etc,proc,sys,dev,dev/pts,run,home,tama,logs,etc/init.d}
```

### 5.3 BusyBox 配置

```bash
sudo cp /bin/busybox /mnt/umuos011/bin/busybox
sudo chown root:root /mnt/umuos011/bin/busybox
sudo chmod 755 /mnt/umuos011/bin/busybox
file /mnt/umuos011/bin/busybox | head
```

### 5.4 BusyBox applet の生成（必ず chroot で実行）

**つまずきポイント（最重要）**：
- ホスト側のマウント先（`/mnt/umuos011`）で `busybox --install` を実行すると、symlink がホスト絶対パスを指して壊れることがある。
- **必ず chroot して、UmuOS 側のパス基準で applet を生成する。**

```bash
sudo chroot /mnt/umuos011 /bin/busybox --install -s /bin
sudo chroot /mnt/umuos011 /bin/busybox --install -s /sbin

sudo ls -l /mnt/umuos011/bin/sh
sudo ls -l /mnt/umuos011/sbin/init
```

期待：
- `/bin/sh -> /bin/busybox`

### 5.5 /sbin/init を BusyBox に向ける

BusyBox の applet として `/sbin/init` が出来ていればOK。
念のため明示する場合：

```bash
sudo ln -sf /bin/busybox /mnt/umuos011/sbin/init
sudo ls -l /mnt/umuos011/sbin/init
```

### 5.6 inittab（ttyS0でログインできるようにする）

```bash
sudo tee /mnt/umuos011/etc/inittab >/dev/null <<'EOF'
::sysinit:/etc/init.d/rcS

# ttyS0（シリアル）でログイン
ttyS0::respawn:/sbin/getty -L 115200 ttyS0 vt100

# 予備：画面側（tty0）も出したい場合は有効化
# tty1::respawn:/sbin/getty 38400 tty1

::ctrlaltdel:/sbin/reboot
::shutdown:/bin/umount -a -r
EOF
```

### 5.7 rcS（初期化。永続ログは任意）

方針：
- ここは ext4 側の責務（initramfs では永続へ書かない）
- ログ追記（推奨/任意）を入れる場合も、失敗でブートを止めない

```bash
sudo tee /mnt/umuos011/etc/init.d/rcS >/dev/null <<'EOF'
#!/bin/sh

# 失敗しても止めない（観測を優先）
mount -t proc proc /proc 2>/dev/null || true
mount -t sysfs sysfs /sys 2>/dev/null || true
mount -t devtmpfs devtmpfs /dev 2>/dev/null || true
mount -t devpts devpts /dev/pts 2>/dev/null || true

# 任意：永続ログ（/logs/boot.log）
# initramfsでは書かない。ここで追記する。
(
  mkdir -p /logs
  echo "[rcS] boot: $(date -Iseconds)" >> /logs/boot.log
) 2>/dev/null || true

# 任意：簡単な表示
/bin/echo "[rcS] rcS done" > /dev/console 2>/dev/null || true
EOF

sudo chmod 755 /mnt/umuos011/etc/init.d/rcS
```

### 5.8 ユーザー（root / tama）

ここは「ログイン成功を固定点にする」ために必須。

#### 5.8.1 /etc/passwd と /etc/group

```bash
sudo tee /mnt/umuos011/etc/passwd >/dev/null <<'EOF'
root:x:0:0:root:/root:/bin/sh
tama:x:1000:1000:tama:/home/tama:/bin/sh
EOF

sudo tee /mnt/umuos011/etc/group >/dev/null <<'EOF'
root:x:0:
users:x:100:
tama:x:1000:
EOF
```

#### 5.8.2 パスワードハッシュ作成（開発機で作って書き込む）

Ubuntu 24.04 では `openssl passwd -6` が使えることが多い。

```bash
# 例：root のハッシュ
openssl passwd -6

# 例：tama のハッシュ
openssl passwd -6
```

出力された `\$6\$...` を控え、`/etc/shadow` を作る。

```bash
sudo tee /mnt/umuos011/etc/shadow >/dev/null <<'EOF'
root:$6$REPLACE_WITH_HASH_FOR_ROOT:20000:0:99999:7:::
tama:$6$REPLACE_WITH_HASH_FOR_TAMA:20000:0:99999:7:::
EOF

sudo chown root:root /mnt/umuos011/etc/shadow
sudo chmod 600 /mnt/umuos011/etc/shadow
```

**つまずきポイント（重要）**：
- `/etc/shadow` がプレースホルダのまま／権限が 600 でないと、ログイン失敗が混ざりやすい。

#### 5.8.3 ホーム作成と所有者

```bash
sudo mkdir -p /mnt/umuos011/home/tama
sudo chown 1000:1000 /mnt/umuos011/home/tama
```

### 5.9 ext4 側の必須ファイル存在確認（観測点）

```bash
sudo ls -l /mnt/umuos011/sbin/init
sudo ls -l /mnt/umuos011/etc/inittab
sudo ls -l /mnt/umuos011/etc/init.d/rcS
sudo ls -l /mnt/umuos011/etc/passwd
sudo ls -l /mnt/umuos011/etc/shadow
```

### 5.10 アンマウント

```bash
sync
sudo umount /mnt/umuos011
```

---

## 6. initramfs（/init）作成（musl 静的）

### 6.1 rootfs 骨格（initramfs側）

```bash
cd ~/umu/umu_project/UmuOS-0.1.1/initramfs
rm -rf rootfs
mkdir -p rootfs/{bin,sbin,etc,proc,sys,dev,dev/pts,run,newroot}

cp /bin/busybox rootfs/bin/busybox
chmod 755 rootfs/bin/busybox

# switch_root を必ず用意（BusyBox applet）
cd rootfs/bin
./busybox --install -s .

# /bin/switch_root があること
ls -l rootfs/bin/switch_root
```

### 6.2 自作 init（C）をビルドして /init に配置

`init.c` は [UmuOS-0.1.1/initramfs/src/init.c](../initramfs/src/init.c) を使う。

```bash
cd ~/umu/umu_project/UmuOS-0.1.1
musl-gcc -static -O2 -Wall -Wextra -o initramfs/rootfs/init initramfs/src/init.c
chmod 755 initramfs/rootfs/init
file initramfs/rootfs/init
```

**期待**：`statically linked` が出る。

### 6.3 initrd 生成（cpio + gzip）

```bash
cd ~/umu/umu_project/UmuOS-0.1.1/initramfs/rootfs
find . -print0 | cpio --null -ov --format=newc | gzip -9 > ../initrd.img-6.18.1
ls -lh ../initrd.img-6.18.1
```

### 6.4 initrd 内容の検証（つまずき対策）

**つまずきポイント**：`lsinitramfs | head` だけ見ると `/init` が無いように見える。

推奨（ピンポイントで grep）：

```bash
lsinitramfs ~/umu/umu_project/UmuOS-0.1.1/initramfs/initrd.img-6.18.1 | grep -E '^(init|bin/switch_root)$'
```

`lsinitramfs` が無い場合の代替：

```bash
cd ~/umu/umu_project/UmuOS-0.1.1/initramfs
zcat initrd.img-6.18.1 | cpio -t | grep -E '^(init|bin/switch_root)$'
```

### 6.5 ISO へ initrd を配置

```bash
cd ~/umu/umu_project/UmuOS-0.1.1
cp initramfs/initrd.img-6.18.1 iso_root/boot/initrd.img-6.18.1
ls -l iso_root/boot/initrd.img-6.18.1
```

---

## 7. GRUB 設定（UEFIブート）

### 7.1 grub.cfg 作成

`DISK_UUID` は 4.2 で取得した UUID に置換する。

```bash
cd ~/umu/umu_project/UmuOS-0.1.1
sudo tee iso_root/boot/grub/grub.cfg >/dev/null <<'EOF'
set timeout=0
set default=0

menuentry "UmuOS-0.1.1" {
    insmod all_video
    insmod gfxterm
    insmod gzio

    linux /boot/vmlinuz-6.18.1 \
        root=UUID=DISK_UUID_REPLACE_ME \
        rw \
        console=tty0 console=ttyS0,115200n8 \
        loglevel=7 \
        panic=-1

    initrd /boot/initrd.img-6.18.1
}
EOF
```

置換：

```bash
DISK_UUID="$(sudo blkid -p -o value -s UUID ~/umu/umu_project/UmuOS-0.1.1/disk/disk.img)"
sed -i "s/DISK_UUID_REPLACE_ME/${DISK_UUID}/" iso_root/boot/grub/grub.cfg
grep -n "root=UUID" -n iso_root/boot/grub/grub.cfg
```

---

## 8. ISO 生成

```bash
cd ~/umu/umu_project/UmuOS-0.1.1
rm -f UmuOS-0.1.1-boot.iso
grub-mkrescue -o UmuOS-0.1.1-boot.iso iso_root
ls -lh UmuOS-0.1.1-boot.iso
```

---

## 9. QEMU 起動（受入：ネット無し、シリアル観測）

### 9.1 OVMF_VARS を run/ にコピー

```bash
cd ~/umu/umu_project/UmuOS-0.1.1
cp -f /usr/share/OVMF/OVMF_VARS_4M.fd run/OVMF_VARS_umuos_0_1_1.fd
ls -l run/OVMF_VARS_umuos_0_1_1.fd
```

環境によって OVMF のパスが異なる場合：

```bash
ls /usr/share/OVMF | head
```

### 9.2 起動コマンド（virtio-blk、accel=tcg）

```bash
cd ~/umu/umu_project/UmuOS-0.1.1
qemu-system-x86_64 \
  -machine q35,accel=tcg \
  -m 1024 \
  -cpu qemu64 \
  -drive if=pflash,format=raw,readonly=on,file=/usr/share/OVMF/OVMF_CODE_4M.fd \
  -drive if=pflash,format=raw,file=run/OVMF_VARS_umuos_0_1_1.fd \
  -cdrom UmuOS-0.1.1-boot.iso \
  -drive file=disk/disk.img,format=raw,if=virtio \
  -nographic \
  -serial mon:stdio
```

---

## 10. 受入チェック（必須）

### 10.1 initramfs の観測点

シリアルログに、少なくとも以下が出ることを確認する。

- `/proc/cmdline` が出る（root=UUID を含む）
- `want root UUID: ...` が出る
- `/dev/...` の `scan:` が複数出る
- 一致した `matched:` が出る
- `mount root ok` が出る
- `exec: /bin/switch_root /newroot /sbin/init` が出る

ここまで出れば、initramfs の責務は達成。

### 10.2 ext4 側で `login:` が出る

`ttyS0` で `login:` が出ること。

### 10.3 root / tama でログインできる

- `root` でログイン → `id` を実行
- `tama` でログイン → `id` を実行

期待例：

```sh
id
uname -r
mount | head
```

### 10.4 再起動後の永続性確認（必須）

1) 何かファイルを作る

```sh
echo "persist" > /home/tama/persist_test.txt
sync
```

2) 再起動

```sh
reboot
```

3) 再起動後に残っていることを確認

```sh
cat /home/tama/persist_test.txt
```

---

## 11. つまずき時の切り分け（最短ルート）

### 11.1 `login:` が出ない（rcS で止まる／getty が出ない）

最優先で疑う：BusyBox applet の symlink 破損。

確認（開発機で disk.img をマウントして確認）：

```bash
sudo mount -o loop ~/umu/umu_project/UmuOS-0.1.1/disk/disk.img /mnt/umuos011
sudo ls -l /mnt/umuos011/bin/sh
sudo ls -l /mnt/umuos011/sbin/getty
sudo umount /mnt/umuos011
```

`/bin/sh -> /bin/busybox` になっていないなら、5.4 の **chroot 手順**で作り直す。

### 11.2 initramfs が root デバイスを見つけられない

- `root=UUID=...` が正しいか（GRUB cfg の UUID）
- カーネル設定が built-in か（3.3）
- `/dev` が見えているか（devtmpfs）

確認：
- initramfs ログに `mount ok: devtmpfs on /dev` が出るか
- `scan:` が出ているか

### 11.3 ext4 が怪しい（原因混入の遮断）

症状：
- 変更したはずのファイルが無い／内容が変
- ブートが不安定

方針：VM を止めてから fsck。

```bash
sudo e2fsck -f ~/umu/umu_project/UmuOS-0.1.1/disk/disk.img
```

エラーが出たら修復してから再開（同じ状態で検証できないなら、先に直して混線を止める）。

### 11.4 initrd に `/init` が無いように見える

`head` で判断しない。

```bash
lsinitramfs ~/umu/umu_project/UmuOS-0.1.1/initramfs/initrd.img-6.18.1 | grep -E '^(init|bin/switch_root)$'
```

---

## 12. 作業のやり直し（安全なリセット手順）

「混ざった」と感じたら、次の順序で戻す。

1) QEMU を停止
2) `sudo e2fsck -f disk/disk.img`
3) 変更した箇所を1つに絞り、該当ステップだけ作り直す
   - 例：initramfs だけ作り直す → ISO 再生成 → 起動

---

## 付録A. 生成物の確認コマンド集（コピー用）

```bash
# initrd 中身（推奨）
lsinitramfs initramfs/initrd.img-6.18.1 | grep -E '^(init|bin/switch_root)$'

# disk.img のUUID
sudo blkid -p -o value -s UUID disk/disk.img

# disk.img の中身（注意：マウント済み確認）
sudo mount -o loop disk/disk.img /mnt/umuos011
findmnt /mnt/umuos011
sudo ls -l /mnt/umuos011/etc/shadow
sudo umount /mnt/umuos011

# ISO の存在
ls -lh UmuOS-0.1.1-boot.iso
```
