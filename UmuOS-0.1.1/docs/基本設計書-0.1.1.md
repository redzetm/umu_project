
# UmuOS-0.1.1 基本設計書

- 対象プロジェクト: `UmuOS-0.1.1/`
- 目的: ver0.1.1 を「いつでも戻れるベース版（安定点）」として確定する
- 重要方針: **動いたら成功ではない。理解・観測・検証が残って成功**
- 改訂日: 2025-12-28

---

## 1. 本基本設計の位置づけ

本基本設計は UmuOS-0.1.1 の「基本設計」を定義する。
ここでの基本設計は、実装詳細（コマンド全文やソース解説）よりも、以下を優先する。

- 成功条件（受入基準）を固定する
- システム構成（層/責務/境界）を固定する
- 観測点（ログの杭）と、実験運用ルール（混線防止）を固定する
- 失敗しやすい点を「仕様・手順」に落とし、再発を防ぐ

---

## 2. ゴール（受入基準）

### 2.1 成功の定義（必須）

0.1.1 の成功＝「開発環境の QEMU で再現でき、以下がすべて満たされる」

1) UEFI → GRUB → Linux kernel → initramfs（自作 init）→ 永続 ext4（disk.img）への `switch_root` が成立する
2) 最終的な `/` は ext4（disk.img）で、再起動してもファイルが保持される（永続性）
3) シリアル（ttyS0）で `root` / `tama` ユーザーのログインが成立する（まずはローカルシリアルで確定）

推奨（任意）:
- `/logs/boot.log` が ext4 側に存在し、再起動後も追記される（観測の永続化）

### 2.1.1 失敗の定義（不合格条件）

以下のいずれかに該当した場合、0.1.1 は失敗（受入不合格）とみなす。

- `switch_root` 後に、最終的な `/` が ext4（disk.img）になっていない
- 再起動後に、ファイル永続性が確認できない
- `root/tama` のログインが ttyS0 で成立しない

### 2.2 受入範囲（固定）

- 受入環境は **開発環境の QEMU** に限定する（virt-manager 等は受入に含めない）
- QEMU は **`accel=tcg` 前提**（KVM や `/dev/kvm` の有無は考慮対象外）
- 観測は **シリアル（ttyS0）を主**とする（起動確認の生命線）

### 2.3 非ゴール（0.1.1 ではやらない）

- LAN 直結ブリッジでの常用（必要時のみの追加検証に分離）
- telnet をベース版の必須条件にしない（最後に導入する機能として扱う）
- GUI（VGA）前提の受入（`-nographic`/`ttyS0` 前提）

### 2.4 固定パラメータ（0.1.1）

本基本設計では、再現性のために以下の値を固定する。

- Kernel version（KVER）: `6.18.1`
  - 理由: initramfs / devtmpfs / switch_root の挙動差分を排除するため
- ISO ファイル名: `UmuOS-0.1.1-boot.iso`
- kernel（ISO内）: `iso_root/boot/vmlinuz-6.18.1`
- initramfs（ISO内）: `iso_root/boot/initrd.img-6.18.1`
- kernel config（ISO内）: `iso_root/boot/config-6.18.1`

---

## 3. 設計思想（不変条件）

- UmuOS は「使うため」ではなく「理解するため」の OS
- 成功は “動作を説明できる観測点” と “再現できる手順” がセット
- 変更量が理解量を超えたら、たとえ動いても研究として失敗になり得る

言語方針:
- 現時点では C 言語を主に採用する（OS の内部挙動を直接観測するため）

---

## 4. システム構成（層と責務）

### 4.1 全体像（成果物とブートフロー）

#### 4.1.1 成果物一覧と役割

この節は「どの成果物が、どの層の責務を担うか」を先に固定する。

（A）設計上の成果物（ビルド成果物）

- `UmuOS-0.1.1-boot.iso`（ISOファイル名はプロジェクト内で固定する）
	- 役割: 起動媒体（UEFI→GRUB→kernel→initramfsへ繋ぐ）。受入で起動に用いる“配布物”

- `iso_root/`
	- 役割: ISO のルート（`grub-mkrescue` 等で ISO 化する入力）

- `iso_root/boot/grub/grub.cfg`
	- 役割: GRUB の起動メニューと kernel cmdline（`root=UUID=...` / `console=...` 等）を定義する

- `iso_root/boot/vmlinuz-6.18.1`
	- 役割: 起動する Linux kernel 本体（bzImage）

- `iso_root/boot/config-6.18.1`
	- 役割: 受入時点の kernel 設定（再現性の根拠）。起動に直接は不要だが、検証のために保持する

- `iso_root/boot/initrd.img-6.18.1`
	- 役割: initramfs（移行専用）。永続 ext4 を探して mount し、`switch_root` へ到達する

- `initramfs/src/init.c`
	- 役割: initramfs の `/init`（C実装）のソース。UUID→デバイス解決・mount・switch_root の中核

- `initramfs/rootfs/init`
	- 役割: initramfs 内で実行される `/init` 本体（`initramfs/src/init.c` を静的リンクでビルドした生成物）。
    `initrd.img-6.18.1` に格納され、起動時に最初に実行される

- `initramfs/rootfs/`
	- 役割: initramfs 生成元（cpio 生成前のルートFS）。BusyBox や `/init` を含む

- `initramfs/initrd.img-6.18.1`
	- 役割: `initramfs/rootfs/` から生成した initramfs 生成物（ISOへコピーする元）

- `disk/disk.img`
	- 役割: 永続 ext4（最終的な `/`）。`/etc`・ユーザー情報・（必要なら）ログを保持する
	- disk.img 内の必須成果物（例）:
		- `/etc/inittab`（BusyBox init の起動定義）
		- `/etc/init.d/rcS`（起動スクリプト。ここで mount やログ等を初期化する）
		- `/etc/passwd` / `/etc/shadow`（認証の正）
		- （推奨）`/logs/boot.log`（永続ログ）

- `run/OVMF_VARS_*.fd`（プロジェクト内に固定する）
	- 役割: UEFI 変数領域（起動の再現性のため、プロジェクト内で管理する）

#### 4.1.2 ブートフロー（論理）

```text
UEFI(OVMF)
	↓
	- UEFI変数: run/OVMF_VARS_*.fd
	↓
GRUB (ISO: UmuOS-0.1.1-boot.iso)
	- 設定: iso_root/boot/grub/grub.cfg
	↓  kernel cmdline: root=UUID=<DISK_UUID> console=tty0 console=ttyS0,115200n8
Linux kernel (iso_root/boot/vmlinuz-6.18.1)
	↓
initramfs (iso_root/boot/initrd.img-6.18.1)
	- 実行される /init: initramfs/rootfs/init（自作Cの生成物）
	- /dev/proc/sys を用意
	- root=UUID=<DISK_UUID> を解析
	- UUID一致するブロックデバイスを自前探索
	- /newroot に ext4 を mount
	- switch_root /newroot /sbin/init
	↓
ext4 ルート (disk/disk.img)
	- BusyBox init/getty/login
	- /etc/inittab /etc/init.d/rcS
	- /etc/passwd /etc/shadow
	- （推奨）/logs/boot.log 追記
```

### 4.2 層ごとの責務（混線防止のための分離）

#### ISO 層（ブート資産）
- 役割: GRUB で kernel と initrd を起動し、必要な cmdline を渡す
- 正とする成果物: `iso_root/boot/grub/grub.cfg`、kernel、initrd

#### initramfs 層（移行専用）
- 役割: 永続 ext4 を見つけて mount し、`switch_root` まで到達する
- やらない: ログイン、ネットワーク常用、永続 rootfs の構築

#### 永続 ext4 層（最終的な /）
- 役割: 最終的な `/` を提供する（init/getty/login/設定/ログ）
- 正とする設定: `/etc/inittab`、`/etc/init.d/rcS`、`/etc/passwd`、`/etc/shadow`、`/etc/umu/*`
- rcS の役割は「ログイン前の最低限の初期化」に限定する。 

---

## 5. 設計上の固定方針（前回失敗の仕様化）

### 5.1 1回の実験は1変数（運用規約）

ベース版を作るため、次を規約とする。

- 1回の実験で変更するのは 1 点だけ
- 変更の前後で「観測点（ログの杭）」がどう変わったかを文章で残す
- 途中中断（`^C`）した場合は、次に進む前に必ず “存在確認” に戻る

推奨の順序（固定）:
1. ネット無しで `UEFI→GRUB→kernel→initramfs→ext4→switch_root`
2. ネット無しで `root/tama` ログイン成功（シリアル）
3. 再起動後にファイル永続性が確認できる（disk.img の永続性）

推奨（任意）:
- 永続ログ（`/logs/boot.log`）は、採用する場合のみ 5.2 のルールに従う
- ネットワークについては、次回以降のバージョンで考えている

### 5.2 観測性（ログの杭）を仕様として固定

「止まった」ではなく「どこで止まったか」にする。

0.1.1 では「ログを取ること自体が新しい故障点にならない」ように、出力先とタイミングを固定する。

※永続ログ（`/logs/boot.log`）は 0.1.1 では推奨（任意）とする。採用する場合は、ログが新しい故障点にならないよう以下を守る。

- initramfs（/init）段階のログは **シリアル（ttyS0）へ必ず出す**（永続領域へは書かない）
- 永続ログ（`/logs/boot.log`）は **ext4（disk.img）を mount できた後**に rcS が追記する
- ログ追記に失敗しても **ブートを止めない**（警告を出して続行し、成功条件は別途観測で判断する）

initramfs（/init）が必ず出すログ例:
- `[init] cmdline parsed: root=UUID=...`
- `[init] devtmpfs mounted`
- `[init] root device found: /dev/...`
- `[init] mounted /newroot`
- `[init] switching root`

ext4 側 rcS が必ず出すログ例:
- `[rcS] start`
- `[rcS] mounted proc/sys/devpts`
- `[rcS] started getty`

### 5.3 失敗しやすい点トップ（対策を設計へ埋め込む）

1) `root=UUID=...` と disk.img の UUID 不一致
	- 対策: UUID は取得手順と反映手順を固定し、確認コマンドを受入前チェックに含める

2) initramfs 環境で `mount UUID=...` に依存すると失敗する
	- 対策: UUID→実デバイス名の解決は initramfs の自作 init が自前で行う

3) `/dev` が無くブロックデバイスが見えない
	- 対策: devtmpfs を必ず mount（kernel config と init の両方で担保）

4) 観測性不足で「止まって見える」
	- 対策: `console=tty0 console=ttyS0,115200n8` を固定、QEMU はシリアル出力で見る

5) ネットワーク検証が基盤（Proxmox等）へ波及
	- 対策: 受入の主経路はネット無しで固める。ネットワークは次回以降の追加検証で扱い、行う場合は NAT 優先、ブリッジは必要時のみ

---

## 6. 主要インタフェース（境界と入力）

### 6.1 kernel cmdline

- `root=UUID=<DISK_UUID>` を渡す（デバイス名依存を捨てる）
- 観測性のため `console=tty0 console=ttyS0,115200n8` を渡す

### 6.2 initramfs -> ext4

- initramfs は `/newroot` に ext4 を mount して `switch_root /newroot /sbin/init`
- ext4 側に `/sbin/init`（BusyBox init への symlink 等）が存在すること

---

## 7. 成果物（プロジェクト内）

この章は「どれが正で、どれが一時物か」を固定する。

### 7.1 期待するディレクトリ層

- ISO層: `iso_root/`
- initramfs層: `initramfs/`
- 永続ディスク層: `disk/disk.img`
- 実行/ログ層: `run/`, `logs/`（一時物が混ざりやすい）
	- 注意: `logs/` はプロジェクト側のログ置き場。`/logs` は UmuOS（disk.img）内のパス

### 7.2 永続 ext4（disk.img）側の必須ファイル

- `/sbin/init`（BusyBox init へのリンク等）
- `/etc/inittab`
- `/etc/init.d/rcS`
- `/etc/passwd`
- `/etc/shadow`（プレースホルダ禁止：ハッシュ確定が必須）

推奨（任意）:
- `/logs/boot.log`

---

## 8. 重要な作業ルール（“地雷”の設計反映）

### 8.1 BusyBox applet 生成ルール（ext4側）

開発機（作業環境の Linux）側で `disk.img` を `/mnt/...` にマウントした状態のまま applet を生成すると、
symlink が開発機側の絶対パスを指して壊れることがある（UmuOS 内のパスとして成立しない）。

0.1.1 の基本ルール:
- ext4 側の applet は **必ず chroot して**ゲスト基準のパスで生成する
- 生成後は `sh` 等の symlink が `/bin/busybox` を指すことを確認する

### 8.2 disk.img のマウント状態の見える化

- `mount: マウント済み` は「状態が壊れた」ではなく「再マウントしようとした」だけの場合がある
- 次に進む前に mount 状態を明示的に確認する（思い込みで進めない）

### 8.3 ext4 破損（fsck 必須状態）への運用

- ext4 に不整合が疑われる場合は、検証を止めて健全性を回復してから再開する
- “直したはずなのに直らない” 状態は、FS破損が混ざっている可能性を最優先で疑う

---

## 9. リスクと対策（最小）

- リスク: 変更点が多すぎて原因が混ざる
	- 対策: 1実験1変数、観測点固定、順序固定

- リスク: 観測不能（QEMU起動オプションの揺れ）
	- 対策: ベース形の QEMU 起動方式を 1つ固定し、変更は 1点だけ

- リスク: 認証が未確定で「半成功」を量産
	- 対策: `shadow` を単独フェーズで確定し、シリアルログイン成功をベース条件にする

---

## 10. 参考文献（前回の成果と課題）

本基本設計の根拠・詳細は以下を参照する。

- `docs/参考文献_前回の成果と課題/UmuOSver011詳細設計.md`
- `docs/参考文献_前回の成果と課題/実装ノート.md`
- `docs/参考文献_前回の成果と課題/ver0.1.1_失敗の振り返り.md`

