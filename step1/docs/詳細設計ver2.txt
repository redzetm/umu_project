
- 目的に直結 →          「最小限のカーネル＋BusyBox initramfsでQEMU起動確認」になっている
- 構成がシンプル →       BusyBox採用で systemd 問題を回避
- 成果物が明示 →         bzImage, initrd.img, grub.cfg, ISO が揃う
- 成功条件が明確 →       GRUB表示 → カーネル起動 → シェル操作



# 1. 環境準備

### 1.1 必要パッケージのインストール

bash

sudo apt update
sudo apt install -y build-essential bc bison flex libssl-dev \
  libelf-dev libncurses-dev dwarves git wget \
  grub-efi-amd64-bin grub-common xorriso mtools \
  qemu-system-x86 ovmf \
  cpio gzip busybox-static


### 1.2 ディレクトリ作成

bash
mkdir -p ~/umu/step1/{kernel,initramfs,iso_root/boot/grub,logs}


## 2. カーネルビルド

### 2.1 ソース取得

bash
cd ~/umu/step1/kernel
wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.58.tar.xz
tar -xf linux-6.6.58.tar.xz
cd linux-6.6.58

### 2.2 カーネル設定

bash
make mrproper           #カーネルソースツリーを完全にクリーンな状態にする
make defconfig          #コンフィグレーション生成

# 必要なら make menuconfig でカスタマイズ（今回はデフォルトで行きます）

cp .config ../config-6.6.58


### 2.3 ビルド

bash
make -j$(nproc)

# カーネルモジュールもビルド（今回はこの工程は無しとする）
make modules -j$(nproc)

### 2.4 成果物コピー

bash
cp arch/x86/boot/bzImage ~/umu/step1/iso_root/boot/vmlinuz-6.6.58
cp .config ~/umu/step1/iso_root/boot/config-6.6.58



## 3. initramfs（busybox版）作成

### 3.1 構造作成

bash
cd ~/umu/step1/initramfs
mkdir -p rootfs/{bin,sbin,etc,proc,sys,dev}
cp /usr/bin/busybox rootfs/bin/
cd rootfs/bin
for cmd in sh mount umount ls cat mkdir cp mv rm chmod ln chown grep sed; do
  ln -s busybox $cmd
done
cd ~/umu/step1/initramfs


### 3.2 initスクリプト作成

GRUBからカーネル起動し、カーネルが初期化時、メモリ管理やデバイス検出など、カーネル内部の
初期化が行われる。
ここで「rootファイルシステム」をマウントする。
initramfsを使う場合はその中の /init が最初に実行される。
カーネルは最初のユーザランドプロセスとして 
/sbin/init（またはinitramfs内の /init）を実行する。
RHEL6系のinit処理に近いです。
systemd の代替品というよりは、
「systemd に渡す前段階」や「systemd がない環境で最低限動かすための簡易 init」 という理解が正しいです。

sh
// filepath: ~/umu/step1/initramfs/rootfs/init
#!/bin/sh
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev
echo "Umu Project Emergency Shell"
exec /bin/sh


chmod +x rootfs/init
※パーミッション755でもよいです。


3.3 cpioアーカイブ作成

cd rootfs
find . | cpio -o -H newc | gzip > ../initrd.img-6.6.58
cd ..
cp initrd.img-6.6.58 ../iso_root/boot/


4. GRUB設定

// filepath: ~/umu/step1/iso_root/boot/grub/grub.cfg

set timeout=10
set default=0

menuentry "Umu Project Linux 6.6.58" {
  linux /boot/vmlinuz-6.6.58 ro console=tty1 console=ttyS0,115200
  initrd /boot/initrd.img-6.6.58
}

＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃　　ここまでできた　　＃＃＃＃＃＃＃＃＃＃＃＃＃＃

5. ISOイメージ作成

cd ~/umu/step1
grub-mkrescue -o step1-boot.iso iso_root


6. QEMU検証

cd ~/umu/step1
qemu-system-x86_64 \
  -enable-kvm \
  -m 2048 \
  -cdrom step1-boot.iso \
  -serial file:logs/serial.log \
  -nographic



7. 成功条件

GRUBメニューが表示される
カーネルが起動し、initramfsのシェルが表示される
シェルで ls / や cat /proc/cmdline などが動作する


8. トラブルシューティング

GRUBが表示されない → ISO作成手順・GRUB設定を再確認
シェルが出ない → initramfsの構成・initスクリプトを再確認
コマンドが動かない → busyboxリンク・initramfs構成を再確認









































































