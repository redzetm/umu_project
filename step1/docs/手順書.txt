Step1プロジェクト 実装手順書

目次
環境準備
カーネルビルド
initramfs 作成
GRUB設定
ブータブルイメージ作成
QEMU検証
トラブルシューティング

＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃

1. 環境準備
1.1 必要なパッケージのインストール
# 基本開発ツール
sudo apt update
sudo apt install -y build-essential bc bison flex libssl-dev \
  libelf-dev libncurses-dev dwarves git wget

# GRUB関連（UEFI対応）
sudo apt install -y grub-efi-amd64-bin grub-common xorriso mtools

# QEMU + OVMF（UEFI firmware）
sudo apt install -y qemu-system-x86 ovmf

# initramfs作成ツール
sudo apt install -y cpio gzip dracut busybox-static


ディレクトリ作成

~/umu/step1/
├── kernel/          # カーネルソースとビルド成果物
├── initramfs/       # initramfs作成作業領域
├── grub/            # GRUB設定ファイル
├── iso_root/        # ISO作成用ルート
│   └── boot/
│       ├── grub/
│       ├── vmlinuz
│       └── initrd.img
└── logs/            # 検証ログ保存場所


2. カーネルビルド

2.1 カーネルソース取得
cd ~/umu/step1/kernel

# Linux 6.x 最新版をダウンロード（例: 6.6.x LTS）
wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.58.tar.xz
tar -xf linux-6.6.58.tar.xz
cd linux-6.6.58

2.2 カーネル設定（.config作成）※make defconfigかmake memuconfigを実施
                               最初はdefconfigでデフォルト構成が無難と思った
                               カスタムするときは、memuconfigでいいかな。
2.2 カーネル設定（.config作成）

cd ~/umu/step1/kernel/linux-6.6.58

# 念のため完全にクリーンアップ
make mrproper

# デフォルト設定をベースに作成
make defconfig

# 設定を確認
make kernelrelease
# 出力: 6.6.58 ← このまま進める

# 必須設定を有効化（任意・カスタマイズする場合）
# make menuconfig

# 設定保存
cp .config ~/umu/step1/kernel/config-6.6.58

# 必須設定を有効化（メニュー形式）
# ※今回はdefconfigベースで進めるが、カスタマイズする場合は以下を実行
make menuconfig

必須設定項目（参考）:

[*] 64-bit kernel
    General setup --->
        [*] Initial RAM filesystem and RAM disk (initramfs/initrd) support
        [*] Support initial ramdisk/ramfs compressed using gzip
        (-custom) Local version - append to kernel release  ← 既に設定済み
    
    Device Drivers --->
        Generic Driver Options --->
            [*] Maintain a devtmpfs filesystem to mount at /dev
            [*] Automount devtmpfs at /dev
        Block devices --->
            <*> RAM block device support
        SCSI device support --->
            <*> SCSI disk support
        Serial ATA and Parallel ATA drivers --->
            <*> AHCI SATA support
        Graphics support --->
            Console display driver support --->
                [*] Framebuffer Console support
                [*] VGA text console
    
    File systems --->
        <*> The Extended 4 (ext4) filesystem
        <*> Btrfs filesystem (任意)
        Pseudo filesystems --->
            [*] /proc file system support
            [*] sysfs file system support
            [*] Tmpfs virtual memory file system support

# 設定保存
cp .config ~/umu/step1/kernel/config-6.6.58-custom


2.3 カーネルビルド

cd ~/umu/step1/kernel/linux-6.6.58

# コア数を自動検出して並列ビルド
make -j$(nproc)

# カーネルモジュールもビルド
make modules -j$(nproc)

# ビルド成果物を確認
ls -lh arch/x86/boot/bzImage

# 成果物をコピー
cp arch/x86/boot/bzImage ~/umu/step1/iso_root/boot/vmlinuz-6.6.58
cp .config ~/umu/step1/iso_root/boot/config-6.6.58

※ビルド時間の目安: 10〜30分（環境による）


3. initramfs 作成
3.1 方法A: dracut を使う（coreutils版・推奨）

cd ~/umu/step1/initramfs

# カーネルモジュールディレクトリを準備
sudo make -C ~/umu/step1/kernel/linux-6.6.58 modules_install \
  INSTALL_MOD_PATH=$PWD/modules

# dracut で initramfs 生成（systemd を完全除外）
dracut --kver 6.6.58 \
  --kmoddir $PWD/modules/lib/modules/6.6.58 \
  --no-hostonly \
  --omit "systemd systemd-initrd busybox plymouth" \
  --add "bash drm" \
  --install "/usr/bin/bash /usr/bin/mount /usr/bin/umount /usr/bin/cp /usr/bin/mv /usr/bin/mkdir /usr/bin/cat /usr/bin/ls /usr/bin/chmod /usr/bin/ln /usr/bin/rm /usr/bin/chown /usr/bin/grep /usr/bin/sed" \
  --add-drivers "ahci sd_mod ext4 virtio_blk virtio_scsi virtio_pci" \
  --force \
  initrd.img-6.6.58

# 成果物をコピー
cp initrd.img-6.6.58 ~/umu/step1/iso_root/boot/


# 補足説明:
# --no-hostonly              : ホスト固有の設定を含めない（汎用性向上）
# --omit "systemd..."        : systemd/busybox/plymouth を除外
# --add "bash drm"           : bash とグラフィックドライバを追加
# --install "/usr/bin/..."   : coreutils のコマンドを明示的に含める
# --add-drivers              : QEMU/KVM 用ドライバ（virtio_pci を追加）

# initramfs の中身を確認（systemd が除外されているか検証）
mkdir -p ~/umu/step1/initramfs/extracted
cd ~/umu/step1/initramfs/extracted
gunzip < ~/umu/step1/iso_root/boot/initrd.img-6.6.58 | cpio -idmv > ../initramfs-contents.txt

# systemd が除外されているか確認
find . -name "*systemd*" | wc -l
# 出力が 0 であることを確認（systemd が含まれていない）

# コマンドの実体を確認（coreutils か busybox かを判定）
file usr/bin/ls usr/bin/cp usr/bin/mount
# coreutils の場合: ELF 64-bit LSB pie executable, x86-64
# busybox の場合: symbolic link to busybox

# サイズ確認
du -sh .
# systemd なし coreutils 版: 約 30-50MB
# systemd あり coreutils 版: 約 80-120MB
# busybox 版: 約 10-20MB




＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃
3.2 方法B: 手動作成（最小構成・学習向け）※これだとBusyBox使うから今回は3.2方法Bは、やらない

cd ~/umu/step1/initramfs
mkdir -p rootfs/{bin,sbin,etc,proc,sys,dev,mnt/root}

# busybox を配置
cp /bin/busybox rootfs/bin/
cd rootfs/bin
for cmd in sh mount umount switch_root; do
  ln -s busybox $cmd
done
cd ~/umu/step1/initramfs

# init スクリプト作成
cat > rootfs/init << 'EOF'
#!/bin/sh
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev

# root パーティション検出（UUID指定の場合）
ROOT_UUID="YOUR-ROOT-UUID"
ROOT_DEV=$(blkid -U $ROOT_UUID)

if [ -n "$ROOT_DEV" ]; then
  mount -o ro $ROOT_DEV /mnt/root
  umount /proc
  umount /sys
  umount /dev
  exec switch_root /mnt/root /sbin/init
else
  echo "ERROR: Root device not found!"
  exec /bin/sh
fi
EOF

chmod +x rootfs/init

# cpio アーカイブ作成
cd rootfs
find . | cpio -o -H newc | gzip > ../../iso_root/boot/initrd.img-6.6.58-custom
cd ~/umu/step1
＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃

initramfs 中身リスト保存:

mkdir -p ~/umu/step1/initramfs/extracted
cd ~/umu/step1/initramfs/extracted
gunzip < ~/umu/step1/iso_root/boot/initrd.img-6.6.58-custom | cpio -idmv > ../initramfs-contents.txt



4. GRUB設定
4.1 grub.cfg 作成

mkdir -p ~/umu/step1/iso_root/boot/grub

cat > ~/umu/step1/iso_root/boot/grub/grub.cfg << 'EOF'
set timeout=10
set default=0

menuentry "Umu Project - Custom Linux 6.6.58 (Normal Mode)" {
  insmod gzio
  insmod part_gpt
  insmod ext2
  
  # rd.shell を追加: エラー時に緊急シェルを起動
  linux /boot/vmlinuz-6.6.58 ro console=tty1 console=ttyS0,115200 rd.shell
  initrd /boot/initrd.img-6.6.58
}

menuentry "Umu Project - Custom Linux 6.6.58 (Debug Mode)" {
  insmod gzio
  insmod part_gpt
  insmod ext2
  
  # rd.debug を追加: dracut のデバッグログを有効化
  linux /boot/vmlinuz-6.6.58 ro console=tty1 console=ttyS0,115200 debug loglevel=7 rd.debug rd.shell
  initrd /boot/initrd.img-6.6.58
}
EOF

# 補足説明:
# rd.shell  : ルートデバイスが見つからない場合に緊急シェルを起動
# rd.debug  : dracut の詳細ログを出力（デバッグモードのみ）



UUID の取得方法（実機/VM ディスクがある場合）:

# ルートパーティションの UUID 確認
sudo blkid | grep 'TYPE="ext4"'
# 出力例: /dev/sda2: UUID="a1b2c3d4-..." TYPE="ext4"

# grub.cfg 内の REPLACE-WITH-YOUR-UUID を実際の UUID に置換
sed -i 's/REPLACE-WITH-YOUR-UUID/a1b2c3d4-.../g' ~/umu/step1/iso_root/boot/grub/grub.cfg


5. ブータブルイメージ作成
5.1 ISO イメージ作成（UEFI対応）

cd ~/umu/step1

# GRUB EFI ブートローダーを含む ISO 作成
grub-mkrescue -o step1-boot.iso iso_root


5.2 ISO 内容確認

# ISO の中身を確認
isoinfo -i step1-boot.iso -l | less

# 特に以下が存在するか確認
isoinfo -i step1-boot.iso -l | grep -E '(vmlinuz|initrd|grub.cfg|BOOTX64.EFI)'


6. QEMU検証
6.1 UEFI（OVMF）での起動テスト

cd ~/umu/step1

# ログディレクトリを作成（存在しない場合）
mkdir -p logs

# OVMF パスを確認
OVMF_CODE=/usr/share/OVMF/OVMF_CODE.fd
OVMF_VARS=/usr/share/OVMF/OVMF_VARS.fd

# OVMF 変数用コピー作成（書き込み可能に）
cp $OVMF_VARS OVMF_VARS_custom.fd

# QEMU 起動（シリアルログ保存）
qemu-system-x86_64 \
  -enable-kvm \
  -m 2048 \
  -cdrom step1-boot.iso \
  -drive if=pflash,format=raw,readonly=on,file=$OVMF_CODE \
  -drive if=pflash,format=raw,file=OVMF_VARS_custom.fd \
  -serial file:logs/serial-$(date +%Y%m%d-%H%M%S).log \
  -nographic

終了方法: Ctrl + A → C → quit → Enter



6.2 期待される動作
✅ GRUB メニュー表示 (10秒)
✅ タイムアウト後に自動起動 (デフォルトエントリ)
✅ カーネル起動ログ (dmesg 相当が表示される)
✅ initramfs 実行
✅ 緊急シェルプロンプトが表示される

期待される出力例:

[    0.000000] Linux version 6.6.58 (tama@umu) ...
[    0.123456] Command line: ro console=tty1 console=ttyS0,115200 rd.shell
[    0.234567] Kernel command line: ro console=tty1 console=ttyS0,115200 rd.shell
[    1.234567] dracut: Mounted root filesystem /dev/root
[    1.345678] dracut: Switching root
[    2.123456] dracut: No root device specified or root device not found
[    2.234567] dracut: Dropping to debug shell.

dracut:/# _  ← ここで緊急シェルプロンプトが出れば成功

注意事項:
- ISO 起動環境では、永続的なルートファイルシステムがないため、
  systemd のログインプロンプトは表示されません
- initramfs の緊急シェル (dracut:/#) が起動すれば成功です
- シェル内で以下のコマンドが動作することを確認してください:
  dracut:/# ls /
  dracut:/# cat /proc/cmdline
  dracut:/# mount | grep -E '(proc|sys|dev)'
  dracut:/# lsmod




7. トラブルシューティング
7.1 GRUB メニューが表示されない
症状: QEMU が起動するが GRUB が出ない

確認:
# ISO 内の EFI ファイル確認
isoinfo -i step1-boot.iso -l | grep -i 'efi/boot'

# 手動マウントして確認
mkdir -p /tmp/iso_check
sudo mount -o loop step1-boot.iso /tmp/iso_check
ls -la /tmp/iso_check/EFI/BOOT/
sudo umount /tmp/iso_check


対処:
grub-mkrescue 再実行
grub-efi-amd64-bin が正しくインストールされているか確認


7.2 カーネルパニック（Kernel Panic）
症状: initramfs 後に "Kernel panic - not syncing: VFS: Unable to mount root fs"

原因: root= 指定が間違っている / initramfs に必要なドライバがない

対処:
# UUID 確認
sudo blkid

# initramfs にドライバを追加（dracut の場合）
dracut --add-drivers "ahci sd_mod ext4 virtio_blk virtio_scsi" --force initrd.img-6.6.58-custom

# ISO 再作成
cp initrd.img-6.6.58-custom ~/umu/step1/iso_root/boot/
grub-mkrescue -o step1-boot.iso iso_root



7.3 緊急シェルプロンプトが出ない
症状: カーネルは起動するが dracut のシェルが表示されない

確認手順:

1. シリアルログを確認
cd ~/umu/step1/logs
cat serial-*.log | grep -E "(dracut|Kernel panic|systemd)"

2. initramfs の中身を確認
cd ~/umu/step1/initramfs/extracted

# init スクリプトが存在するか
ls -la init
# 出力例: -rwxr-xr-x 1 root root 12345 ... init

# systemd が除外されているか確認
find . -name "*systemd*" | wc -l
# 出力が 0 であることを確認（systemd が含まれていない）

# dracut モジュールが正しいか確認
ls -la usr/lib/dracut/modules.d/
# 90kernel-modules/, 99base/ などが存在することを確認

3. カーネルパラメータを確認
# ISO を QEMU で起動し、GRUB メニューで 'e' を押して編集
# linux /boot/vmlinuz... の行に rd.shell が含まれているか確認

対処方法:

# dracut を再実行（systemd を明示的に除外）
cd ~/umu/step1/initramfs
dracut --kver 6.6.58 \
  --kmoddir $PWD/modules/lib/modules/6.6.58 \
  --no-hostonly \
  --omit "systemd systemd-initrd busybox plymouth" \
  --add "bash drm" \
  --install "/usr/bin/bash /usr/bin/mount /usr/bin/umount /usr/bin/ls /usr/bin/cat /usr/bin/mkdir /usr/bin/cp /usr/bin/mv /usr/bin/chmod /usr/bin/ln /usr/bin/rm /usr/bin/chown /usr/bin/grep /usr/bin/sed" \
  --add-drivers "ahci sd_mod ext4 virtio_blk virtio_scsi virtio_pci" \
  --force \
  initrd.img-6.6.58

# 成果物をコピー
cp initrd.img-6.6.58 ~/umu/step1/iso_root/boot/

# grub.cfg に rd.shell が含まれているか確認
cat ~/umu/step1/iso_root/boot/grub/grub.cfg | grep rd.shell
# 出力例: linux /boot/vmlinuz-6.6.58 ro console=tty1 console=ttyS0,115200 rd.shell


# ISO 再作成
cd ~/umu/step1
grub-mkrescue -o step1-boot.iso iso_root

# QEMU で再テスト
mkdir -p logs
qemu-system-x86_64 \
  -enable-kvm \
  -m 2048 \
  -cdrom step1-boot.iso \
  -drive if=pflash,format=raw,readonly=on,file=/usr/share/OVMF/OVMF_CODE.fd \
  -drive if=pflash,format=raw,file=OVMF_VARS_custom.fd \
  -serial file:logs/serial-$(date +%Y%m%d-%H%M%S).log \
  -nographic



7.4 シリアルログが空
症状: logs/ 内のファイルが空またはサイズ0

対処:
# -nographic を外してグラフィカルモードで確認
qemu-system-x86_64 \
  -enable-kvm \
  -m 2048 \
  -cdrom step1-boot.iso \
  -drive if=pflash,format=raw,readonly=on,file=/usr/share/OVMF/OVMF_CODE.fd \
  -serial mon:stdio




8. 成功条件チェックリスト
 ✅ GRUB メニューが表示される
 ✅ timeout（10秒）経過後に自動起動する
 ✅ カーネルが initramfs をロードする
 ✅ dracut の init スクリプトが実行される
 ✅ 緊急シェルプロンプト (dracut:/#) が表示される
 ✅ logs/serial-*.log にカーネルパニックがない
 ✅ シェルで基本コマンド (ls, cat, mount) が動作する
 ✅ 手動選択（Enter）でも起動できる
 ✅ 3回連続で再現性がある

注意事項:
- systemd を除外したため、ログインプロンプト (localhost login:) は表示されません
- 緊急シェル (dracut:/#) が起動すれば成功です
- シェル内で以下のコマンドが動作することを確認してください:

  dracut:/# ls /
  bin  dev  etc  init  lib  lib64  proc  root  run  sbin  sys  tmp  usr  var

  dracut:/# cat /proc/cmdline
  ro console=tty1 console=ttyS0,115200 rd.shell

  dracut:/# mount | grep -E '(proc|sys|dev)'
  proc on /proc type proc (rw,relatime)
  sysfs on /sys type sysfs (rw,relatime)
  devtmpfs on /dev type devtmpfs (rw,relatime,size=...)

  dracut:/# lsmod | head -5
  Module                  Size  Used by
  virtio_scsi            20480  0
  virtio_blk             20480  0
  ext4                  786432  0
  ...

  dracut:/# file /usr/bin/ls
  /usr/bin/ls: ELF 64-bit LSB pie executable, x86-64 ...

- ISO 起動環境では root デバイスがないため、これ以上先に進むことはできません
- この状態で「成功」と判断してください



 9. 成果物一覧

~/umu/step1/
├── kernel/
│   ├── linux-6.6.58/                 # カーネルソースツリー
│   │   ├── .config                   # ビルド時の設定
│   │   └── arch/x86/boot/bzImage     # カーネルイメージ（ビルド成果物）
│   ├── linux-6.6.58.tar.xz           # ダウンロードしたアーカイブ
│   └── config-6.6.58                 # 保存した設定（バックアップ）
├── initramfs/
│   ├── modules/                      # カーネルモジュール（一時ディレクトリ）
│   │   └── lib/modules/6.6.58/
│   ├── extracted/                    # initramfs 展開内容（検証用）
│   ├── initramfs-contents.txt        # initramfs ファイルリスト
│   └── initrd.img-6.6.58             # 生成された initramfs
├── iso_root/
│   └── boot/
│       ├── vmlinuz-6.6.58            # カーネルイメージ（コピー）
│       ├── initrd.img-6.6.58         # initramfs（コピー）
│       ├── config-6.6.58             # カーネル設定（コピー）
│       └── grub/
│           └── grub.cfg              # GRUB メニュー設定
├── logs/
│   └── serial-YYYYMMDD-HHMMSS.log    # QEMU 起動ログ（複数）
├── step1-boot.iso                    # 最終成果物（ブータブルISO）
└── OVMF_VARS_custom.fd               # UEFI 変数（テスト用、書き込み可能）

重要な成果物:
- step1-boot.iso: QEMU で直接起動可能な ISO イメージ
- logs/serial-*.log: 起動ログ（トラブルシューティング用）
- kernel/config-6.6.58: カーネルビルド設定（再現性確保）
- initramfs/initramfs-contents.txt: initramfs の内容一覧





