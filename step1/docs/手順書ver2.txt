Step1プロジェクト 実装手順書ver2

＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃　前回の失敗の洗い出し　＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃

1. プロジェクト目的・方針の不明確さ

目的が不明確	
    Step1 で何を達成したいのか（最小起動？学習？実運用？）が明示されていない
coreutils vs busybox の混在	
    3.1（coreutils）と 3.2（busybox）が併記され、どちらを推奨するか不明
手順の優先順位なし	
    複数の方法が並列に書かれており、初心者はどれを選ぶべきか判断できない

2. カーネル設定関連

-custom サフィックスの混乱	
    config-6.6.58-custom と config-6.6.58 のどちらを使うべきか不明確
バージョン表記の不統一	
    手順書内で 6.6.58 と 6.6.58-custom が混在している
LOCALVERSION 重複警告	
    .config に複数の LOCALVERSION 設定があり、ビルド時に警告が出る
config-6.6.58/ ディレクトリの誤作成	
    cp .config config-6.6.58/ でファイルではなくディレクトリが作成された
make olddefconfig の動作不明	
    既存の .config がどう処理されるか説明されていない

3. Git 管理関連

.gitignore の不在	
    初期状態で .gitignore が存在せず、ビルド成果物も追跡対象になる
カーネルソースが Git に追加される	
    linux-6.6.58/（約1.5GB）や *.tar.xz（約140MB）が大量にコミット対象になる
除外ファイルの判断基準不明	
    何を Git 管理すべきか、何を除外すべきか明確な基準が示されていない

4. initramfs 作成関連（dracut）


systemd 除外が困難	
    dracut の --omit "systemd" が効かない（udev が systemd に依存）
--omit オプションの限界	
    --omit を指定しても依存関係により systemd ライブラリが含まれる
圧縮形式が環境依存	
    gzip/zstd/非圧縮のどれが使われるか実行環境に依存し、予測不可能
--install の挙動不明	
    指定したコマンドが含まれない場合があり、原因が分からない
udev と systemd の依存関係	
    udev が systemd ライブラリ（libsystemd.so）に依存しているため完全除外が困難

5. initramfs 展開・検証関連

非圧縮 cpio への対応不足	
    dracut が非圧縮 cpio を生成した場合、gunzip で展開できない
cpio で early_cpio のみ展開	
    cpio -idmv でマイクロコード（early_cpio）のみ展開され、本体が展開されない
lsinitrd の存在が不明	
    lsinitrd コマンドの存在や使い方が説明されていない
複数 cpio 連結構造の説明不足	
    initramfs が「early_cpio + メイン cpio」の連結形式であることが説明されていない

6. 手順書の記述不足

ディレクトリ構造が不明	
    ~/umu/step1/ 配下の構成が冒頭に示されていない
期待される出力が不明	
    コマンド実行後の「成功時のメッセージ」が示されていない
エラー時の対処法なし	
    コマンドが失敗した場合の切り分け方法・対処法が書かれていない
ビルド時間の目安なし	
    make -j$(nproc) が何分かかるか示されていない（10〜30分）
リソース要件が不明	
    メモリ使用量（2GB以上推奨）やディスク容量（約3GB）の目安がない
前提条件の不足	
    「Ubuntu 24.04 を想定」などの環境情報が書かれていない

7. 検証手順の不足

中間成果物の確認方法なし	
    bzImage や initrd.img が正しく生成されたか確認する手順がない
ISO 構造の事前確認なし	
    QEMU で起動する前に ISO の構造を確認する手順がない
ログの保存場所が不明	
    QEMU のシリアルログをどこに保存すべきか指定されていない

8. トラブルシューティングの不足

systemd 混入時の対処なし	
    systemd が含まれてしまった場合の対処法が書かれていない
エラーメッセージの解説なし	
    よくあるエラー（not in gzip format など）の原因と対処が書かれていない
切り分け方法が不明	
    問題が「カーネル」「initramfs」「GRUB」のどこにあるか判断する方法がない

9. 用語・概念の説明不足

initramfs の役割不明	
    なぜ initramfs が必要なのか、何をするものなのか説明されていない
GRUB 設定項目の意味不明	
    insmod gzio, rd.shell, console=ttyS0 などの意味が不明
UEFI vs BIOS の違い不明
	なぜ OVMF が必要なのか、BIOS との違いが説明されていない
INSTALL_MOD_PATH の意味不明	
    make modules_install で何が起きるのか分からない
make olddefconfig の説明なし	
    カーネル設定がどう更新されるのか説明されていない

＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃　↑↑↑↑↑　前回の失敗の洗い出し　↑↑↑↑↑　＃＃＃＃＃＃＃＃＃＃＃＃＃＃＃


# Step1プロジェクト 実装手順書（新規・最小構成版）

- 目的に直結 →          「最小限のカーネル＋BusyBox initramfsでQEMU起動確認」になっている
- 構成がシンプル →       BusyBox採用で systemd 問題を回避
- 成果物が明示 →         bzImage, initrd.img, grub.cfg, ISO が揃う
- 成功条件が明確 →       GRUB表示 → カーネル起動 → シェル操作


---

## 1. 環境準備

### 1.1 必要パッケージのインストール

```bash
sudo apt update
sudo apt install -y build-essential bc bison flex libssl-dev \
  libelf-dev libncurses-dev dwarves git wget \
  grub-efi-amd64-bin grub-common xorriso mtools \
  qemu-system-x86 ovmf \
  cpio gzip busybox-static
```

### 1.2 ディレクトリ作成

```bash
mkdir -p ~/umu/step1/{kernel,initramfs,iso_root/boot/grub,logs}
```

---

## 2. カーネルビルド

### 2.1 ソース取得

```bash
cd ~/umu/step1/kernel
wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.58.tar.xz
tar -xf linux-6.6.58.tar.xz
cd linux-6.6.58
```

### 2.2 カーネル設定

```bash
make mrproper
make defconfig
# 必要なら make menuconfig でカスタマイズ
cp .config ../config-6.6.58
```

### 2.3 ビルド

```bash
make -j$(nproc)
```

### 2.4 成果物コピー

```bash
cp arch/x86/boot/bzImage ~/umu/step1/iso_root/boot/vmlinuz-6.6.58
cp .config ~/umu/step1/iso_root/boot/config-6.6.58
```

---

## 3. initramfs（busybox版）作成

### 3.1 構造作成

```bash
cd ~/umu/step1/initramfs
mkdir -p rootfs/{bin,sbin,etc,proc,sys,dev}
cp /usr/bin/busybox rootfs/bin/
cd rootfs/bin
for cmd in sh mount umount ls cat mkdir cp mv rm chmod ln chown grep sed; do
  ln -s busybox $cmd
done
cd ~/umu/step1/initramfs
```

### 3.2 initスクリプト作成

````sh
// filepath: ~/umu/step1/initramfs/rootfs/init
#!/bin/sh
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev
echo "Umu Project Emergency Shell"
exec /bin/sh


chmod +x rootfs/init


3.3 cpioアーカイブ作成

cd rootfs
find . | cpio -o -H newc | gzip > ../initrd.img-6.6.58
cd ..
cp initrd.img-6.6.58 ../iso_root/boot/



4. GRUB設定

// filepath: ~/umu/step1/iso_root/boot/grub/grub.cfg
set timeout=10
set default=0

menuentry "Umu Project Linux 6.6.58" {
  linux /boot/vmlinuz-6.6.58 ro console=tty1 console=ttyS0,115200
  initrd /boot/initrd.img-6.6.58
}


5. ISOイメージ作成

cd ~/umu/step1
grub-mkrescue -o step1-boot.iso iso_root


6. QEMU検証

cd ~/umu/step1
qemu-system-x86_64 \
  -enable-kvm \
  -m 2048 \
  -cdrom step1-boot.iso \
  -serial file:logs/serial.log \
  -nographic



7. 成功条件

GRUBメニューが表示される
カーネルが起動し、initramfsのシェルが表示される
シェルで ls / や cat /proc/cmdline などが動作する


8. トラブルシューティング

GRUBが表示されない → ISO作成手順・GRUB設定を再確認
シェルが出ない → initramfsの構成・initスクリプトを再確認
コマンドが動かない → busyboxリンク・initramfs構成を再確認




