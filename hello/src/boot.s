; src/boot.s
; 今回のプロジェクトでは src/boot.s がカーネルのエントリコードであり、
; GRUBがロードする ELF バイナリの主要な中身となります。
; .multiboot ヘッダと _start（最初に実行されるコード）を定義し、
; スタック設定や最低限の初期化、描画処理呼び出しを行います。
; ただし厳密には「カーネル全体」ではなく「カーネルの最初に実行されるブート／初期化コード」です。
; カーネル機能を拡張するには、C/アセンブリの追加ファイルをリンクして kernel ELF を大きくします。
; 単一ファイルで完結させればそれがそのままカーネルです。
; 補足:
; このファイルが PID1（ユーザーランド init）を起動する仕組みは含みません。
; 今回は単に画面表示して停止する「簡易カーネル」です。
; 将来的にユーザランド init を作るなら、カーネル（このファイルを含む）で
; プロセス起動機構や rootfs マウントなどを実装する必要があります。

; 32ビットモードで動作するコードセクションを定義(アセンブル時の設定)
bits 32

; マルチブートヘッダの定義だが、いろいろなboot方法がある
section .multiboot
  
  align 4   ; マルチブートヘッダーのアライメント

  ;MULTIBOOT_HEADER_MAGIC
  ; マルチブートであることを示すマジックナンバー（固定値で決められてる）
  dd 0x1BADB002        
  
  ; FLAGS (mem info + video)
  ; メモリ情報とビデオ情報を要求するフラグ（これも固定値で決められている）
  dd 0x00000003        
  
  ;データの整合性を確認するためのチェックサムを処理
  dd -(0x1BADB002 + 0x00000003)

section .text      ; カーネルコードセクションの開始。このセクションは結構重要だからもう少し詳しく説明する。
                   ; .text セクションは実行可能なコードを含むセクションであり、
                   ; カーネルのエントリポイント（_start ラベル）がここに配置される。
                   ; 32ビットモードで動作するコードを含むため、アセンブル時に bits 32 指示子が使用されている。
                   ; このセクションはリンカスクリプトで指定されたアドレスにロードされ、
                   ; GRUB がカーネルを起動する際に最初に実行されるコードがここに含まれる。


global _start


extern draw_ascii

_start:
  ; スタックセット（リンクスクリプトに合わせる）
  cli
  mov  esp, 0x90000
  mov  ebp, esp
  sti

  ; BSSクリア（省略ならここに追加）

  call draw_ascii

.hang:
  jmp .hang
; ...existing code...
