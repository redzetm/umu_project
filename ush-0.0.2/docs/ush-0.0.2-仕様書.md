# ush-0.0.2-仕様書.md
UmuOS User Shell (ush) — 仕様書（0.0.2 / MVP）  
Target OS: UmuOS-0.1.6-dev  

---

# 1. 概要
ush（ウッシュ）は **UmuOS の対話型ユーザーシェル**として設計される。

既存の `/bin/sh`（BusyBox）は以下の用途で継続利用する：

- `/bin/sh` → サーバーソフト・スクリプト実行用（BusyBox sh）
- `/umu_bin/ush` → ユーザー向け対話シェル（本仕様で実装）
  - UmuOS の PATH 方針（`/umu_bin:/sbin:/bin`）に合わせる

ush は **最小限・高速・シンプル・教育的** を理念とし、UmuOS の世界観に沿った独自性を持つ。

0.0.2 MVP では「Bシェルチックな最小実用」を目標に、パイプ `|` とリダイレクト（`<` `>` `>>`）を追加する。

---

# 2. 哲学
ush の設計思想は以下の通り。

- **最小限・高速・シンプル**
- **教育的で読みやすいコード**
- **UmuOS の世界観に沿った独自性**
- **POSIX 互換性は追わない**
  - ただし将来 Apache などを動かすために `/bin/sh`（BusyBox）を残す
- **MVP(ミニマム・バイアブル・プロダクト) ＝　価値が成立する最小の構造を目指す**

未対応構文は「検出してエラー」に倒し、誤動作よりも観測可能性（どこで失敗したかが分かる）を優先する。

ush は「ユーザー向けの対話シェル」であり、POSIX sh とは役割を分離する。

---

# 3. ビルド方針
- **musl-gcc による静的リンクビルド**
  - glibc に依存しない自己完結バイナリを生成する
  - Alpine Linux と同様の軽量・堅牢な構成を目指す

- **開発ホストで静的リンクビルドして持ち込む**
  - UmuOS 上でのビルドは MVP 対象外とする
  - 生成物は単一バイナリとして完結させ、環境依存を最小限にする
  - 静的リンクが難しい場合でも、MVP では動的リンクへのフォールバックは行わない

例：
musl-gcc -static -o ush main.o ...

---

# 4. MVP（ミニマム・バイアブル・プロダクト）
ush の MVP は「最小限の実用性を持つ最初の完成形」とする。

## 4.1 MVPで実装する機能
### ✔ 入力処理
- プロンプト表示
- 標準入力から1行取得
- EOF（Ctrl-D）で終了
- 空行・空白だけの行は何もせず再プロンプト

### ✔ トークナイズ（parser）
- 空白（スペース/タブ）区切り
- 連続空白は1つの区切りとして扱う（先頭/末尾空白は無視）
- 行頭の `#`（先頭の空白は許容）をコメントとして無視
- 対応（MVP最小）: シングルクォート（`'...'`）
  - 囲まれた範囲はそのまま1トークンとする（展開なし）
  - クォート内では空白や `|` `<` `>` `>>` なども「文字」として扱う
  - 閉じクォートが無い場合は未対応としてエラー（`unsupported syntax`）
- 未対応: ダブルクォート/バックスラッシュ/変数展開/グロブ/制御構文（検出したらエラー）
- 対応: パイプ `|` とリダイレクト `<` `>` `>>`

### ✔ 行編集（最低限）
- Backspace: `BS(0x08)` と `DEL(0x7f)` を「カーソル左の1文字削除」として扱う
- Delete: `ESC [ 3 ~` を「カーソル位置の1文字削除」として扱う
- 矢印キー
  - Left/Right（`ESC [ D` / `ESC [ C`）でカーソル移動
  - Up/Down（`ESC [ A` / `ESC [ B`）で履歴移動（簡易）
- Tab: コマンド名補完（先頭トークンのみ）
  - 候補が1つなら、その候補で確定補完（バッファ書き換え＋再描画）
  - 候補が複数なら、共通プレフィックスが伸びる分だけ補完
  - それ以上決められない場合は、改行して候補一覧を表示→プロンプト＋入力行を再描画

### ✔ PATH 検索
- `$PATH` を走査して実行ファイルを探す
  - `$PATH` 未設定時のデフォルトは `/umu_bin:/sbin:/bin`

### ✔ 実行（exec）
- パイプライン長に応じて `pipe()` を作成
- 各コマンドごとに `fork()`
- 子プロセスで `dup2()`（パイプ/リダイレクト）→ `execve()`
- 親プロセスで全子プロセスを `waitpid()`
- `execve()` は親の環境を引き継ぐ（`environ` を渡す）
- `execve()` が `ENOEXEC` の場合のみ `/bin/sh` へフォールバック

### ✔ builtins（内蔵コマンド）
- `cd`
- `pwd`
- `export`
- `exit`
- `help`（UmuOSらしい説明を表示）
- builtins は「単一コマンド（パイプ/リダイレクトなし）」のみ対応

### ✔ シグナル（最低限）
- 親（ush）は SIGINT（Ctrl+C）で落ちない
- 子プロセスは SIGINT をデフォルト動作に戻してから exec する

### ✔ プロンプト
- プロンプト文字列は環境変数から取得して表示する
  - 優先順位: `USH_PS1` → `PS1` → デフォルト
- デフォルト値:
  - `\u@UmuOS:ush:\w\$ `
- 展開（MVPで対応する最小）:
  - `\u` : ユーザー名（例: `root`, `tama`）
  - `\w` : カレントディレクトリ（`$HOME` 配下なら `~` で省略）
  - `\$` : root なら `#`、それ以外は `$`
  - `\\` : `\`（バックスラッシュ）

例（デフォルト）:

- root: `root@UmuOS:ush:~# `
- tama: `tama@UmuOS:ush:~$ `

## 4.2 MVP仕様（詳細）

### 4.2.1 終了コード（`last_status`）
- ush は `last_status`（初期値 0）を保持する
- 外部コマンド実行後:
  - 通常終了: `WEXITSTATUS(status)` を `last_status` に保存
  - シグナル終了: `128 + WTERMSIG(status)` を `last_status` に保存
- builtin 実行後:
  - 成功: 0、失敗: 1（引数不正などは 2）を `last_status` に保存
- EOF（Ctrl-D）で終了する場合は `exit(last_status)` とする

### 4.2.2 エラーメッセージ
- エラーは stderr に出力する
- 先頭に `ush:` を付与する
- 終了コード慣習:
  - コマンド未発見: 127
  - 見つかったが実行不可（権限など）: 126

### 4.2.3 トークナイズ（0.0.2 MVP）

#### 4.2.3.1 区切り

- トークンの区切りは空白類（スペース・タブ）とする
- 行頭コメント: 「最初の非空白文字が `#`」の行は無視する

#### 4.2.3.2 未対応（検出してエラー）

MVPでは以下を未対応とし、検出したらその行を実行しない。

- ダブルクォート（`"`）
- バックスラッシュ（`\\`）によるエスケープ
- 変数展開（`$VAR` / `${VAR}`）
- グロブ（`* ? [ ]`）
- 制御構文（`;` `&` `&&` `||` など）

シングルクォート（`'...'`）は対応（MVP最小）とし、以下の規約とする:

- シングルクォートで囲まれた範囲は、そのまま1トークンとして扱う（展開なし）
- クォート内では空白や演算子文字（`|` `<` `>` など）も特別扱いしない
- 閉じクォートが無い場合は未対応としてエラー（`unsupported syntax`）

未対応を検出した場合:

- stderr に `ush: unsupported syntax` を出す
- `last_status = 2`

#### 4.2.3.3 対応する演算子（Bシェル最小）

以下のみ対応する。

- パイプ: `|`
- 入力リダイレクト: `<`
- 出力リダイレクト（上書き）: `>`
- 出力リダイレクト（追記）: `>>`

トークナイザ要件:

- 上記演算子は **空白の有無に関わらず** 独立トークンとして認識する（例: `echo a>f`）
- `>>` は1トークンとして認識する
- ただしシングルクォート（`'...'`）で囲まれた範囲内では、演算子文字は特別扱いせず「文字」として扱う

#### 4.2.3.4 構文制約（MVPの簡略化）

パイプとリダイレクトの組み合わせは実装を単純にしつつ実用性を確保するため、以下に制限する。

- `<` は **パイプライン全体の先頭コマンド**にのみ指定できる
- `>` / `>>` は **パイプライン全体の末尾コマンド**にのみ指定できる
- 1コマンドに対し、入力リダイレクトは最大1つ、出力リダイレクトは最大1つ

例（OK）:

- `cat < in.txt | grep foo | wc -l > out.txt`

例（MVPではエラー）:

- `cmd1 > out | cmd2`
- `cmd1 | cmd2 < in.txt`

### 4.2.4 コマンド探索と実行

#### 4.2.4.1 構文モデル（MVP）

- 1行は「パイプライン」として解釈する
  - パイプラインは 1つ以上の「コマンド」からなる
  - `|` でコマンドを連結できる
- 各コマンドは `argv[]`（`argv[0]` はコマンド名）を持つ

#### 4.2.4.2 コマンド探索（各コマンド共通）

- コマンド文字列に `/` が含まれる場合は PATH 検索しない（指定パスをそのまま exec）
- `/` を含まない場合のみ `$PATH` を走査して探索する
- PATH 走査では以下を行う:
  - 実行可能な候補が見つかったらそれを exec する
  - 「存在するが実行不可（例: EACCES）」な候補が1つでもあったかを記録する
  - 最後まで実行できなかった場合:
    - 実行不可候補があった: permission denied（終了 126）
    - それ以外: command not found（終了 127）

#### 4.2.4.3 パイプライン実行

- パイプライン長を $N$（コマンド数）とし、$N-1$ 本の pipe を作る
- 各コマンドについて `fork()` し、子プロセス側で以下を行う:
  - パイプ接続（該当する場合）
    - 先頭以外のコマンド: stdin を「直前 pipe の read end」に `dup2()`
    - 末尾以外のコマンド: stdout を「次 pipe の write end」に `dup2()`
  - リダイレクト（構文制約に合致する場合のみ）
    - 先頭コマンドの `< file` は stdin に適用
    - 末尾コマンドの `> file` / `>> file` は stdout に適用
  - 使わない FD（pipe FD・open した FD など）は全て close する
  - `execve()` を呼ぶ（環境は親の `environ` を渡す）
  - `execve()` が `ENOEXEC` の場合のみ、`/bin/sh` へフォールバックする
    - 例: `argv_sh = {"/bin/sh", <実行しようとしたファイル>, argv[1], argv[2], ..., NULL}`
    - `execve("/bin/sh", argv_sh, environ)`
- 親プロセスは pipe FD を全て close し、全ての子プロセスに対して `waitpid()` する

`last_status` の規約:

- パイプライン実行後の `last_status` は「末尾コマンド」の終了コードとする
- `pipe()`/`fork()` などで実行を開始できない場合は、その行全体を失敗として `last_status = 1` とする

#### 4.2.4.4 リダイレクトの open 仕様

- `< file`
  - `open(file, O_RDONLY)`
- `> file`
  - `open(file, O_WRONLY | O_CREAT | O_TRUNC, 0644)`
- `>> file`
  - `open(file, O_WRONLY | O_CREAT | O_APPEND, 0644)`

open/dup2/close に失敗した場合:

- stderr に `ush: <op>: <strerror>` 形式で出力する
- そのコマンド（または行全体）の実行を中止し、`last_status = 1` とする

### 4.2.5 builtins
- `cd`
  - `cd` 引数なし: `$HOME` があれば `$HOME`、なければ `/` に移動
  - `cd -` は MVP では未対応（エラー）
  - `cd` 成功時に `PWD` と `OLDPWD` を更新する（`setenv` 等）
- `pwd`
  - `getcwd()` で取得したカレントディレクトリを stdout に表示する（末尾に `\n`）
  - 取得に失敗した場合はエラーとして `last_status = 1` とする
- `export`
  - 目的: 子プロセスに引き継がれる環境変数（`environ`）を更新する
  - 書式（MVP）:
    - `export NAME=VALUE` : `NAME` を `VALUE` に設定する
    - `export NAME` : `NAME` が未設定なら空文字で設定し、設定済みなら何もしない
    - `export`（引数なし）: 環境変数を `NAME=VALUE` 形式で列挙する（順序は未規定）
  - `NAME` は `[A-Za-z_][A-Za-z0-9_]*` のみ許可する（それ以外は `last_status = 2`）
- `exit`
  - `exit` は `last_status` で終了
  - `exit n` は `n & 255` で終了
  - 引数が数値でない／引数が多すぎる場合はエラーとして終了しない（`last_status` は 2）
- `help`
  - builtins 一覧と未対応事項（クォート/展開/制御構文など）を簡潔に表示する

builtins の制約（MVP）:

- builtins は「単一コマンド（パイプなし）」かつ「リダイレクトなし」の場合のみ実行する
- builtins がパイプやリダイレクトと組み合わさっている場合は未対応として扱う
  - stderr に `ush: unsupported syntax` を出し、`last_status = 2`

### 4.2.6 シグナル
- 親（ush 本体）は SIGINT を無視する（方針A）
- 子プロセスは SIGINT をデフォルト動作に戻してから exec する（Ctrl+C で子だけ止まる）

### 4.2.7 制限値
- 1行の最大長: 8192
- 最大引数数: 128
- 1トークン最大長: 1024
- 上限超過時はエラーとしてその行を破棄し、次のプロンプトへ戻る

### 4.2.8 メモリ確保
- 行は固定長バッファ（例: `USH_MAX_LINE_LEN + 1`）で取得してもよい
  - `getline()` 等で動的に取得してもよい（実装容易性/移植性に応じて選ぶ）
- トークンは行バッファを `\0` 区切りにして `argv[]` にポインタ参照で並べる
- `argv[]` は固定上限を設け、上限超過はエラーにする

### 4.2.9 行編集（簡易）

- 対話入力は端末を raw mode（canonical off, echo off）にして 1文字ずつ取得する
- Enter（`\n` または `\r`）で行を確定する
- Ctrl-D（`0x04`）
  - 入力バッファが空なら EOF とみなし終了する（`exit(last_status)`）
  - 入力バッファが空でない場合は無視する
- Backspace
  - `BS(0x08)` と `DEL(0x7f)` は「カーソル左の1文字削除」
- Delete
  - `ESC [ 3 ~` は「カーソル位置の1文字削除」
- 左右矢印
  - `ESC [ D` / `ESC [ C` でカーソルを左右に移動する（行頭/行末を超えない）
- 上下矢印（履歴）
  - `ESC [ A` / `ESC [ B` で履歴を前後に移動する（簡易）
  - 履歴は「確定した非空行」を保存対象とする

### 4.2.10 プロンプト（`USH_PS1` / `PS1`）

- ush はプロンプト表示のたびに `USH_PS1` を参照し、未設定または空の場合は `PS1` を参照する
- どちらも未設定または空の場合はデフォルト `\u@UmuOS:ush:\w\$ ` を用いる
- 未対応の `\<x>` シーケンスは、そのまま `\<x>` として表示する（エラーにはしない）

注記:

- ここでいう `\u` / `\w` / `\$` / `\\` は「プロンプト文字列の展開」であり、入力行（コマンドライン）のトークナイズにおける「バックスラッシュによるエスケープ」とは別物とする

運用（UmuOS / ash 前提）:

- UmuOS では基本運用を BusyBox ash とし、必要時に ash から ush を起動する想定とする
- その場合、ush が参照する `USH_PS1` は「ush 起動前」に ash 側で `export` しておく
- 全ユーザー共通で適用するには `/etc/profile` に設定するのが最も単純で安定する

設定例（`/etc/profile` など）:

```sh
export USH_PS1='\u@UmuOS:ush:\w\$ '
```

上記 1 行の設定で、ユーザーごとに以下のように表示が自動的に切り替わる:

- `\u` がログインユーザー名（例: `root`, `tama`）に展開される
- `\$` が UID=0（root）の場合は `#`、それ以外は `$` に展開される

---

# 5. ディレクトリ構造
0.0.2 MVP の参照実装（詳細設計書の付録コード）は、以下の構造を採用する。

ush/
  include/            // 公開ヘッダ（モジュール境界）
  src/                // 実装（*.c）

注記:
- `parser/` や `exec/` 等のサブディレクトリ分割は将来の整理としては有用だが、0.0.2 MVP では必須としない。

---

# 6. UmuOS への組み込み
- ビルドした `ush` バイナリを `/umu_bin/ush` に配置
- `/bin/sh` は BusyBox のまま維持

---

# 7. 今回の拡張
- パイプ `|`
- リダイレクト `<` `>` `>>`
- 行編集（Backspace/Delete/矢印）
- コマンド履歴（簡易。Up/Downで参照）
- POSIX 互換性の強化（追わない）

---
