# ush-0.0.2-基本設計書.md
UmuOS User Shell (ush) — 基本設計書（0.0.2 / MVP）  
Target OS: UmuOS-0.1.6-dev  

本書は [ush-0.0.2/docs/ush-0.0.2-仕様書.md](ush-0.0.2/docs/ush-0.0.2-仕様書.md) を、実装に落とし込むための基本設計（構成・責務・入出力・例外）として整理する。

---

# 1. 目的と非目的

## 1.1 目的
- UmuOS のユーザー向け対話シェルとして、最小限の実用性を提供する。
- 0.0.2 では `|` と `<` `>` `>>` を追加し、Bシェルチックな最小実用を成立させる。
- 未対応構文は「検出してエラー」に倒し、誤動作より観測可能性を優先する。

## 1.2 非目的
- POSIX sh / bash 互換を追わない。
- 変数展開、グロブ展開、制御構文、ダブルクォート、バックスラッシュエスケープ等は 0.0.2 では未対応（検出してエラー）。
- ジョブ制御（`&` / `fg` / `bg` 等）は対象外。
- UmuOS 上でのビルドは対象外（開発ホストで musl により静的リンクビルド）。

---

# 2. 実行環境と運用

## 2.1 位置づけ
- `/bin/sh`（BusyBox ash）はスクリプト実行用途として継続利用する。
- `ush` はユーザー向け対話シェルとして `/umu_bin/ush` を想定する。

## 2.2 起動経路
- 基本運用は BusyBox ash。
- 必要時に ash から ush を起動して使用する。

## 2.3 プロンプト設定（環境変数）
- ush はプロンプト表示のたびに `USH_PS1` → `PS1` → デフォルトの順に参照する。
- 運用上は `/etc/profile` に `export USH_PS1=...` を設定しておくのが単純。

---

# 3. 全体構成

## 3.1 処理フロー（概略）
1. SIGINT 方針を設定（親は落ちない）
2. プロンプトを生成・表示
3. 行編集付きで1行入力を取得
4. 空行・コメント行なら何もせず戻る
5. トークナイズ（演算子トークン化、`'...'` の最小対応、未対応検出）
6. 構文解析（パイプライン/リダイレクト制約を検査し、内部表現へ）
7. builtins 判定（単一コマンド・リダイレクトなしのみ）
8. builtins または外部実行
9. `last_status` 更新
10. ループ継続（EOF なら `exit(last_status)`）

## 3.2 モジュール分割（責務）
- main
	- ループ、状態（`last_status`）管理、SIGINT 方針、各モジュールの接続
- prompt
	- `USH_PS1`/`PS1`/デフォルト選択、最小展開（`\u` `\w` `\$` `\\`）
- lineedit
	- raw mode 入力、カーソル移動、削除、履歴
- tokenize
	- 文字列→トークン列（演算子の独立トークン化、シングルクォート、未対応検出）
- parse
	- トークン列→パイプライン（コマンド列 + 入出力リダイレクト）の内部表現
	- 構文制約（`<` は先頭のみ、`>`/`>>` は末尾のみ）チェック
- builtins
	- `cd` `pwd` `export` `exit` `help`
- exec
	- パイプライン実行（pipe/fork/dup2/close/execve/waitpid）
	- PATH 探索（126/127 の扱い）
	- ENOEXEC のみ `/bin/sh` フォールバック
- env/utils
	- PATH のデフォルト値提供、共通関数、エラー整形

---

# 4. データ設計

## 4.1 状態（`last_status`）
- ush は `last_status`（初期値0）を保持する。
- 外部実行の終了状態、および builtins 実行結果を反映する。

## 4.2 内部表現（概念）
- token
	- 文字列トークン（コマンド名/引数/ファイル名）
	- 演算子トークン（`|` `<` `>` `>>`）
- command
	- `argv[]`（最大 `USH_MAX_ARGS`）
- pipeline
	- command の配列
	- 入力リダイレクト（任意、先頭コマンドに適用）
	- 出力リダイレクト（任意、末尾コマンドに適用、append フラグ）

---

# 5. 入力設計（line editor）

## 5.1 前提
- 対話入力は端末を raw mode（canonical off, echo off）にして 1文字ずつ処理する。

## 5.2 対応キー（仕様準拠）
- Enter: 行確定（`\n`/`\r`）
- Ctrl-D: バッファ空なら EOF（終了）、非空なら無視
- BS(0x08)/DEL(0x7f): カーソル左を削除
- Delete（`ESC [ 3 ~`）: カーソル位置を削除
- 矢印（`ESC [ A/B/C/D`）: 履歴/移動

---

# 6. パース設計

## 6.1 字句（トークン化）
- 空白（スペース/タブ）で区切る。
- 演算子（`|` `<` `>` `>>`）は空白の有無にかかわらず独立トークン。
- シングルクォート `'...'` は最小対応:
	- 囲まれた範囲はそのまま1トークン
	- 展開なし
	- クォート内では演算子文字も特別扱いしない
	- 未閉鎖は `unsupported syntax`
- 未対応構文は検出してエラー（`unsupported syntax`, `last_status=2`）

## 6.2 構文（MVP）
- 1行は「パイプライン」
- `cmd ( '|' cmd )*`
- リダイレクトはパイプラインに対して付く（制約あり）
	- `< file` はパイプライン先頭コマンドのみ
	- `> file` / `>> file` はパイプライン末尾コマンドのみ

---

# 7. 実行設計

## 7.1 builtins
- builtins は「単一コマンド」かつ「リダイレクトなし」の場合のみ実行。
- パイプやリダイレクトと組み合わさる場合は未対応として `unsupported syntax`（`last_status=2`）。

## 7.2 外部実行（パイプライン）
- `$N` コマンドのパイプラインに対し、`N-1` 本の pipe を作成。
- `fork()` した子で `dup2()` により stdin/stdout を接続。
- 先頭/末尾のリダイレクトは `open()` した FD を `dup2()` で適用。
- 親は不要 FD を close し、全子プロセスを `waitpid()`。
- `last_status` は末尾コマンドの終了コード。

## 7.3 PATH 探索
- `argv[0]` に `/` があるなら PATH 探索しない。
- `/` が無い場合は `$PATH` を `:` 区切りで探索。
- 実行不可候補（EACCES等）を一度でも見たかで 126/127 を分岐。

## 7.4 ENOEXEC フォールバック
- `execve()` が `ENOEXEC` の場合のみ `/bin/sh` にフォールバック。

---

# 8. エラー設計

## 8.1 出力
- エラーは stderr。
- 接頭辞 `ush:` を付ける。

## 8.2 終了コード
- `last_status` 規約は仕様書に準拠。
- 構文未対応（検出）: `last_status=2`
- 実行開始不可（pipe/fork/open等）: `last_status=1`
- コマンド未発見: 127
- 実行不可: 126

---

# 9. 受け入れ（基本設計観点）
- 仕様書の全項目が、この基本設計に矛盾なく写像されていること。
- 特に以下が成立していること:
	- パイプ/リダイレクトの制約が実装で強制される
	- 未対応構文の検出と `last_status=2` が一貫する
	- プロンプトが `USH_PS1` → `PS1` → デフォルトで選択され、`\u`/`\w`/`\$`/`\\` が展開される
