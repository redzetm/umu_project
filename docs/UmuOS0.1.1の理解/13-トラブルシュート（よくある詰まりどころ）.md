# 13-トラブルシュート（よくある詰まりどころ）

UmuOS 0.1.1 のトラブルシュートは、「万能の対処集」ではなく
**起動フローのどこで止まっているかを、観測点で確定する作業**である。

本書の第3章で描いたフローは、この章のためにある。
「止まっている場所」が分かれば、原因候補は狭くなる。
逆に、止まっている場所が曖昧なまま変更を重ねると、混線して破綻する。

この章では、一次情報（特に失敗の振り返り）で整理された事象を、
起動段階（フェーズ）と観測点に結びつけ直す。

- 参照：`UmuOS-0.1.1/docs/参考文献_前回の成果と課題/ver0.1.1_失敗の振り返り.md`

---

## 0. まず「どこで止まっているか」を固定する

UmuOS 0.1.1 の起動は、観測可能な境界が多い。
それは「どこで壊れたか」を最短で確定するための設計でもある。

以下の図のどこまで到達しているかを、シリアル（ttyS0）ログで確認する。

```mermaid
flowchart TD
  A[UEFI/OVMF 起動] --> B[GRUB メニュー/設定読み込み]
  B --> C[Linux kernel 起動]
  C --> D[initramfs /init 開始]
  D --> E[root=UUID を読む]
  E --> F[/dev を走査して ext4 UUID を探す]
  F --> G[/newroot に mount]
  G --> H[exec switch_root /newroot /sbin/init]
  H --> I[BusyBox init が /etc/inittab を読む]
  I --> J[rcS 実行]
  I --> K[ttyS0 getty -> login]
  K --> L[ログイン成功]
  L --> M[再起動しても disk.img が残る]
```

この図で、次の問いに答える。

- `/init` のログは出ているか（第7章の観測点）
- `matched:` は出ているか（UUID 一致があるか）
- `exec: /bin/switch_root ...` は出ているか（責務移譲したか）
- `login:` は出ているか（第8章の成立観測点に到達したか）

以後の節は「この問いに対する答え」に対応している。

---

## 1. GRUB 以前：そもそも何も出ない（観測できない）

### 1.1 症状：QEMU を起動したのに、端末に何も出ない

この症状の怖さは、起動していないのか、起動しているが見えていないのかが分からない点にある。
一次情報では、この混乱を「観測経路が揺れる」問題として整理している。

- 参照：失敗の振り返り「F-09 QEMUを起動したのに観測できない」

UmuOS 0.1.1 は ttyS0 を生命線にしているため、まず観測経路を固定する。

- `UmuOS-0.1.1/umuOSstart.sh` を使う（出力混線を避ける基本形を固定している）
- `UmuOS-0.1.1/iso_root/boot/grub/grub.cfg` に serial 出力の設定が入っているか確認する

ここでの発想は「何を直すか」ではなく「見えるようにする」ことである。

---

## 2. initramfs `/init` まで来ない：initrd の中身が足りない

### 2.1 症状：`/init` が実行されている気配がない

`initrd` の構築に失敗しているか、`/init` が入っていない可能性がある。
ただし、失敗の振り返りが指摘する通り、単に一覧の先頭に出ていないだけのこともある。

- 参照：失敗の振り返り「F-01 initrd に `/init` が無いように見える」

確認は「必要ファイルだけ」を見る。

```bash
lsinitramfs UmuOS-0.1.1/initramfs/initrd.img-6.18.1 | grep -E '^(init|bin/switch_root)$'
```

`init` と `bin/switch_root` が両方入っていれば、最低限の骨格はある。

---

## 3. `/init` は動くが永続 root を見つけられない（UUID まわり）

### 3.1 症状：`matched:` が出ない／タイムアウトする

第7章で見た通り、UmuOS 0.1.1 の `/init` は `/dev` を走査し、ext4 superblock を読んで UUID を比較する。
一致が無ければ永続 root を mount できない。

典型原因は 2 つである。

1) disk.img を作り直したが、`grub.cfg` の `root=UUID=...` を更新していない
2) QEMU に disk.img を接続していない（`-drive ...` が無い／パスが違う）

確認はホストでできる。

```bash
sudo blkid -p -o value -s UUID UmuOS-0.1.1/disk/disk.img
grep -n "root=UUID" UmuOS-0.1.1/iso_root/boot/grub/grub.cfg
```

この 2 つが一致していないなら、/init の失敗は仕様通りである。

---

## 4. `switch_root` 以降が崩れる：ext4 側ユーザーランドが成立していない

### 4.1 症状：`exec: /bin/switch_root ...` は出たが、`login:` が出ない

この場合、問題は initramfs 側ではなく、永続 root（disk.img）側に寄る。
第8章・第9章で扱った「成立条件（最小セット）」が揃っていない可能性が高い。

失敗の振り返りでは、特に多い原因として BusyBox applet の symlink 破損が挙げられている。

- 参照：失敗の振り返り「F-03 ext4 側 BusyBox applet が壊れる（`rcS` で止まる）」

これは、ホストで `/mnt/...` に mount した状態で `busybox --install` を実行してしまい、
symlink がホスト絶対パスを指してしまう事故である。

対処は、手順を「必ず chroot」に固定すること。

```bash
sudo chroot /mnt/umuos011 /bin/busybox --install -s /bin
sudo chroot /mnt/umuos011 /bin/busybox --install -s /sbin
sudo ls -l /mnt/umuos011/bin/sh
sudo ls -l /mnt/umuos011/sbin/init
```

`/bin/sh -> /bin/busybox` になっていないなら、以後のシェルやスクリプトが成立しない。

---

## 5. `login:` は出るのにログインできない（shadow の未確定）

### 5.1 症状：`login:` は出るが root/tama が通らない

これは「getty までは成立している」ことを意味する。
したがって、原因は多くの場合、認証情報（`/etc/shadow`）の未確定にある。

- 参照：失敗の振り返り「F-07 `/etc/shadow` 未確定でログインできない」

第9章で扱った通り、`/etc/shadow` は次を満たす必要がある。

- プレースホルダのままになっていない
- 権限が 600 である（読めない/挙動が変わる混乱を避ける）

ここもホストで確認できる。

```bash
sudo ls -l /mnt/umuos011/etc/shadow
sudo head -n 2 /mnt/umuos011/etc/shadow
```

ログイン失敗を「ネットワーク」や「telnet」と混ぜないことが重要である。
まずはシリアルでログイン成功を固定点にし、その後で必要なら別機能を足す。

---

## 6. disk.img の健全性が疑わしい（ext4 破損）

### 6.1 症状：何を直しても挙動が安定しない／不安が消えない

ファイルシステムが壊れていると、変更の結果が信用できない。
失敗の振り返りは、ここで原因断定より運用対策を重視している。

- 参照：失敗の振り返り「F-04 ext4 破損（checksum）」

対処は、VM 停止後に fsck を挟んで、状態をクリーンに戻してから再開すること。

```bash
sudo e2fsck -f UmuOS-0.1.1/disk/disk.img
```

そして次回からは、終了条件に `sync` と正常停止を含め、破損時は必ず fsck を挟む。

---

## 7. 混線を避ける運用（理解を守る）

一次情報が強調している失敗は、技術ミスだけではない。
変更量が理解量を上回ると、成功していても「説明できる理解」にならない。

- 参照：失敗の振り返り「フェーズH：理解が追いつかない」

UmuOS 0.1.1 を学ぶ上では、次の運用が本質になる。

- 変更は 1 点だけにする
- 変更の前後で、観測点（ログのどの行が変わったか）を文章で残す
- ネットワークなど主経路と無関係な要素は、受入が通ってから最後に導入する

---

## まとめ

この章では、よくある詰まりどころを「起動段階」と「観測点」に結びつけ、
最短で原因へ辿り着くための見方を固定した。

次章では、本書で何度も登場した用語を最小の言葉で定義し、説明を圧縮できるようにする。
