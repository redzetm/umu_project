# 02-成果物（何がどこにありどの段階が参照するか）

OS を理解する上で最初にやるべきことは、
「成果物を覚える」ではなく「成果物の責務を分ける」ことである。

同じファイルでも、

- 起動に直接必要な成果物
- 再現（ビルドや生成）に必要な成果物
- 観測（ログや設定の固定）に必要な成果物

が混ざると、原因の切り分けが難しくなる。

ここでは UmuOS 0.1.1 の成果物を、「どの段階（どのコンポーネント）が参照するか」で整理する。

## 1. 成果物の視点（3つの参照主体）

UmuOS 0.1.1 の世界には、主に3種類の参照主体がいる。

### 1.1 ホスト（開発機）

Ubuntu などの開発機上で、QEMU を起動する。
ISO や disk.img はホスト側のファイルであり、QEMU に渡す入力である。

### 1.2 ブートローダ（GRUB）

ISO 内の配置を前提として、
カーネル（vmlinuz）と initrd（initramfs）を読み込む。

### 1.3 Linux カーネル + initramfs

initramfs の `/init` を実行し、
永続 root（disk.img）へ到達し、root を切り替え、ユーザーランドへ繋ぐ。

この観点で整理すると、成果物の役割が自然に見える。

## 2. 起動に直接必要な成果物（最低限）

### 2.1 ブートISO

- `UmuOS-0.1.1/UmuOS-0.1.1-boot.iso`

QEMU が CD-ROM として読ませる起動媒体。
GRUB 設定、カーネル、initrd を含む。

### 2.2 ISO 内のブート資材

- `UmuOS-0.1.1/iso_root/boot/grub/grub.cfg`
- `UmuOS-0.1.1/iso_root/boot/vmlinuz-6.18.1`
- `UmuOS-0.1.1/iso_root/boot/initrd.img-6.18.1`

GRUB は `grub.cfg` に従って vmlinuz と initrd をロードする。
ここで重要なのは、initrd が「ディスクの中身」ではなく
「カーネルが最初に展開する一時 root（initramfs）」である点。

### 2.3 永続ディスク

- `UmuOS-0.1.1/disk/disk.img`

UmuOS 0.1.1 が最終的に `/` として使う ext4。
再起動しても内容が残るのが最大の特徴で、0.1.1 の成立条件の一つでもある。

### 2.4 UEFI NVRAM（OVMF VARS）

- `UmuOS-0.1.1/run/OVMF_VARS_umuos_0_1_1.fd`

UEFI の設定が書き込まれる“変化する”ファイル。
そのため、テンプレを汚さないよう run/ にコピーして使う。

## 3. 再現（生成）のための成果物

### 3.1 initramfs（生成物と生成元）

- 生成物（圧縮イメージ）: `UmuOS-0.1.1/initramfs/initrd.img-6.18.1`
- 中身（cpio）: `UmuOS-0.1.1/initramfs/initrd.cpio`
- 生成元（ツリー）: `UmuOS-0.1.1/initramfs/rootfs/`
- `/init` のソース: `UmuOS-0.1.1/initramfs/src/init.c`

このセットは「どう作るか」と「何が入っているか」が分離されている。
initramfs を理解するには、生成物だけでなく生成元ツリーを見るのが早い。

### 3.2 カーネル（ソースと配置）

- `UmuOS-0.1.1/kernel/` 配下にカーネルソースとビルド成果物がある。
- 起動に使う vmlinuz は `iso_root/boot/vmlinuz-6.18.1` に配置される。

「ソースの場所」と「ISO 内の配置」を混ぜないことが、再現性を守る基本になる。

### 3.3 ISO を作るための配置（iso_root）

- `UmuOS-0.1.1/iso_root/` は ISO のルートとして使う“配置ディレクトリ”。

ISO を再生成する手順は後の章で説明する。
ここでは、iso_root が「ISO の中身に直結する」という一点だけ覚えればよい。

## 4. 起動の入口（ホスト側スクリプト）

### 4.1 umuOSstart.sh

- `UmuOS-0.1.1/umuOSstart.sh`

このスクリプトは、QEMU 起動の引数を固定し、
混線（途中失敗して変な状態で続行すること）を避けるための工夫が入っている。

たとえば、

- プロジェクト直下基準で必ず起動する
- ISO / disk.img が無ければ理由を出して停止する
- OVMF_VARS はコピーして使う

などは、すべて「再現」と「観測」を壊さない設計判断である。

## 5. 設計書（仕様の根拠）

- `UmuOS-0.1.1/docs/詳細設計-0.1.1.md`

本書の解説は、この詳細設計の「作業手順＋観測点」という思想と整合するように書く。
ただし本書は“手順の列挙”に留まらず、なぜそれが必要か（背景と仕組み）まで説明する。
