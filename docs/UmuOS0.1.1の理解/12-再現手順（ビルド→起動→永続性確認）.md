# 12-再現手順（ビルド→起動→永続性確認）

この章は「理解を確定させる」ための章である。
第1章〜第11章で、UmuOS 0.1.1 の起動を概念として説明してきたが、
最終的に 100% 理解したと言える状態は、次の 2 つが自分の手で再現できる状態である。

1. ISO（kernel+initrd+GRUB）から起動し、initramfs `/init` が `switch_root` に到達する。
2. 最終 `/` が disk.img（ext4）になり、ログインでき、**再起動しても状態が残る**。

この章では、`UmuOS-0.1.1/docs/詳細設計-0.1.1.md` の手順を“理解できる粒度”へ再構成する。
（厳密なコマンド列としては詳細設計が一次情報であり、本章はその読み方と成功条件を含めた教科書版である。）

---

## 0. 前提（開発機と必要コマンド）

UmuOS 0.1.1 の詳細設計は Ubuntu 24.04 を前提にしている。
必要パッケージも詳細設計に列挙されている。

- 参照：`UmuOS-0.1.1/docs/詳細設計-0.1.1.md` の 2.1

確認として、少なくとも次が存在すること。

```bash
command -v qemu-system-x86_64
command -v grub-mkrescue
command -v musl-gcc
file /bin/busybox
```

ここで `file /bin/busybox` が静的リンク（`statically linked`）だと、最小 rootfs で成立しやすい。

---

## 1. disk.img（永続 root）を作って内容を入れる

この段階の目的は 2 つ。

- ext4 の UUID を持つ disk.img を作る（GRUB の `root=UUID=...` の入力になる）
- disk.img の中身に `/sbin/init`・`/etc/inittab`・`rcS`・ユーザー情報を置き、ログインまで成立させる

手順の本体は第9章で説明した通りで、一次情報は詳細設計の 4〜5 章である。

- 作成：`truncate` → `mkfs.ext4`
- UUID 取得：`blkid -p -o value -s UUID disk.img`
- loop mount：`sudo mount -o loop ... /mnt/umuos011`
- BusyBox 配置と applet 生成：**必ず chroot**

この段階での成功条件（観測点）は、ホストで mount して次が確認できることだ。

```bash
sudo ls -l /mnt/umuos011/sbin/init
sudo ls -l /mnt/umuos011/etc/inittab
sudo ls -l /mnt/umuos011/etc/init.d/rcS
sudo ls -l /mnt/umuos011/etc/passwd
sudo ls -l /mnt/umuos011/etc/shadow
```

---

## 2. initramfs（initrd）を作る

この段階の目的は「永続 root を見つけて `switch_root` する、橋渡し」を作ることだ。

- 参照：`UmuOS-0.1.1/initramfs/src/init.c`
- 参照：`UmuOS-0.1.1/docs/詳細設計-0.1.1.md` の 6 章

重要なのは、initramfs は永続 root を“作る場所”ではないこと。
永続 root は disk.img に作る（第9章）。
initramfs は、あくまで mount/switch_root まで到達するための最小ユーザー空間である。

詳細設計の要点を、成立条件としてまとめ直す。

- initramfs に `/init`（自作、静的リンク）がある
- initramfs に `/bin/switch_root`（BusyBox applet）がある
- initramfs で `/proc` `/sys` `/dev` が mount でき、`/dev/vda` 等が見える

この段階で `file init` が `statically linked` であることは、初期環境での失敗要因を減らす。

---

## 3. `iso_root/` を揃え、ISO を作る

この段階の目的は「UEFI→GRUB→kernel+initrd」を起動できる形に束ねることだ。

- ISO の材料：`iso_root/boot/vmlinuz-6.18.1` / `iso_root/boot/initrd.img-6.18.1` / `iso_root/boot/grub/grub.cfg`
- ISO の生成：`grub-mkrescue -o UmuOS-0.1.1-boot.iso iso_root`

ここでの最重要ポイントは、`grub.cfg` の `root=UUID=...` を **disk.img の UUID に一致させる**ことだ。

disk.img を作り直すたびに UUID が変わるので、必ず更新する。

詳細設計には、UUID を埋め込むための置換コマンド例がある。

- 参照：`UmuOS-0.1.1/docs/詳細設計-0.1.1.md` の 7.1

---

## 4. QEMU を起動し、起動が成立していることを観測する

ここまで揃ったら起動する。
推奨は、プロジェクト同梱の起動スクリプト `umuOSstart.sh` を使う方法である。

- 参照：`UmuOS-0.1.1/umuOSstart.sh`

このスクリプトは、ISO/disk.img/OVMF の存在チェックを行い、ttyS0 観測に適したオプションで起動する。

### 4.1 initramfs（/init）側の観測点

詳細設計が挙げる必須観測点を、そのまま“合格条件”として採用する。

- `/proc/cmdline` が出る（`root=UUID=...` を含む）
- `want root UUID: ...` が出る
- `/dev/...` の `scan:` が複数出る
- 一致した `matched:` が出る
- `mount root ok` が出る
- `exec: /bin/switch_root /newroot /sbin/init` が出る

ここまで出れば、initramfs の責務は達成である（第7章の結論）。

### 4.2 永続 root 側の観測点（ログイン）

次に、ttyS0 で `login:` が出ること。
これは第8章で定義した「成立」の重要観測点である。

`root` と `tama` の両方でログインし、次を実行する。

```sh
id
uname -r
mount
```

この `mount` の出力により、最終 `/` が ext4（disk.img）になっていることを確認できる。

---

## 5. 永続性の確認（UmuOS 0.1.1 の受入）

永続性の確認は「disk.img に書いたものが、再起動しても残る」ことを示せばよい。
最小の確認は次のどちらかで成立する。

### 5.1 ゲスト内でファイルを作り、再起動して残ることを確認

1) ログイン後、例えば次を実行する。

```sh
echo "hello" > /home/tama/persist.txt
sync
```

2) 再起動する。

- `Ctrl+Alt+Del`（inittab の `::ctrlaltdel:/sbin/reboot` に繋がる）
- あるいは `reboot`

3) 再びログインし、ファイルが残っていることを確認する。

```sh
cat /home/tama/persist.txt
```

### 5.2 ホストで disk.img を mount して確認

ゲスト停止後に、ホスト側で disk.img を loop mount して確認する。

```bash
sudo mount -o loop ~/umu/umu_project/UmuOS-0.1.1/disk/disk.img /mnt/umuos011
sudo ls -l /mnt/umuos011/home/tama/persist.txt
sudo umount /mnt/umuos011
```

UmuOS 0.1.1 の設計は「ホストで確認できる」ことを強く活用している。
この観測手段を持っていると、ゲスト内の不具合切り分けが極端に楽になる。

---

## 付録：E2Eで一周した“合格ログ例”（最小抜粋）

この章の手順どおりに実行し、次の流れを **実際に** 通した。

1. initramfs `/init` が `matched`→`switch_root` へ到達
2. ext4 root で `login:` が出る
3. `/home/tama/persist.txt` を作成して `reboot`
4. 再起動後も `persist.txt` が残る（`cat` で `hello-umuos` を確認）
5. 最後に `poweroff`

シリアルログ（`ttyS0`）の最小抜粋は次の通り。

```text
[init] UmuOS initramfs init start
[init] /proc/cmdline: ... root=UUID=abea9a02-bacf-4671-93e6-30c870c8f011 ... console=ttyS0,115200n8 ...
[init] want root UUID: abea9a02-bacf-4671-93e6-30c870c8f011
[init] scan: /dev/vda
[init] matched: dev=/dev/vda uuid=abea9a02-bacf-4671-93e6-30c870c8f011
[init] mount root ok (rw): /dev/vda
[init] exec: /bin/switch_root /newroot /sbin/init
[rcS] rcS done
(none) login: root

~ # echo "hello-umuos" > /home/tama/persist.txt
~ # reboot
...
reboot: Restarting system

...（再起動後）...
(none) login: root
~ # cat /home/tama/persist.txt
hello-umuos
~ # poweroff
reboot: Power down
```

（補足）ログイン資格情報は、一次情報として `UmuOS-0.1.1/docs/詳細設計-0.1.1.md` の「5.8 ユーザー（root / tama）」に従う。

## まとめ

この章では、UmuOS 0.1.1 を “最初から作り直して起動できる” 状態へ持っていくために、

- disk.img の作成と内容構築（第9章）
- initrd（initramfs）の構築（第7章）
- ISO の生成（第10章）
- QEMU 起動と ttyS0 観測（第11章）
- 永続性の確認

を 1 本の再現手順として繋いだ。

次章では、ここまでの理解を前提に「よくある詰まりどころ」を、観測点と結びつけてトラブルシュートとして整理する。
