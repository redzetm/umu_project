Umu Project Step2 詳細設計書

1. 環境準備

1.1 必要パッケージのインストール

sudo apt update
sudo apt install -y build-essential bc bison flex libssl-dev \
  libelf-dev libncurses-dev dwarves git wget \
  grub-efi-amd64-bin grub-common xorriso mtools \
  qemu-system-x86 ovmf \
  cpio gzip busybox-static


各PKGの説明
build-essential
  build-essential は UbuntuやDebian系Linuxでソフトウェア開発に必須と
  される基本的なツール群をまとめたメタパッケージです。
  C/C++コンパイラやmakeなどを一括で導入でき、特に Debianパッケージの
  構築環境を整えるために必須とされています。
  - gcc : GNU Cコンパイラ
  - g++ : GNU C++コンパイラ
  - make : ビルド制御ユーティリティ
  - libc6-dev : GNU Cライブラリの開発用ヘッダ・ライブラリ
  - dpkg-dev : Debianパッケージ開発ツール
  - 用途
  - ソースコードからのビルド環境構築
  - Debianパッケージの作成・ビルド
  - C/C++開発の基本環境整備

bc
  bc は 任意精度の計算が可能なコマンドライン電卓兼簡易言語で、
  Linux環境で数値計算を行う際に利用されます。シェルスクリプトに組み込んで
  計算処理を自動化できるため、ビルド環境やカーネル開発の補助ツールとしてもよく使われます。
  〇なぜ環境構築で必要か
  LinuxカーネルやOS関連のビルド手順では、バージョン番号の計算やサイズ計算などを
  スクリプト内で行う場面が多くあります。
  bc はその計算処理を担うため、開発環境の必須パッケージに含まれています。

bisonとflex
  LinuxカーネルやOS自作のビルド環境では、構文解析器を
  生成する必要がある場面（設定ファイルの解釈、ビルドツールの内部処理など）があり、
  bison はそのための必須ツールとしてインストールされます。特に flex と
  セットで使われることが多いです。
  カーネルや関連ツールのビルド工程で利用される
  Linuxカーネルや周辺ユーティリティのソースコードには、構文解析器（パーサ）が必要な
  部分があります。例えば、カーネルの設定ファイルや一部のビルドスクリプトは 
  Yacc/Bison形式の文法定義を使っており、これをコンパイルするために bison が必須です。
  Linuxカーネルをソースからビルドする場合、カーネルの scripts/kconfig や 
  genksyms などの内部ツールが bison/flex に依存しており、これらが無いと
  ビルド途中でエラーになります。

libssl-dev
  libssl-dev は OpenSSL ライブラリの開発用パッケージです。
  OpenSSL は暗号化通信（SSL/TLS）や暗号アルゴリズムを提供するライブラリで、
  libssl-dev はその ヘッダファイルやスタティックライブラリを含んでおり、
  ソフトウェアをビルドするときに OpenSSL を利用できるようにします。
  主な役割
  - 暗号化機能の提供
  AES、DES、RSA、SHA、MD5 などの暗号アルゴリズムを利用可能。
  - SSL/TLS 通信のサポート
  HTTPS やセキュアなソケット通信を実装する際に必要。
  - 開発用ヘッダファイルを提供
  /usr/include/openssl/ 以下に配置され、C/C++ プログラムから OpenSSL API を呼び出せる。
  - ビルド時にリンク可能
  -lssl -lcrypto を指定してプログラムに組み込む。
  
  ※今回のStep2の仕様では、不要だが、推奨PKGであるために環境構築を一度で完了させる狙いで
  installしておく。

libelf-dev
  libelf-dev は ELF (Executable and Linkable Format) ファイルを読み書きするための
  開発用ライブラリです。ELF は Linux や Unix 系 OS で標準的に使われる、
  実行ファイル／オブジェクトファイル／共有ライブラリのフォーマットであり、
  libelf-dev をインストールすることで、ELF ファイルを操作するプログラムを
  ビルドできるようになります。
  主な役割
  - ELFファイルの読み書き
    実行ファイルやカーネルモジュールのバイナリ構造を解析・編集可能。
  - 開発用ヘッダファイルの提供
    /usr/include/elf.h などのヘッダを含み、C/C++ から ELF API を利用できる。
  - カーネルビルドで必須
    Linuxカーネルのビルド工程では、モジュールやシンボル情報を ELF 形式で扱うため、
    このライブラリが必要。

libncurses-dev
  libncurses-dev は ncurses ライブラリの開発用ヘッダファイルや
  静的ライブラリを提供するパッケージです。
  ncurses は「端末に依存しない文字ベースの画面制御」を行うためのライブラリで、
  CUI（キャラクタユーザインターフェース）プログラムを作る際に利用されます。
  ncursesの特徴
  - 端末非依存の画面制御
    VT100 などの端末エスケープシーケンスを抽象化し、どの端末でも同じコードで動作可能。
  - 文字ベースUIの構築
    ウィンドウ分割、カーソル移動、色付け、キーボード入力、スクロールなどを簡単に実装できる。
  - 古い curses ライブラリの拡張版
    「new curses」＝ ncurses として UNIX 系環境で広く使われている。
  - 開発用ヘッダファイルを提供
    /usr/include/ncurses.h などを含み、C/C++ プログラムから ncurses API を利用可能。
  - 静的ライブラリを提供
  -lncurses を指定してリンクできる。
  - カーネルビルドで必須
    Linux カーネルの make menuconfig（対話型設定画面）で
    ncurses が利用されるため、開発環境には必ず必要。

dwarves
  dwarves は DWARF デバッグ情報を処理するためのツール群で、Linuxカーネルや 
  ELF バイナリに埋め込まれたデバッグ情報を解析・活用するために使われます。
  代表的なユーティリティに pahole があり、C構造体のメモリ配置に存在する「穴（padding）」を
  可視化することで、構造体の最適化や BTF (BPF Type Format) 情報の生成に役立ちます。
  dwarves の主な機能
  - pahole
    構造体やクラスのメモリ配置を解析し、アライメントによる隙間（padding）を表示。
    カーネル開発で構造体サイズを最適化する際に利用。
  - pfunct
    関数やインライン展開の情報を解析し、コンパイラがどのように最適化したかを確認可能。
  - codiff
    ソースコード変更がバイナリにどう影響したかを比較。
  - btfdiff
    BTF と DWARF の出力を比較し、整合性を確認。
  - その他ユーティリティ
    ELF バイナリに埋め込まれた DWARF デバッグ情報を読み取り、整形表示や解析を行う。







1.2 ディレクトリ作成

mkdir -p ~/umu/step2/{kernel,initramfs,iso_root/boot/grub,logs}

2. カーネルビルド

2.1 ソース取得

cd ~/umu/step2/kernel
wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.58.tar.xz
tar -xf linux-6.6.58.tar.xz
cd linux-6.6.58


2.2 カーネル設定

今回はデフォルト設定でビルド。

cd linux-6.6.58
make mrproper
make defconfig
cp .config ../config-6.6.58

2.3 ビルド

make -j$(nproc)

2.4 成果物コピー

cp arch/x86/boot/bzImage ~/umu/step2/iso_root/boot/vmlinuz-6.6.58
cp .config ~/umu/step2/iso_root/boot/config-6.6.58


3. initramfs（BusyBox版）

3.1 構造作成

cd ~/umu/step2/initramfs
mkdir -p rootfs/{bin,sbin,etc,proc,sys,dev,home/tama,root}
cp /usr/bin/busybox rootfs/bin/
cd rootfs/bin
busybox --install -s .
cd ~/umu/step2/initramfs


3.2 ユーザー構成

/etc/passwd と /etc/shadow を作成。

# ~/umu/step2/initramfs/rootfs/etc/passwd
root:x:0:0:root:/root:/bin/sh
tama:x:1000:1000:tama:/home/tama:/bin/sh


# ~/umu/step2/initramfs/rootfs/etc/shadow
root::19000:0:99999:7:::
tama::19000:0:99999:7:::

3.3 initスクリプト作成

# ~/umu/step2/initramfs/rootfs/init
#!/bin/sh
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev

echo "Umu Project Step2: Multi-user mode"

# ログインプロンプトをシリアルに出す
/sbin/getty -L ttyS0 115200 vt100 &
exec /bin/sh

chmod +x rootfs/init


3.4 cpioアーカイブ作成

cd rootfs
find . | cpio -o -H newc | gzip > ../initrd.img-6.6.58
cd ..
cp initrd.img-6.6.58 ../iso_root/boot/


4. GRUB設定

# ~/umu/step2/iso_root/boot/grub/grub.cfg
set timeout=10
set default=0

menuentry "Umu Project Linux kernel 6.6.58" {
  linux /boot/vmlinuz-6.6.58 ro console=ttyS0,115200
  initrd /boot/initrd.img-6.6.58
}

menuentry "Umu Project rescue 6.6.58" {
  linux /boot/vmlinuz-6.6.58 ro single console=ttyS0,115200
  initrd /boot/initrd.img-6.6.58
}


5. ISOイメージ作成

cd ~/umu/step2
grub-mkrescue -o step2-boot.iso iso_root


6. QEMU検証

cd ~/umu/step2
qemu-system-x86_64 \
  -enable-kvm \
  -m 2048 \
  -cdrom step2-boot.iso \
  -serial stdio \
  -nographic

注意点
- -serial file:logs/serial.log を指定すると、
   標準出力がファイルにリダイレクトされ、-nographic と競合する場合がある。
- Step1で「起動しない」ケースは、シリアル出力がファイルに奪われて
   GRUBの標準出力が見えなくなったため。
- Step2では -serial stdio を利用し、シリアルを標準入出力に統一する。


7. 成功条件

- GRUBメニューが表示される
- カーネルが起動し、initramfsのログインプロンプトが表示される
- root / tama ユーザーでログイン可能
- BusyBoxコマンドが利用可能 (ls, cat, ps, su, poweroff, reboot)
- poweroff → 仮想マシン終了
- reboot → GRUB再起動










