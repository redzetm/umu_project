Umu Project Step2 詳細設計書

1. 環境準備

1.1 必要パッケージのインストール

sudo apt update
sudo apt install -y build-essential bc bison flex libssl-dev \
  libelf-dev libncurses-dev dwarves git wget \
  grub-efi-amd64-bin grub-common xorriso mtools \
  qemu-system-x86 ovmf \
  cpio gzip busybox-static

1.2 ディレクトリ作成

mkdir -p ~/umu/step2/{kernel,initramfs,iso_root/boot/grub,logs}

2. カーネルビルド

2.1 ソース取得

cd ~/umu/step2/kernel
wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.6.58.tar.xz
tar -xf linux-6.6.58.tar.xz
cd linux-6.6.58


2.2 カーネル設定

今回はデフォルト設定でビルド。

cd linux-6.6.58
make mrproper
make defconfig
cp .config ../config-6.6.58

2.3 ビルド

make -j$(nproc)

2.4 成果物コピー

cp arch/x86/boot/bzImage ~/umu/step2/iso_root/boot/vmlinuz-6.6.58
cp .config ~/umu/step2/iso_root/boot/config-6.6.58


3. initramfs（BusyBox版）

3.1 構造作成

cd ~/umu/step2/initramfs
mkdir -p rootfs/{bin,sbin,etc,proc,sys,dev,home/tama,root}
cp /usr/bin/busybox rootfs/bin/
cd rootfs/bin
busybox --install -s .
cd ~/umu/step2/initramfs


3.2 ユーザー構成

/etc/passwd と /etc/shadow を作成。

# ~/umu/step2/initramfs/rootfs/etc/passwd
root:x:0:0:root:/root:/bin/sh
tama:x:1000:1000:tama:/home/tama:/bin/sh


# ~/umu/step2/initramfs/rootfs/etc/shadow
root::19000:0:99999:7:::
tama::19000:0:99999:7:::

3.3 initスクリプト作成

# ~/umu/step2/initramfs/rootfs/init
#!/bin/sh
mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev

echo "Umu Project Step2: Multi-user mode"

# ログインプロンプトをシリアルに出す
/sbin/getty -L ttyS0 115200 vt100 &
exec /bin/sh

chmod +x rootfs/init


3.4 cpioアーカイブ作成

cd rootfs
find . | cpio -o -H newc | gzip > ../initrd.img-6.6.58
cd ..
cp initrd.img-6.6.58 ../iso_root/boot/


4. GRUB設定

# ~/umu/step2/iso_root/boot/grub/grub.cfg
set timeout=10
set default=0

menuentry "Umu Project Linux kernel 6.6.58" {
  linux /boot/vmlinuz-6.6.58 ro console=ttyS0,115200
  initrd /boot/initrd.img-6.6.58
}

menuentry "Umu Project rescue 6.6.58" {
  linux /boot/vmlinuz-6.6.58 ro single console=ttyS0,115200
  initrd /boot/initrd.img-6.6.58
}


5. ISOイメージ作成

cd ~/umu/step2
grub-mkrescue -o step2-boot.iso iso_root


6. QEMU検証

cd ~/umu/step2
qemu-system-x86_64 \
  -enable-kvm \
  -m 2048 \
  -cdrom step2-boot.iso \
  -serial stdio \
  -nographic

注意点
- -serial file:logs/serial.log を指定すると、
   標準出力がファイルにリダイレクトされ、-nographic と競合する場合がある。
- Step1で「起動しない」ケースは、シリアル出力がファイルに奪われて
   GRUBの標準出力が見えなくなったため。
- Step2では -serial stdio を利用し、シリアルを標準入出力に統一する。


7. 成功条件

- GRUBメニューが表示される
- カーネルが起動し、initramfsのログインプロンプトが表示される
- root / tama ユーザーでログイン可能
- BusyBoxコマンドが利用可能 (ls, cat, ps, su, poweroff, reboot)
- poweroff → 仮想マシン終了
- reboot → GRUB再起動










