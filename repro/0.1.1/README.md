# repro/0.1.1

このディレクトリは、UmuOS-0.1.1 を「何度でも再現できる固定点」にするための、再現（reproduction）用ツール一式を置く。

- 目的: 失敗コストを下げ、破壊的な検証を躊躇なく行えるようにする
- 非目的: 便利化そのもの／OS本体の仕様変更
- 方針: UmuOS-0.1.1 側の成果物は変更しない（ベース版を温存する）

## 生成物

このツールは、UmuOS-0.1.1 相当の成果物（例: ISO、disk.img、起動スクリプト）を再現する。

生成先は「親ディレクトリ」を指定し、その直下に `UmuOS-0.1.1/` を作る。

- デフォルト: `UMU_ROOT/work`（存在しない場合は `repro/0.1.1` 配下）
- 指定方法: **対話プロンプトで入力**（環境変数 `OUT_PARENT` は「プロンプトのデフォルト値」としてのみ参照される）

例（親ディレクトリが `~/umu_project/work` の場合）:

```
~/umu_project/work/
	UmuOS-0.1.1/
		disk/disk.img
		logs/
		run/
		...
```

運用方針として、作り直しのたびに生成先ディレクトリは削除し、クリーンに初期化する。

注意:

- `disk.img` は「mkfsでゼロから作る」のではなく、ベース版の `disk.img` をコピーしてから UUID 等を更新して作る（=ベースの初期状態を引き継ぐ）
- したがって、ベース版 `disk.img` にファイルが残っていれば、それは毎回“初期状態”として現れる
- リポジトリを clone したら、まずは `work/` 等の作業用ディレクトリへ生成し、その複製側で検証・実装することを強く推奨する（ベース成果物を汚さないため）

## 運用方法

結論: **UmuOS-0.1.1（ベース）は原則変更しない**。変更・検証は **`work/` 配下に複製した UmuOS-0.1.1** に対して行う。

理由:

- 固定点（ベース）を温存できるため、いつでも同じ出発点へ戻れる
- `work/` 側だけを壊してよいので、破壊的な検証の心理的コストが下がる
- 起動スクリプトも `work/<...>/UmuOS-0.1.1/umuOSstart.sh` を使うため、誤ってベースの `disk.img` を起動してしまう事故を避けやすい

推奨ルール:

- `OUT_PARENT` は実験ごとに分ける（例: `~/umu_project/work/20260101_login_test`）
- このスクリプトは生成先を削除して作り直すため、重要なディレクトリを `OUT_PARENT` に指定しない
- シリアルコンソール（`-nographic`）運用では、日本語パスワードは入力が崩れることがあるため、まずはASCII（英数字）を推奨

## 必要コマンド（ホスト側）

少なくとも以下が必要。

- `debugfs`, `e2fsck`, `tune2fs`, `blkid`（e2fsprogs）
- `grub-mkrescue`
- `xorriso`
- `python3`

Ubuntu で足りない場合の例:

```bash
sudo apt update
sudo apt install -y e2fsprogs grub-pc-bin grub-efi-amd64-bin xorriso
```

## 入力

このインストーラは **対話式** で進みます。入力ミスもそのまま反映されるので、プロンプトはよく確認してください。

- 生成先の親ディレクトリ（フルパス）
- 一般ユーザ名
- root パスワード（必ず対話で入力）
- 一般ユーザのパスワード（必ず対話で入力）

補足:

- `OUT_PARENT` と `USER_NAME` は、環境変数が設定されている場合に「プロンプトのデフォルト表示」に利用されます（未入力でEnterすると採用される）。
- パスワードは環境変数では受け取りません（必ず対話で入力）。

## 使い方

```bash
cd ~/umu_project/repro/0.1.1
./install_0.1.1.sh
```

対話で聞かれる内容（概要）:

- 「生成先の親ディレクトリ」: ここで指定したディレクトリ直下に `UmuOS-0.1.1/` を作ります
- 「一般ユーザ名」: 作成されるOS内の一般ユーザ名に反映されます
- 「root/一般ユーザのパスワード」: 入力中は画面に表示されません

既存の生成物がある場合:

- 既に `UmuOS-0.1.1/` が存在する場合、**削除して作り直す**ための確認が出ます
- 続行する場合は `YES` と入力してください（それ以外は中断）

実行後（生成されたものを起動）:

```bash
cd "<生成されたUmuOS-0.1.1ディレクトリ>"
./umuOSstart.sh
```

`UMU_ROOT` を明示したい場合（ベース成果物探索の起点を変えたい場合）:

```bash
UMU_ROOT=~/umu_project ./install_0.1.1.sh
```

ヒント（毎回同じ場所に出したい場合）:

```bash
OUT_PARENT=~/umu_project/work ./install_0.1.1.sh
```

※この場合も、最終的にはプロンプトで確認されます（未入力でEnterすると上記が採用される）。

## files/

`files/` は、スクリプトから生成・投入するファイル（Cコード、設定ファイルなど）の素材を置く。

- 直接 `tee` で流し込む方式でもよい
- ただし、差分レビューしやすいように「材料としてのファイル」を残す方針を推奨
