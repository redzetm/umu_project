# ush-0.0.4-仕様書.md
UmuOS User Shell (ush) — 仕様書（0.0.4 / 拡張）  
Target OS: UmuOS-0.1.6-dev（想定）

この文書は、ush 0.0.3 の仕様を引き継ぎつつ、ush 0.0.4 で「ash（/bin/sh）に逃げずに日常操作で詰まらない」ための追加仕様を定義する。

0.0.4 の設計方針は次のとおり。

- 目標
  - ash に逃げずに「日常操作で詰まらない」ラインを作る
  - POSIX 準拠は目的にしない（ただし挙動は曖昧にせず仕様で固定）
- 設計思想
  - 最小限・高速・シンプル
  - 未対応は「検出してエラー」または「決め打ちで単純化」
  - 誤動作より観測可能性（何が起きたかが読める）を優先

---

# 1. 目的と非目的

## 1.1 目的
- UmuOS におけるユーザー向け対話シェルとして、軽量で観測可能な操作環境を提供する
- 直列処理・成功/失敗分岐（`&&` / `||`）中心の「小物スクリプト」を ush で書けるようにする
- 0.0.4 では、日常操作で頻出の以下を ush で扱えるようにする
  - コマンド区切り `;`
  - 最小のバックスラッシュエスケープ
  - `${VAR}` 展開
  - グロブ（`* ? [ ]`）
  - ファイル名（パス）Tab 補完

## 1.2 非目的（0.0.4ではやらない）
- POSIX sh / bash 互換の追求
- ジョブ制御（バックグラウンド実行 `&`、fg/bg、`jobs` 等）
- 制御構文（`if/for/while/case` 等）による本格スクリプト
- 位置パラメータ（`$1`、`$@` 等）を含む引数処理
- コマンド置換 `$(...)` / `` `...` ``
- ヒアドキュメント（`<<` / `<<<`）
- 高度な FD 操作（例: `2>file`、`n>file`、`2>&1` 等）
- 多段パイプ（`a|b|c`）

本格スクリプトが必要な場合は `/bin/sh`（BusyBox ash）で実行する。

---

# 2. 位置づけ（ash と ush）

## 2.1 役割分担
- `/umu_bin/ush` : ユーザー向け対話操作・軽量スクリプト（本仕様）
- `/bin/sh` : 互換性重視のスクリプト実行（BusyBox ash）

## 2.2 運用方針（推奨）
- 対話操作は ush を基本にする
- スクリプトは以下で使い分ける
  - ush: 直列処理・簡易な分岐（`&&`/`||`）・コマンド区切り `;`・（必要なら）グロブ程度までで足りるもの
  - sh: 分岐/ループ/引数処理/多段パイプ/高度なリダイレクトが必要なもの

---

# 3. ビルド方針
- musl-gcc による静的リンクを基本とする

---

# 4. 機能一覧（0.0.4）

## 4.1 対話シェル（0.0.3 継承）
- プロンプト表示
- 1 行入力（EOF/Ctrl-D で終了）
- 行編集（最低限）
  - Backspace/Delete/左右矢印/上下（履歴）
  - Tab 補完（0.0.4 で拡張。詳細は 15 章）
- PATH 検索（未設定時は `/umu_bin:/sbin:/bin`）
- 外部コマンド実行（fork/exec）
- builtins: `cd`, `pwd`, `export`, `exit`, `help`
- SIGINT の扱い（親は落ちない、子はデフォルト）

### 4.1.1 行編集の対応キー（0.0.3 継承）
- Enter: 行確定
- Ctrl-D: バッファ空なら EOF（終了）、非空なら無視
- BS(0x08)/DEL(0x7f): カーソル左を削除
- Delete（`ESC [ 3 ~`）: カーソル位置を削除
- 矢印（`ESC [ A/B/C/D`）: 履歴/移動
- Tab: 補完（0.0.4 で拡張。15章）

## 4.2 シェル言語（小物スクリプト向け）
### 0.0.3 から継承するもの
- クォート
  - シングルクォート `'...'`（展開なし）
  - ダブルクォート `"..."`（変数展開のみ）
- 展開
  - `$VAR`（環境変数）
  - `$?`（直前の終了コード）
  - `~` / `~/...`（チルダ展開）
- 演算子
  - `|`（1段パイプのみ）
  - `&&` / `||`（短絡評価）
  - `<` `>` `>>`（リダイレクト）
- コメント
  - `#`（行中コメント対応、ただしトークン先頭のみ）

### 0.0.4 で追加するもの
- コマンド区切り `;`
- 最小のバックスラッシュエスケープ（詳細は 10 章）
- `${VAR}` 形式の変数展開（詳細は 11 章）
- グロブ（`* ? [ ]`）の展開（詳細は 12 章）

---

# 5. 実行モデル

## 5.1 `last_status`（0.0.3 継承）
- ush は `last_status`（初期値 0）を保持する
- 外部コマンド実行後
  - 通常終了: `WEXITSTATUS(status)`
  - シグナル終了: `128 + WTERMSIG(status)`
- builtin 実行後
  - 成功: 0
  - 実行エラー: 1
  - 構文/引数不正: 2
- 対話モードの EOF（Ctrl-D）は `exit(last_status)`

外部コマンド探索の慣習：
- 未発見: 127
- 実行不可（権限等）: 126

## 5.2 エラーメッセージ（0.0.3 継承）
- stderr に出力し、先頭に `ush:` を付与する
- 代表例
  - `ush: unsupported syntax`
  - `ush: syntax error`
  - `ush: open: <strerror>`

## 5.3 失敗時の優先順位（0.0.3 継承）
同一行の評価で複数の「失敗要因」があり得るため、0.0.4 でも次の順序で `last_status` を決める。

1) 字句/構文段階の失敗
  - 未対応構文検出: `last_status = 2`（その行は実行しない）
  - 構文エラー: `last_status = 2`（その行は実行しない）
2) リダイレクトの失敗
  - `open()` 等に失敗: `last_status = 1`（その行は実行しない）
3) 実行（fork/exec）段階の失敗
  - コマンド探索に失敗: 126/127
4) 実行結果
  - 外部コマンド: 0..255 または `128 + signal`
  - builtins: 0/1/2

---

# 6. トークナイズ（字句）

## 6.1 区切り（0.0.3 継承）
- 空白（スペース/タブ）で区切る
- 連続空白は 1 つの区切りとして扱う（先頭/末尾は無視）

## 6.2 コメント（`#`）（0.0.3 継承）
未クォートで、かつ「トークン先頭の `#`」をコメント開始として扱う。

- `# ...` / `   # ...` はその行を無視
- `echo hi # comment` の `#` 以降を無視
- `echo foo#bar` の `#` はトークン途中なのでコメント扱いしない

## 6.3 演算子（独立トークン）
空白の有無に関わらず、以下を独立トークンとして認識する。

- `|` `&&` `||` `<` `>` `>>` `;`

ただし、クォート内では演算子は文字として扱う。

## 6.4 クォート（0.0.3 継承）
### 6.4.1 シングルクォート（`'...'`）
- 囲まれた範囲は 1 トークン
- 展開なし
- 閉じクォートがない場合はエラー

### 6.4.2 ダブルクォート（`"..."`）
- 囲まれた範囲は 1 トークン
- ダブルクォート内は空白や演算子も文字
- ダブルクォート内で行う展開は **変数展開のみ**（`$VAR`, `$?`, `${VAR}`）
- 閉じクォートがない場合はエラー

## 6.5 バックスラッシュ（0.0.4 追加）
- バックスラッシュによる **行継続（`\` + 改行）** は未対応
- ただし、0.0.4 では最小の「1文字エスケープ」を導入する（詳細は 10 章）

## 6.6 未対応トークンの検出（0.0.3継承 + 明文化）
- 単体 `&` は未対応（`&&` のみ対応）
- `(` `)` `{` `}` は未対応
- これらを未クォートで検出した場合は、その行は実行せず `unsupported syntax` とする

---

# 7. 構文（パーサ）

## 7.1 優先順位
- `|` が高い
- `&&` / `||` が中
- `;` が低い（左から順に実行）

## 7.2 文法（概略）
コメントはトークナイザ段階で除去されている前提とする。

```
line        := seq
seq         := list (";" list)*
list        := pipeline ( ("&&" | "||") pipeline )*
pipeline    := command ("|" command)?
command     := words redirects?
words       := WORD+
redirects   := ("<" WORD)? ((">"|">>") WORD)?
```

### 7.2.1 リダイレクトの位置（0.0.3 継承）
- リダイレクトは **コマンド引数（words）の後ろにまとめて書く**
  - OK: `cat a.txt > out.txt`
  - NG: `cat > out.txt a.txt`（`syntax error`）
- 同一コマンド内で許可するリダイレクト
  - `<` は 0 個または 1 個
  - `>` / `>>` は 0 個または 1 個（両方同時は不可）
- パイプは 1 段まで（最大 2 コマンド）
- `<` はパイプライン先頭コマンドのみ
- `>` / `>>` はパイプライン末尾コマンドのみ

### 7.2.2 `;` の制約（0.0.4 追加）
- `;` は「コマンド列」の区切りであり、空要素は許可しない
  - 例: `; ls` / `ls ;` / `ls ;; pwd` は `syntax error`

---

# 8. 実行（exec）

## 8.1 条件実行（`&&`, `||`）（0.0.3 継承）
- `A && B` : `A` が 0 のときだけ `B`
- `A || B` : `A` が 0 以外のときだけ `B`

## 8.2 コマンド区切り（`;`）（0.0.4 追加）
- `A ; B` : `A` を実行してから必ず `B`
- `last_status` は最後に実行した要素の終了コード

## 8.3 パイプ（1段）（0.0.3 継承）
- `cmd1 | cmd2` のみ
- `last_status` は右側（cmd2）の終了コード

## 8.4 リダイレクト（0.0.3 継承）
- `< file` : `open(file, O_RDONLY)`
- `> file` : `open(file, O_WRONLY | O_CREAT | O_TRUNC, 0644)`
- `>> file` : `open(file, O_WRONLY | O_CREAT | O_APPEND, 0644)`

失敗時：
- stderr に `ush: open: <strerror>` など
- 行の実行を中止し `last_status = 1`
- **この行では 1 つも fork/exec しない**（部分実行を防ぐ）

## 8.5 コマンド探索（0.0.3 継承）
- コマンドに `/` を含む場合は PATH 検索しない
- `/` を含まない場合は `$PATH` を `:` 区切りで走査
- 実行不可（EACCES）候補が 1 つでもあれば、最終失敗は 126
- それ以外は 127
- `execve()` が `ENOEXEC` の場合のみ `/bin/sh` へフォールバックする

---

# 9. builtins（0.0.3 継承）
対象： `cd`, `pwd`, `export`, `exit`, `help`

## 9.1 builtins の実行条件
- builtins は親プロセス（ush 本体）で実行する
- `&&` / `||` の左右要素として builtins を置くことは許可する

制限：
- builtins は「パイプなし」かつ「リダイレクトなし」の場合のみ対応
- builtins をパイプに含めることは未対応

## 9.2 各 builtin の仕様（0.0.3 継承）
- `cd [DIR]`
  - `DIR` 省略時は `$HOME`（未設定なら `/`）
  - 引数過多は `syntax error` 相当（終了コード 2）
- `pwd`
  - 現在ディレクトリを 1 行で出力
  - 引数がある場合は終了コード 2
- `export NAME=VALUE` / `export NAME`
  - `NAME=VALUE` は環境変数を設定
  - `NAME` のみは、未定義なら空文字で作成（定義済みなら維持）
  - `NAME` は `[A-Za-z_][A-Za-z0-9_]*`
- `exit [N]`
  - `N` 省略時は `last_status`
  - `N` は 10 進整数（0..255 に丸め）
- `help`
  - builtins 一覧と主要演算子を表示

---

# 10. バックスラッシュエスケープ（0.0.4 追加）

## 10.1 基本方針
- 0.0.4 では「普段使いで困らない」ための **最小の 1 文字エスケープ**のみ導入する
- 行継続（`\` + 改行）は未対応

## 10.2 未クォートでの扱い
未クォートで `\X` を見た場合、次の 1 文字 `X` を **リテラル**としてトークンに取り込む。

対象文字 `X` は以下に限定する。
- 空白（スペース/タブ）
- `\\` `'` `"`
- `$`
- `;` `|` `&` `<` `>`
- `*` `?` `[` `]`

規約：
- 対象外の `\X` は、`\` を通常文字として扱う（エラーにはしない）

## 10.3 ダブルクォート内での扱い
ダブルクォート内では以下のみ特別扱いする。
- `\"` → `"`
- `\\` → `\\`
- `\$` → `$`

それ以外の `\` は通常文字。

## 10.4 シングルクォート内
- シングルクォート内ではエスケープは解釈しない（0.0.3 継承）

---

# 11. 変数展開（0.0.4 拡張）

## 11.1 対応
- `$NAME`（`NAME` は `[A-Za-z_][A-Za-z0-9_]*`）
- `${NAME}`（同上）
- `$?`（`last_status` を 10 進で展開）

規約：
- 未定義の環境変数は空文字
- シングルクォート内は展開しない
- ダブルクォート内と未クォートで展開する

## 11.2 未対応（検出してエラー）
- `${...}` の派生（例: `${NAME:-default}` 等）
- `${?}`
- `$1` などの位置パラメータ
- `$(...)` / `` `...` ``

未対応検出時：
- stderr に `ush: unsupported syntax`
- `last_status = 2`

---

# 12. グロブ展開（0.0.4 追加）

## 12.1 対象
- **未クォートの WORD** に `*` `?` `[` `]` のいずれかが含まれる場合、グロブ展開を試みる
- クォート内（シングル/ダブル）はグロブしない

## 12.2 パターン規則（最小）
- `*` : 任意長（空文字含む）
- `?` : 任意 1 文字
- `[...]` : 文字クラス（列挙のみ）
  - 例: `[abc]` は `a` または `b` または `c`
  - 範囲指定（`[a-z]`）は 0.0.4 では未対応（検出して `unsupported syntax`）

## 12.3 先頭ドット
- パターン先頭が `.` のときだけ、先頭 `.` のファイルにマッチする

## 12.4 マッチ0件の扱い（重要）
- マッチが 0 件の場合は **エラーにしない**
- その WORD は「展開せず、そのまま」argv に残す

## 12.5 並び順
- 0.0.4 では `readdir()` 順でよい（安定ソートは将来課題）

---

# 13. チルダ展開（0.0.3 継承）
未クォートのトークン先頭で、以下のみ対応する。

- `~` → `$HOME`
- `~/path` → `$HOME/path`

規約：
- `$HOME` が未設定の場合は `~` を `/` とみなす
- クォート内では展開しない
- `~user` は未対応

---

# 14. 未対応（検出してエラー）一覧
0.0.4 でも以下は未対応とし、検出したらその行は実行しない。

- バックグラウンド `&`（`&&` は対応）
- `(`, `)`, `{`, `}`
- 行継続（`\` + 改行）
- ヒアドキュメント（`<<` / `<<<`）
- 環境代入（先頭 `NAME=...` 形式。例: `FOO=bar echo hi`）
  - ただし `export NAME=VALUE` は builtin として許可
- 位置パラメータ、コマンド置換、算術展開
- 多段パイプ
- stderr/FD リダイレクト、FD 操作

未対応検出時：
- stderr に `ush: unsupported syntax`
- `last_status = 2`

---

# 15. Tab 補完（0.0.4 拡張）

## 15.1 目的
- 普段の編集作業（`vim te<Tab>` など）で詰まらない

## 15.2 補完対象
- 0.0.3: 先頭トークン（コマンド名）のみ
- 0.0.4: **カーソル位置を含む「現在トークン」**を補完対象にする

制限（0.0.4）：
- クォートやエスケープを含む複雑ケースは「補完しない」（誤動作を避ける）

## 15.3 候補ソース
- 先頭トークン（コマンド名）
  - builtins + `$PATH` 上のエントリ
- それ以外（引数・パス）
  - トークンに `/` を含む場合: そのディレクトリを走査して候補を列挙
  - `/` を含まない場合: `.`（カレント）を走査して候補を列挙

## 15.4 挙動
- 候補が 1 つ: 確定補完（バッファ書き換え＋再描画）
- 候補が複数: 共通プレフィックスが伸びる分だけ補完
- それ以上決められない: 改行して候補一覧を表示→プロンプト＋入力行を再描画
- 候補がディレクトリの場合は末尾に `/` を付けてよい

---

# 16. スクリプトモード（0.0.3 継承）

## 16.1 起動
- `ush <script>` でスクリプトモード
- `#!/umu_bin/ush` を想定

## 16.2 実行規約
- 1 行ずつ読み、各行を対話と同じ評価器で実行する
- 空行/コメント行はスキップ
- 先頭行が `#!` で始まる場合は 1 行目を無視する
- `exit` が実行されたら、その時点で終了する

エラー時：
- `unsupported syntax` / `syntax error` が起きても次の行へ進む（fail-fast は未対応）
- 実行エラーでも次の行へ進む

---

# 17. シグナル（0.0.3 継承）
- 親（ush 本体）は SIGINT で落ちない
- 子は SIGINT をデフォルト動作に戻してから exec する

---

# 18. 制限値（0.0.3 継承）
- 1 行の最大長: 8192
- 最大引数数: 128
- 1 トークン最大長: 1024

---

# 19. プロンプト（0.0.3 継承）
- 優先順位: `USH_PS1` → `PS1` → デフォルト
- ush 自身は rc（例: `/etc/profile`）を自動で読まない。必要なら起動前に親側で `export` しておく。
- デフォルト: `\u@UmuOS:ush:\w\$ `
- 展開（最小）: `\u`, `\w`, `\$`, `\\`

---

# 20. UmuOS への組み込み
- ビルドした `ush` バイナリを `/umu_bin/ush` に配置
- `/bin/sh` は BusyBox のまま維持

---

# 21. 受け入れ（仕様観点）
以下が成立していること。
- `;` が左から順に実行され、空要素が `syntax error` になる
- `${VAR}` が `$VAR` と同等に展開され、派生形は `unsupported syntax` になる
- グロブが未クォートのみで展開され、0件マッチ時はそのまま残る
- 最小エスケープで `\*` 等によりグロブを抑止できる
- Tab 補完が「現在トークン」に対して動作し、ファイル名補完が可能
- 0.0.3 の `&&/||`、1段パイプ、リダイレクトの「fork前open」などの成立条件が維持される

---

# 22. 一般的なシェルと比較して足りない機能一覧（参考）
この章は、将来の検討用メモであり、0.0.4 の必須要件ではない。

## 22.1 ジョブ制御・プロセス管理
- バックグラウンド実行 `&`
- `jobs` / `fg` / `bg`
- 端末制御（プロセスグループ、TTY の奪い合い制御）

## 22.2 制御構文（本格スクリプト機能）
- `if/then/elif/else/fi`
- `for/while/until/do/done`
- `case/esac`
- `break` / `continue`

## 22.3 コマンド置換・算術・式評価
- コマンド置換 `$(...)` / `` `...` ``
- 算術展開 `$((...))`、算術評価（`let` など）
- `test`/`[` `]` を用いた条件評価（細かな互換挙動含む）

## 22.4 位置パラメータ・引数処理
- `$0..$9`、`$1`、`$@`、`$*`、`$#` 等
- `shift`
- `getopts` 相当

## 22.5 リダイレクト・FD 操作（高度）
- stderr/任意FDのリダイレクト（例: `2>file`, `2>>file`, `2>&1`, `n>file` 等）
- ヒアドキュメント（`<<`）/ ヒアストリング（`<<<`）

## 22.6 パイプ・コマンド連結（高度）
- 多段パイプ（`a | b | c ...`）
- パイプ失敗の扱い（`pipefail` 的なもの）

## 22.7 グルーピング・サブシェル・関数
- サブシェル `(...)`
- グルーピング `{ ...; }`
- シェル関数定義とスコープ（`name(){ ...; }` 等）

## 22.8 変数・展開（高度）
- パラメータ展開の派生形（例: `${VAR:-default}`, `${VAR%pat}`, `${#VAR}` 等）
- 配列、連想配列
- `export` 以外の変数（シェルローカル変数）と代入（`NAME=VALUE cmd` を含む）

## 22.9 対話機能（強い使い勝手）
- 高度な履歴（検索、部分一致、永続化、`Ctrl-R`）
- 高度な行編集（Emacs/vi モード、単語単位移動、kill/yank 等）
- 高度な補完（オプション補完、コンテキスト補完、補完メニュー等）

## 22.10 互換挙動・シェル運用機能
- `set -e/-u`、`IFS`、`trap`、`source`（`.`）などの運用要素
- ush 自身が起動時に rc を自動 `source` する仕組み（例: `/etc/profile`, `~/.profile`, `~/.shrc` 等）※ush は親プロセスの環境変数を継承するため、親側で rc を読んで `export` 済みなら ush 側でも参照できる。

