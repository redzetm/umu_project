# ush-spec.md
UmuOS User Shell (ush) — MVP 仕様書  
Version: 0.1.0-MVP  
Target OS: UmuOS-0.1.4-base-stable  

---

# 1. 概要
ush（ウッシュ）は **UmuOS の対話型ユーザーシェル**として設計される。

既存の `/bin/sh`（BusyBox）は以下の用途で継続利用する：

- `/bin/sh` → サーバーソフト・スクリプト実行用（BusyBox sh）
- `/bin/ush` → ユーザー向け対話シェル（本仕様で実装）

ush は **最小限・高速・シンプル・教育的** を理念とし、UmuOS の世界観に沿った独自性を持つ。

---

# 2. 哲学（Philosophy）
ush の設計思想は以下の通り。

- **最小限・高速・シンプル**
- **教育的で読みやすいコード**
- **UmuOS の世界観に沿った独自性**
- **POSIX 互換性は追わない**
  - ただし将来 Apache などを動かすために `/bin/sh`（BusyBox）を残す

ush は「ユーザー向けの対話シェル」であり、POSIX sh とは役割を分離する。

---

# 3. ビルド方針
- **musl-gcc による静的リンクビルド**
  - glibc に依存しない自己完結バイナリを生成する
  - Alpine Linux と同様の軽量・堅牢な構成を目指す

- **開発ホストで静的リンクビルドして持ち込む**
  - UmuOS 上でのビルドは MVP 対象外とする
  - 生成物は単一バイナリとして完結させ、環境依存を最小限にする
  - 静的リンクが難しい場合でも、MVP では動的リンクへのフォールバックは行わない

例：
musl-gcc -static -o ush main.o ...

---

# 4. MVP（Minimum Viable Product）
ush の MVP は「最小限の実用性を持つ最初の完成形」とする。

## 4.1 MVPで実装する機能
### ✔ 入力処理
- プロンプト表示
- 標準入力から1行取得
- EOF（Ctrl-D）で終了
- 空行・空白だけの行は何もせず再プロンプト

### ✔ トークナイズ（parser）
- 空白（スペース/タブ）区切り
- 連続空白は1つの区切りとして扱う（先頭/末尾空白は無視）
- 行頭の `#`（先頭の空白は許容）をコメントとして無視
- クォート/バックスラッシュ/変数展開/グロブ/演算子は MVP では未対応（検出したらエラー）

### ✔ PATH 検索
- `$PATH` を走査して実行ファイルを探す
  - `$PATH` 未設定時のデフォルトは `/bin:/sbin`

### ✔ 実行（exec）
- `fork()`
- 子プロセスで `execve()`
- 親プロセスで `waitpid()`
- `execve()` は親の環境を引き継ぐ（`environ` を渡す）
- `execve()` が `ENOEXEC` の場合のみ `/bin/sh` へフォールバック

### ✔ builtins（内蔵コマンド）
- `cd`
- `exit`
- `help`（UmuOSらしい説明を表示）

### ✔ シグナル（最低限）
- 親（ush）は SIGINT（Ctrl+C）で落ちない
- 子プロセスは SIGINT をデフォルト動作に戻してから exec する

### ✔ プロンプト
- `UmuOS:ush:<cwd>$`
- `<cwd>` は `getcwd()` で取得

例：
UmuOS:ush:/home/tama$

## 4.2 MVP仕様（詳細）

### 4.2.1 終了コード（`last_status`）
- ush は `last_status`（初期値 0）を保持する
- 外部コマンド実行後:
  - 通常終了: `WEXITSTATUS(status)` を `last_status` に保存
  - シグナル終了: `128 + WTERMSIG(status)` を `last_status` に保存
- builtin 実行後:
  - 成功: 0、失敗: 1（引数不正などは 2）を `last_status` に保存
- EOF（Ctrl-D）で終了する場合は `exit(last_status)` とする

### 4.2.2 エラーメッセージ
- エラーは stderr に出力する
- 先頭に `ush:` を付与する
- 終了コード慣習:
  - コマンド未発見: 127
  - 見つかったが実行不可（権限など）: 126

### 4.2.3 トークナイズ
- 区切りは空白類（スペース・タブ）とする
- 行頭コメント: 「最初の非空白文字が `#`」の行は無視する
- 未対応事項（MVP）:
  - クォート（`'` / `"`）
  - バックスラッシュ（`\\`）によるエスケープ
  - 変数展開（`$VAR`）
  - グロブ（`* ? []`）
  - 演算子（`| < > >> ; &`）
- 未対応事項を検出した場合はエラーとしてその行を実行しない

### 4.2.4 コマンド探索と実行
- コマンド文字列に `/` が含まれる場合は PATH 検索しない（指定パスをそのまま exec）
- `/` を含まない場合のみ `$PATH` を走査して探索する
- PATH 走査では以下を行う:
  - 実行可能な候補が見つかったらそれを exec する
  - 「存在するが実行不可（例: EACCES）」な候補が1つでもあったかを記録する
  - 最後まで実行できなかった場合:
    - 実行不可候補があった: permission denied（終了 126）
    - それ以外: command not found（終了 127）
- 子プロセスへの環境引き継ぎは親の `environ` を用いる
- `execve()` が `ENOEXEC` の場合のみ、`/bin/sh <file> ...` にフォールバックして実行する

### 4.2.5 builtins
- `cd`
  - `cd` 引数なし: `$HOME` があれば `$HOME`、なければ `/` に移動
  - `cd -` は MVP では未対応（エラー）
  - `cd` 成功時に `PWD` と `OLDPWD` を更新する（`setenv` 等）
- `exit`
  - `exit` は `last_status` で終了
  - `exit n` は `n & 255` で終了
  - 引数が数値でない／引数が多すぎる場合はエラーとして終了しない（`last_status` は 2）
- `help`
  - builtins 一覧と未対応事項（クォート、パイプ等）を簡潔に表示する

### 4.2.6 シグナル
- 親（ush 本体）は SIGINT を無視する（方針A）
- 子プロセスは SIGINT をデフォルト動作に戻してから exec する（Ctrl+C で子だけ止まる）

### 4.2.7 制限値
- 1行の最大長: 8192
- 最大引数数: 128
- 1トークン最大長: 1024
- 上限超過時はエラーとしてその行を破棄し、次のプロンプトへ戻る

### 4.2.8 メモリ確保
- 行は `getline()` 等で動的に取得する
- トークンは行バッファを `\0` 区切りにして `argv[]` にポインタ参照で並べる
- `argv[]` は固定上限を設け、上限超過はエラーにする

---

# 5. ディレクトリ構造
ush のソースツリーは以下の構造とする。

ush/
├── main.c            // メインループ
├── parser/           // トークナイザ・構文解析
├── exec/             // 実行系（fork/exec）
├── builtins/         // 内蔵コマンド
├── env/              // 環境変数管理
└── utils/            // 便利関数

---

# 6. UmuOS への組み込み
- ビルドした `ush` バイナリを `/bin/ush` に配置
- `/bin/sh` は BusyBox のまま維持

---

# 7. 将来の拡張（MVP以降）
- パイプ `|`
- リダイレクト `< > >>`
- ジョブ制御（簡易版）
- コマンド履歴
- 補完機能
- カラー表示
- シェルスクリプト実行（構文対応）
- POSIX 互換性の強化（たぶんやらない、少なくとも今回はやらない）

---

# 8. 付録：help コマンドの例
ush - UmuOS User Shell (MVP)
Builtins:
cd <dir>     Change directory
exit         Exit ush
help         Show this help

---

# 9. ライセンス
UmuOS は研究目的のプロジェクトのため、ライセンスは後日整理して追記します。


