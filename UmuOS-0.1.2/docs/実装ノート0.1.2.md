# 実装ノート0.1.2

目的：詳細設計書-0.1.2.md の手順を、再現可能なログとして残す。

- 対象：UmuOS-0.1.2
- 重要方針：1回の実験で変えるのは1点だけ（混線防止）
- 観測の一次証拠：①ホスト側ログ（logs/）＋②ゲスト側ログ（/logs/boot.log）

---

## 2026-01-12

### 実施範囲
- 2. 事前準備（2.1 必要パッケージ）
- 3. 作業ディレクトリ作成
- 4. Kernel（6.18.1）取得・ビルド・配置（4.4 まで）
- 5. 永続ディスク（disk.img）作成・UUID取得
- 6. ext4 ルート（disk.img）中身を作る（6.10 まで）
- 7. initramfs（/init）作成（7.4 まで）
- 8. GRUB 設定（8.1 まで）
- 9. ISO 生成（9 まで）
- 10. 起動スクリプト（10.1 まで）
- 11. QEMU 起動
- 12. 受入チェック（12.6 まで）

### 結果
- OK（受入チェックまで完了：switch_root/ext4/login/二系統ログ/永続性）

### 実行内容（要点）
- 作業ルート：`~/umu/umu_project/UmuOS-0.1.2`
- 使った環境：Ubuntu 24.04.3 LTS
- 実行コマンド：
  - `sudo apt update`
  - `sudo apt install -y build-essential bc bison flex libssl-dev libelf-dev libncurses-dev dwarves git wget grub-efi-amd64-bin grub-common xorriso mtools qemu-system-x86 ovmf cpio gzip xz-utils busybox-static e2fsprogs musl-tools util-linux`
- 出力メモ（apt install 抜粋）：
  - `アップグレード: 0 個、新規インストール: 0 個、削除: 0 個、保留: 0 個。`

（3. 作業ディレクトリ作成）

- 実行コマンド：
  - `cd ~/umu/umu_project/UmuOS-0.1.2`
  - `mkdir -p {kernel,initramfs/{rootfs,src},iso_root/boot/grub,disk,run,logs,docs}`
  - `ls -d kernel initramfs initramfs/rootfs initramfs/src iso_root/boot/grub disk run logs docs`
- 出力メモ（ls 抜粋）：
  - `disk  docs  initramfs  initramfs/rootfs  initramfs/src  iso_root/boot/grub  kernel  logs  run`

（4.1 Kernel 取得と展開）

- 実行コマンド：
  - `cd ~/umu/umu_project/UmuOS-0.1.2/kernel`
  - `tar -xf linux-6.18.1.tar.xz`
  - `rm linux-6.18.1.tar.xz`
- 出力メモ：
  - `linux-6.18.1/` が作成されたことを確認
  - tarball（`linux-6.18.1.tar.xz`）は削除

（4.2 Kernel ビルド）

- 実行内容（ログ抜粋）：
  - `Kernel: arch/x86/boot/bzImage is ready  (#1)`

（4.3 必須カーネル設定の確認）

- 実行コマンド：
  - `grep -E '^(CONFIG_EXT4_FS=|CONFIG_DEVTMPFS=|CONFIG_DEVTMPFS_MOUNT=|CONFIG_BLK_DEV_INITRD=|CONFIG_VIRTIO_BLK=|CONFIG_RD_GZIP=)' .config`
- 出力メモ：
  - `CONFIG_BLK_DEV_INITRD=y`
  - `CONFIG_RD_GZIP=y`
  - `CONFIG_DEVTMPFS=y`
  - `CONFIG_DEVTMPFS_MOUNT=y`
  - `CONFIG_VIRTIO_BLK=y`
  - `CONFIG_EXT4_FS=y`

（4.4 ISO へ配置）

- 実行コマンド：
  - `cd ~/umu/umu_project/UmuOS-0.1.2`
  - `cp kernel/linux-6.18.1/arch/x86/boot/bzImage iso_root/boot/vmlinuz-6.18.1`
  - `cp kernel/linux-6.18.1/.config iso_root/boot/config-6.18.1`
  - `file iso_root/boot/vmlinuz-6.18.1`
- 出力メモ（file 抜粋）：
  - `Linux kernel x86 boot executable bzImage, version 6.18.1 ...`

（5.1 永続ディスク作成 + 5.2 UUID取得）

- 実行コマンド：
  - `cd ~/umu/umu_project/UmuOS-0.1.2/disk`
  - `truncate -s 4G disk.img`
  - `mkfs.ext4 -F disk.img`
  - `sudo blkid -p -o value -s UUID disk.img`
- 出力メモ（mkfs.ext4 抜粋）：
  - `Filesystem UUID: 806c6520-f1e2-4186-8584-e43b95507886`
- 出力メモ（blkid 抜粋）：
  - `806c6520-f1e2-4186-8584-e43b95507886`

- DISK_UUID：`806c6520-f1e2-4186-8584-e43b95507886`

（6.1〜6.5 ext4 ルート作成：mount + BusyBox）

- 実行コマンド：
  - `sudo mount -o loop ~/umu/umu_project/UmuOS-0.1.2/disk/disk.img /mnt/umuos012`
  - `findmnt /mnt/umuos012`
  - `sudo mkdir -p /mnt/umuos012/{bin,sbin,etc,proc,sys,dev,dev/pts,run,home,root,tmp,logs,etc/init.d}`
  - `sudo cp /bin/busybox /mnt/umuos012/bin/busybox`
  - `sudo chown root:root /mnt/umuos012/bin/busybox`
  - `sudo chmod 755 /mnt/umuos012/bin/busybox`
  - `file /mnt/umuos012/bin/busybox`
  - `sudo chroot /mnt/umuos012 /bin/busybox --install -s /bin`
  - `sudo chroot /mnt/umuos012 /bin/busybox --install -s /sbin`
  - `sudo ls -l /mnt/umuos012/bin/sh`
  - `sudo ls -l /mnt/umuos012/sbin/init`
  - `sudo ln -sf /bin/busybox /mnt/umuos012/sbin/init`
  - `sudo ls -l /mnt/umuos012/sbin/init`
- 出力メモ（findmnt）：
  - `/mnt/umuos012 /dev/loop4 ext4 rw,relatime`
- 出力メモ（busybox 静的確認）：
  - `statically linked`
- 出力メモ（symlink 確認）：
  - `/mnt/umuos012/bin/sh -> /bin/busybox`
  - `/mnt/umuos012/sbin/init -> /bin/busybox`

（6.6 inittab / 6.7 rcS 作成）

- 実行コマンド：
  - `sudo tee /mnt/umuos012/etc/inittab >/dev/null <<'EOF' ... EOF`
  - `sudo tee /mnt/umuos012/etc/init.d/rcS >/dev/null <<'EOF' ... EOF`
  - `sudo chmod 755 /mnt/umuos012/etc/init.d/rcS`
- 出力メモ：
  - `tee` は出力なし（正常）

- メモ：rcS は ② 永続ログ（`/logs/boot.log`）を 1ブート=1ブロックで追記する想定

（6.8 ユーザー設定 + 6.9 必須ファイル確認）

- 実行コマンド：
  - `sudo tee /mnt/umuos012/etc/passwd >/dev/null <<'EOF' ... EOF`
  - `sudo tee /mnt/umuos012/etc/group >/dev/null <<'EOF' ... EOF`
  - `openssl passwd -6`（root / tama の2回）
  - `sudo tee /mnt/umuos012/etc/shadow >/dev/null <<'EOF' ... EOF`
  - `sudo chown root:root /mnt/umuos012/etc/shadow`
  - `sudo chmod 600 /mnt/umuos012/etc/shadow`
  - `sudo mkdir -p /mnt/umuos012/root`
  - `sudo mkdir -p /mnt/umuos012/home/tama`
  - `sudo chown 1000:1000 /mnt/umuos012/home/tama`
  - `sudo ls -l /mnt/umuos012/sbin/init`
  - `sudo ls -l /mnt/umuos012/etc/inittab`
  - `sudo ls -l /mnt/umuos012/etc/init.d/rcS`
  - `sudo ls -l /mnt/umuos012/etc/passwd`
  - `sudo ls -l /mnt/umuos012/etc/shadow`

- 出力メモ（ls -l 抜粋）：
  - `/mnt/umuos012/sbin/init -> /bin/busybox`
  - `/mnt/umuos012/etc/inittab` は `-rw-r--r--`
  - `/mnt/umuos012/etc/init.d/rcS` は `-rwxr-xr-x`
  - `/mnt/umuos012/etc/passwd` は `-rw-r--r--`
  - `/mnt/umuos012/etc/shadow` は `-rw-------`（600）

- メモ：パスワードハッシュはログには残さず、設定した事実のみ記録（再現は詳細設計書の手順で実施）

（6.10 umount）

- 実行コマンド：
  - `sync`
  - `sudo umount /mnt/umuos012`

（7.1 initramfs rootfs 骨格 + BusyBox applet）

- 実行コマンド：
  - `cd ~/umu/umu_project/UmuOS-0.1.2/initramfs`
  - `rm -rf rootfs`
  - `mkdir -p rootfs/{bin,sbin,etc,proc,sys,dev,dev/pts,run,newroot}`
  - `cp /bin/busybox rootfs/bin/busybox`
  - `chmod 755 rootfs/bin/busybox`
  - `sudo chroot rootfs /bin/busybox --install -s /bin`
  - `ls -l rootfs/bin/switch_root`
- 出力メモ（ls -l 抜粋）：
  - `rootfs/bin/switch_root -> /bin/busybox`

（7.2 init.c コピー + musl 静的ビルド）

- 実行コマンド：
  - `cd ~/umu/umu_project/UmuOS-0.1.2`
  - `cp -a ~/umu/umu_project/UmuOS-0.1.1/initramfs/src/init.c initramfs/src/init.c`
  - `musl-gcc -static -O2 -Wall -Wextra -o initramfs/rootfs/init initramfs/src/init.c`
  - `chmod 755 initramfs/rootfs/init`
  - `file initramfs/rootfs/init`
- 出力メモ（file 抜粋）：
  - `statically linked` を確認（`ELF 64-bit ... statically linked ...`）

（7.3 initrd 生成：cpio + gzip + 内容確認）

- 実行コマンド：
  - `cd ~/umu/umu_project/UmuOS-0.1.2/initramfs/rootfs`
  - `rm -f ../initrd.filelist0 ../initrd.cpio ../initrd.cpio.list ../initrd.img-6.18.1`
  - `find . -print0 > ../initrd.filelist0`
  - `cpio --null -ov --format=newc < ../initrd.filelist0 > ../initrd.cpio`
  - `cd ../`
  - `cpio -t < initrd.cpio > initrd.cpio.list`
  - `grep -E '^(init|bin/switch_root)$' initrd.cpio.list`
  - `gzip -9 -c initrd.cpio > initrd.img-6.18.1`
  - `ls -lh initrd.img-6.18.1`
- 出力メモ：
  - `cpio`：`4336 ブロック`
  - 観測点：`bin/switch_root` と `init` が入っていることを確認
  - `ls -lh initrd.img-6.18.1`：`1.1M`

（7.4 ISO へ initrd 配置）

- 実行コマンド：
  - `cd ~/umu/umu_project/UmuOS-0.1.2`
  - `cp initramfs/initrd.img-6.18.1 iso_root/boot/initrd.img-6.18.1`
  - `ls -l iso_root/boot/initrd.img-6.18.1`
- 出力メモ（ls -l 抜粋）：
  - `-rw-rw-r-- 1 tama tama 1137159  1月 12 14:21 iso_root/boot/initrd.img-6.18.1`

（8.1 GRUB 設定：grub.cfg 作成 + root=UUID 観測点）

- 実行コマンド：
  - `cd ~/umu/umu_project/UmuOS-0.1.2`
  - `tee iso_root/boot/grub/grub.cfg >/dev/null <<'EOF' ... EOF`
  - `grep -n "root=UUID" iso_root/boot/grub/grub.cfg`
- 出力メモ（grep 抜粋）：
  - `15:        root=UUID=806c6520-f1e2-4186-8584-e43b95507886 \\`

（9 ISO 生成：grub-mkrescue）

- 実行コマンド：
  - `cd ~/umu/umu_project/UmuOS-0.1.2`
  - `rm -f UmuOS-0.1.2-boot.iso`
  - `grub-mkrescue -o UmuOS-0.1.2-boot.iso iso_root`
  - `ls -lh UmuOS-0.1.2-boot.iso`
- 出力メモ（grub-mkrescue/ls 抜粋）：
  - `Writing to 'stdio:UmuOS-0.1.2-boot.iso' completed successfully.`
  - `-rw-rw-r-- 1 tama tama 27M  1月 12 15:13 UmuOS-0.1.2-boot.iso`

（10.1 起動スクリプト作成：umuOSstart.sh）

- 実行コマンド：
  - `cd ~/umu/umu_project/UmuOS-0.1.2`
  - `tee umuOSstart.sh >/dev/null <<'EOF' ... EOF`
  - `chmod 755 umuOSstart.sh`
- 出力メモ：
  - `tee` は出力なし（正常）

（10 観測点：ホスト側ログ生成）

- 出力メモ（ls 抜粋）：
  - `logs/qemu-serial_20260112_152229.log`（生成を確認）

（11 QEMU 起動：./umuOSstart.sh）

- 実行コマンド：
  - `cd ~/umu/umu_project/UmuOS-0.1.2`
  - `./umuOSstart.sh`
- 出力メモ（シリアルログ 抜粋）：
  - `exec: /bin/switch_root /newroot /sbin/init`
  - `login: root`（root ログインできたことを確認）

（12 受入チェック：ext4 側で root 確認）

- 実行コマンド（ゲスト）:
  - `id`
  - `uname -r`
  - `mount`
- 出力メモ（抜粋）:
  - `uid=0(root) gid=0(root) groups=0(root)`
  - `6.18.1`
  - `/dev/vda on / type ext4 (rw,relatime)`

（12 受入チェック：tama ログイン + ② /logs/boot.log 確認）

- 実行コマンド（ゲスト）:
  - `id`
  - `uname -r`
  - `mount`
  - `ls -lah /logs`
  - `tail -n 200 /logs/boot.log`
- 出力メモ（抜粋）:
  - `uid=1000(tama) gid=1000(tama) groups=1000(tama)`
  - `/dev/vda on / type ext4 (rw,relatime)`
  - `/logs/boot.log` が存在（例：`-rw-r--r--    1 root     root       60.6K ... boot.log`）
  - `tail` 末尾に `===== boot end =====` が見える（rcS による「1ブート=1ブロック」追記の証拠）

（12 受入チェック：12.5 永続性（ファイル作成→再起動））

- 実行コマンド（ゲスト：tama）:
  - `echo "persist" > /home/tama/persist_test.txt`
  - `ls`（確認）
  - `sync`
  - `reboot`
- 出力メモ（抜粋）:
  - `reboot: Operation not permitted`（tama では再起動できない）
- 実行コマンド（ゲスト：root）:
  - `reboot`

（12 受入チェック：12.5 永続性（再起動後の確認））

- 実行コマンド（ゲスト：tama）:
  - `ls -l /home/tama`
  - `cat /home/tama/persist_test.txt`
- 出力メモ（抜粋）:
  - `-rw-r--r--    1 tama     tama             8 Jan 12 06:37 persist_test.txt`
  - `persist`

### 観測点
- `command -v qemu-system-x86_64` → `/usr/bin/qemu-system-x86_64`
- `command -v grub-mkrescue` → `/usr/bin/grub-mkrescue`
- `command -v musl-gcc` → `/usr/bin/musl-gcc`
- `command -v script` → `/usr/bin/script`
- `file /bin/busybox` → `statically linked` を確認
- 3章の観測点：必要ディレクトリが全て存在することを確認
- 4.3 の観測点：必須カーネル設定が全て `=y` であることを確認

### 次にやること
- 完了（0.1.2 ベース版として受入OK）

### 受入完了サマリ（要点）
- switch_root 成立：ホスト側ログに `exec: /bin/switch_root /newroot /sbin/init`
- 最終 `/` が ext4：`/dev/vda on / type ext4 (rw,relatime)`
- ログイン成立：`root` / `tama` ともに `id` が期待どおり
- ②ゲスト側ログ成立：`/logs/boot.log` が存在し、`===== boot end =====` が追記される
- 永続性成立：`/home/tama/persist_test.txt` が再起動後も残り、`cat` で `persist`
- ①ホスト側ログ成立：`logs/qemu-serial_20260112_152229.log` が生成される

### 成果物（0.1.2 の固定点）
- ISO：`~/umu/umu_project/UmuOS-0.1.2/UmuOS-0.1.2-boot.iso`
- 永続ディスク：`~/umu/umu_project/UmuOS-0.1.2/disk/disk.img`
- 起動スクリプト：`~/umu/umu_project/UmuOS-0.1.2/umuOSstart.sh`
- ホスト側ログ：`~/umu/umu_project/UmuOS-0.1.2/logs/qemu-serial_20260112_152229.log`

### 既知の注意（成功判定には影響しない）
- ホスト側ログに `^[[6n` 等の制御シーケンスが混入することがある（端末→シリアルへ流れた入力の記録）。

---

## （チェックリスト：詳細設計書-0.1.2 対応）

### 2. 事前準備（開発機）
- [x] 2.1 必要パッケージ導入（`apt install`）
- [x] 2.1 観測点：`qemu-system-x86_64` / `grub-mkrescue` / `musl-gcc` / `script` の存在

### 3. 作業ディレクトリ作成
- [x] 3. ディレクトリ作成（`kernel/ initramfs/ iso_root/ disk/ run/ logs/ docs/`）

### 4. Kernel（6.18.1）取得・ビルド・配置
- [x] 4.1 取得と展開
- [x] 4.2 `make defconfig` + `make -j...`
- [x] 4.3 観測点：必須カーネル設定（EXT4/DEVTMPFS/INITRD/VIRTIO_BLK/RD_GZIP）
- [x] 4.4 ISOへ配置（`vmlinuz-6.18.1` と `config-6.18.1`）

### 5. 永続ディスク（disk.img）作成・UUID取得
- [x] 5.1 `truncate` + `mkfs.ext4`
- [x] 5.2 UUID取得（`sudo blkid -p ...`）
- [x] DISK_UUID をここに記録：`DISK_UUID=806c6520-f1e2-4186-8584-e43b95507886`

### 6. ext4 ルート（disk.img）中身を作る
- [x] 6.1 loopマウント（`findmnt` で確認）
- [x] 6.2 最小ディレクトリ
- [x] 6.3 BusyBox 配置（静的確認）
- [x] 6.4 BusyBox applet生成（必ず chroot）
- [x] 6.5 `/sbin/init` のリンク確認
- [x] 6.6 inittab 作成（ttyS0 getty）
- [x] 6.7 rcS 作成（② /logs/boot.log 追記：boot_id/uptime/cmdline/mount/dmesg）
- [x] 6.8 ユーザー（root/tama）設定（/etc/shadow 600）
- [x] 6.9 観測点：必須ファイル存在
- [x] 6.10 umount

### 7. initramfs（/init）作成（musl静的）
- [x] 7.1 rootfs骨格 + BusyBox applet生成（chroot）
- [x] 7.2 init.c を0.1.1からコピーしてビルド（※原則変更なし）
- [x] 7.3 initrd生成（cpio+gzip）
- [x] 7.4 ISOへ initrd 配置

### 8. GRUB 設定（UEFIブート）
- [x] 8.1 grub.cfg 作成
- [x] 観測点：`root=UUID=...` が DISK_UUID に置換されている

### 9. ISO 生成
- [x] 9. grub-mkrescue

### 10. 起動スクリプト（①ホスト側ログ保存込み）
- [x] 10.1 umuOSstart.sh 作成
- [x] 観測点：logs/qemu-serial_YYYYmmdd_HHMMSS.log が作られる

### 11. QEMU 起動
- [x] 11. `./umuOSstart.sh`

### 12. 受入チェック（必須）
- [x] 12.1 initramfs観測点（cmdline/scan/matched/mount ok/switch_root）
- [x] 12.2 ext4側で `login:` が出る
- [x] 12.3 root/tama ログイン
- [x] 12.4 ② /logs/boot.log が追記される
- [x] 12.5 永続性確認
- [x] 12.6 ① ホスト側ログ保存確認

### 13. つまずき時の切り分け
- [ ] 13.1 loginが出ない（bin/sh, getty, init, inittab, rcS を確認）
- [ ] 13.2 initramfsがrootを見つけない（UUID, kernel config, devtmpfs）
- [ ] 13.3 e2fsck
- [ ] 13.4 initrdに init が入っているか確認（gzip+cpio）

### 14. やり直し
- [ ] 14. リセット手順の実施ログ
