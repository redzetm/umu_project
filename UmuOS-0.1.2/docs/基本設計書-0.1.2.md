# UmuOS-0.1.2 基本設計書

- 対象プロジェクト: `UmuOS-0.1.2/`
- 位置づけ: ver0.1.2 の基本設計（詳細なコマンドや手順は別紙/詳細設計に分離）
- 改訂日: 2025-12-31

---

## UmuOS-0.1.1 での仕様確認

本節は、ver0.1.2 の設計に入る前提として、ver0.1.1 が「設計書修正なしで再現できた」ことと、そのとき確定できた仕様（再現性・観測性の杭）を整理する。

### 1) 受入基準（必須）の達成

開発環境（Ubuntu 24.04 LTS）上の QEMU（`accel=tcg`）にて、以下を満たした。

- UEFI → GRUB → Linux kernel → initramfs（自作 `/init`）→ 永続 ext4（`disk/disk.img`）へ `switch_root` が成立
- 最終的な `/` が ext4（`disk/disk.img`）であり、再起動後もファイルが保持される（永続性）
- シリアル（ttyS0）で `root` / `tama` がパスワードログインできる

### 2) 観測された確証（抜粋）

「成功条件を満たした」ことの証拠として、少なくとも以下の観測が取れた。

- kernel cmdline に `root=UUID=...` が含まれる
  - 例: `BOOT_IMAGE=/boot/vmlinuz-6.18.1 root=UUID=abea9a02-bacf-4671-93e6-30c870c8f011 rw console=tty0 console=ttyS0,115200n8 ...`
- `mount` により最終 `/` が ext4 の永続ディスクであることが分かる
  - 例: `/dev/vda on / type ext4 (rw,relatime)`
- `tama` / `root` のログインが成立
  - 例: `uid=1000(tama) gid=1000(tama)` / `uid=0(root) gid=0(root)`
- 再起動後も永続ファイルが残存
  - 例: `persist_test.txt` が再起動後も存在し、内容も保持される

### 3) 仕様として固定できたこと（0.1.2 設計の前提）

- ISO（起動媒体）と永続ディスク（`disk/disk.img`）は責務が分離されている
  - ISO は「UEFI→GRUB→kernel→initramfs への橋渡し」を担う
  - 永続ディスクは「最終的な `/`」であり、ユーザー情報・設定・永続ログ等を保持する
- 永続ディスクの同一性は UUID（`root=UUID=...`）で参照される
  - ISO を更新しても、`root=UUID` が `disk.img` の実 UUID を指し続ける限り、同じ永続ディスクをマウントできる
  - 逆に `disk.img` を作り直すと UUID が変わるため、GRUB の `root=UUID` は必ず更新が必要

### 4) ver0.1.2 の観測性拡張（今回の射程）の設計方針（ログ機能の拡張）

- ext4 側 `rcS` による `boot.log` 追記は、「`switch_root` 後（= rcS が動く回）」の証跡強化として有効
- 一方で、`rcS` 実行前に panic 等で停止する回は ext4 へ書き込めないため、ver0.1.2 では「起動できた回の証跡強化」をまず対象にする

上記を踏まえ、ver0.1.2 ではログを「開発環境側」と「UmuOS 側」に分離し、それぞれの責務を固定する（= 二系統ログ）。

- ① 開発環境側ログ（QEMU のシリアル出力をファイル保存）
  - 価値: `switch_root` 前（UEFI→GRUB→kernel→initramfs）を含めて「どこで止まったか」の一次証拠を残せる
  - 性質: UmuOS の実装・構成に影響を与えにくく、起動スクリプト運用の改善として閉じられる
  - 射程: 「起動できない回」も含めて採取対象とする（UmuOS 側ログで拾えない領域の補完）
  - 方針: 端末上のシリアル表示を維持しつつ、同一出力をログにも残す（単純なリダイレクト/パイプに依存しない）

- ② UmuOS 側ログ（boot 後に `/logs/boot.log` へ追記）
  - 価値: 起動できた回について、UmuOS 自身が「起動時状態（cmdline、mount、dmesg 等）」を証跡化できる
  - 限界: `switch_root` 前に停止する回は ext4 へ書き込めない（①で補完する）
  - 射程: 「起動できた回」の品質保証（自己診断ログ）として扱う

この二系統は、ver0.1.2 では「合流しない」ことを前提とする。目的はログの完全統合ではなく、
起動の成否や停止点の切り分けに必要な最小限の観測基盤を確立することに置く。

また、ver0.1.2 ではログローテーション機能は実装せず、手動運用とする。

タイムスタンプについては、ver0.1.2 では次の方針とする。

- ① 開発環境側ログ: 取得開始時刻を特定できるよう、ログファイル名にタイムスタンプを含める（ログ本文の行頭タイムスタンプ付与方式は詳細設計で確定する）
- ② UmuOS 側ログ: RTC/NTP に依存せず成立するよう、`boot.log` の各追記ブロックに uptime 等の相対タイムスタンプ（起動からの経過時間）を含める
