# 詳細設計書-0.1.2（作業手順 + 仕様：再現性・観測性・混線防止）

本詳細設計は、UmuOS-0.1.2 を「いつでも戻れるベース版」として成立させるための **作業手順（オペレーション）** を、コマンドレベルで網羅する。

- 受入環境（固定）：開発機（Ubuntu 24.04 LTS）上の QEMU（`accel=tcg`）
- 観測（固定）：シリアル `ttyS0`
- ゴール（必須）：
  1. UEFI → GRUB → Linux kernel → initramfs（自作 `/init`）→ 永続 ext4（`disk.img`）へ `switch_root` が成立
  2. 最終的な `/` が ext4（`disk.img`）で、再起動後も永続性が確認できる
  3. `ttyS0` で `root` / `tama` がパスワードログインできる
- ゴール（必須：0.1.2差分）：
  - ① 開発環境側ログ（QEMUシリアル保存）が残る
  - ② UmuOS 側ログ（`/logs/boot.log`）が「1ブート=1ブロック」で追記される

> 重要：1回の実験で変えるのは1点だけ。次に進む前に「観測点」で到達を確定する。

---

## 0. 固定パラメータ（この文書で固定する値）

- Kernel version：`6.18.1`
- ISO 名：`UmuOS-0.1.2-boot.iso`
- initrd 名：`initrd.img-6.18.1`
- kernel 名：`vmlinuz-6.18.1`
- 永続ディスク：`disk/disk.img`
- 永続ディスクサイズ：4GiB
- QEMU ディスク：virtio-blk（`if=virtio`）
- initramfs `/init`：musl 静的リンク（`musl-gcc -static`）

---

## 1. ディレクトリ構成（プロジェクト内の配置）

作業ルート：`$UMU_ROOT/UmuOS-0.1.2`

最小構成（0.1.2 で正とする）：

```
UmuOS-0.1.2/
  umuOSstart.sh
  UmuOS-0.1.2-boot.iso
  kernel/
  initramfs/
  iso_root/
  disk/
    disk.img
  run/
  logs/
  docs/
```

---

## 2. 事前準備（開発機：Ubuntu 24.04 LTS）

### 2.1 必要パッケージ

```bash
sudo apt update
sudo apt install -y \
  build-essential bc bison flex libssl-dev libelf-dev libncurses-dev dwarves \
  git wget \
  grub-efi-amd64-bin grub-common xorriso mtools \
  qemu-system-x86 ovmf \
  cpio gzip xz-utils \
  busybox-static e2fsprogs \
  musl-tools util-linux
```

確認：

```bash
command -v qemu-system-x86_64
command -v grub-mkrescue
command -v musl-gcc
command -v script
file /bin/busybox
```

`script(1)` は、①「ホスト側ログ」を残すために **QEMU の標準入出力（操作含む）をセッション丸ごとファイルへ記録**する用途で使う（端末表示を維持したまま保存する）。
`command -v script` が失敗する場合は、まず `util-linux` が入っているか確認し、環境によっては `bsdutils` を追加で入れる。

---

## 3. 作業ディレクトリ作成（0.1.2 側で完結させる）

```bash
cd "$UMU_ROOT"
mkdir -p UmuOS-0.1.2/{kernel,initramfs/{rootfs,src},iso_root/boot/grub,disk,run,logs,docs}
cd UmuOS-0.1.2
```

確認：

```bash
ls -d kernel initramfs initramfs/rootfs initramfs/src iso_root/boot/grub disk run logs docs
```

---

## 4. Kernel（6.18.1）取得・ビルド・配置

### 4.1 取得と展開

```bash
cd "$UMU_ROOT/UmuOS-0.1.2/kernel"
wget -nc https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.18.1.tar.xz
rm -rf linux-6.18.1
tar -xf linux-6.18.1.tar.xz
cd linux-6.18.1
```

### 4.2 ビルド（defconfig）

```bash
make mrproper
make defconfig
make -j"$(nproc)"
```

### 4.3 必須カーネル設定の確認（観測点）

initramfs から ext4 を mount するため、少なくとも以下が built-in（`=y`）であることを確認する。

```bash
grep -E '^(CONFIG_EXT4_FS=|CONFIG_DEVTMPFS=|CONFIG_DEVTMPFS_MOUNT=|CONFIG_BLK_DEV_INITRD=|CONFIG_VIRTIO_BLK=|CONFIG_RD_GZIP=)' .config
```

期待（最低限）：

- `CONFIG_EXT4_FS=y`
- `CONFIG_DEVTMPFS=y`（可能なら `CONFIG_DEVTMPFS_MOUNT=y`）
- `CONFIG_BLK_DEV_INITRD=y`
- `CONFIG_VIRTIO_BLK=y`
- `CONFIG_RD_GZIP=y`

### 4.4 ISO へ配置

```bash
cd "$UMU_ROOT/UmuOS-0.1.2"
cp kernel/linux-6.18.1/arch/x86/boot/bzImage iso_root/boot/vmlinuz-6.18.1
cp kernel/linux-6.18.1/.config iso_root/boot/config-6.18.1
file iso_root/boot/vmlinuz-6.18.1
```

---

## 5. 永続ディスク（disk.img）作成・UUID取得

### 5.1 作成（4GiB、パーティション無しの ext4）

```bash
cd "$UMU_ROOT/UmuOS-0.1.2/disk"
rm -f disk.img
truncate -s 4G disk.img
mkfs.ext4 -F disk.img
```

### 5.2 UUID 取得（最重要：GRUB の root=UUID に使用）

```bash
cd "$UMU_ROOT/UmuOS-0.1.2/disk"
sudo blkid -p -o value -s UUID disk.img
```

この UUID を以降 `DISK_UUID` と呼ぶ。

---

## 6. ext4 ルート（disk.img）中身を作る

### 6.1 一時マウント（loop）

```bash
sudo mkdir -p /mnt/umuos012
sudo mount -o loop "$UMU_ROOT/UmuOS-0.1.2/disk/disk.img" /mnt/umuos012
findmnt /mnt/umuos012
```

迷ったら `findmnt` で状態確認し、必要なら `sudo umount /mnt/umuos012`。

### 6.2 最小ディレクトリ

```bash
sudo mkdir -p /mnt/umuos012/{bin,sbin,etc,proc,sys,dev,dev/pts,run,home,root,tmp,logs,etc/init.d}
```

### 6.3 BusyBox 配置（静的版を前提）

```bash
sudo cp /bin/busybox /mnt/umuos012/bin/busybox
sudo chown root:root /mnt/umuos012/bin/busybox
sudo chmod 755 /mnt/umuos012/bin/busybox
file /mnt/umuos012/bin/busybox
```

### 6.4 BusyBox applet の生成（必ず chroot で実行）

ホスト側で `busybox --install` を実行すると symlink がホスト絶対パス化して壊れる可能性がある。
必ず chroot してゲスト基準のパスで生成する。

```bash
sudo chroot /mnt/umuos012 /bin/busybox --install -s /bin
sudo chroot /mnt/umuos012 /bin/busybox --install -s /sbin

sudo ls -l /mnt/umuos012/bin/sh
sudo ls -l /mnt/umuos012/sbin/init
```

期待：`/bin/sh -> /bin/busybox`

### 6.5 /sbin/init を BusyBox に向ける（念のため）

```bash
sudo ln -sf /bin/busybox /mnt/umuos012/sbin/init
sudo ls -l /mnt/umuos012/sbin/init
```

### 6.6 inittab（ttyS0 でログインできるようにする）

```bash
sudo tee /mnt/umuos012/etc/inittab >/dev/null <<'EOF'
::sysinit:/etc/init.d/rcS

# ttyS0（シリアル）でログイン
ttyS0::respawn:/sbin/getty -L 115200 ttyS0 vt100

::ctrlaltdel:/sbin/reboot
::shutdown:/bin/umount -a
EOF
```

### 6.7 rcS（初期化 + ②boot.log 追記）

方針：

- initramfs では永続へ書かない（0.1.1方針を継承）
- ②の永続ログは ext4 側の rcS で追記する
- ログ追記に失敗してもブートを止めない
- タイムスタンプは RTC/NTP に依存しない（uptime/boot_id を採用）

```bash
sudo tee /mnt/umuos012/etc/init.d/rcS >/dev/null <<'EOF'
#!/bin/sh

# 失敗しても止めない（観測を優先）
mount -t proc proc /proc 2>/dev/null || true
mount -t sysfs sysfs /sys 2>/dev/null || true
mount -t devtmpfs devtmpfs /dev 2>/dev/null || true
mount -t devpts devpts /dev/pts 2>/dev/null || true

# ② 永続ログ（/logs/boot.log）
(
  mkdir -p /logs

  UPTIME_S="$(cut -d' ' -f1 /proc/uptime 2>/dev/null || echo '?')"
  BOOT_ID="$(cat /proc/sys/kernel/random/boot_id 2>/dev/null || echo '?')"

  {
    echo ""
    echo "===== boot begin (boot_id=${BOOT_ID} uptime_s=${UPTIME_S}) ====="
    echo "[cmdline]"
    cat /proc/cmdline 2>/dev/null || true
    echo ""
    echo "[mount]"
    mount 2>/dev/null || true
    echo ""
    echo "[dmesg]"
    dmesg 2>/dev/null || true
    echo "===== boot end ====="
  } >> /logs/boot.log
) 2>/dev/null || (
  /bin/echo "[rcS] WARN: boot.log write failed" > /dev/console 2>/dev/null || true
)

/bin/echo "[rcS] rcS done" > /dev/console 2>/dev/null || true
EOF

sudo chmod 755 /mnt/umuos012/etc/init.d/rcS
```

### 6.8 ユーザー（root / tama）

#### 6.8.1 /etc/passwd と /etc/group

```bash
sudo tee /mnt/umuos012/etc/passwd >/dev/null <<'EOF'
root:x:0:0:root:/root:/bin/sh
tama:x:1000:1000:tama:/home/tama:/bin/sh
EOF

sudo tee /mnt/umuos012/etc/group >/dev/null <<'EOF'
root:x:0:
users:x:100:
tama:x:1000:
EOF
```

#### 6.8.2 パスワードハッシュ作成（開発機で作って書き込む）

`openssl passwd -6` 等でハッシュを作り、`/etc/shadow` に反映する。

```bash
openssl passwd -6
openssl passwd -6
```

出力された `\$6\$...` を控え、`/etc/shadow` を作る。

```bash
sudo tee /mnt/umuos012/etc/shadow >/dev/null <<'EOF'
root:$6$REPLACE_WITH_HASH_FOR_ROOT:20000:0:99999:7:::
tama:$6$REPLACE_WITH_HASH_FOR_TAMA:20000:0:99999:7:::
EOF

sudo chown root:root /mnt/umuos012/etc/shadow
sudo chmod 600 /mnt/umuos012/etc/shadow
```

#### 6.8.3 ホーム作成と所有者

```bash
sudo mkdir -p /mnt/umuos012/root
sudo mkdir -p /mnt/umuos012/home/tama
sudo chown 1000:1000 /mnt/umuos012/home/tama
```

### 6.9 ext4 側の必須ファイル存在確認（観測点）

```bash
sudo ls -l /mnt/umuos012/sbin/init
sudo ls -l /mnt/umuos012/etc/inittab
sudo ls -l /mnt/umuos012/etc/init.d/rcS
sudo ls -l /mnt/umuos012/etc/passwd
sudo ls -l /mnt/umuos012/etc/shadow
```

### 6.10 アンマウント

```bash
sync
sudo umount /mnt/umuos012
```

---

## 7. initramfs（/init）作成（musl 静的）

### 7.1 rootfs 骨格（initramfs側）

```bash
cd "$UMU_ROOT/UmuOS-0.1.2/initramfs"
rm -rf rootfs
mkdir -p rootfs/{bin,sbin,etc,proc,sys,dev,dev/pts,run,newroot}

cp /bin/busybox rootfs/bin/busybox
chmod 755 rootfs/bin/busybox

# 混線防止：BusyBox applet の生成は chroot して実行する
sudo chroot rootfs /bin/busybox --install -s /bin

# switch_root を必ず用意（BusyBox applet）
ls -l rootfs/bin/switch_root
```

### 7.2 自作 init（C）を配置してビルド

方針：0.1.1 の `init.c` をベースにし、0.1.2 側へコピーして固定する。

```bash
cd "$UMU_ROOT/UmuOS-0.1.2"
cp -a "$UMU_ROOT/UmuOS-0.1.1/initramfs/src/init.c" initramfs/src/init.c

musl-gcc -static -O2 -Wall -Wextra -o initramfs/rootfs/init initramfs/src/init.c
chmod 755 initramfs/rootfs/init
file initramfs/rootfs/init
```

期待：`statically linked` が出る。

### 7.3 initrd 生成（cpio + gzip）

```bash
cd "$UMU_ROOT/UmuOS-0.1.2/initramfs/rootfs"
rm -f ../initrd.filelist0 ../initrd.cpio ../initrd.cpio.list ../initrd.img-6.18.1

find . -print0 > ../initrd.filelist0
cpio --null -ov --format=newc < ../initrd.filelist0 > ../initrd.cpio

cd ..
cpio -t < initrd.cpio > initrd.cpio.list

grep -E '^(init|bin/switch_root)$' initrd.cpio.list

gzip -9 -c initrd.cpio > initrd.img-6.18.1
ls -lh initrd.img-6.18.1
```

### 7.4 ISO へ initrd を配置

```bash
cd "$UMU_ROOT/UmuOS-0.1.2"
cp initramfs/initrd.img-6.18.1 iso_root/boot/initrd.img-6.18.1
ls -l iso_root/boot/initrd.img-6.18.1
```

---

## 8. GRUB 設定（UEFIブート）

### 8.1 grub.cfg 作成

`DISK_UUID` は 5.2 で取得した UUID を使う。

```bash
cd "$UMU_ROOT/UmuOS-0.1.2"
tee iso_root/boot/grub/grub.cfg >/dev/null <<'EOF'
set timeout=20
set default=0

# 観測（ttyS0）を優先：GRUBメニューもシリアルへ出す
serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1
terminal_input serial console
terminal_output serial console

menuentry "UmuOS-0.1.2" {
    insmod all_video
    insmod gfxterm
    insmod gzio

    linux /boot/vmlinuz-6.18.1 \
        root=UUID=DISK_UUID_REPLACE_ME \
        rw \
        console=tty0 console=ttyS0,115200n8 \
        loglevel=7 \
        panic=-1

    initrd /boot/initrd.img-6.18.1
}
EOF

DISK_UUID="$(sudo blkid -p -o value -s UUID disk/disk.img)"
sed -i "s/DISK_UUID_REPLACE_ME/${DISK_UUID}/" iso_root/boot/grub/grub.cfg
grep -n "root=UUID" iso_root/boot/grub/grub.cfg
```

---

## 9. ISO 生成

```bash
cd "$UMU_ROOT/UmuOS-0.1.2"
rm -f UmuOS-0.1.2-boot.iso
grub-mkrescue -o UmuOS-0.1.2-boot.iso iso_root
ls -lh UmuOS-0.1.2-boot.iso
```

---

## 10. ① 開発環境側ログ（QEMU シリアル出力の保存）を含む起動スクリプト

方針：

- 保存先は `logs/` に固定
- 命名は `qemu-serial_YYYYmmdd_HHMMSS.log`
- 端末表示は維持（ログイン操作に必要）
- `script(1)` を使いセッション単位で記録する

### 10.1 umuOSstart.sh 作成

```bash
cd "$UMU_ROOT/UmuOS-0.1.2"
tee umuOSstart.sh >/dev/null <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

PROJECT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)"
LOG_DIR="${PROJECT_DIR}/logs"
RUN_DIR="${PROJECT_DIR}/run"
ISO="${PROJECT_DIR}/UmuOS-0.1.2-boot.iso"
DISK="${PROJECT_DIR}/disk/disk.img"

mkdir -p "${LOG_DIR}" "${RUN_DIR}"

TS="$(date +%Y%m%d_%H%M%S)"
LOG_FILE="${LOG_DIR}/qemu-serial_${TS}.log"

echo "[umuOSstart] log: ${LOG_FILE}"

OVMF_CODE="/usr/share/OVMF/OVMF_CODE_4M.fd"
OVMF_VARS_SRC="/usr/share/OVMF/OVMF_VARS_4M.fd"
OVMF_VARS="${RUN_DIR}/OVMF_VARS_umuos_0_1_2.fd"

if [[ ! -f "${OVMF_VARS}" ]]; then
  cp -f "${OVMF_VARS_SRC}" "${OVMF_VARS}"
fi

QEMU_CMD=(
  qemu-system-x86_64
  -machine q35,accel=tcg
  -m 1024
  -cpu qemu64
  -drive if=pflash,format=raw,readonly=on,file="${OVMF_CODE}"
  -drive if=pflash,format=raw,file="${OVMF_VARS}"
  -cdrom "${ISO}"
  -drive file="${DISK}",format=raw,if=virtio
  -nographic
  -serial stdio
  -monitor none
)

exec script -q -f --command "$(printf '%q ' "${QEMU_CMD[@]}")" "${LOG_FILE}"
EOF

chmod 755 umuOSstart.sh
```

---

## 11. QEMU 起動（受入：ネット無し、シリアル観測）

```bash
cd "$UMU_ROOT/UmuOS-0.1.2"
./umuOSstart.sh
```

---

## 12. 受入チェック（必須）

### 12.1 initramfs の観測点

シリアルログに、少なくとも以下が出ることを確認する。

- `/proc/cmdline` が出る（root=UUID を含む）
- `want root UUID:` が出る
- `/dev/...` の `scan:` が複数出る
- 一致した `matched:` が出る
- `mount root ok` が出る
- `exec: /bin/switch_root /newroot /sbin/init` が出る

### 12.2 ext4 側で `login:` が出る

ttyS0 で `login:` が出ること。

### 12.3 root / tama でログインできる

```sh
id
uname -r
mount
```

期待：`/dev/vda on / type ext4 (rw,relatime)` のように最終 `/` が ext4 である。

### 12.4 ② `/logs/boot.log` の追記

```sh
ls -lah /logs
tail -n 200 /logs/boot.log
```

再起動後に再度確認し、ブロックが増えること。

### 12.5 永続性確認（必須）

```sh
echo "persist" > /home/tama/persist_test.txt
sync
reboot
```

再起動後：

```sh
cat /home/tama/persist_test.txt
```

### 12.6 ① ホスト側ログの保存確認

ホストで：

```bash
ls -lah "$UMU_ROOT/UmuOS-0.1.2/logs/"
```

---

## 13. つまずき時の切り分け（最短ルート）

### 13.1 `login:` が出ない

最優先で疑う：BusyBox applet の symlink 破損。

```bash
sudo mount -o loop "$UMU_ROOT/UmuOS-0.1.2/disk/disk.img" /mnt/umuos012
sudo ls -l /mnt/umuos012/bin/sh
sudo ls -l /mnt/umuos012/sbin/getty
sudo umount /mnt/umuos012
```

`/bin/sh -> /bin/busybox` になっていないなら、6.4 の chroot 手順で作り直す。

### 13.2 initramfs が root デバイスを見つけられない

- `root=UUID=...` が正しいか（grub.cfg の UUID）
- カーネル設定が built-in か（4.3）
- `/dev` が見えているか（devtmpfs）

### 13.3 ext4 が怪しい（原因混入の遮断）

```bash
sudo e2fsck -f "$UMU_ROOT/UmuOS-0.1.2/disk/disk.img"
```

### 13.4 initrd に `/init` が無い

`head` で判断しない。

```bash
cd "$UMU_ROOT/UmuOS-0.1.2"
lsinitramfs initramfs/initrd.img-6.18.1 | grep -E '^(init|bin/switch_root)$'
```

---

## 14. やり直し（安全なリセット手順）

「混ざった」と感じたら、次の順序で戻す。

1) QEMU を停止
2) `sudo e2fsck -f disk/disk.img`
3) 変更した箇所を 1 つに絞り、該当ステップだけ作り直す

