# UmuOS-0.1.2 詳細設計-0.1.2

- 対象: UmuOS-0.1.2（観測性拡張：二系統ログ）
- 改訂日: 2026-01-01
- 位置づけ: [UmuOS-0.1.2/docs/基本設計書-0.1.2.md](基本設計書-0.1.2.md) を、実装と検証の手順へ落とす

---

## 0. 用語・前提

- **開発環境側ログ（①）**: QEMU のシリアル出力（ttyS0 相当）をホスト側ファイルへ保存するログ
- **UmuOS 側ログ（②）**: UmuOS 起動後（`switch_root` 後）に永続ディスクへ追記する `/logs/boot.log`

前提として、作業ルートを `UMU_ROOT` と呼ぶ（例: `UMU_ROOT=~/umu_project`）。

この詳細設計は、作業ディレクトリを `UMU_ROOT/UmuOS-0.1.2/` とし、その配下で完結する運用（成果物を 0.1.2 側へ取り込む）を前提とする。

### 0.1 作業ディレクトリ（確定）

- 作業は常に `UMU_ROOT/UmuOS-0.1.2/` を起点にする

例:

```bash
cd "$UMU_ROOT/UmuOS-0.1.2"
```

### 0.2 0.1.1 成果物の取り込み（必須）

0.1.2 は「0.1.1 を土台にした差分拡張」である。
ただし、作業ディレクトリを 0.1.2 配下で完結させるために、起動に必要な 0.1.1 の成果物を 0.1.2 側へ取り込む。

取り込むもの:

- 起動 ISO（0.1.1 生成物）
- 永続ディスク（ext4 の `disk.img`）

手順:

```bash
cd "$UMU_ROOT/UmuOS-0.1.2"

mkdir -p disk logs run

# 0.1.1 はベース版として温存する（0.1.1 側は変更しない）

# ISO は軽いので通常コピーでよい。
# 0.1.2 配下で完結させるため、コピー後にファイル名を 0.1.2 表記へ統一する。
cp -a "$UMU_ROOT/UmuOS-0.1.1/UmuOS-0.1.1-boot.iso" ./UmuOS-0.1.2-boot.iso

# disk.img は大きいので、スパースを保つ（コピー時間はかかる）
cp -a --sparse=always "$UMU_ROOT/UmuOS-0.1.1/disk/disk.img" ./disk/
```

以降、この詳細設計のパスは原則として 0.1.2 配下の成果物を参照する。

- 起動 ISO: `UMU_ROOT/UmuOS-0.1.2/UmuOS-0.1.1-boot.iso`
- 起動 ISO: `UMU_ROOT/UmuOS-0.1.2/UmuOS-0.1.2-boot.iso`
- 永続ディスク: `UMU_ROOT/UmuOS-0.1.2/disk/disk.img`

### 0.3 使用ディレクトリ構成（0.1.1 と同じ雰囲気で統一）

0.1.2 は作業ディレクトリ配下で完結させ、0.1.1 と同じ雰囲気（起動入口・ISO・disk・run・logs）で統一する。

最低限の構成（今回のスコープで使用）:

```
UmuOS-0.1.2/
  umuOSstart.sh
  UmuOS-0.1.2-boot.iso
  disk/
    disk.img
  logs/
  run/
  docs/
```

補足:

- `logs/` は ①（開発環境側ログ）の保存先として使用する
- `run/` は OVMF_VARS 等の実行時生成物の置き場として使用する
- `iso_root/` / `initramfs/` / `kernel/` は、ISO を作り直す段階になったら追加する（ver0.1.2 の今回スコープでは必須ではない）

---

## 1. 目的・非目標（要点）

### 1.1 目的

- 起動の成否や停止点の切り分けに必要な **最小限の観測基盤** を作る
- `switch_root` 前後をまたいで「どこまで進んだか」を追いやすくする

### 1.2 非目標

- ①②のログは合流しない
- ログローテーションは自動化しない（手動運用）
- `switch_root` 前に停止する回の「UmuOS 側永続ログへの確実保存」は対象外
- ログ解析・整形・要約などの機能提供は対象外

---

## 2. 変更点の境界（どこを触るか）

- **①は開発環境側で完結** させる（UmuOS ゲストへ影響を与えない）
- **②は永続ディスク上の起動後スクリプトで完結** させる（`/etc/init.d/rcS`）

---

## 3. 成果物（作る／変更するもの）

### 3.1 新規（推奨）

- `UMU_ROOT/UmuOS-0.1.2/umuOSstart.sh`
  - 0.1.1 の起動スクリプトをベースに、ログ保存（①）を追加したもの
  - 起動 ISO / disk.img は 0.1.2 配下のものを参照する

### 3.2 変更（②）

- 永続ディスク内の `/etc/init.d/rcS`
  - 0.1.2 では「1ブート=1ブロック」「相対時刻（uptime）」「cmdline/mount/dmesg」を満たすように追記を拡張する

---

## 4. ① 開発環境側ログ（QEMU シリアル出力の保存）

### 4.1 仕様

- 保存先: `UMU_ROOT/UmuOS-0.1.2/logs/` に固定する
- 命名: `qemu-serial_YYYYmmdd_HHMMSS.log`（取得開始時刻が分かること）
- 対象: UEFI→GRUB→kernel→initramfs→（可能なら）ログイン画面まで
- 端末表示: 維持する（ログイン操作に必要）

### 4.2 実装方針（確定）

`script(1)` を使い、擬似端末（PTY）単位で QEMU セッションを記録する。

#### 推奨コマンドイメージ（確定）

```bash
LOG_DIR="$PROJECT_DIR/logs"
TS="$(date +%Y%m%d_%H%M%S)"
LOG_FILE="$LOG_DIR/qemu-serial_${TS}.log"

mkdir -p "$LOG_DIR"

script -q -f --command "qemu-system-x86_64 ... -serial stdio ..." "$LOG_FILE"
```

### 4.3 実装手順（0.1.2 側にスクリプトを用意する）

1. `UMU_ROOT/UmuOS-0.1.2/umuOSstart.sh` を新規作成する
2. 中身は `UMU_ROOT/UmuOS-0.1.1/umuOSstart.sh` をベースにする
3. QEMU 起動直前に、ログディレクトリとログファイル名を組み立てる
4. `exec qemu-system-x86_64 ...` の代わりに、`script -q -f --command "qemu..." "$LOG_FILE"` で起動する

---

## 5. ② UmuOS 側ログ（/logs/boot.log 追記）

### 5.1 現状の確認（根拠）

永続ディスク（`disk.img`）内の設定は次の通り。

- `/etc/inittab` が `::sysinit:/etc/init.d/rcS` を実行する
- `/etc/init.d/rcS` は `/logs/boot.log` へ追記している（現状は `date` 依存）

### 5.2 仕様

- 保存先: `/logs/boot.log`（永続ディスク上）
- 追記単位: **1ブート=1ブロック**（追記のみ、上書きしない）
- タイムスタンプ: RTC/NTP に依存しない **相対時刻**
  - `cat /proc/uptime` の 1列目（起動からの秒数）を使用
- 最小記録項目（各ブロックに含める）:
  - `cmdline`: `/proc/cmdline`
  - `mount`: `mount` の出力
  - `dmesg`: `dmesg`（全量でよい）
- 失敗時: ログ保存失敗で起動を止めない。可能なら `/dev/console` に短く失敗を出す。

### 5.3 rcS の追記ブロック（設計案）

`/etc/init.d/rcS` 内の `/logs/boot.log` 追記ブロックを、次のように拡張する。

```sh
(
  mkdir -p /logs

  UPTIME_S="$(cut -d' ' -f1 /proc/uptime 2>/dev/null || echo '?')"

  {
    echo ""
    echo "===== boot begin (uptime_s=${UPTIME_S}) ====="
    echo "[cmdline]"
    cat /proc/cmdline 2>/dev/null || true
    echo ""
    echo "[mount]"
    mount 2>/dev/null || true
    echo ""
    echo "[dmesg]"
    dmesg 2>/dev/null || true
    echo "===== boot end ====="
  } >> /logs/boot.log
) 2>/dev/null || (
  /bin/echo "[rcS] WARN: boot.log write failed" > /dev/console 2>/dev/null || true
)
```

### 5.4 disk.img の編集手順（確定: 案A）

この手順はホスト（Ubuntu 24.04 LTS）側で実施する。

1. マウントポイント作成

```bash
mkdir -p /tmp/umuos_root
```

2. ループマウント

```bash
sudo mount -o loop "$UMU_ROOT/UmuOS-0.1.1/disk/disk.img" /tmp/umuos_root
```

※ 0.1.2 配下で完結させるため、実際には次のパスを使う。

```bash
sudo mount -o loop "$UMU_ROOT/UmuOS-0.1.2/disk/disk.img" /tmp/umuos_root
```

3. rcS を編集

- `/tmp/umuos_root/etc/init.d/rcS` を編集して保存
- 実行権限（`755`）が維持されていることを確認

確認例:

```bash
ls -la /tmp/umuos_root/etc/init.d/rcS
```

4. アンマウント

```bash
sudo umount /tmp/umuos_root
```

---

## 6. 検証手順（受入条件への対応）

### 6.1 ①の受入（開発環境側ログ）

- 起動スクリプトで起動し、ログファイルが作成されること
- ログファイルに `UEFI/GRUB`〜`kernel`〜`initramfs`〜`switch_root` 付近の出力が含まれること

確認例:

```bash
ls -lah "$PROJECT_DIR/logs/"
```

### 6.2 ②の受入（/logs/boot.log 追記）

ゲスト（UmuOS）にログインして確認する。

```sh
ls -lah /logs
tail -n 200 /logs/boot.log
```

- 再起動後に再度確認し、追記でブロックが増えること

---

## 7. 失敗時の切り分けの見方（最小）

- ②（/logs/boot.log）が増えない場合:
  - `switch_root` 後に到達していない可能性が高い → ①のログで停止点を確認する
- ①のログが出ない場合:
  - 起動スクリプト側の保存先・権限・`script(1)` の動作を確認する
