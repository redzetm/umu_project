# UmuOS-0.1.3 基本設計書

- 対象プロジェクト: `UmuOS-0.1.3/`
- 目的: ver0.1.3 を「0.1.2 と同じ粒度で最初から再現できるベース版」として確定し、ユーザーランド操作性を最小拡張する
- 重要方針: **動いたら成功ではない。理解・観測・検証が残って成功**
- 改訂日: 2026-01-12

---

## 1. 本基本設計の位置づけ（0.1.3 は “最初から作る”）

ver0.1.3 は ver0.1.2 を土台として参照する。
ただし、構造理解と再現性を成果物として残すため、ver0.1.3 では起動に必要な成果物を **0.1.3 配下で再生成**する（Kernelビルド含む）。

- ver0.1.2 は「戻れるベース」「比較対象」として温存する（原則として 0.1.2 側は変更しない）
- ver0.1.3 は「0.1.2 と同じ粒度で再現できる」ことを成果物として確定する
- 追加差分は「権限（su）」と「同時ログイン（別ターミナル）」に限定し、混線を防ぐ

本設計では、作業ルート（作業ディレクトリ）を次で固定する。

- `PROJECT_DIR=~/umu/umu_project/UmuOS-0.1.3`

---

## 2. ゴール（受入基準）
　
### 2.1 成功の定義（必須）

0.1.3 の成功＝「開発環境の QEMU で再現でき、以下がすべて満たされる」

#### Phase 1（ベース成立：0.1.2 相当）

1) UEFI → GRUB → Linux kernel → initramfs（自作 `/init`）→ 永続 ext4（`disk.img`）へ `switch_root` が成立する
2) 最終的な `/` は ext4（`disk.img`）で、再起動してもファイルが保持される（永続性）
3) シリアル（ttyS0）で `root` / `tama` ユーザーの **パスワードログイン**が成立する

#### Phase 2（観測性：0.1.2 相当）

4) 開発環境側ログ（①）が **ホスト側** の `PROJECT_DIR/logs/` 配下に保存され（例: `logs/qemu-serial_YYYYmmdd_HHMMSS.log`）、`switch_root` 前（UEFI→GRUB→kernel→initramfs を含む）の出力を追跡できる
5) UmuOS 側ログ（②）が `/logs/boot.log` に追記され、再起動後に「1ブート=1ブロック」で増える

#### Phase 3（0.1.3 差分：操作性・同時ログイン）

6) `tama` でログイン後に `su -` が成功し、root に切り替えられる（`exit` で `tama` に戻れる）
   - 方針: **BusyBox 全体を setuid にせず**、`su` 専用の実体（`busybox.su`）を用意して setuid を限定する
7) 別ターミナル（別シリアル）で **同時ログイン**が成立する（例: 端末Aで root、端末Bで tama）
   - 方針: `ttyS0` に加えて `ttyS1` に getty を立て、QEMU も 2本目シリアルを提供する

8) ttyS1 のホスト側ログが取得できる（必須）
  - 方針: ttyS1 は `-serial pty` で PTY（`/dev/pts/N`）として提供し、接続側を `script(1)` で記録する
  - 成果物: `PROJECT_DIR/logs/ttyS1_YYYYmmdd_HHMMSS.log`（例）

### 2.2 失敗の定義（不合格条件）

以下のいずれかに該当した場合、0.1.3 は失敗（受入不合格）とみなす。

- `switch_root` 後に、最終的な `/` が ext4（disk.img）になっていない
- 再起動後に、ファイル永続性が確認できない
- `root/tama` のログインが ttyS0 で成立しない
- ①のログが保存されない（起動観測の一次証拠が残らない）
- ②の `/logs/boot.log` が追記されない（起動できた回の証跡が永続に残らない）
- `tama` から `su -` が成立しない
- 同時ログイン（ttyS1）が成立しない
- ttyS1 のホスト側ログが取得できない

### 2.3 受入範囲（固定）

- 受入環境は **開発環境の QEMU** に限定する
- QEMU は **`accel=tcg` 前提**（KVM や `/dev/kvm` の有無は考慮対象外）
- 観測は **シリアル（ttyS0）主**とする（起動確認の生命線）
- ttyS1 は「同時ログイン」のための追加経路で、ttyS0 の観測を置き換えない

### 2.4 非ゴール（0.1.3 ではやらない）

- ログの完全統合（①②の合流）
- `switch_root` 前に停止する回の「UmuOS 側永続ログへの確実保存」（pstore 等）
- `su` を BusyBox 全体の setuid で雑に成立させる（安全寄りの最小差分を優先）
- ネットワーク（NAT/ブリッジ/telnet）を受入の必須条件にする

---

## 3. 実施環境（設計上の必須条件）

- ビルド、ISO 作成、ディスク操作は Ubuntu 24.04 LTS 上で実施する
- 起動・検証は QEMU（UEFI/OVMF）上で実施する
- 観測はシリアル（ttyS0）出力を主とする（起動確認の生命線）。同時ログイン/ログ取得のため ttyS1 も使用する

---

## 4. 固定パラメータ（0.1.3）

再現性と差分最小化のため、0.1.3 でも Kernel version は **0.1.2 と同一**とする。

- Kernel version（KVER）: `6.18.1`
- ISO ファイル名: `UmuOS-0.1.3-boot.iso`
- initrd 名: `initrd.img-6.18.1`
- kernel 名: `vmlinuz-6.18.1`

- 永続ディスク: `disk/disk.img`
- 永続ディスクサイズ: 4GiB
- QEMU ディスク: virtio-blk（`if=virtio`）

- initramfs `/init`: musl 静的リンク（`musl-gcc -static`）
- 観測端末: `console=tty0 console=ttyS0,115200n8`

---

## 5. システム構成（層と責務）

### 5.1 層の分離（混線防止）

- ISO 層: GRUBで kernel/initrd を起動し cmdline を渡す（橋渡し）
- initramfs 層: 永続 ext4 を見つけて mount し `switch_root` まで（永続へ書かない）
- 永続 ext4 層: 最終 `/` とログイン・設定・永続ログ（②）
- 開発環境側（ホスト）: ①のログ保存・起動運用（UmuOS側へ影響を与えない）

### 5.2 0.1.3 差分の責務分離

- `su`（権限）:
  - `/bin/busybox` は通常権限のまま
  - `su` の実体だけを `busybox.su` として setuid に限定
- 同時ログイン:
  - `ttyS0` は観測主経路（既存と同じ）
  - `ttyS1` は操作の追加経路（別端末でログインする）

---

## 6. 成果物（0.1.3 で正とするもの）

- Kernel: `kernel/linux-6.18.1/`（ビルド成果物と `.config`）
- initramfs: `initramfs/rootfs/` と `initramfs/initrd.img-6.18.1`
- ISO 入力: `iso_root/`（grub.cfg、kernel、initrd を格納）
- ISO 生成物: `UmuOS-0.1.3-boot.iso`
- 永続ディスク: `disk/disk.img`
- 起動入口: `umuOSstart.sh`
- 実行時生成物: `run/`（OVMF_VARS 等）
- ①ログ保存先: `logs/`

---

## 7. 参照

- 詳細手順は [詳細設計書-0.1.3.md](詳細設計書-0.1.3.md) を正とする
- 差分整理は [UmuOS0.1.2との違い.md](UmuOS0.1.2との違い.md) を参照
