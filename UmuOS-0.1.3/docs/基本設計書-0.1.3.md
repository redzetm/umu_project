---
title: UmuOS-0.1.3 基本設計書
version: 0.1.3
date: 2026-01-18
修正: 2026-01-20
---

# UmuOS-0.1.3 基本設計書（同時ログイン・telnet接続版）

## 0. 目的（0.1.3 で確実に成立させること）

UmuOS-0.1.3 は、0.1.2 を参照しつつ「最初から再構築できる」ことを前提に、ユーザーランドの操作性を **最小の差分** で拡張する。

0.1.3 の主目的は、シリアルを2本に増やして **同時ログイン（root / tama）** を成立させること。

重要方針：**動いたら成功ではない。再現手順と受入条件が残って成功**

作業ルート（固定）：`~/umu/umu_project/UmuOS-0.1.3`

---

## 1. ゴール（受入基準）

0.1.3 の成功＝「開発機（Ubuntu 24.04 LTS）上の QEMU（`accel=tcg`）で再現でき、以下が満たされる」。

### 1.1 必須（Phase A: ベース）

1) UEFI → GRUB → kernel → initramfs（自作 `/init`）→ ext4（`disk.img`）へ `switch_root` が成立する
2) 最終的な `/` は ext4（`disk.img`）である（`findmnt /` で確認できる）
3) ttyS0（主コンソール）で `root` と `tama` がログインできる

### 1.2 必須（Phase B: 同時ログイン）

4) ttyS1（追加コンソール）で `login:` が出て、ホスト側から接続してログインできる
5) ttyS0 でログインしたまま、ttyS1 でもログインできる（**同時ログイン**）

> ここでいう「telnet仕様」は **ゲストtelnetdではない**。
> QEMU が「2本目シリアルをTCPで公開」し、ホストが `telnet 127.0.0.1 PORT` で接続する方式。

---

## 2. 非ゴール（0.1.3 ではやらない）

混線を防ぐため、0.1.3 は以下を受入条件に含めない。

- `su` による権限昇格（BusyBox / SUID / NoNewPrivs / nosuid 等の罠が多く、同時ログインと独立）
- ログ基盤の整備（ホストログの整形、ゲスト永続ログの設計確定など）
- ゲストOSのネットワーク（NIC導入、IP設定、telnetd実装、SSH等）

ログの「基盤整備」は 0.1.4 以降で扱う（0.1.3 は「同時ログインが成立する」ことに集中する）。

ただし、0.1.2 相当の **最小の観測ログ**（ホスト側シリアル保存 + ゲスト側 `/logs/boot.log`）は、再現性確認のため 0.1.3 でも実施する。

---

## 3. 仕様（最小で固定すること）

### 3.1 実行環境（固定）

- ホスト：Ubuntu 24.04 LTS
- QEMU：`qemu-system-x86_64`、`accel=tcg`、UEFI（OVMF）

### 3.2 シリアル仕様（最重要）

- ttyS0（主経路）：QEMU の `-serial stdio`
- ttyS1（同時ログイン用）：QEMU の `-serial tcp:127.0.0.1:<PORT>,server,nowait,telnet`
  - 接続クライアント：`telnet 127.0.0.1 <PORT>`
  - 注：接続できても表示が出ない場合がある（接続より前の出力は流れない）。その場合は Enter を数回押して `login:` を出す。
  - 代替：QEMUを raw TCP のまま使う場合は `nc 127.0.0.1 <PORT>` を使う

### 3.3 OS構成（層と責務）

- ISO 層：GRUBで kernel/initrd を起動し cmdline を渡す
- initramfs 層：root=UUID の ext4 を mount して `switch_root` まで
- ext4 層：`/sbin/init`（BusyBox）、`inittab`、`getty` により ttyS0/ttyS1 を提供

---

## 4. 固定パラメータ（0.1.3）

- Kernel version（KVER）：`6.18.1`
- ISO ファイル名：`UmuOS-0.1.3-boot.iso`
- initrd 名：`initrd.img-6.18.1`
- kernel 名：`vmlinuz-6.18.1`

- 永続ディスク：`disk/disk.img`（ext4、4GiB、UUIDでroot指定）
- QEMU ディスク：virtio-blk（`if=virtio`）

---

## 5. 成果物

0.1.3 の成果物は「作れる手順」と「受入が通ること」。最終的に以下が揃っていること。

- `kernel/linux-6.18.1/`（ビルド成果物と `.config`）
- `disk/disk.img`（rootfs）
- `initramfs/initrd.img-6.18.1`（自作 `/init` を含む）
- `iso_root/`（GRUB設定と kernel/initrd を格納）
- `UmuOS-0.1.3-boot.iso`

---

## 6. 参照

- 実装手順は [詳細設計書-0.1.3.md](詳細設計書-0.1.3.md)
- 0.1.2との差分は [UmuOS0.1.2との違い.md](UmuOS0.1.2との違い.md)
