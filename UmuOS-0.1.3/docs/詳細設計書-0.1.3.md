---
title: 詳細設計書-0.1.3
date: 2026-01-18
修正: 2026-01-20
---

# 詳細設計書-0.1.3（手順：同時ログイン / ttyS1=TCPシリアル）

この文書は、UmuOS-0.1.3 を「最初から再構築できるベース」として成立させるための作業手順を、コマンドレベルでまとめる。

## 重要方針

- 0.1.3 の主目的は **同時ログイン（ttyS0 + ttyS1）**。
- 0.1.3 では `su` は扱わない（0.1.4以降）。
- ログは「観測用の最小（ホスト側シリアル保存 + ゲスト側 `/logs/boot.log`）」まで。
- ttyS1 は PTY ではなく **QEMUのTCPシリアル** を使う。

> NOTE: `telnet` を使うが、これは「ゲストtelnetd」ではなく、ホストが QEMU の TCP ポートへ接続しているだけ。

---

## 0. 固定パラメータ（この文書で固定する値）

- 作業ルート：`~/umu/umu_project/UmuOS-0.1.3`
- Kernel version：`6.18.1`
- ISO 名：`UmuOS-0.1.3-boot.iso`
- initrd 名：`initrd.img-6.18.1`
- kernel 名：`vmlinuz-6.18.1`
- 永続ディスク：`disk/disk.img`（ext4、4GiB、UUIDでroot指定）
- QEMU ディスク：virtio-blk（`if=virtio`）
- initramfs `/init`：musl 静的リンク（`musl-gcc -static`）

ttyS1 のポート（推奨固定）：`TTYS1_PORT=5555`

---

## 1. 事前準備（Ubuntu 24.04 LTS）

### 1.1 必要パッケージ

```bash
sudo apt update
sudo apt install -y \
  build-essential bc bison flex libssl-dev libelf-dev libncurses-dev dwarves \
  git wget \
  grub-efi-amd64-bin grub-common xorriso mtools \
  qemu-system-x86 ovmf \
  cpio gzip xz-utils \
  busybox-static e2fsprogs \
  musl-tools util-linux \
  openssl telnet netcat-openbsd
```

### 1.2 コマンド存在確認（観測点）

```bash
command -v qemu-system-x86_64
command -v grub-mkrescue
command -v musl-gcc
command -v mkfs.ext4
command -v openssl
```

---

## 2. 作業ディレクトリ作成（0.1.3 側で完結）

```bash
mkdir -p ~/umu/umu_project/UmuOS-0.1.3
cd ~/umu/umu_project/UmuOS-0.1.3
mkdir -p kernel initramfs/src initramfs/rootfs iso_root/boot/grub disk run
```

観測点：

```bash
ls -la
```

---

## 3. Kernel（6.18.1）取得・ビルド・配置

### 3.1 取得と展開

```bash
cd ~/umu/umu_project/UmuOS-0.1.3/kernel
wget -nc https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.18.1.tar.xz
rm -rf linux-6.18.1
tar -xf linux-6.18.1.tar.xz
cd linux-6.18.1
```

### 3.2 ビルド（defconfig）

```bash
make mrproper
make defconfig
make -j"$(nproc)"
```

### 3.3 必須設定の確認（観測点）

```bash
grep -E '^(CONFIG_EXT4_FS=|CONFIG_DEVTMPFS=|CONFIG_DEVTMPFS_MOUNT=|CONFIG_BLK_DEV_INITRD=|CONFIG_VIRTIO=|CONFIG_VIRTIO_PCI=|CONFIG_VIRTIO_BLK=|CONFIG_RD_GZIP=)' .config
```

期待（最低限）：

- `CONFIG_EXT4_FS=y`
- `CONFIG_DEVTMPFS=y`（可能なら `CONFIG_DEVTMPFS_MOUNT=y`）
- `CONFIG_BLK_DEV_INITRD=y`
- `CONFIG_VIRTIO=y`
- `CONFIG_VIRTIO_PCI=y`
- `CONFIG_VIRTIO_BLK=y`
- `CONFIG_RD_GZIP=y`

#### 3.3.1 もし `=m`（module）だった場合の修正

この設計（initramfs の自作 `/init` が ext4 を直接 `mount(2)` する）では、ext4 や virtio-blk が `=m` だと initramfs 側でモジュールをロードできず、`/dev/vda` が出ない / `mount -t ext4` が失敗してタイムアウトする。

`=y`（built-in）に揃えてから再ビルドする。

```bash
cd ~/umu/umu_project/UmuOS-0.1.3/kernel/linux-6.18.1

# まず現状確認
grep -E '^(CONFIG_EXT4_FS=|CONFIG_DEVTMPFS=|CONFIG_DEVTMPFS_MOUNT=|CONFIG_BLK_DEV_INITRD=|CONFIG_VIRTIO=|CONFIG_VIRTIO_PCI=|CONFIG_VIRTIO_BLK=|CONFIG_RD_GZIP=)' .config

# scripts/config で有効化（=y）
./scripts/config --file .config \
  -e EXT4_FS \
  -e DEVTMPFS \
  -e DEVTMPFS_MOUNT \
  -e BLK_DEV_INITRD \
  -e VIRTIO \
  -e VIRTIO_PCI \
  -e VIRTIO_BLK \
  -e RD_GZIP

make olddefconfig
make -j"$(nproc)"

# 期待通りになったか再確認
grep -E '^(CONFIG_EXT4_FS=|CONFIG_DEVTMPFS=|CONFIG_DEVTMPFS_MOUNT=|CONFIG_BLK_DEV_INITRD=|CONFIG_VIRTIO=|CONFIG_VIRTIO_PCI=|CONFIG_VIRTIO_BLK=|CONFIG_RD_GZIP=)' .config
```

### 3.4 ISO入力へ配置

```bash
cd ~/umu/umu_project/UmuOS-0.1.3
cp kernel/linux-6.18.1/arch/x86/boot/bzImage iso_root/boot/vmlinuz-6.18.1
cp kernel/linux-6.18.1/.config iso_root/boot/config-6.18.1
file iso_root/boot/vmlinuz-6.18.1
```

---

## 4. 永続ディスク（disk.img）作成・UUID取得

### 4.1 作成（4GiB、パーティション無しの ext4）

```bash
cd ~/umu/umu_project/UmuOS-0.1.3/disk
rm -f disk.img
truncate -s 4G disk.img
mkfs.ext4 -F disk.img
```

### 4.2 UUID 取得（最重要：GRUB の root=UUID に使用）

```bash
cd ~/umu/umu_project/UmuOS-0.1.3/disk
sudo blkid -p -o value -s UUID disk.img
```

この UUID を以降 `DISK_UUID` と呼ぶ。

---

## 5. ext4 ルート（disk.img）中身を作る

### 5.1 一時マウント（loop）

```bash
sudo mkdir -p /mnt/umuos013
sudo mount -o loop ~/umu/umu_project/UmuOS-0.1.3/disk/disk.img /mnt/umuos013
findmnt /mnt/umuos013
```

### 5.2 最小ディレクトリ

```bash
sudo mkdir -p /mnt/umuos013/{bin,sbin,etc,proc,sys,dev,dev/pts,run,home,root,tmp,logs,etc/init.d}
```

### 5.3 BusyBox 配置（静的版を前提）

```bash
sudo cp /bin/busybox /mnt/umuos013/bin/busybox
sudo chown root:root /mnt/umuos013/bin/busybox
sudo chmod 755 /mnt/umuos013/bin/busybox
file /mnt/umuos013/bin/busybox
```

### 5.4 BusyBox applet の生成（必ず chroot で実行）

```bash
sudo chroot /mnt/umuos013 /bin/busybox --install -s /bin
sudo chroot /mnt/umuos013 /bin/busybox --install -s /sbin

sudo ls -l /mnt/umuos013/bin/sh
sudo ls -l /mnt/umuos013/sbin/init
```

期待：`/bin/sh -> /bin/busybox`

### 5.5 /sbin/init を BusyBox に向ける（念のため）

```bash
sudo ln -sf /bin/busybox /mnt/umuos013/sbin/init
sudo ls -l /mnt/umuos013/sbin/init
```

### 5.6 inittab（ttyS0/ttyS1 でログインできるようにする：0.1.3差分）

0.1.3 では同時ログインのため、ttyS1 も getty を立てる。

```bash
sudo tee /mnt/umuos013/etc/inittab >/dev/null <<'EOF'
::sysinit:/etc/init.d/rcS

# ttyS0（シリアル）でログイン（観測主経路）
ttyS0::respawn:/sbin/getty -L 115200 ttyS0 vt100

# ttyS1（シリアル）でログイン（同時ログイン用：0.1.3差分）
ttyS1::respawn:/sbin/getty -L 115200 ttyS1 vt100

::ctrlaltdel:/sbin/reboot
::shutdown:/bin/umount -a
EOF
```

### 5.7 rcS（初期化 + ②boot.log 追記）

```bash
sudo tee /mnt/umuos013/etc/init.d/rcS >/dev/null <<'EOF'
#!/bin/sh

# 失敗しても止めない（観測を優先）
mount -t proc proc /proc 2>/dev/null || true
mount -t sysfs sysfs /sys 2>/dev/null || true
mount -t devtmpfs devtmpfs /dev 2>/dev/null || true
mount -t devpts devpts /dev/pts 2>/dev/null || true

# ② 永続ログ（/logs/boot.log）
(
  mkdir -p /logs

  UPTIME_S="$(cut -d' ' -f1 /proc/uptime 2>/dev/null || echo '?')"
  BOOT_ID="$(cat /proc/sys/kernel/random/boot_id 2>/dev/null || echo '?')"

  {
    echo ""
    echo "===== boot begin (boot_id=${BOOT_ID} uptime_s=${UPTIME_S}) ====="
    echo "[cmdline]"
    cat /proc/cmdline 2>/dev/null || true
    echo ""
    echo "[mount]"
    mount 2>/dev/null || true
    echo ""
    echo "[dmesg]"
    dmesg 2>/dev/null || true
    echo "===== boot end ====="
  } >> /logs/boot.log
) 2>/dev/null || (
  /bin/echo "[rcS] WARN: boot.log write failed" > /dev/console 2>/dev/null || true
)

/bin/echo "[rcS] rcS done" > /dev/console 2>/dev/null || true
EOF

sudo chmod 755 /mnt/umuos013/etc/init.d/rcS
```

### 5.8 ユーザー（root / tama）

#### 5.8.1 /etc/passwd と /etc/group

```bash
sudo tee /mnt/umuos013/etc/passwd >/dev/null <<'EOF'
root:x:0:0:root:/root:/bin/sh
tama:x:1000:1000:tama:/home/tama:/bin/sh
EOF

sudo tee /mnt/umuos013/etc/group >/dev/null <<'EOF'
root:x:0:
users:x:100:
tama:x:1000:
EOF
```

#### 5.8.2 /etc/shadow

`openssl passwd -6` 等でハッシュを作り、`/etc/shadow` に反映する。

```bash
openssl passwd -6
openssl passwd -6
```

出力された `\$6$...` を控え、`/etc/shadow` を作る。

```bash
sudo tee /mnt/umuos013/etc/shadow >/dev/null <<'EOF'
root:$6$REPLACE_WITH_HASH_FOR_ROOT:20000:0:99999:7:::
tama:$6$REPLACE_WITH_HASH_FOR_TAMA:20000:0:99999:7:::
EOF

sudo chown root:root /mnt/umuos013/etc/shadow
sudo chmod 600 /mnt/umuos013/etc/shadow
```

#### 5.8.3 ホーム作成と所有者

```bash
sudo mkdir -p /mnt/umuos013/root
sudo mkdir -p /mnt/umuos013/home/tama
sudo chown 1000:1000 /mnt/umuos013/home/tama
```

### 5.9 `su -` を安全寄りに成立させる（任意：0.1.4以降の予定案）

狙い：`tama` から `su -` ができるようにする。
ただし BusyBox 全体を setuid にすると権限が広がりやすいので、`su` 専用の実体（`busybox.su`）を作って setuid を限定する。

注意：`busybox --install` により `/bin/su -> /bin/busybox` が作られている可能性があるため、**applet 生成の後**に差し替える。

```bash
# su 専用 BusyBox を作る
sudo cp -a /mnt/umuos013/bin/busybox /mnt/umuos013/bin/busybox.su
sudo chown root:root /mnt/umuos013/bin/busybox.su
sudo chmod 4755 /mnt/umuos013/bin/busybox.su

# /bin/su を su専用 BusyBox に向ける
sudo ln -sf /bin/busybox.su /mnt/umuos013/bin/su

# 確認
sudo ls -l /mnt/umuos013/bin/busybox /mnt/umuos013/bin/busybox.su /mnt/umuos013/bin/su
```

期待（例）：

- `/mnt/umuos013/bin/busybox` は `-rwxr-xr-x`
- `/mnt/umuos013/bin/busybox.su` は `-rwsr-xr-x`
- `/mnt/umuos013/bin/su -> /bin/busybox.su`

### 5.10 ext4 側の必須ファイル存在確認（観測点）

```bash
sudo ls -l /mnt/umuos013/sbin/init
sudo ls -l /mnt/umuos013/etc/inittab
sudo ls -l /mnt/umuos013/etc/init.d/rcS
sudo ls -l /mnt/umuos013/etc/passwd
sudo ls -l /mnt/umuos013/etc/shadow
sudo ls -l /mnt/umuos013/bin/busybox.su
sudo ls -l /mnt/umuos013/bin/su
```

### 5.11 アンマウント

```bash
sync
sudo umount /mnt/umuos013
```

---

## 6. initramfs（/init）作成（musl 静的）

### 6.1 rootfs 骨格（initramfs側）

```bash
cd ~/umu/umu_project/UmuOS-0.1.3/initramfs
rm -rf rootfs
mkdir -p rootfs/{bin,sbin,etc,proc,sys,dev,dev/pts,run,newroot}

cp /bin/busybox rootfs/bin/busybox
chmod 755 rootfs/bin/busybox

# 混線防止：BusyBox applet の生成は chroot して実行する
sudo chroot rootfs /bin/busybox --install -s /bin

# switch_root を必ず用意（BusyBox applet）
ls -l rootfs/bin/switch_root
```

### 6.2 自作 init（C）を配置してビルド

方針：0.1.1 の `init.c` をベースにし、0.1.3 側へコピーして固定する。

```bash
cd ~/umu/umu_project/UmuOS-0.1.3
cp -a ~/umu/umu_project/UmuOS-0.1.1/initramfs/src/init.c initramfs/src/init.c

musl-gcc -static -O2 -Wall -Wextra -o initramfs/rootfs/init initramfs/src/init.c
chmod 755 initramfs/rootfs/init
file initramfs/rootfs/init
```

期待：`statically linked` が出る。

### 6.3 initrd 生成（cpio + gzip）

```bash
cd ~/umu/umu_project/UmuOS-0.1.3/initramfs/rootfs
rm -f ../initrd.filelist0 ../initrd.cpio ../initrd.cpio.list ../initrd.img-6.18.1

find . -print0 > ../initrd.filelist0
cpio --null -ov --format=newc < ../initrd.filelist0 > ../initrd.cpio

cd ..
cpio -t < initrd.cpio > initrd.cpio.list

grep -E '^(init|bin/switch_root)$' initrd.cpio.list

gzip -9 -c initrd.cpio > initrd.img-6.18.1
ls -lh initrd.img-6.18.1
```

### 6.4 ISO へ initrd を配置

```bash
cd ~/umu/umu_project/UmuOS-0.1.3
cp initramfs/initrd.img-6.18.1 iso_root/boot/initrd.img-6.18.1
ls -l iso_root/boot/initrd.img-6.18.1
```

---

## 7. GRUB 設定（UEFIブート）

### 7.1 grub.cfg 作成

`DISK_UUID` は 4.2 で取得した UUID を使う。

```bash
cd ~/umu/umu_project/UmuOS-0.1.3
tee iso_root/boot/grub/grub.cfg >/dev/null <<'EOF'
set timeout=20
set default=0

# 観測（ttyS0）を優先：GRUBメニューもシリアルへ出す
serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1
terminal_input serial console
terminal_output serial console

menuentry "UmuOS-0.1.3" {
    insmod all_video
    insmod gfxterm
    insmod gzio

    linux /boot/vmlinuz-6.18.1 \
        root=UUID=DISK_UUID_REPLACE_ME \
        rw \
        console=tty0 console=ttyS0,115200n8 \
        loglevel=7 \
        panic=-1

    initrd /boot/initrd.img-6.18.1
}
EOF

DISK_UUID="$(sudo blkid -p -o value -s UUID disk/disk.img)"
sed -i "s/DISK_UUID_REPLACE_ME/${DISK_UUID}/" iso_root/boot/grub/grub.cfg
grep -n "root=UUID" iso_root/boot/grub/grub.cfg
```

---

## 8. ISO 生成

```bash
cd ~/umu/umu_project/UmuOS-0.1.3
rm -f UmuOS-0.1.3-boot.iso
grub-mkrescue -o UmuOS-0.1.3-boot.iso iso_root
ls -lh UmuOS-0.1.3-boot.iso
```

---

## 9. ① 開発環境側ログ（QEMU シリアル出力の保存）を含む起動スクリプト

方針：

- 保存先は `logs/` に固定
- 命名は `qemu-serial_YYYYmmdd_HHMMSS.log`
- 端末表示は維持（ログイン操作に必要）
- `script(1)` を使い ttyS0（stdio）のセッションを記録する
- 0.1.3 差分：ttyS1 用に `-serial tcp:127.0.0.1:${TTYS1_PORT},server,nowait` を追加し、別端末から接続して同時ログインする

ttyS1 もログ取得を必須にする場合、ttyS1 に接続する側の端末を `script(1)` で包んで別ファイルに保存する。

### 9.1 umuOSstart.sh 作成

```bash
cd ~/umu/umu_project/UmuOS-0.1.3
tee umuOSstart.sh >/dev/null <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

LOG_DIR=~/umu/umu_project/UmuOS-0.1.3/logs
RUN_DIR=~/umu/umu_project/UmuOS-0.1.3/run
ISO=~/umu/umu_project/UmuOS-0.1.3/UmuOS-0.1.3-boot.iso
DISK=~/umu/umu_project/UmuOS-0.1.3/disk/disk.img
TTYS1_PORT=5555

mkdir -p "${LOG_DIR}" "${RUN_DIR}"

TS="$(date +%Y%m%d_%H%M%S)"
LOG_FILE="${LOG_DIR}/qemu-serial_${TS}.log"

echo "[umuOSstart] log: ${LOG_FILE}"

echo "[umuOSstart] ttyS1 tcp: 127.0.0.1:${TTYS1_PORT}"

OVMF_CODE="/usr/share/OVMF/OVMF_CODE_4M.fd"
OVMF_VARS_SRC="/usr/share/OVMF/OVMF_VARS_4M.fd"
OVMF_VARS="${RUN_DIR}/OVMF_VARS_umuos_0_1_3.fd"

# 環境差吸収（パスが違う場合がある）
if [[ ! -f "${OVMF_CODE}" ]]; then
  for cand in \
    /usr/share/OVMF/OVMF_CODE.fd \
    /usr/share/edk2/ovmf/OVMF_CODE.fd
  do
    if [[ -f "${cand}" ]]; then OVMF_CODE="${cand}"; break; fi
  done
fi

if [[ ! -f "${OVMF_VARS_SRC}" ]]; then
  for cand in \
    /usr/share/OVMF/OVMF_VARS.fd \
    /usr/share/edk2/ovmf/OVMF_VARS.fd
  do
    if [[ -f "${cand}" ]]; then OVMF_VARS_SRC="${cand}"; break; fi
  done
fi

if [[ ! -f "${OVMF_CODE}" || ! -f "${OVMF_VARS_SRC}" ]]; then
  echo "[umuOSstart] ERROR: OVMF files not found" >&2
  echo "[umuOSstart] OVMF_CODE=${OVMF_CODE}" >&2
  echo "[umuOSstart] OVMF_VARS_SRC=${OVMF_VARS_SRC}" >&2
  exit 1
fi

if [[ ! -f "${OVMF_VARS}" ]]; then
  cp -f "${OVMF_VARS_SRC}" "${OVMF_VARS}"
fi

QEMU_CMD=(
  qemu-system-x86_64
  -machine q35,accel=tcg
  -m 1024
  -cpu qemu64
  -drive if=pflash,format=raw,readonly=on,file="${OVMF_CODE}"
  -drive if=pflash,format=raw,file="${OVMF_VARS}"
  -cdrom "${ISO}"
  -drive file="${DISK}",format=raw,if=virtio
  -nographic
  -serial stdio
  -serial tcp:127.0.0.1:${TTYS1_PORT},server,nowait
  -monitor none
)

exec script -q -f --command "$(printf '%q ' "${QEMU_CMD[@]}")" "${LOG_FILE}"
EOF

chmod 755 umuOSstart.sh
```

### 9.2 ttyS1 接続スクリプト（ログ取得用：0.1.3差分）

ttyS1（`127.0.0.1:${TTYS1_PORT}`）への接続とログ保存をワンコマンド化する。

```bash
cd ~/umu/umu_project/UmuOS-0.1.3
tee connect_ttyS1.sh >/dev/null <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

PORT="${1:-5555}"
LOG_DIR=~/umu/umu_project/UmuOS-0.1.3/logs

mkdir -p "${LOG_DIR}"

TS="$(date +%Y%m%d_%H%M%S)"
LOG_FILE="${LOG_DIR}/ttyS1_${TS}.log"

echo "[connect_ttyS1] tcp: 127.0.0.1:${PORT}"
echo "[connect_ttyS1] log: ${LOG_FILE}"

echo "[connect_ttyS1] NOTE: This logs the ttyS1 session (telnet + script)."
exec script -q -f --command "telnet 127.0.0.1 ${PORT}" "${LOG_FILE}"
EOF

chmod 755 connect_ttyS1.sh
```

---

## 10. 起動（同時ログイン手順）

### 10.1 起動

```bash
cd ~/umu/umu_project/UmuOS-0.1.3
./umuOSstart.sh
```

### 10.2 ttyS1（2本目シリアル）へ接続

別ターミナルで ttyS1（TCPシリアル）に接続する。

```bash
cd ~/umu/umu_project/UmuOS-0.1.3
telnet 127.0.0.1 5555
```

ログ取得を必須にする場合は、スクリプトを使って接続する。

```bash
cd ~/umu/umu_project/UmuOS-0.1.3
./connect_ttyS1.sh 5555
```

`login:` が出れば ttyS1 が成立している。

---

## 11. 受入チェック（必須）

### 11.1 `switch_root` が成立

ttyS0 のログに `exec: /bin/switch_root /newroot /sbin/init` が出ること。

### 11.2 `/` が ext4（disk.img）

```sh
mount | grep ' on / '
```

期待：`/dev/vda on / type ext4 ...`

### 11.3 二系統ログ

- ① ホスト: `logs/qemu-serial_*.log` が生成される
- ② ゲスト: `/logs/boot.log` が追記される

### 11.4 `su -`（任意：0.1.4以降の予定案）

ttyS0 または ttyS1 のどちらかで `tama` ログインし、以下。

```sh
su -
id
```

期待：`uid=0(root)`

`tama` に戻る：

```sh
exit
id
```

期待：`uid=1000(tama)`

### 11.5 同時ログイン（0.1.3差分）

- ttyS0 で root ログインできる
- ttyS1 で tama ログインできる
- 両方同時にコマンドを打てる（干渉しない）

### 11.6 ttyS1 のホスト側ログ取得（0.1.3差分：必須）

ttyS1 接続側で `script(1)` を使い、`logs/ttyS1_*.log` が生成されること。

```bash
cd ~/umu/umu_project/UmuOS-0.1.3
ls -1 logs/ttyS1_*.log | tail -n 1

# 最低限 login: がログに含まれること
grep -n "login:" logs/ttyS1_*.log | tail -n 1
```

---

## 12. トラブルシュート（0.1.3の追加観点）

### 12.1 ttyS1 に `login:` が出ない

- ext4 側の `/etc/inittab` に `ttyS1::respawn:...` が入っているか
- QEMU 起動オプションに `-serial tcp:127.0.0.1:${TTYS1_PORT},server,nowait` が入っているか
- ホスト側から `telnet 127.0.0.1 ${TTYS1_PORT}` で接続できるか

### 12.2 `su: must be suid to work properly`

- `/bin/su -> /bin/busybox.su` になっているか
- `/bin/busybox.su` が `-rwsr-xr-x`（setuid）になっているか
- `/` が `nosuid` でマウントされていないか（`mount | grep ' on / '`）
