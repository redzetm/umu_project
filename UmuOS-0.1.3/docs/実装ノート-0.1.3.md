---
title: 実装ノート-0.1.3
date: 2026-01-20
---

# 実装ノート-0.1.3（再現用ログ）

目的： [詳細設計書-0.1.3.md](詳細設計書-0.1.3.md) を手で実行した「実際の履歴」を残し、後から同じ環境で再現できるようにする。

- 方針：**設計書の手順は変えない**。変えた場合は必ず「差分」と「理由」を記録する。
- 重要：コピペ実装では改行/クオート崩れが起こりやすいので、生成したファイルは必ず `cat` / `grep` 等で確認した結果も書く。

---

## 0. 実行環境

- 日時：
- ホストOS：
- パッケージ：
- 端末：
  - ttyS0: 
  - ttyS1: 

---

## 1. 作業ディレクトリ

- 作業ルート：`~/umu/umu_project/UmuOS-0.1.3`

---

## 2. 実装ログ（時系列）

### 2.1 セットアップ

```bash
cd ~/umu/umu_project/UmuOS-0.1.3/docs

sudo apt update
sudo apt upgrade

sudo apt install -y \
  build-essential bc bison flex libssl-dev libelf-dev libncurses-dev dwarves \
  git wget \
  grub-efi-amd64-bin grub-common xorriso mtools \
  qemu-system-x86 ovmf \
  cpio gzip xz-utils \
  busybox-static e2fsprogs \
  musl-tools util-linux \
  openssl telnet netcat-openbsd

command -v qemu-system-x86_64
command -v grub-mkrescue
command -v musl-gcc
command -v mkfs.ext4
command -v openssl
```

結果/観測：
- `apt update`: OK
- `apt upgrade`: avahi 系 6 パッケージを更新
- `apt install`: 全てインストール済み（追加なし）
- `command -v`:
  - `qemu-system-x86_64` -> `/usr/bin/qemu-system-x86_64`
  - `grub-mkrescue` -> `/usr/bin/grub-mkrescue`
  - `musl-gcc` -> `/usr/bin/musl-gcc`
  - `mkfs.ext4` -> `/usr/sbin/mkfs.ext4`
  - `openssl` -> `/usr/bin/openssl`

### 2.1.1 作業ディレクトリ作成

```bash
cd ~/umu/umu_project/UmuOS-0.1.3
mkdir -p kernel initramfs/src initramfs/rootfs iso_root/boot/grub disk run

ll -a
```

結果/観測：
- `~/umu/umu_project/UmuOS-0.1.3/` 配下に以下が存在
  - `disk/` `docs/` `initramfs/` `iso_root/` `kernel/` `run/`

### 2.2 Kernel

```bash
cd ~/umu/umu_project/UmuOS-0.1.3/kernel
wget -nc https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.18.1.tar.xz
rm -rf linux-6.18.1
tar -xf linux-6.18.1.tar.xz
cd linux-6.18.1

make mrproper
make defconfig
make -j"$(nproc)"

grep -E '^(CONFIG_EXT4_FS=|CONFIG_DEVTMPFS=|CONFIG_DEVTMPFS_MOUNT=|CONFIG_BLK_DEV_INITRD=|CONFIG_VIRTIO=|CONFIG_VIRTIO_PCI=|CONFIG_VIRTIO_BLK=|CONFIG_RD_GZIP=)' .config
```

結果/観測：
- `.config` 必須項目（=y）確認
- ビルド：`arch/x86/boot/bzImage is ready` を確認
- 必須設定（全て built-in =y）
  - `CONFIG_BLK_DEV_INITRD=y`
  - `CONFIG_RD_GZIP=y`
  - `CONFIG_DEVTMPFS=y`
  - `CONFIG_DEVTMPFS_MOUNT=y`
  - `CONFIG_VIRTIO_BLK=y`
  - `CONFIG_VIRTIO=y`
  - `CONFIG_VIRTIO_PCI=y`
  - `CONFIG_EXT4_FS=y`

#### 2.2.1 ISO入力へ配置

```bash
cd ~/umu/umu_project/UmuOS-0.1.3
cp kernel/linux-6.18.1/arch/x86/boot/bzImage iso_root/boot/vmlinuz-6.18.1
cp kernel/linux-6.18.1/.config iso_root/boot/config-6.18.1
file iso_root/boot/vmlinuz-6.18.1
```

結果/観測：
- `iso_root/boot/vmlinuz-6.18.1`: `Linux kernel x86 boot executable bzImage, version 6.18.1 ...`

### 2.3 disk.img

```bash
cd ~/umu/umu_project/UmuOS-0.1.3/disk
truncate -s 4G disk.img
mkfs.ext4 -F disk.img
sudo blkid -p -o value -s UUID disk.img
```

結果/観測：
- DISK_UUID=`f072def4-1bda-403d-80a6-d123d08c661c`

### 2.4 ext4 rootfs（/mnt/umuos013）

```bash
cd ~/umu/umu_project/UmuOS-0.1.3/disk

sudo mkdir -p /mnt/umuos013
sudo mount -o loop ~/umu/umu_project/UmuOS-0.1.3/disk/disk.img /mnt/umuos013
findmnt /mnt/umuos013

sudo mkdir -p /mnt/umuos013/{bin,sbin,etc,proc,sys,dev,dev/pts,run,home,root,tmp,logs,etc/init.d}

# BusyBox 配置
sudo cp /bin/busybox /mnt/umuos013/bin/busybox
sudo chown root:root /mnt/umuos013/bin/busybox
sudo chmod 755 /mnt/umuos013/bin/busybox
file /mnt/umuos013/bin/busybox

# BusyBox applet 生成（chroot 必須）
sudo chroot /mnt/umuos013 /bin/busybox --install -s /bin
sudo chroot /mnt/umuos013 /bin/busybox --install -s /sbin

sudo ls -l /mnt/umuos013/bin/sh
sudo ls -l /mnt/umuos013/sbin/init

# /sbin/init を BusyBox に向ける（念のため）
sudo ln -sf /bin/busybox /mnt/umuos013/sbin/init
sudo ls -l /mnt/umuos013/sbin/init

# inittab（ttyS0/ttyS1）
sudo tee /mnt/umuos013/etc/inittab >/dev/null <<'EOF'
::sysinit:/etc/init.d/rcS

# ttyS0（シリアル）でログイン（観測主経路）
ttyS0::respawn:/sbin/getty -L 115200 ttyS0 vt100

# ttyS1（シリアル）でログイン（同時ログイン用：0.1.3差分）
ttyS1::respawn:/sbin/getty -L 115200 ttyS1 vt100

::ctrlaltdel:/sbin/reboot
::shutdown:/bin/umount -a
EOF

# rcS（永続ログ /logs/boot.log）
sudo tee /mnt/umuos013/etc/init.d/rcS >/dev/null <<'EOF'
#!/bin/sh

# 失敗しても止めない（観測を優先）
mount -t proc proc /proc 2>/dev/null || true
mount -t sysfs sysfs /sys 2>/dev/null || true
mount -t devtmpfs devtmpfs /dev 2>/dev/null || true
mount -t devpts devpts /dev/pts 2>/dev/null || true

# ② 永続ログ（/logs/boot.log）
(
  mkdir -p /logs

  UPTIME_S="$(cut -d' ' -f1 /proc/uptime 2>/dev/null || echo '?')"
  BOOT_ID="$(cat /proc/sys/kernel/random/boot_id 2>/dev/null || echo '?')"

  {
    echo ""
    echo "===== boot begin (boot_id=${BOOT_ID} uptime_s=${UPTIME_S}) ====="
    echo "[cmdline]"
    cat /proc/cmdline 2>/dev/null || true
    echo ""
    echo "[mount]"
    mount 2>/dev/null || true
    echo ""
    echo "[dmesg]"
    dmesg 2>/dev/null || true
    echo "===== boot end ====="
  } >> /logs/boot.log
) 2>/dev/null || (
  /bin/echo "[rcS] WARN: boot.log write failed" > /dev/console 2>/dev/null || true
)

/bin/echo "[rcS] rcS done" > /dev/console 2>/dev/null || true
EOF

sudo chmod 755 /mnt/umuos013/etc/init.d/rcS

# ユーザー（root / tama）
sudo tee /mnt/umuos013/etc/passwd >/dev/null <<'EOF'
root:x:0:0:root:/root:/bin/sh
tama:x:1000:1000:tama:/home/tama:/bin/sh
EOF

sudo tee /mnt/umuos013/etc/group >/dev/null <<'EOF'
root:x:0:
users:x:100:
tama:x:1000:
EOF

openssl passwd -6
openssl passwd -6

sudo tee /mnt/umuos013/etc/shadow >/dev/null <<'EOF'
root:<REPLACE_WITH_HASH_FOR_ROOT>:20000:0:99999:7:::
tama:<REPLACE_WITH_HASH_FOR_TAMA>:20000:0:99999:7:::
EOF

sudo chown root:root /mnt/umuos013/etc/shadow
sudo chmod 600 /mnt/umuos013/etc/shadow

sudo mkdir -p /mnt/umuos013/root
sudo mkdir -p /mnt/umuos013/home/tama
sudo chown 1000:1000 /mnt/umuos013/home/tama

# 観測点（5.10）
sudo ls -l /mnt/umuos013/sbin/init
sudo ls -l /mnt/umuos013/etc/inittab
sudo ls -l /mnt/umuos013/etc/init.d/rcS
sudo ls -l /mnt/umuos013/etc/passwd
sudo ls -l /mnt/umuos013/etc/shadow

# 任意：su（setuid 限定）
sudo cp -a /mnt/umuos013/bin/busybox /mnt/umuos013/bin/busybox.su
sudo chown root:root /mnt/umuos013/bin/busybox.su
sudo chmod 4755 /mnt/umuos013/bin/busybox.su
sudo ln -sf /bin/busybox.su /mnt/umuos013/bin/su

sudo ls -l /mnt/umuos013/bin/busybox /mnt/umuos013/bin/busybox.su /mnt/umuos013/bin/su

# 観測点（5.10：追加）
sudo ls -l /mnt/umuos013/bin/busybox.su
sudo ls -l /mnt/umuos013/bin/su

# アンマウント（5.11）
sync
sudo umount /mnt/umuos013
```

結果/観測：
- `findmnt /mnt/umuos013`
  - `SOURCE=/dev/loop14` `FSTYPE=ext4` `OPTIONS=rw,relatime`
- `file /mnt/umuos013/bin/busybox`
  - `ELF 64-bit ... statically linked ...`（busybox-static）
- `/mnt/umuos013/bin/sh -> /bin/busybox` を確認
- `/mnt/umuos013/sbin/init -> /bin/busybox` を確認
- `/etc/inittab` を作成（ttyS0/ttyS1 の getty）
- `/etc/init.d/rcS` を作成して `chmod 755`
- `/etc/passwd` `/etc/group` `/etc/shadow` を作成
  - NOTE: 実装ノートにはパスワードハッシュを残さない（再現時に都度生成して差し替える）
- 観測点（作成物の存在と権限）
  - `/mnt/umuos013/sbin/init`: `lrwxrwxrwx ... -> /bin/busybox`
  - `/mnt/umuos013/etc/inittab`: `-rw-r--r--`（323 bytes）
  - `/mnt/umuos013/etc/init.d/rcS`: `-rwxr-xr-x`（958 bytes）
  - `/mnt/umuos013/etc/passwd`: `-rw-r--r--`（71 bytes）
  - `/mnt/umuos013/etc/shadow`: `-rw-------`（262 bytes）
- 任意：`su` の setuid 限定
  - `/mnt/umuos013/bin/busybox.su`: `-rwsr-xr-x`（owner `root:root`）
  - `/mnt/umuos013/bin/su -> /bin/busybox.su`
- 実行時の観測（0.1.3）：`su -` は `su: must be suid to work properly` で失敗し、0.1.3では未成立（受入条件外）
- `sync` → `umount /mnt/umuos013` まで完了

### 2.5 initramfs

```bash
cd ~/umu/umu_project/UmuOS-0.1.3/initramfs
rm -rf rootfs
mkdir -p rootfs/{bin,sbin,etc,proc,sys,dev,dev/pts,run,newroot}

cp /bin/busybox rootfs/bin/busybox
chmod 755 rootfs/bin/busybox

sudo chroot rootfs /bin/busybox --install -s /bin
ls -l rootfs/bin/switch_root

cd ~/umu/umu_project/UmuOS-0.1.3
cp -a ~/umu/umu_project/UmuOS-0.1.1/initramfs/src/init.c initramfs/src/init.c

musl-gcc -static -O2 -Wall -Wextra -o initramfs/rootfs/init initramfs/src/init.c
chmod 755 initramfs/rootfs/init
file initramfs/rootfs/init

cd ~/umu/umu_project/UmuOS-0.1.3/initramfs/rootfs
rm -f ../initrd.filelist0 ../initrd.cpio ../initrd.cpio.list ../initrd.img-6.18.1

find . -print0 > ../initrd.filelist0
cpio --null -ov --format=newc < ../initrd.filelist0 > ../initrd.cpio

cd ..
cpio -t < initrd.cpio > initrd.cpio.list

grep -E '^(init|bin/switch_root)$' initrd.cpio.list

gzip -9 -c initrd.cpio > initrd.img-6.18.1
ls -lh initrd.img-6.18.1

cd ~/umu/umu_project/UmuOS-0.1.3
cp initramfs/initrd.img-6.18.1 iso_root/boot/initrd.img-6.18.1
ls -l iso_root/boot/initrd.img-6.18.1
```

結果/観測：
- `ls -l rootfs/bin/switch_root`
  - `rootfs/bin/switch_root -> /bin/busybox`
- `file initramfs/rootfs/init`
  - `ELF 64-bit ... statically linked, with debug_info, not stripped`
- `grep -E '^(init|bin/switch_root)$' initrd.cpio.list`
  - `bin/switch_root`
  - `init`
- `ls -lh initrd.img-6.18.1`
  - `1.1M`
- `ls -l iso_root/boot/initrd.img-6.18.1`
  - `-rw-rw-r-- 1 tama tama 1137142 ... iso_root/boot/initrd.img-6.18.1`

### 2.6 GRUB / ISO

```bash
cd ~/umu/umu_project/UmuOS-0.1.3

tee iso_root/boot/grub/grub.cfg >/dev/null <<'EOF'
set timeout=20
set default=0

# 観測（ttyS0）を優先：GRUBメニューもシリアルへ出す
serial --unit=0 --speed=115200 --word=8 --parity=no --stop=1
terminal_input serial console
terminal_output serial console

menuentry "UmuOS-0.1.3" {
    insmod all_video
    insmod gfxterm
    insmod gzio

    linux /boot/vmlinuz-6.18.1 \
        root=UUID=f072def4-1bda-403d-80a6-d123d08c661c \
        rw \
        console=tty0 console=ttyS0,115200n8 \
        loglevel=7 \
        panic=-1

    initrd /boot/initrd.img-6.18.1
}
EOF

DISK_UUID="$(sudo blkid -p -o value -s UUID disk/disk.img)"
sed -i "s/f072def4-1bda-403d-80a6-d123d08c661c/${DISK_UUID}/" iso_root/boot/grub/grub.cfg
grep -n "root=UUID" iso_root/boot/grub/grub.cfg

# ISO 生成
rm -f UmuOS-0.1.3-boot.iso
grub-mkrescue -o UmuOS-0.1.3-boot.iso iso_root
ls -lh UmuOS-0.1.3-boot.iso
```

結果/観測：
- `DISK_UUID` は `f072def4-1bda-403d-80a6-d123d08c661c`
- `grep -n "root=UUID" iso_root/boot/grub/grub.cfg`
  - `15:        root=UUID=f072def4-1bda-403d-80a6-d123d08c661c \\`
- `grub-mkrescue -o UmuOS-0.1.3-boot.iso iso_root`: 成功（`Writing to 'stdio:UmuOS-0.1.3-boot.iso' completed successfully.`）
- `ls -lh UmuOS-0.1.3-boot.iso`: `27M`
- UEFI ブートローダの確認（観測点）
  - `xorriso -indev UmuOS-0.1.3-boot.iso -ls /efi/boot` -> `bootx64.efi` が見える
  - NOTE: `xorriso -find` は GNU `find` と互換ではないため、`-iname` や `-print` がエラーになることがある

### 2.7 起動

```bash
cd ~/umu/umu_project/UmuOS-0.1.3

# 起動スクリプト（ttyS0ログ保存 + ttyS1 TCPシリアル）
tee umuOSstart.sh >/dev/null <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

LOG_DIR=~/umu/umu_project/UmuOS-0.1.3/logs
RUN_DIR=~/umu/umu_project/UmuOS-0.1.3/run
ISO=~/umu/umu_project/UmuOS-0.1.3/UmuOS-0.1.3-boot.iso
DISK=~/umu/umu_project/UmuOS-0.1.3/disk/disk.img
TTYS1_PORT=5555

mkdir -p "${LOG_DIR}" "${RUN_DIR}"

TS="$(date +%Y%m%d_%H%M%S)"
LOG_FILE="${LOG_DIR}/qemu-serial_${TS}.log"

echo "[umuOSstart] log: ${LOG_FILE}"

echo "[umuOSstart] ttyS1 tcp: 127.0.0.1:${TTYS1_PORT}"

OVMF_CODE="/usr/share/OVMF/OVMF_CODE_4M.fd"
OVMF_VARS_SRC="/usr/share/OVMF/OVMF_VARS_4M.fd"
OVMF_VARS="${RUN_DIR}/OVMF_VARS_umuos_0_1_3.fd"

# 環境差吸収（パスが違う場合がある）
if [[ ! -f "${OVMF_CODE}" ]]; then
  for cand in \
    /usr/share/OVMF/OVMF_CODE.fd \
    /usr/share/edk2/ovmf/OVMF_CODE.fd
  do
    if [[ -f "${cand}" ]]; then OVMF_CODE="${cand}"; break; fi
  done
fi

if [[ ! -f "${OVMF_VARS_SRC}" ]]; then
  for cand in \
    /usr/share/OVMF/OVMF_VARS.fd \
    /usr/share/edk2/ovmf/OVMF_VARS.fd
  do
    if [[ -f "${cand}" ]]; then OVMF_VARS_SRC="${cand}"; break; fi
  done
fi

if [[ ! -f "${OVMF_CODE}" || ! -f "${OVMF_VARS_SRC}" ]]; then
  echo "[umuOSstart] ERROR: OVMF files not found" >&2
  echo "[umuOSstart] OVMF_CODE=${OVMF_CODE}" >&2
  echo "[umuOSstart] OVMF_VARS_SRC=${OVMF_VARS_SRC}" >&2
  exit 1
fi

if [[ ! -f "${OVMF_VARS}" ]]; then
  cp -f "${OVMF_VARS_SRC}" "${OVMF_VARS}"
fi

QEMU_CMD=(
  qemu-system-x86_64
  -machine q35,accel=tcg
  -m 1024
  -cpu qemu64
  -drive if=pflash,format=raw,readonly=on,file="${OVMF_CODE}"
  -drive if=pflash,format=raw,file="${OVMF_VARS}"
  -cdrom "${ISO}"
  -drive file="${DISK}",format=raw,if=virtio
  -nographic
  -serial stdio
  -serial tcp:127.0.0.1:${TTYS1_PORT},server,nowait,telnet
  -monitor none
)

exec script -q -f --command "$(printf '%q ' "${QEMU_CMD[@]}")" "${LOG_FILE}"
EOF

chmod 755 umuOSstart.sh

# ttyS1接続（ログ保存）
tee connect_ttyS1.sh >/dev/null <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

PORT="${1:-5555}"
LOG_DIR=~/umu/umu_project/UmuOS-0.1.3/logs

mkdir -p "${LOG_DIR}"

TS="$(date +%Y%m%d_%H%M%S)"
LOG_FILE="${LOG_DIR}/ttyS1_${TS}.log"

echo "[connect_ttyS1] tcp: 127.0.0.1:${PORT}"
echo "[connect_ttyS1] log: ${LOG_FILE}"

echo "[connect_ttyS1] NOTE: This logs the ttyS1 session (telnet + script)."
exec script -q -f --command "telnet 127.0.0.1 ${PORT}" "${LOG_FILE}"
EOF

chmod 755 connect_ttyS1.sh
```

結果/観測：
- `umuOSstart.sh` / `connect_ttyS1.sh` を作成し、実行権限を付与した
- ホスト側ログ：`logs/qemu-serial_*.log`
- 実ログ（例）
  - `logs/qemu-serial_20260120_070205.log`
  - `logs/ttyS1_20260120_070306.log`
- ゲスト側ログ：`/logs/boot.log`
- ttyS1 接続：`telnet 127.0.0.1 5555`（または `./connect_ttyS1.sh 5555`）
- ttyS1 は接続できても表示が出ない場合があるが、Enter を数回押すと `login:` が再表示された（接続より前の出力は流れないため）
- ttyS1 で `tama` ログインできた（同時ログイン経路として成立）
  - `echo OK-ttys1` -> `OK-ttys1`
- ttyS0/ttyS1 で同時に操作でき、干渉していないことを確認
  - ttyS0: `echo OK-ttys0` -> `OK-ttys0`
  - ttyS1: `echo OK-ttys1-2` -> `OK-ttys1-2`

---

## 3. 受入チェック結果

- [x] `switch_root` が成立（ttyS0ログに `exec: /bin/switch_root /newroot /sbin/init`）
- [x] `/` が ext4（`/dev/vda on / type ext4 ...`）
- [x] ttyS0 で root ログインできる
- [x] ttyS1 で `login:` が出てログインできる
- [x] 同時ログインできる（ttyS0/ttyS1両方で操作可能）
- [x] ホスト側ログが保存される（`logs/qemu-serial_*.log`, `logs/ttyS1_*.log`）
- [x] ゲスト側ログが追記される（`/logs/boot.log`）

補足：`su` について

- 0.1.3 では `su` は未成立（`su: must be suid to work properly` を観測）。同時ログインとは独立の課題のため、受入条件から除外。

補足（ホスト側から `boot.log` を確認した）：

```bash
cd ~/umu/umu_project/UmuOS-0.1.3

sudo mkdir -p /mnt/umuos013
sudo mount -o loop disk/disk.img /mnt/umuos013

sudo tail -n 5 /mnt/umuos013/logs/boot.log

sudo umount /mnt/umuos013
```

---

## 4. 設計書との差分（もしあれば）

今回の実行では「設計書の手順を変える必要がある差分」は発生しなかった。

- 差分：なし
- 理由：N/A
- 影響：N/A
- 再現手順への反映方針：N/A

---

## 5. トラブルシュート（発生したもの）

### ttyS1: telnet接続できるが `login:` が見えない / `UNKNOWN` になる

- 症状
  - `telnet 127.0.0.1 5555` は connect するが、画面が進まない
  - ttyS0ログに `login[...]: invalid password for 'UNKNOWN' on 'ttyS1'` が出ることがある
- 原因
  - QEMU の `-serial tcp:...` が raw TCP のままで、telnet クライアントのネゴシエーション文字が ttyS1 に流れ込む
- 対処
  - QEMU の ttyS1 を `-serial tcp:127.0.0.1:${TTYS1_PORT},server,nowait,telnet` にする（telnet互換）
  - 実際の運用は起動スクリプトに寄せた（起動側を直す）
- 代替
  - raw TCP のまま使うなら、接続側は `telnet` ではなく `nc 127.0.0.1 5555`
- 再発防止
  - 「telnet で接続するなら QEMU 側は `...,telnet` 必須」を設計書・スクリプトに明記

### su: `su: must be suid to work properly`

- 症状
  - `tama` でログイン後に `su -` を実行すると `su: must be suid to work properly`
- 状態（0.1.3）
  - 未解決（0.1.3では未成立）
  - 受入条件（同時ログイン）とは独立のため、0.1.4 以降の課題として切り出す
