# UmuOS-0.1.5-dev 機能追加

UmuOS-0.1.4-base-stableの機能に追加する一覧
再現可能なように、0.1.4-base-stableの差分実装ではなく、まったく最初から構築する
基本設計、詳細設計、実装ノートを必ず残す

## 用語

- `/umu_bin`：umu_bin（ユーザー向けの自作の追加コマンド置き場）Busyboxコマンドと名前が被っても自作コマンドが優先されるよう検索パスの1番目とする
  - BusyBox 由来の標準コマンドは消さずに残し、追加・ラップは原則 `/umu_bin` に置く

## UmuOS-0.1.5-devの実装方法

- UmuOS-0.1.4-base-stableをカーネルビルドを含め、再現し、UmuOS-0.1.5-devとして実装
- 手動で下記、追加する項目を実装（それぞれの項目は、しっかり手順書を作成し、コードベースまで落とし込み作業する）
- 受け入れテスト
- 合格したら、UmuOS-0.1.5-dev/　配下のファイルを全て精査し、理解。かつ、再現可能な、基本設計、詳細設計を作成し、UmuOS-0.1.6-base-stableとして実装する。

## 追加する項目

- DNS：`/etc/resolv.conf` を Google DNS `8.8.8.8` にして外界通信可能にする
- タイムゾーン：JST（`Japan/Tokyo`）にする
- NTP：BusyBox の `ntpd` で時刻を同期する
- Busyboxのsuでsetuidが効かない問題。自作suコマンド作成する
- llコマンドはよく使うので、ラッパースクリプトを `/umu_bin` に追加する
- 自作コマンドの置き場として `/umu_bin` を追加する
  - 検索パス（例）：`PATH=/umu_bin:/bin:/sbin`
  - UmuOS ビルド時に `PATH` の先頭を `/umu_bin` にする（ush(自作シェル)も/umu_binに配置）
  - `/umu_bin` は root のみ書き込み可能にする（例：`root:root`, `0755`）

- FTPサーバ：BusyBox の `ftpd` で簡易に提供できる
  - 想定用途：ファイル転送（テキスト/バイナリ）
    - 転送モードは原則 `binary` を推奨（テキストも `binary` で問題ない。`ascii` は改行コード変換等が入る可能性がある）
  - ユーザーのホームディレクトリは不要（公開ディレクトリは新設せず、既存ディレクトリを FTP のルートとして扱う。例：`/tmp`）
  - 常駐させる場合は `ftpd` 単体を常駐させるのではなく、前段の `tcpsvd` を常駐させて接続ごとに `ftpd` を起動する（`inetd` のミニ版のような役割）
  - init（BusyBox init）で常駐させる：`/etc/inittab` の `::sysinit:/etc/init.d/rcS` から実行される `/etc/init.d/rcS` に、以下のように `tcpsvd` をバックグラウンド起動して PID を保存する
    - PIDファイル保存先は `/run` を優先する（`/var/run` は歴史的経緯で `/run` への symlink のことが多い）

    ```sh
    mkdir -p /run

    # LAN 内限定にしたい場合は 0.0.0.0 の代わりに特定IPを指定する
    FTP_ROOT=/tmp
    busybox tcpsvd -vE 0.0.0.0 21 busybox ftpd "$FTP_ROOT" &
    echo $! > /run/ftpd.pid
    ```

  - 手動で起動・停止できる start/stop スクリプトを `/umu_bin` に配置する（PIDは `tcpsvd` を管理する）
    - 停止例：`kill "$(cat /run/ftpd.pid)"`（必要なら PID ファイルも削除）
  - `ftpd` の書き込み許可などのオプションは環境により異なるため、まず `busybox ftpd --help` で確認する

## 受け入れ条件（DoD）

### ブート/基盤

- 起動できる（ISO + 永続ディスク）
- `switch_root` が成立する（ttyS0 ログで確認）
- BusyBox `telnetd` で LAN 内からログインできる（root / tama）

### `/umu_bin` と検索パス

- `/umu_bin` が存在し、`root:root` かつ `0755` である
- ログイン後の `echo "$PATH"` で `/umu_bin` が先頭にある
- `ll` が `/umu_bin/ll` として存在し、実行できる（例：`ll /`）

### DNS/時刻

- DNS 解決ができる（例：`ping -c 1 google.com`）
- タイムゾーンが JST になっている（例：`date` の表示がJST）
- NTP で時刻同期できる（BusyBox `ntpd` を起動し、時刻が補正される）

### `su`（setuid 問題の回避）

- `su` 相当の手段が成立している（設計した自作 `su`/代替コマンドで root になれる）

### FTP（tcpsvd + ftpd）

- `tcpsvd + ftpd` が起動できる
- PID が `/run/ftpd.pid` に保存され、停止できる
- LAN 内端末から接続でき、FTP_ROOT（例：`/tmp`）配下へアップロード/ダウンロードできる

#### 参考：確認コマンド例

```sh
# 起動確認
ps | grep -E 'tcpsvd|ftpd' || true
test -f /run/ftpd.pid && cat /run/ftpd.pid

# 接続ポート確認（環境により利用可能コマンドが異なる）
netstat -lntp 2>/dev/null | grep ':21' || ss -lntp 2>/dev/null | grep ':21' || true
```

