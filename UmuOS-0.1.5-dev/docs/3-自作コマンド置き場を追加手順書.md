# UmuOS-0.1.5-dev 機能追加（手動により実装）手順書：自作コマンド置き場を作成し、パスの優先順位を一番にする

本書は、UmuOS（0.1.4-base-stable 相当の最小 BusyBox ユーザーランド）に対して、

- 自作コマンドの置き場として `/umu_bin` を追加する
- 検索パス（`PATH`）の先頭に `/umu_bin` を置き、既存コマンドをラップしやすくする

ための手順をまとめる。

結論：`/umu_bin` を `root:root 0755` で作成し、`/etc/init.d/rcS` の `PATH` を `export PATH=/umu_bin:/sbin:/bin` にする。

## 前提

- 以降のコマンドはゲスト上で root で実行する
- UmuOS-0.1.4-base-stable の構成では、`/etc/inittab` の `::sysinit:/etc/init.d/rcS` で rcS が実行される
- rootfs は永続ディスク（ext4）なので、ゲスト内で編集すれば次回起動後も残る

## 1. `/umu_bin` を作成して権限を固定する

```sh
mkdir -p /umu_bin
chown root:root /umu_bin
chmod 0755 /umu_bin
ls -ld /umu_bin
```

ポイント：

- 0755 にして「誰でも実行できるが、書き込みは root のみ」にする。
- ここを 0777 にすると誰でも上書き可能になり危険。

## 2. `PATH` の先頭に `/umu_bin` を追加する

0.1.4-base-stable の rcS は先頭で `export PATH=/sbin:/bin` を設定しているため、
ここを `/umu_bin` 優先に変更する。

### 2.1 rcS を編集する（推奨）

`/etc/init.d/rcS` の `export PATH=...` を次のようにする。

```sh
export PATH=/umu_bin:/sbin:/bin
```

編集後、反映確認：

```sh
echo "$PATH"
which ls
```

※`rcS` はブート時に実行されるので、確実に全プロセスへ反映したい場合はここが一番安全。

### 2.2（任意）ログインシェルにも確実に反映したい場合

環境によっては、ログイン後のシェル初期化で PATH が上書きされることがある。
その場合は `/etc/profile`（存在する場合）などにも同様に書く。

ただし最小構成では `/etc/profile` が無い/読まれない可能性があるため、まずは 2.1 の rcS で成立させる。

## 3. 動作確認：ラッパーコマンドを置いてみる（例：`ll`）

例として、よく使う `ll` を `/umu_bin/ll` として作る。

```sh
cat > /umu_bin/ll <<'EOF'
#!/bin/sh
exec ls -alF "$@"
EOF

chown root:root /umu_bin/ll
chmod 0755 /umu_bin/ll
```

確認：

```sh
which ll
ll /
```

## 4. 永続化（ホスト側から disk.img に投入する場合）

disk.img を作り直した・ゲストに入れない等の「例外時」の投入手順。

```sh
sudo mkdir -p /mnt/umuos
sudo mount -o loop /home/tama/umu/umu_project/UmuOS-0.1.4-base-stable/disk/disk.img /mnt/umuos

sudo mkdir -p /mnt/umuos/umu_bin
sudo chown root:root /mnt/umuos/umu_bin
sudo chmod 0755 /mnt/umuos/umu_bin

# 例：ll
sudo tee /mnt/umuos/umu_bin/ll >/dev/null <<'EOF'
#!/bin/sh
exec ls -alF "$@"
EOF
sudo chown root:root /mnt/umuos/umu_bin/ll
sudo chmod 0755 /mnt/umuos/umu_bin/ll

# rcS の PATH を修正（手元の運用に合わせて編集）
# 例：export PATH=/sbin:/bin を export PATH=/umu_bin:/sbin:/bin に変更
sudo sed -i 's|^export PATH=/sbin:/bin$|export PATH=/umu_bin:/sbin:/bin|' /mnt/umuos/etc/init.d/rcS

sync
sudo umount /mnt/umuos
```

## トラブルシュート

- `which ll` が見つからない
  - `echo "$PATH"` で `/umu_bin` が先頭に入っているか確認
  - `/umu_bin/ll` が `0755` で実行可能か確認
- `/umu_bin` を作ったのに再起動で消える
  - その rootfs が永続ディスク（ext4）側か確認（initramfs 側に書いていると消える）
- `sed -i` が無い/動かない
  - BusyBox のビルド設定次第なので、ホスト側で `/mnt/umuos/etc/init.d/rcS` をエディタで直接編集する